"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3466],{3905:(e,a,t)=>{t.d(a,{Zo:()=>m,kt:()=>k});var n=t(7294);function s(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function p(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?p(Object(t),!0).forEach((function(a){s(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function r(e,a){if(null==e)return{};var t,n,s=function(e,a){if(null==e)return{};var t,n,s={},p=Object.keys(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||(s[t]=e[t]);return s}(e,a);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var o=n.createContext({}),c=function(e){var a=n.useContext(o),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},m=function(e){var a=c(e.components);return n.createElement(o.Provider,{value:a},e.children)},i="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},N=n.forwardRef((function(e,a){var t=e.components,s=e.mdxType,p=e.originalType,o=e.parentName,m=r(e,["components","mdxType","originalType","parentName"]),i=c(t),N=s,k=i["".concat(o,".").concat(N)]||i[N]||d[N]||p;return t?n.createElement(k,l(l({ref:a},m),{},{components:t})):n.createElement(k,l({ref:a},m))}));function k(e,a){var t=arguments,s=a&&a.mdxType;if("string"==typeof e||s){var p=t.length,l=new Array(p);l[0]=N;var r={};for(var o in a)hasOwnProperty.call(a,o)&&(r[o]=a[o]);r.originalType=e,r[i]="string"==typeof e?e:s,l[1]=r;for(var c=2;c<p;c++)l[c]=t[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}N.displayName="MDXCreateElement"},7626:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>m,contentTitle:()=>o,default:()=>k,frontMatter:()=>r,metadata:()=>c,toc:()=>i});var n=t(7462),s=t(3366),p=(t(7294),t(3905)),l=["components"],r={title:"The Design of Shrine"},o=void 0,c={unversionedId:"design",id:"design",title:"The Design of Shrine",description:"*If you want an in-depth walkthrough through the Shrine codebase, see [Notes on",source:"@site/../doc/design.md",sourceDirName:".",slug:"/design",permalink:"/docs/design",draft:!1,editUrl:"https://github.com/shrinerb/shrine/edit/master/doc/../doc/design.md",tags:[],version:"current",lastUpdatedBy:"Ben Koshy",lastUpdatedAt:1607062623,formattedLastUpdatedAt:"Dec 4, 2020",frontMatter:{title:"The Design of Shrine"},sidebar:"guides",previous:{title:"Getting Started",permalink:"/docs/getting-started"},next:{title:"Retrieving Uploads",permalink:"/docs/retrieving-uploads"}},m={},i=[{value:"Storage",id:"storage",level:2},{value:"<code>Shrine</code>",id:"shrine",level:2},{value:"Plugins",id:"plugins",level:3},{value:"<code>Shrine::UploadedFile</code>",id:"shrineuploadedfile",level:2},{value:"<code>Shrine::Attacher</code>",id:"shrineattacher",level:2},{value:"<code>Shrine::Attachment</code>",id:"shrineattachment",level:2}],d={toc:i},N="wrapper";function k(e){var a=e.components,t=(0,s.Z)(e,l);return(0,p.kt)(N,(0,n.Z)({},d,t,{components:a,mdxType:"MDXLayout"}),(0,p.kt)("p",null,(0,p.kt)("em",{parentName:"p"},"If you want an in-depth walkthrough through the Shrine codebase, see ",(0,p.kt)("a",{parentName:"em",href:"https://bibwild.wordpress.com/2018/09/12/notes-on-study-of-shrine-implementation/"},"Notes on\nstudy of shrine implementation")," article by Jonathan Rochkind.")),(0,p.kt)("p",null,"There are five main types of classes that you deal with in Shrine:"),(0,p.kt)("table",null,(0,p.kt)("thead",{parentName:"table"},(0,p.kt)("tr",{parentName:"thead"},(0,p.kt)("th",{parentName:"tr",align:"left"},"Class"),(0,p.kt)("th",{parentName:"tr",align:"left"},"Description"))),(0,p.kt)("tbody",{parentName:"table"},(0,p.kt)("tr",{parentName:"tbody"},(0,p.kt)("td",{parentName:"tr",align:"left"},(0,p.kt)("a",{parentName:"td",href:"#Storage"},(0,p.kt)("inlineCode",{parentName:"a"},"Shrine::Storage::*"))),(0,p.kt)("td",{parentName:"tr",align:"left"},"Manages files on a particular storage service")),(0,p.kt)("tr",{parentName:"tbody"},(0,p.kt)("td",{parentName:"tr",align:"left"},(0,p.kt)("a",{parentName:"td",href:"#Shrine"},(0,p.kt)("inlineCode",{parentName:"a"},"Shrine"))),(0,p.kt)("td",{parentName:"tr",align:"left"},"Wraps uploads and handles loading plugins")),(0,p.kt)("tr",{parentName:"tbody"},(0,p.kt)("td",{parentName:"tr",align:"left"},(0,p.kt)("a",{parentName:"td",href:"#shrineuploadedfile"},(0,p.kt)("inlineCode",{parentName:"a"},"Shrine::UploadedFile"))),(0,p.kt)("td",{parentName:"tr",align:"left"},"Represents a file uploaded to a storage")),(0,p.kt)("tr",{parentName:"tbody"},(0,p.kt)("td",{parentName:"tr",align:"left"},(0,p.kt)("a",{parentName:"td",href:"#shrineattacher"},(0,p.kt)("inlineCode",{parentName:"a"},"Shrine::Attacher"))),(0,p.kt)("td",{parentName:"tr",align:"left"},"Handles file attachment logic")),(0,p.kt)("tr",{parentName:"tbody"},(0,p.kt)("td",{parentName:"tr",align:"left"},(0,p.kt)("a",{parentName:"td",href:"#shrineattachment"},(0,p.kt)("inlineCode",{parentName:"a"},"Shrine::Attachment"))),(0,p.kt)("td",{parentName:"tr",align:"left"},"Provides convenience model attachment interface")))),(0,p.kt)("h2",{id:"storage"},"Storage"),(0,p.kt)("p",null,"On the lowest level we have a storage. A storage class encapsulates file\nmanagement logic on a particular service. It is what actually performs uploads,\ngeneration of URLs, deletions and similar. By convention it is namespaced under\n",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Storage::*"),"."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"filesystem "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Storage"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"FileSystem"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"uploads"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"filesystem.upload(file, "),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"foo"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"filesystem.url("),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"foo"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},") "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "uploads/foo"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"filesystem.delete("),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"foo"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,p.kt)("p",null,"A storage is a PORO which implements the following interface:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"Shrine")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"module"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Storage")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"MyStorage")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#62E884"}},"upload"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"io"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,p.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"id"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"shrine_metadata"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," {}, "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"upload_options)")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"        "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# uploads `io` to the location `id`")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#62E884"}},"open"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"id"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options)")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"        "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# returns the remote file as an IO-like object")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#62E884"}},"exists?"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"id"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"        "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# checks if the file exists on the storage")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#62E884"}},"delete"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"id"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"        "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# deletes the file from the storage")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#62E884"}},"url"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"id"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options)")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"        "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# URL to the remote file, accepts options for customizing the URL")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("p",null,"Storages are typically not used directly, but through ",(0,p.kt)("a",{parentName:"p",href:"#shrine"},(0,p.kt)("inlineCode",{parentName:"a"},"Shrine"))," and\n",(0,p.kt)("a",{parentName:"p",href:"#shrine-uploadedfile"},(0,p.kt)("inlineCode",{parentName:"a"},"Shrine::UploadedFile"))," classes."),(0,p.kt)("h2",{id:"shrine"},(0,p.kt)("inlineCode",{parentName:"h2"},"Shrine")),(0,p.kt)("p",null,"The ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine"),' class (also called an "uploader") primarily provides a wrapper\nmethod around ',(0,p.kt)("inlineCode",{parentName:"p"},"Storage#upload"),". First, the storage needs to be registered under\na name:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".storages["),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":disk"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"] "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Storage"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"FileSystem"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"uploads"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,p.kt)("p",null,"Now we can upload files to the registered storage:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".upload(file, "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":disk"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> #<Shrine::UploadedFile storage=:disk id="6a9fb596cc554efb" ...>'))))),(0,p.kt)("p",null,"The argument to ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine#upload")," must be an IO-like object. The method does the\nfollowing:"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"generates a unique location"),(0,p.kt)("li",{parentName:"ul"},"extracts metadata"),(0,p.kt)("li",{parentName:"ul"},"uploads the file (calls ",(0,p.kt)("inlineCode",{parentName:"li"},"Storage#upload"),")"),(0,p.kt)("li",{parentName:"ul"},"closes the file"),(0,p.kt)("li",{parentName:"ul"},"creates a ",(0,p.kt)("inlineCode",{parentName:"li"},"Shrine::UploadedFile")," from the data")),(0,p.kt)("h3",{id:"plugins"},"Plugins"),(0,p.kt)("p",null,"The ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine")," class is also used for loading plugins, which provide additional\nfunctionality by extending core classes."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":derivatives")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"UploadedFile"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".ancestors "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> [..., Shrine::Plugins::Derivatives::FileMethods, Shrine::UploadedFile::InstanceMethods, ...]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".ancestors     "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> [..., Shrine::Plugins::Derivatives::AttacherMethods, Shrine::Attacher::InstanceMethods,  ...]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".ancestors   "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> [..., Shrine::Plugins::Derivatives::AttachmentMethods, Shrine::Attachment::InstanceMethods, ...]"))))),(0,p.kt)("p",null,"The plugins store their configuration in ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine.opts"),":"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":derivation_endpoint"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", secret_key"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"foo"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":default_storage"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", store"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":other_store")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":activerecord")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".opts "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=>")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'# { derivation_endpoint: { options: { secret_key: "foo" }, derivations: {} },')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#   default_storage: { store: :other_store },")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#   column: { serializer: Shrine::Plugins::Column::JsonSerializer },")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#   model: { cache: true },")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#   activerecord: { callbacks: true, validations: true } }"))))),(0,p.kt)("p",null,"Each ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine")," subclass has its own copy of the core classes, storages and\noptions, which makes it possible to customize attachment logic per uploader."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"UploadedFile"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".superclass "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> Shrine::UploadedFile")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".superclass     "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> Shrine::Attacher")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".superclass   "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> Shrine::Attachment"))))),(0,p.kt)("p",null,"See ",(0,p.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/creating-plugins"},"Creating a New Plugin")," guide and the ",(0,p.kt)("a",{parentName:"p",href:"https://twin.github.io/the-plugin-system-of-sequel-and-roda/"},"Plugin system of Sequel and Roda"),"\narticle for more details on the design of Shrine's plugin system."),(0,p.kt)("h2",{id:"shrineuploadedfile"},(0,p.kt)("inlineCode",{parentName:"h2"},"Shrine::UploadedFile")),(0,p.kt)("p",null,"A ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::UploadedFile")," object represents a file that was uploaded to a\nstorage, containing upload location, storage, and any metadata extracted during\nthe upload."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> #<Shrine::UploadedFile id="949sdjg834.jpg" storage=:store metadata={...}>')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.id          "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "949sdjg834.jpg"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.storage_key "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> :store")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.storage     "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<Shrine::Storage::S3>")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata    "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> {...}"))))),(0,p.kt)("p",null,"It has convenience methods for accessing metadata:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=>")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# {")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "filename" => "matrix.mp4",')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "mime_type" => "video/mp4",')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "size" => 345993,')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# }")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.original_filename "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "matrix.mp4"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.extension         "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "mp4"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.mime_type         "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "video/mp4"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.size              "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> 345993"))))),(0,p.kt)("p",null,"It also has methods that delegate to the storage:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.url                     "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "https://my-bucket.s3.amazonaws.com/949sdjg834.jpg"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file."),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"open"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { |io| ... }       "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# opens the uploaded file stream")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.download { |file| ... } "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# downloads the uploaded file to disk")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.stream(destination)     "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# streams uploaded content into a writable destination")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.exists?                 "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> true")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.delete                  "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# deletes the uploaded file from the storage"))))),(0,p.kt)("p",null,"A ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::UploadedFile")," is itself an IO-like object (built on top of\n",(0,p.kt)("inlineCode",{parentName:"p"},"Storage#open"),"), so it can be passed to ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine#upload")," as well."),(0,p.kt)("h2",{id:"shrineattacher"},(0,p.kt)("inlineCode",{parentName:"h2"},"Shrine::Attacher")),(0,p.kt)("p",null,"We usually want to treat uploaded files as ",(0,p.kt)("em",{parentName:"p"},"attachments")," to records, saving\ntheir data into a database column. This is done by ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Attacher"),", which\ninternally uses ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine")," and ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::UploadedFile")," classes."),(0,p.kt)("p",null,"The attaching process requires a temporary and a permanent storage to be\nregistered (by default that's ",(0,p.kt)("inlineCode",{parentName:"p"},":cache")," and ",(0,p.kt)("inlineCode",{parentName:"p"},":store"),"):"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".storages "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," {")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  cache"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Storage"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"FileSystem"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"uploads/cache"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"),")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  store"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Storage"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"FileSystem"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"uploads/store"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"),")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"}"))))),(0,p.kt)("p",null,"A ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Attacher")," can be initialized standalone and handle the common\nattachment flow, which includes dirty tracking (promoting cached file to\npermanent storage, deleting previously attached file), validation, processing,\nserialization etc."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ... user uploads a file ...")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.assign(io) "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# uploads to temporary storage")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.file       "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<Shrine::UploadedFile storage=:cache ...>")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ... handle file validations ...")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.finalize   "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# uploads to permanent storage")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.file       "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<Shrine::UploadedFile storage=:store ...>"))))),(0,p.kt)("p",null,"It can also be initialized with a model instance to handle serialization into a\nmodel attribute:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".from_model(photo, "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.assign(file)")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image_data "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "{\\"storage\\":\\"cache\\",\\"id\\":\\"9260ea09d8effd.jpg\\",\\"metadata\\":{...}}"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.finalize")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image_data "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "{\\"storage\\":\\"store\\",\\"id\\":\\"ksdf02lr9sf3la.jpg\\",\\"metadata\\":{...}}"'))))),(0,p.kt)("p",null,"For more details, see the ",(0,p.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/attacher"},"Using Attacher")," guide and\n",(0,p.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/entity"},(0,p.kt)("inlineCode",{parentName:"a"},"entity")),"/",(0,p.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/model"},(0,p.kt)("inlineCode",{parentName:"a"},"model"))," plugins."),(0,p.kt)("h2",{id:"shrineattachment"},(0,p.kt)("inlineCode",{parentName:"h2"},"Shrine::Attachment")),(0,p.kt)("p",null,"A ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Attachment")," module provides a convenience model interface around the\n",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Attacher")," object. The ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Attachment")," class is a subclass of\n",(0,p.kt)("inlineCode",{parentName:"p"},"Module"),", which means that an instance of ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Attachment")," is a module:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},").is_a?("),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Module"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},") "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> true")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},").instance_methods "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> [:image=, :image, :image_url, :image_attacher, ...]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# equivalents")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"["),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,p.kt)("p",null,"We can include this module into a model:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Photo"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"include"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Attachment"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," file   "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# shorthand for `photo.image_attacher.assign(file)`")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image          "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# shorthand for `photo.image_attacher.get`")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image_url      "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# shorthand for `photo.image_attacher.url`")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image_attacher "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<Shrine::Attacher @cache_key=:cache @store_key=:store ...>"))))),(0,p.kt)("p",null,"When a persistence plugin is loaded (",(0,p.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/activerecord"},(0,p.kt)("inlineCode",{parentName:"a"},"activerecord")),",\n",(0,p.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/sequel"},(0,p.kt)("inlineCode",{parentName:"a"},"sequel")),"), the ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine::Attachment")," module also automatically:"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},"syncs Shrine's validation errors with the record"),(0,p.kt)("li",{parentName:"ul"},"triggers promoting after record is saved"),(0,p.kt)("li",{parentName:"ul"},"deletes the uploaded file if attachment was replaced or the record destroyed")))}k.isMDXComponent=!0}}]);