"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[8653],{3905:(e,a,t)=>{t.d(a,{Zo:()=>m,kt:()=>N});var n=t(7294);function s(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function p(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?p(Object(t),!0).forEach((function(a){s(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function r(e,a){if(null==e)return{};var t,n,s=function(e,a){if(null==e)return{};var t,n,s={},p=Object.keys(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||(s[t]=e[t]);return s}(e,a);if(Object.getOwnPropertySymbols){var p=Object.getOwnPropertySymbols(e);for(n=0;n<p.length;n++)t=p[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var o=n.createContext({}),i=function(e){var a=n.useContext(o),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},m=function(e){var a=i(e.components);return n.createElement(o.Provider,{value:a},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},F=n.forwardRef((function(e,a){var t=e.components,s=e.mdxType,p=e.originalType,o=e.parentName,m=r(e,["components","mdxType","originalType","parentName"]),c=i(t),F=s,N=c["".concat(o,".").concat(F)]||c[F]||d[F]||p;return t?n.createElement(N,l(l({ref:a},m),{},{components:t})):n.createElement(N,l({ref:a},m))}));function N(e,a){var t=arguments,s=a&&a.mdxType;if("string"==typeof e||s){var p=t.length,l=new Array(p);l[0]=F;var r={};for(var o in a)hasOwnProperty.call(a,o)&&(r[o]=a[o]);r.originalType=e,r[c]="string"==typeof e?e:s,l[1]=r;for(var i=2;i<p;i++)l[i]=t[i];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}F.displayName="MDXCreateElement"},4270:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>m,contentTitle:()=>o,default:()=>N,frontMatter:()=>r,metadata:()=>i,toc:()=>c});var n=t(7462),s=t(3366),p=(t(7294),t(3905)),l=["components"],r={id:"securing-uploads",title:"Securing Uploads"},o=void 0,i={unversionedId:"securing-uploads",id:"securing-uploads",title:"Securing Uploads",description:"Shrine does a lot to make your file uploads secure, but there are still a lot",source:"@site/../doc/securing_uploads.md",sourceDirName:".",slug:"/securing-uploads",permalink:"/docs/securing-uploads",draft:!1,editUrl:"https://github.com/shrinerb/shrine/edit/master/doc/../doc/securing_uploads.md",tags:[],version:"current",lastUpdatedBy:"y-yagi",lastUpdatedAt:1576678853,formattedLastUpdatedAt:"Dec 18, 2019",frontMatter:{id:"securing-uploads",title:"Securing Uploads"},sidebar:"guides",previous:{title:"Multiple Files",permalink:"/docs/multiple-files"},next:{title:"Testing with Shrine",permalink:"/docs/testing"}},m={},c=[{value:"Validate file type",id:"validate-file-type",level:2},{value:"Limit filesize",id:"limit-filesize",level:2},{value:"Limiting filesize in direct uploads",id:"limiting-filesize-in-direct-uploads",level:3},{value:"Limiting filesize at application level",id:"limiting-filesize-at-application-level",level:3},{value:"Failsafe filesize limiting",id:"failsafe-filesize-limiting",level:3},{value:"Limit image dimensions",id:"limit-image-dimensions",level:2},{value:"Prevent metadata tampering",id:"prevent-metadata-tampering",level:2},{value:"Limit number of files",id:"limit-number-of-files",level:2},{value:"References",id:"references",level:2}],d={toc:c},F="wrapper";function N(e){var a=e.components,t=(0,s.Z)(e,l);return(0,p.kt)(F,(0,n.Z)({},d,t,{components:a,mdxType:"MDXLayout"}),(0,p.kt)("p",null,"Shrine does a lot to make your file uploads secure, but there are still a lot\nof security measures that could be added by the user on the application's side.\nThis guide will try to cover some well-known security issues, ranging from the\nobvious ones to not-so-obvious ones, and try to provide solutions."),(0,p.kt)("h2",{id:"validate-file-type"},"Validate file type"),(0,p.kt)("p",null,"Almost always you will be accepting certain types of files, and it's a good\nidea to create a whitelist (or a blacklist) of extensions and MIME types."),(0,p.kt)("p",null,"By default Shrine stores the MIME type derived from the extension, which means\nit's not guaranteed to hold the actual MIME type of the the file. However, you\ncan load the ",(0,p.kt)("inlineCode",{parentName:"p"},"determine_mime_type")," plugin to determine MIME type from magic\nfile headers."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Gemfile")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"gem "),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"marcel"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"~> 0.3"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'))))),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":determine_mime_type"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", analyzer"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":marcel")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":validation_helpers")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".validate "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    validate_extension "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"%"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"w[jpg jpeg png webp]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    validate_mime_type "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"%"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"w[image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"/"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"jpeg image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"/"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"png image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"/"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"webp]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("h2",{id:"limit-filesize"},"Limit filesize"),(0,p.kt)("p",null,"It's a good idea to generally limit the filesize of uploaded files, so that\nattackers cannot easily flood your storage. There are various layers at which\nyou can apply filesize limits, depending on how you're accepting uploads. For\nstarters you can add a filesize validation to prevent large files from being\nuploaded to ",(0,p.kt)("inlineCode",{parentName:"p"},":store"),":"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":validation_helpers")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".validate "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    validate_max_size "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"100"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# 100 MB")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("p",null,"In the following sections we talk about various strategies to prevent files\nfrom being uploaded to Shrine's temporary storage and the system's temporary\ndirectory."),(0,p.kt)("h3",{id:"limiting-filesize-in-direct-uploads"},"Limiting filesize in direct uploads"),(0,p.kt)("p",null,"If you're doing direct uploads with the ",(0,p.kt)("inlineCode",{parentName:"p"},"upload_endpoint")," plugin, you can pass\nin the ",(0,p.kt)("inlineCode",{parentName:"p"},":max_size")," option to reject files that are larger than the specified\nlimit:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", max_size"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"100"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# 100 MB"))))),(0,p.kt)("p",null,"If you're doing direct uploads to Amazon S3 using the ",(0,p.kt)("inlineCode",{parentName:"p"},"presign_endpoint"),"\nplugin, you can pass in the ",(0,p.kt)("inlineCode",{parentName:"p"},":content_length_range")," presign option:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":presign_endpoint"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", presign_options"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," (request) "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  { content_length_range"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"0"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".."),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"100"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," }")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("h3",{id:"limiting-filesize-at-application-level"},"Limiting filesize at application level"),(0,p.kt)("p",null,"If your application is accepting file uploads, it's good practice to limit the\nmaximum allowed ",(0,p.kt)("inlineCode",{parentName:"p"},"Content-Length")," before calling ",(0,p.kt)("inlineCode",{parentName:"p"},"params")," for the first time,\nto avoid Rack parsing the multipart request parameters and creating a Tempfile\nfor uploads that are obviously attempts of attacks."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"if"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," request.content_length "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},">="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"100"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# 100MB")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  response.status "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"413"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Request Entity Too Large")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  response.body "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"The uploaded file was too large (maximum is 100MB)"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  request.halt")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"request.params "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Rack parses the multipart request params"))))),(0,p.kt)("p",null,"Alternatively you can allow uploads of any size to temporary Shrine storage,\nbut tell Shrine to immediately delete the file if it failed validations by\nloading the ",(0,p.kt)("inlineCode",{parentName:"p"},"remove_invalid")," plugin."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":remove_invalid"))))),(0,p.kt)("h3",{id:"failsafe-filesize-limiting"},"Failsafe filesize limiting"),(0,p.kt)("p",null,"If you want to make sure that no large files ever get to your storages, and you\ndon't really care about the error message, you can override ",(0,p.kt)("inlineCode",{parentName:"p"},"Shrine#upload"),":"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#62E884"}},"upload"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,p.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"io"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options)")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"fail"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"FileTooLarge"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"if"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," io.size "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},">="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"100"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"super")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("h2",{id:"limit-image-dimensions"},"Limit image dimensions"),(0,p.kt)("p",null,"It's possible to create so-called ",(0,p.kt)("a",{parentName:"p",href:"https://www.bamsoftware.com/hacks/deflate.html"},"image bombs"),", which are images that have a\nsmall filesize but very large dimensions. These are dangerous if you're doing\nimage processing, since processing them can take a lot of time and memory. This\nmakes it trivial to DoS the application which doesn't have any protection\nagainst them."),(0,p.kt)("p",null,"So, in addition to validating filesize, we should also validate image\ndimensions:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Gemfile")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"gem "),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,p.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"fastimage"),(0,p.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'))))),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"ImageUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":store_dimensions")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":validation_helpers")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".validate "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    validate_max_size "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"100"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"if"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," validate_mime_type "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"%"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"w[image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"/"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"jpeg image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"/"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"png image"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"/"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"webp]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      validate_max_dimensions ["),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"5000"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"5000"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("p",null,"If you want to be extra safe, you can add a failsafe before performing\nprocessing:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"ImageUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ...")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".derivatives "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," |original|")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    width, height "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".dimensions(original)")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"fail"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"ImageBombError"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"if"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," width "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},">"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"5000"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"||"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," height "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},">"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"5000")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ...")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("h2",{id:"prevent-metadata-tampering"},"Prevent metadata tampering"),(0,p.kt)("p",null,"When cached file is retained on validation errors or it was direct uploaded,\nthe uploaded file representation is assigned to the attacher. This also\nincludes any file metadata. By default Shrine won't attempt to re-extract\nmetadata, because for remote storages that requires an additional HTTP request,\nwhich might not be feasible depending on the application requirements."),(0,p.kt)("p",null,"However, this means that the attacker can directly upload a malicious file\n(because direct uploads aren't validated), and then modify the metadata hash so\nthat it passes Shrine validations, before submitting the cached file to your\napp. To guard yourself from such attacks, you can load the\n",(0,p.kt)("inlineCode",{parentName:"p"},"restore_cached_data")," plugin, which will automatically re-extract metadata from\ncached files on assignment and override the received metadata."),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":restore_cached_data"))))),(0,p.kt)("h2",{id:"limit-number-of-files"},"Limit number of files"),(0,p.kt)("p",null,"When doing direct uploads, it's a good idea to apply some kind of throttling to\nthe endpoint, to ensure the attacker cannot upload an unlimited number files,\nbecause even with a filesize limit it would allow flooding the storage. A good\nlibrary for throttling requests is ",(0,p.kt)("a",{parentName:"p",href:"https://github.com/kickstarter/rack-attack"},"rack-attack"),"."),(0,p.kt)("p",null,"Also, it's generally a good idea to limit the ",(0,p.kt)("em",{parentName:"p"},"minimum")," filesize as well as\nmaximum, to prevent uploading large amounts of small files:"),(0,p.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,p.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,p.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"MyUploader"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":validation_helpers")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"}),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".validate "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    validate_min_size "),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"10"),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,p.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# 10 KB")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,p.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ...")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,p.kt)("span",{parentName:"code",className:"line"},(0,p.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,p.kt)("h2",{id:"references"},"References"),(0,p.kt)("ul",null,(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("a",{parentName:"li",href:"https://nvisium.com/blog/2015/10/13/secure-file-uploads/"},"Nvisium: Secure File Uploads")),(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("a",{parentName:"li",href:"https://www.owasp.org/index.php/Unrestricted_File_Upload"},"OWASP: Unrestricted File Upload")),(0,p.kt)("li",{parentName:"ul"},(0,p.kt)("a",{parentName:"li",href:"https://software-security.sans.org/blog/2009/12/28/8-basic-rules-to-implement-secure-file-uploads/"},"AppSec: 8 Basic Rules to Implement Secure File Uploads"))))}N.isMDXComponent=!0}}]);