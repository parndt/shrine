"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[6087],{3905:(a,e,t)=>{t.d(e,{Zo:()=>m,kt:()=>N});var n=t(7294);function p(a,e,t){return e in a?Object.defineProperty(a,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):a[e]=t,a}function s(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(a);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),t.push.apply(t,n)}return t}function l(a){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?s(Object(t),!0).forEach((function(e){p(a,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(t,e))}))}return a}function o(a,e){if(null==a)return{};var t,n,p=function(a,e){if(null==a)return{};var t,n,p={},s=Object.keys(a);for(n=0;n<s.length;n++)t=s[n],e.indexOf(t)>=0||(p[t]=a[t]);return p}(a,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(a);for(n=0;n<s.length;n++)t=s[n],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(a,t)&&(p[t]=a[t])}return p}var r=n.createContext({}),c=function(a){var e=n.useContext(r),t=e;return a&&(t="function"==typeof a?a(e):l(l({},e),a)),t},m=function(a){var e=c(a.components);return n.createElement(r.Provider,{value:e},a.children)},i="mdxType",d={inlineCode:"code",wrapper:function(a){var e=a.children;return n.createElement(n.Fragment,{},e)}},F=n.forwardRef((function(a,e){var t=a.components,p=a.mdxType,s=a.originalType,r=a.parentName,m=o(a,["components","mdxType","originalType","parentName"]),i=c(t),F=p,N=i["".concat(r,".").concat(F)]||i[F]||d[F]||s;return t?n.createElement(N,l(l({ref:e},m),{},{components:t})):n.createElement(N,l({ref:e},m))}));function N(a,e){var t=arguments,p=e&&e.mdxType;if("string"==typeof a||p){var s=t.length,l=new Array(s);l[0]=F;var o={};for(var r in e)hasOwnProperty.call(e,r)&&(o[r]=e[r]);o.originalType=a,o[i]="string"==typeof a?a:p,l[1]=o;for(var c=2;c<s;c++)l[c]=t[c];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}F.displayName="MDXCreateElement"},5706:(a,e,t)=>{t.r(e),t.d(e,{assets:()=>m,contentTitle:()=>r,default:()=>N,frontMatter:()=>o,metadata:()=>c,toc:()=>i});var n=t(7462),p=t(3366),s=(t(7294),t(3905)),l=["components"],o={title:"Upload Endpoint"},r=void 0,c={unversionedId:"plugins/upload_endpoint",id:"plugins/upload_endpoint",title:"Upload Endpoint",description:"The uploadendpoint plugin provides a Rack endpoint which",source:"@site/../doc/plugins/upload_endpoint.md",sourceDirName:"plugins",slug:"/plugins/upload_endpoint",permalink:"/docs/plugins/upload_endpoint",draft:!1,editUrl:"https://github.com/shrinerb/shrine/edit/master/doc/../doc/plugins/upload_endpoint.md",tags:[],version:"current",lastUpdatedBy:"Janko Marohni\u0107",lastUpdatedAt:1578769044,formattedLastUpdatedAt:"Jan 11, 2020",frontMatter:{title:"Upload Endpoint"},sidebar:"plugins",previous:{title:"Presign Endpoint",permalink:"/docs/plugins/presign_endpoint"},next:{title:"Derivation Endpoint",permalink:"/docs/plugins/derivation_endpoint"}},m={},i=[{value:"Setup",id:"setup",level:2},{value:"Calling from a controller",id:"calling-from-a-controller",level:2},{value:"Limiting filesize",id:"limiting-filesize",level:2},{value:"Uploader options",id:"uploader-options",level:2},{value:"Upload",id:"upload",level:2},{value:"URL",id:"url",level:2},{value:"Response",id:"response",level:2},{value:"Ad-hoc options",id:"ad-hoc-options",level:2},{value:"Checksum",id:"checksum",level:2}],d={toc:i},F="wrapper";function N(a){var e=a.components,t=(0,p.Z)(a,l);return(0,s.kt)(F,(0,n.Z)({},d,t,{components:e,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"The ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/shrinerb/shrine/blob/master/lib/shrine/plugins/upload_endpoint.rb"},(0,s.kt)("inlineCode",{parentName:"a"},"upload_endpoint"))," plugin provides a Rack endpoint which\naccepts file uploads and forwards them to specified storage. On the client side\nit's recommended to use ",(0,s.kt)("a",{parentName:"p",href:"https://uppy.io"},"Uppy")," for asynchronous uploads."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"))))),(0,s.kt)("h2",{id:"setup"},"Setup"),(0,s.kt)("p",null,"The plugin adds a ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine.upload_endpoint")," method which, given a storage\nidentifier, returns a Rack application that accepts multipart POST requests,\nand uploads received files to the specified storage. You can run this Rack\napplication inside your app:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# config/routes.rb (Rails)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Rails"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".application.routes.draw "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ...")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  mount "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"ImageUploader"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".upload_endpoint("),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},") "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"/images/upload"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("p",null,"Asynchronous upload is typically meant to replace the caching phase in the\ndefault synchronous workflow, so we want the uploads to go to temporary\n(",(0,s.kt)("inlineCode",{parentName:"p"},":cache"),") storage."),(0,s.kt)("p",null,"The above will create a ",(0,s.kt)("inlineCode",{parentName:"p"},"POST /images/upload")," endpoint, which uploads the file\nreceived in the ",(0,s.kt)("inlineCode",{parentName:"p"},"file")," param using ",(0,s.kt)("inlineCode",{parentName:"p"},"ImageUploader"),", and returns a JSON\nrepresentation of the uploaded file."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# POST /images/upload")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"{")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"id"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"43kewit94.jpg"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},",")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"storage"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},",")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"metadata"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"size"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"384393"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},",")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"filename"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"nature.jpg"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},",")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"mime_type"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"image/jpeg"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"}"))))),(0,s.kt)("p",null,"This JSON string can now be assigned to an attachment attribute instead of a\nraw file. In a form it can be written to a hidden attachment field, and then it\ncan be assigned as the attachment."),(0,s.kt)("h2",{id:"calling-from-a-controller"},"Calling from a controller"),(0,s.kt)("p",null,"If you want to run additional code around the upload (such as authentication),\nmounting the upload endpoint in your router might be limiting. You can instead\ncreate a custom controller action and handle upload requests there using\n",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine.upload_response"),":"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# config/routes.rb (Rails)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Rails"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".application.routes.draw "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ...")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  post "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"/images/upload"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", to"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"uploads#image"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# app/controllers/uploads_controller.rb (Rails)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"UploadsController"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"ApplicationController")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#62E884"}},"image")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ... we can perform authentication here ...")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    set_rack_response "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"ImageUploader"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".upload_response("),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", request.env)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"private")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#62E884"}},"set_rack_response"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"(("),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"status"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"headers"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"body"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"))")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE",fontStyle:"italic"}},"self"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".status "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," status")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE",fontStyle:"italic"}},"self"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".headers.merge!(headers)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE",fontStyle:"italic"}},"self"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".response_body "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," body")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("h2",{id:"limiting-filesize"},"Limiting filesize"),(0,s.kt)("p",null,"It's good practice to limit the accepted filesize of uploaded files. You can do\nthat with the ",(0,s.kt)("inlineCode",{parentName:"p"},":max_size")," option:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", max_size"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"20"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# 20 MB"))))),(0,s.kt)("p",null,"If the uploaded file is larger than the specified value, a ",(0,s.kt)("inlineCode",{parentName:"p"},"413 Payload Too\nLarge")," response will be returned."),(0,s.kt)("h2",{id:"uploader-options"},"Uploader options"),(0,s.kt)("p",null,"You can pass additional uploader options via ",(0,s.kt)("inlineCode",{parentName:"p"},":upload_context"),":"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", upload_context"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," (request) "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  { location"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"my-location"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("p",null,"Note that the uploader will ",(0,s.kt)("em",{parentName:"p"},"not")," receive ",(0,s.kt)("inlineCode",{parentName:"p"},":record")," and ",(0,s.kt)("inlineCode",{parentName:"p"},":name")," values, as the\nupload happens independently of a database record."),(0,s.kt)("h2",{id:"upload"},"Upload"),(0,s.kt)("p",null,"You can also customize the upload itself via the ",(0,s.kt)("inlineCode",{parentName:"p"},":upload")," option:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", upload"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," (io, options, request) "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".upload(io, "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("h2",{id:"url"},"URL"),(0,s.kt)("p",null,"You can have the endpoint include the uploaded file URL in the response body\nby specifying the ",(0,s.kt)("inlineCode",{parentName:"p"},":url")," option:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", url"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"true")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# or")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", url"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { public"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"true"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# or")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", url"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," (uploaded_file, request) {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  uploaded_file.url("),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"}"))))),(0,s.kt)("p",null,"In this case the response body will be:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"{")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"data"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"id"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"..."),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"storage"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"..."),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"metadata"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": {...} },")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"url"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},": "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"https://example.com/path/to/file"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"}"))))),(0,s.kt)("h2",{id:"response"},"Response"),(0,s.kt)("p",null,"The response returned by the endpoint can be customized via the\n",(0,s.kt)("inlineCode",{parentName:"p"},":rack_response")," option:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":upload_endpoint"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", rack_response"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," (uploaded_file, request) "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  body "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { data"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploaded_file.data, url"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploaded_file.url }.to_json")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  ["),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"201"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"Content-Type"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"application/json"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," }, [body]]")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("h2",{id:"ad-hoc-options"},"Ad-hoc options"),(0,s.kt)("p",null,"You can override any of the options above when creating the endpoint/response:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".upload_endpoint("),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", max_size"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"20"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# or")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".upload_response("),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", request.env, max_size"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"20"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"*"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"1024"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,s.kt)("h2",{id:"checksum"},"Checksum"),(0,s.kt)("p",null,"If you want the upload endpoint to verify the integrity of the uploaded file,\nyou can include the ",(0,s.kt)("inlineCode",{parentName:"p"},"Content-MD5")," header in the request filled with the\nbase64-encoded MD5 hash of the file that was calculated prior to the upload,\nand the endpoint will automatically use it to verify the uploaded data."),(0,s.kt)("p",null,"If the checksums don't match, a ",(0,s.kt)("inlineCode",{parentName:"p"},"460 Checksum Mismatch")," response is returned."))}N.isMDXComponent=!0}}]);