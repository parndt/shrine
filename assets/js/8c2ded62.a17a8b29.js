"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2391],{3905:(e,a,t)=>{t.d(a,{Zo:()=>m,kt:()=>N});var n=t(7294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function s(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function p(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?s(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=n.createContext({}),c=function(e){var a=n.useContext(l),t=a;return e&&(t="function"==typeof e?e(a):p(p({},a),e)),t},m=function(e){var a=c(e.components);return n.createElement(l.Provider,{value:a},e.children)},i="mdxType",d={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},k=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),i=c(t),k=r,N=i["".concat(l,".").concat(k)]||i[k]||d[k]||s;return t?n.createElement(N,p(p({ref:a},m),{},{components:t})):n.createElement(N,p({ref:a},m))}));function N(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var s=t.length,p=new Array(s);p[0]=k;var o={};for(var l in a)hasOwnProperty.call(a,l)&&(o[l]=a[l]);o.originalType=e,o[i]="string"==typeof e?e:r,p[1]=o;for(var c=2;c<s;c++)p[c]=t[c];return n.createElement.apply(null,p)}return n.createElement.apply(null,t)}k.displayName="MDXCreateElement"},600:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>m,contentTitle:()=>l,default:()=>N,frontMatter:()=>o,metadata:()=>c,toc:()=>i});var n=t(7462),r=t(3366),s=(t(7294),t(3905)),p=["components"],o={title:"Atomic Helpers"},l=void 0,c={unversionedId:"plugins/atomic_helpers",id:"plugins/atomic_helpers",title:"Atomic Helpers",description:"The atomichelpers plugin provides API for retrieving and",source:"@site/../doc/plugins/atomic_helpers.md",sourceDirName:"plugins",slug:"/plugins/atomic_helpers",permalink:"/docs/plugins/atomic_helpers",draft:!1,editUrl:"https://github.com/shrinerb/shrine/edit/master/doc/../doc/plugins/atomic_helpers.md",tags:[],version:"current",lastUpdatedBy:"Jonathan Rochkind",lastUpdatedAt:1590340841,formattedLastUpdatedAt:"May 24, 2020",frontMatter:{title:"Atomic Helpers"},sidebar:"plugins",previous:{title:"URL Options",permalink:"/docs/plugins/url_options"},next:{title:"Included",permalink:"/docs/plugins/included"}},m={},i=[{value:"Problem Statement",id:"problem-statement",level:2},{value:"High-level ORM helpers",id:"high-level-orm-helpers",level:2},{value:"Retrieving",id:"retrieving",level:2},{value:"File data",id:"file-data",level:3},{value:"Promoting",id:"promoting",level:2},{value:"Persisting",id:"persisting",level:2}],d={toc:i},k="wrapper";function N(e){var a=e.components,t=(0,r.Z)(e,p);return(0,s.kt)(k,(0,n.Z)({},d,t,{components:a,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"The ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/shrinerb/shrine/blob/master/lib/shrine/plugins/atomic_helpers.rb"},(0,s.kt)("inlineCode",{parentName:"a"},"atomic_helpers"))," plugin provides API for retrieving and\npersisting attachments in a concurrency-safe way, which is especially useful\nwhen using the ",(0,s.kt)("inlineCode",{parentName:"p"},"backgrounding")," plugin. The database plugins (",(0,s.kt)("inlineCode",{parentName:"p"},"activerecord"),"\nand ",(0,s.kt)("inlineCode",{parentName:"p"},"sequel"),") implement atomic promotion and atomic persistence on top of this\nplugin."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":atomic_helpers"))))),(0,s.kt)("h2",{id:"problem-statement"},"Problem Statement"),(0,s.kt)("p",null,'What happens if two different processors (web workers, background jobs,\ncommand-line executions, whatever) try to edit a shrine attachment\nconcurrently? The kinds of edits typically made include: "promoting a file",\nmoving it to a different storage and persisting that change in the model;\nadding or changing a derivative; adding or changing a metadata element.'),(0,s.kt)("p",null,'There are two main categories of "race condition":'),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"The file could be switched out from under you. If you were promoting a file,\nbut some other process has ",(0,s.kt)("em",{parentName:"p"},"changed")," the attachment, you don't want to\noverwrite it with the promomoted version of the ",(0,s.kt)("em",{parentName:"p"},"prior")," attacchment. Likewise,\nif you were adding metadata or a derivative, they would be corresponding to a\ncertain attachment, and you don't want to accidentally add them to a now changed\nattacchment for which they are inappropriate.")),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("p",{parentName:"li"},"Overwriting each other's edits. Since all shrine (meta)data is stored in a\nsingle JSON hash, standard implementations will write the entire JSON hash at\nonce to a rdbms column or other store. If two processes both read in the hash,\nmake a change to different keys in it, and then write it back out, the second\nprocess to write will 'win' and overwrite changes made by the first."))),(0,s.kt)("p",null,"The atomic helpers give you tools to avoid both of these sorts of race\nconditions, under conditions of concurrent editing."),(0,s.kt)("h2",{id:"high-level-orm-helpers"},"High-level ORM helpers"),(0,s.kt)("p",null,"If you are using the ",(0,s.kt)("inlineCode",{parentName:"p"},"sequel")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"activerecord")," plugins, they give you two\nhigher-level helpers: ",(0,s.kt)("inlineCode",{parentName:"p"},"atomic_persist")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"atomic_promote"),". See the\n",(0,s.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/persistence"},"persistence"),"  documentation for more."),(0,s.kt)("h2",{id:"retrieving"},"Retrieving"),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher.retrieve")," method provided by the plugin instantiates an attacher\nfrom a record instance, attachment name and attachment data, asserting that the\ngiven attachment data matches the attached file on the record."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# with a model instance")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".retrieve(")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  model"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," photo,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},",")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"id"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"abc123"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"storage"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," },")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<Shrine::Attacher ...>")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# with an entity instance")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".retrieve(")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  entity"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," photo,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"   "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},",")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"   { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"id"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"abc123"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"storage"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"cache"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," },")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<Shrine::Attacher ...>"))))),(0,s.kt)("p",null,"If the record has ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::Attachment")," included, the ",(0,s.kt)("inlineCode",{parentName:"p"},"#<name>_attacher")," method\nwill be called on the record, which will return the correct attacher class."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"Photo")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"include"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"ImageUploader"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Attachment"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".retrieve(model"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," photo, name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { ... })")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<ImageUploader::Attacher ...>"))))),(0,s.kt)("p",null,"Otherwise it will call ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher.from_model"),"/",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher.from_entity")," from the\n",(0,s.kt)("inlineCode",{parentName:"p"},"model"),"/",(0,s.kt)("inlineCode",{parentName:"p"},"entity")," plugin, in which case you need to make sure to call\n",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher.retrieve")," on the appropriate attacher class."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"ImageUploader"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".retrieve(entity"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," photo, name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { ... })")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> #<ImageUploader::Attacher ...>"))))),(0,s.kt)("p",null,"If the attached file on the record doesn't match the provided attachment data,\na ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::AttachmentChanged")," exception is raised. Note that metadata is\nallowed to differ, Shrine will only compare location and storage of the file."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image_data "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> \'{"id":"foo","storage":"store","metadata":{...}}\'')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".retrieve(")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  model"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," photo,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":image"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},",")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"id"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"bar"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"storage"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"store"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," },")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ~> Shrine::AttachmentChanged: attachment has changed"))))),(0,s.kt)("h3",{id:"file-data"},"File data"),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#file_data")," method can be used for sending the attached file data\ninto a background job. It returns only location and storage of the attached\nfile, leaving out any metadata or derivatives data that ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#data")," would\nreturn. This way the background job payload is kept light."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.file_data "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> { "id" => "abc123", "storage" => "store" }'))))),(0,s.kt)("p",null,"This value can then be passed as the ",(0,s.kt)("inlineCode",{parentName:"p"},":file")," argument to\n",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::Attacher.retrieve"),"."),(0,s.kt)("h2",{id:"promoting"},"Promoting"),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#abstract_atomic_promote")," method provided by the plugin promotes\nthe cached file to permanent storage, reloads the record to check whether the\nattachment hasn't changed, and if not persists the promoted file."),(0,s.kt)("p",null,"Internally it calls ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#abstract_atomic_persist")," to do the persistence,\nforwarding ",(0,s.kt)("inlineCode",{parentName:"p"},":reload")," and ",(0,s.kt)("inlineCode",{parentName:"p"},":persist")," options as well as a given block to it (see\nthe next section for more details)."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# in the controller")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.attach_cached(io)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.cached? "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> true"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# in a background job")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.abstract_atomic_promote(reload"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," ("),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"&"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"block) { ... }, persist"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { ... })")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.stored? "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> true"))))),(0,s.kt)("p",null,"If the attachment has changed during promotion, the promoted file is deleted and\na ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::AttachmentChanged")," exception is raised."),(0,s.kt)("p",null,"If you want to execute some code after the attachment change check but before\npersistence, you can pass a block:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.abstract_atomic_promote("),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options) "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," |reloaded_attacher|")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# this will be executed before persistence")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("p",null,"Any additional options to ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#abstract_atomic_promote")," are forwarded to\n",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#promote"),"."),(0,s.kt)("h2",{id:"persisting"},"Persisting"),(0,s.kt)("p",null,"The ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#abstract_atomic_persist")," method reloads the record to check\nwhether the attachment hasn't changed, and if not persists the attachment."),(0,s.kt)("p",null,"It requires reloader and persister to be passed in, as they will be specific to\nthe database library you're using. The reloader needs to call the given block\nwith the reloaded record, while the persister needs to persist the promoted\nfile."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.abstract_atomic_persist(")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  reload"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," ("),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"&"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"block) { ... }, "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# call the block with reloaded record")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  persist"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { ... },          "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# persist promoted file")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,s.kt)("p",null,"To illustrate, this is how the ",(0,s.kt)("inlineCode",{parentName:"p"},"Attacher#atomic_promote")," method provided by the\n",(0,s.kt)("inlineCode",{parentName:"p"},"sequel")," plugin is implemented:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.abstract_atomic_persist(")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  reload"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," ("),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"&"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"block) {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.record.db.transaction "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      block.call attacher.record.dup.lock! "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# the DB lock ensures no changes")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  },")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  persist"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"->"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.record.save_changes(validate"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"false"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,s.kt)("p",null,"By default, the file currently set on the attacher will be considered the\noriginal file, and will be compared to the reloaded record. You can specify a\ndifferent original file:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"original_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," attacher.file")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.set(new_file)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.abstract_atomic_persist(original_file, "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options)"))))),(0,s.kt)("p",null,"If you want to execute some code after the attachment change check but before\npersistence, you can pass a block:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.abstract_atomic_persist("),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options) "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," |reloaded_attacher|")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# this will be executed before persistence")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))))}N.isMDXComponent=!0}}]);