"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2330],{3905:(a,e,t)=>{t.d(e,{Zo:()=>c,kt:()=>F});var n=t(7294);function p(a,e,t){return e in a?Object.defineProperty(a,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):a[e]=t,a}function s(a,e){var t=Object.keys(a);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(a);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(a,e).enumerable}))),t.push.apply(t,n)}return t}function r(a){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?s(Object(t),!0).forEach((function(e){p(a,e,t[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(e){Object.defineProperty(a,e,Object.getOwnPropertyDescriptor(t,e))}))}return a}function l(a,e){if(null==a)return{};var t,n,p=function(a,e){if(null==a)return{};var t,n,p={},s=Object.keys(a);for(n=0;n<s.length;n++)t=s[n],e.indexOf(t)>=0||(p[t]=a[t]);return p}(a,e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(a);for(n=0;n<s.length;n++)t=s[n],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(a,t)&&(p[t]=a[t])}return p}var o=n.createContext({}),m=function(a){var e=n.useContext(o),t=e;return a&&(t="function"==typeof a?a(e):r(r({},e),a)),t},c=function(a){var e=m(a.components);return n.createElement(o.Provider,{value:e},a.children)},i="mdxType",d={inlineCode:"code",wrapper:function(a){var e=a.children;return n.createElement(n.Fragment,{},e)}},N=n.forwardRef((function(a,e){var t=a.components,p=a.mdxType,s=a.originalType,o=a.parentName,c=l(a,["components","mdxType","originalType","parentName"]),i=m(t),N=p,F=i["".concat(o,".").concat(N)]||i[N]||d[N]||s;return t?n.createElement(F,r(r({ref:e},c),{},{components:t})):n.createElement(F,r({ref:e},c))}));function F(a,e){var t=arguments,p=e&&e.mdxType;if("string"==typeof a||p){var s=t.length,r=new Array(s);r[0]=N;var l={};for(var o in e)hasOwnProperty.call(e,o)&&(l[o]=e[o]);l.originalType=a,l[i]="string"==typeof a?a:p,r[1]=l;for(var m=2;m<s;m++)r[m]=t[m];return n.createElement.apply(null,r)}return n.createElement.apply(null,t)}N.displayName="MDXCreateElement"},1043:(a,e,t)=>{t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>F,frontMatter:()=>l,metadata:()=>m,toc:()=>i});var n=t(7462),p=t(3366),s=(t(7294),t(3905)),r=["components"],l={title:"Extracting Metadata"},o=void 0,m={unversionedId:"metadata",id:"metadata",title:"Extracting Metadata",description:"Before a file is uploaded, Shrine automatically extracts metadata from it, and",source:"@site/../doc/metadata.md",sourceDirName:".",slug:"/metadata",permalink:"/docs/metadata",draft:!1,editUrl:"https://github.com/shrinerb/shrine/edit/master/doc/../doc/metadata.md",tags:[],version:"current",lastUpdatedBy:"NILID",lastUpdatedAt:1622112992,formattedLastUpdatedAt:"May 27, 2021",frontMatter:{title:"Extracting Metadata"},sidebar:"guides",previous:{title:"Direct Uploads to S3",permalink:"/docs/direct-s3"},next:{title:"File Processing",permalink:"/docs/processing"}},c={},i=[{value:"Accessing metadata",id:"accessing-metadata",level:2},{value:"Controlling extraction",id:"controlling-extraction",level:2},{value:"MIME type",id:"mime-type",level:2},{value:"Image Dimensions",id:"image-dimensions",level:2},{value:"Custom metadata",id:"custom-metadata",level:2},{value:"Adding metadata",id:"adding-metadata",level:3},{value:"Metadata columns",id:"metadata-columns",level:2},{value:"Direct uploads",id:"direct-uploads",level:2},{value:"Extracting on attachment",id:"extracting-on-attachment",level:3},{value:"Extracting in the background",id:"extracting-in-the-background",level:3},{value:"A) Extracting with promotion",id:"a-extracting-with-promotion",level:4},{value:"B) Extracting separately from promotion",id:"b-extracting-separately-from-promotion",level:4},{value:"Combining foreground and background",id:"combining-foreground-and-background",level:3},{value:"Optimizations",id:"optimizations",level:3}],d={toc:i},N="wrapper";function F(a){var e=a.components,t=(0,p.Z)(a,r);return(0,s.kt)(N,(0,n.Z)({},d,t,{components:e,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"Before a file is uploaded, Shrine automatically extracts metadata from it, and\nstores them in the ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::UploadedFile")," object."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload(file)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=>")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "size" => 345993,')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "filename" => "matrix.mp4",')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "mime_type" => "video/mp4",')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# }"))))),(0,s.kt)("p",null,"Under the hood, ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine#upload")," calls ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine#extract_metadata"),", which you can\nalso use directly to extract metadata from any IO object:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploader.extract_metadata(io) "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=>")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "size" => 345993,')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "filename" => "matrix.mp4",')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "mime_type" => "video/mp4",')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# }"))))),(0,s.kt)("p",null,"The following metadata is extracted by default:"),(0,s.kt)("table",null,(0,s.kt)("thead",{parentName:"table"},(0,s.kt)("tr",{parentName:"thead"},(0,s.kt)("th",{parentName:"tr",align:"left"},"Key"),(0,s.kt)("th",{parentName:"tr",align:"left"},"Default source"))),(0,s.kt)("tbody",{parentName:"table"},(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:"left"},(0,s.kt)("inlineCode",{parentName:"td"},"filename")),(0,s.kt)("td",{parentName:"tr",align:"left"},"extracted from ",(0,s.kt)("inlineCode",{parentName:"td"},"io.original_filename")," or ",(0,s.kt)("inlineCode",{parentName:"td"},"io.path"))),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:"left"},(0,s.kt)("inlineCode",{parentName:"td"},"mime_type")),(0,s.kt)("td",{parentName:"tr",align:"left"},"extracted from ",(0,s.kt)("inlineCode",{parentName:"td"},"io.content_type"))),(0,s.kt)("tr",{parentName:"tbody"},(0,s.kt)("td",{parentName:"tr",align:"left"},(0,s.kt)("inlineCode",{parentName:"td"},"size")),(0,s.kt)("td",{parentName:"tr",align:"left"},"extracted from ",(0,s.kt)("inlineCode",{parentName:"td"},"io.size"))))),(0,s.kt)("h2",{id:"accessing-metadata"},"Accessing metadata"),(0,s.kt)("p",null,"You can access the stored metadata in three ways:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# via methods (if they're defined)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.size")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.original_filename")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.mime_type")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# via the metadata hash")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"size"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"filename"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"mime_type"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# via the #[] operator")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"size"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"filename"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"mime_type"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]"))))),(0,s.kt)("h2",{id:"controlling-extraction"},"Controlling extraction"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"Shrine#upload")," accepts a ",(0,s.kt)("inlineCode",{parentName:"p"},":metadata")," option which accepts the following values:"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("inlineCode",{parentName:"p"},"Hash")," \u2013 adds/overrides extracted metadata with the given hash"),(0,s.kt)("div",{parentName:"li","data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload(file, metadata"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"filename"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"Matrix[1999].mp4"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"foo"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"bar"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," })")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.original_filename "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "Matrix[1999].mp4"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"foo"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]   "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "bar"')))))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("inlineCode",{parentName:"p"},"false")," \u2013 skips metadata extraction (useful in tests)"),(0,s.kt)("div",{parentName:"li","data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload(file, metadata"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"false"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> {}")))))),(0,s.kt)("li",{parentName:"ul"},(0,s.kt)("p",{parentName:"li"},(0,s.kt)("inlineCode",{parentName:"p"},"true")," \u2013 forces metadata extraction when a ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::UploadedFile")," is being\nuploaded (by default metadata is simply copied over)"),(0,s.kt)("div",{parentName:"li","data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload(uploaded_file, metadata"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"true"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# re-extracted metadata"))))))),(0,s.kt)("h2",{id:"mime-type"},"MIME type"),(0,s.kt)("p",null,"By default, the ",(0,s.kt)("inlineCode",{parentName:"p"},"mime_type")," metadata will be copied over from the\n",(0,s.kt)("inlineCode",{parentName:"p"},"#content_type")," attribute of the input file (if present). However, since\n",(0,s.kt)("inlineCode",{parentName:"p"},"#content_type")," value comes from the ",(0,s.kt)("inlineCode",{parentName:"p"},"Content-Type")," header of the upload\nrequest, it's ",(0,s.kt)("em",{parentName:"p"},"not guaranteed")," to hold the actual MIME type of the file (browser\ndetermines this header based on file extension)."),(0,s.kt)("p",null,"Moreover, only ",(0,s.kt)("inlineCode",{parentName:"p"},"ActionDispatch::Http::UploadedFile"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::RackFile"),", and\n",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::DataFile")," objects have ",(0,s.kt)("inlineCode",{parentName:"p"},"#content_type")," defined, so when uploading\nobjects such as ",(0,s.kt)("inlineCode",{parentName:"p"},"File"),", the ",(0,s.kt)("inlineCode",{parentName:"p"},"mime_type")," value will be nil by default."),(0,s.kt)("p",null,"To remedy that, Shrine comes with a\n",(0,s.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/determine_mime_type"},(0,s.kt)("inlineCode",{parentName:"a"},"determine_mime_type"))," plugin which is able to extract\nthe MIME type from IO ",(0,s.kt)("em",{parentName:"p"},"content"),":"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Gemfile")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"gem "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"marcel"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"~> 0.3"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":determine_mime_type"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", analyzer"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":marcel"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"StringIO"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"<?php ... ?>"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.mime_type "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "application/x-php"'))))),(0,s.kt)("p",null,"You can choose different analyzers, and even mix-and-match them. See the\n",(0,s.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/determine_mime_type"},(0,s.kt)("inlineCode",{parentName:"a"},"determine_mime_type"))," plugin docs for more details."),(0,s.kt)("h2",{id:"image-dimensions"},"Image Dimensions"),(0,s.kt)("p",null,"Shrine comes with a ",(0,s.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/store_dimensions"},(0,s.kt)("inlineCode",{parentName:"a"},"store_dimensions"))," plugin for\nextracting image dimensions. It adds ",(0,s.kt)("inlineCode",{parentName:"p"},"width")," and ",(0,s.kt)("inlineCode",{parentName:"p"},"height")," metadata values, and\nalso adds ",(0,s.kt)("inlineCode",{parentName:"p"},"#width"),", ",(0,s.kt)("inlineCode",{parentName:"p"},"#height"),", and ",(0,s.kt)("inlineCode",{parentName:"p"},"#dimensions")," methods to the\n",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::UploadedFile")," object."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Gemfile")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"gem "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"fastimage"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# default analyzer"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":store_dimensions"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload(image)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"width"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"]  "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> 1600")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"height"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"] "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> 900")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# convenience methods")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.width      "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> 1600")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.height     "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> 900")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.dimensions "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> [1600, 900]"))))),(0,s.kt)("p",null,"By default, the plugin uses ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/sdsykes/fastimage"},"FastImage")," to analyze dimensions, but you can also\nhave it use ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/minimagick/minimagick"},"MiniMagick")," or ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/libvips/ruby-vips"},"ruby-vips"),". See the\n",(0,s.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/store_dimensions"},(0,s.kt)("inlineCode",{parentName:"a"},"store_dimensions"))," plugin docs for more details."),(0,s.kt)("h2",{id:"custom-metadata"},"Custom metadata"),(0,s.kt)("p",null,"In addition to the built-in metadata, Shrine allows you to extract and store\nany custom metadata, using the ",(0,s.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/add_metadata"},(0,s.kt)("inlineCode",{parentName:"a"},"add_metadata"))," plugin (which\ninternally extends ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine#extract_metadata"),")."),(0,s.kt)("p",null,"For example, you might want to extract EXIF data from images:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Gemfile")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"gem "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"exiftool"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"require"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"exiftool"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"ImageUploader"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":add_metadata")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  add_metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":exif"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," |io, context|")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".with_file(io) "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," |file|")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Exiftool"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"(file.path).to_hash")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload(image)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata["),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"exif"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"] "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> {...}")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.exif             "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=> {...}"))))),(0,s.kt)("p",null,"Or, if you're uploading videos, you might want to extract some video-specific\nmetadata:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# Gemfile")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"gem "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"streamio-ffmpeg"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"require"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"streamio-ffmpeg"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"VideoUploader"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":add_metadata")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  add_metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," |io, context|")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    movie "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".with_file(io) { |file| "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"FFMPEG"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Movie"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"(file.path) }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"duration"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"   "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.duration,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"bitrate"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.bitrate,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"resolution"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.resolution,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"frame_rate"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.frame_rate }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," uploader.upload(video)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"uploaded_file.metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=>")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#   ...")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "duration" => 7.5,')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "bitrate" => 481,')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "resolution" => "640x480",')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "frame_rate" => 16.72')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# }"))))),(0,s.kt)("p",null,"The yielded ",(0,s.kt)("inlineCode",{parentName:"p"},"io")," object will not always be an object that responds to ",(0,s.kt)("inlineCode",{parentName:"p"},"#path"),".\nFor example, with the ",(0,s.kt)("inlineCode",{parentName:"p"},"data_uri")," plugin the ",(0,s.kt)("inlineCode",{parentName:"p"},"io")," can be a ",(0,s.kt)("inlineCode",{parentName:"p"},"StringIO")," wrapper,\nwhile with ",(0,s.kt)("inlineCode",{parentName:"p"},"restore_cached_data")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"refresh_metadata")," plugins the ",(0,s.kt)("inlineCode",{parentName:"p"},"io")," might\nbe a ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine::UploadedFile")," object. So, we're using ",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine.with_file")," to\nensure we have a file object."),(0,s.kt)("h3",{id:"adding-metadata"},"Adding metadata"),(0,s.kt)("p",null,"If you wish to add metadata to an already attached file, you can do it as\nfollows:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image_attacher.add_metadata("),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"foo"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"bar"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image.metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> { ..., "foo" => "bar" }')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.save "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# persist changes"))))),(0,s.kt)("h2",{id:"metadata-columns"},"Metadata columns"),(0,s.kt)("p",null,"If you want to write any of the metadata values into a separate database column\non the record, you can use the ",(0,s.kt)("inlineCode",{parentName:"p"},"metadata_attributes")," plugin."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":metadata_attributes"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"mime_type "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":type"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Photo"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"(image"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," file)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image_type "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#=> "image/jpeg"'))))),(0,s.kt)("h2",{id:"direct-uploads"},"Direct uploads"),(0,s.kt)("p",null,"When attaching files that were uploaded directly to the cloud or a ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/janko/tus-ruby-server"},"tus\nserver"),", Shrine won't automatically extract metadata from them, instead it will\ncopy any existing metadata that was set on the client side. The reason why this\nis the default behaviour is because metadata extraction requires (at least\npartially) retrieving file content from the storage, which could potentially be\nexpensive depending on the storage and the type of metadata being extracted."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# no additional metadata will be extracted in this assignment by default")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},"'"),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},'{"id":"9e6581a4ea1.jpg","storage":"cache","metadata":{...}}'),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},"'"))))),(0,s.kt)("h3",{id:"extracting-on-attachment"},"Extracting on attachment"),(0,s.kt)("p",null,"If you want metadata to be automatically extracted on assignment (which is\nuseful if you want to validate the extracted metadata or have it immediately\navailable for any other reason), you can load the ",(0,s.kt)("inlineCode",{parentName:"p"},"restore_cached_data")," plugin:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":restore_cached_data"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# automatically extract metadata from cached files on assignment"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},"'"),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},'{"id":"ks9elsd.jpg","storage":"cache","metadata":{}}'),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},"'"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# metadata is extracted")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"photo.image.metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"#=>")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# {")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "size" => 4593484,')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "filename" => "nature.jpg",')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},'#   "mime_type" => "image/jpeg"')),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# }"))))),(0,s.kt)("h3",{id:"extracting-in-the-background"},"Extracting in the background"),(0,s.kt)("h4",{id:"a-extracting-with-promotion"},"A) Extracting with promotion"),(0,s.kt)("p",null,"If you're using ",(0,s.kt)("a",{parentName:"p",href:"https://shrinerb.com/docs/plugins/backgrounding"},"backgrounding"),", you can extract metadata during background\npromotion using the ",(0,s.kt)("inlineCode",{parentName:"p"},"refresh_metadata")," plugin (which the ",(0,s.kt)("inlineCode",{parentName:"p"},"restore_cached_data"),"\nplugin uses internally):"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":refresh_metadata"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# allow re-extracting metadata")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":backgrounding")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Attacher"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".promote_block "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"PromoteJob"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".perform_async("),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE",fontStyle:"italic"}},"self"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".class.name, record.class.name, record.id, name, file_data)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"PromoteJob")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"include"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Sidekiq"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Worker")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#62E884"}},"perform"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"attacher_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_id"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"file_data"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher_class "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(attacher_class)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    record         "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(record_class).find(record_id) "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# if using Active Record")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," attacher_class.retrieve(model"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," record, name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," name, file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," file_data)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.refresh_metadata! "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# extract metadata")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.atomic_promote")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("h4",{id:"b-extracting-separately-from-promotion"},"B) Extracting separately from promotion"),(0,s.kt)("p",null,"You can also extract metadata in the background separately from promotion:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"MetadataJob"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".perform_async(")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  attacher.class.name,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  attacher.record.class.name,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  attacher.record.id,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  attacher.name,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  attacher.file_data,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"MetadataJob")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"include"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Sidekiq"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Worker")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#62E884"}},"perform"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"attacher_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_id"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"file_data"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher_class "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(attacher_class)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    record         "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(record_class).find(record_id) "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# if using Active Record")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," attacher_class.retrieve(model"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," record, name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," name, file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," file_data)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.refresh_metadata!")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.atomic_persist")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("h3",{id:"combining-foreground-and-background"},"Combining foreground and background"),(0,s.kt)("p",null,"If you have some metadata that you want to extract in the foreground and some\nthat you want to extract in the background, you can use the uploader context:"),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"VideoUploader"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"<"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":add_metadata")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  add_metadata "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," |io, "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"**"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"options|")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"next"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"unless"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," options["),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":background"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"] "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# proceed only when `background: true` was specified")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# example of metadata extraction")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    movie "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".with_file(io) { |file| "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"FFMPEG"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Movie"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"."),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"new"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"(file.path) }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    { "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"duration"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"   "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.duration,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"bitrate"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.bitrate,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"resolution"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.resolution,")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      "),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#E7EE98"}},"frame_rate"),(0,s.kt)("span",{parentName:"span",style:{color:"#DEE492"}},'"'),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"=>"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," movie.frame_rate }")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"PromoteJob")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"include"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Sidekiq"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Worker")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#62E884"}},"perform"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"attacher_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_id"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"file_data"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher_class "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(attacher_class)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    record         "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(record_class).find(record_id) "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# if using Active Record")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," attacher_class.retrieve(model"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," record, name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," name, file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," file_data)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.refresh_metadata!(background"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"true"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},") "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# specify the flag")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.atomic_promote")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("p",null,"Now triggering metadata extraction in the controller on attachment (using\n",(0,s.kt)("inlineCode",{parentName:"p"},"restore_cached_data")," or ",(0,s.kt)("inlineCode",{parentName:"p"},"refresh_metadata")," plugin) will skip the video\nmetadata block, which will be triggered later in the background job."),(0,s.kt)("h3",{id:"optimizations"},"Optimizations"),(0,s.kt)("p",null,"If you want to do both metadata extraction and file processing during\npromotion, you can wrap both in an ",(0,s.kt)("inlineCode",{parentName:"p"},"UploadedFile#open")," block to make\nsure the file content is retrieved from the storage only once."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"PromoteJob")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"include"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Sidekiq"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"::"),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},"Worker")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"def"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#62E884"}},"perform"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"("),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"attacher_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_class"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"record_id"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},", "),(0,s.kt)("span",{parentName:"span",style:{color:"#FFB86C",fontStyle:"italic"}},"file_data"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},")")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher_class "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(attacher_class)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    record         "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Object"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".const_get(record_class).find(record_id) "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# if using Active Record")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"="),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," attacher_class.retrieve(model"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," record, name"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," name, file"),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},":"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," file_data)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.file."),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"open"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      attacher.refresh_metadata!")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"      attacher.create_derivatives")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"}),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"    attacher.atomic_promote")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end"))))),(0,s.kt)("p",null,"If you're dealing with large files and have metadata extractors that use\n",(0,s.kt)("inlineCode",{parentName:"p"},"Shrine.with_file"),", you might want to use the ",(0,s.kt)("inlineCode",{parentName:"p"},"tempfile")," plugin to make sure\nthe same copy of the uploaded file is reused for both metadata extraction and\nfile processing."),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1",fontStyle:"italic"}},"Shrine"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},".plugin "),(0,s.kt)("span",{parentName:"span",style:{color:"#BF9EEE"}},":tempfile"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# load it globally so that it overrides `Shrine.with_file`"))))),(0,s.kt)("div",{"data-rehype-pretty-code-fragment":""},(0,s.kt)("pre",{parentName:"div","data-language":"rb","data-theme":"default"},(0,s.kt)("code",{parentName:"pre","data-language":"rb","data-theme":"default"},(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ...")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"attacher.file."),(0,s.kt)("span",{parentName:"span",style:{color:"#97E1F1"}},"open"),(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}}," "),(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"do")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  attacher.refresh_metadata!")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F6F6F4"}},"  attacher.create_derivatives(attacher.file.tempfile)")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#F286C4"}},"end")),"\n",(0,s.kt)("span",{parentName:"code",className:"line"},(0,s.kt)("span",{parentName:"span",style:{color:"#7B7F8B"}},"# ..."))))))}F.isMDXComponent=!0}}]);