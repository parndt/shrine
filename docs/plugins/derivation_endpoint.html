<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-plugins/derivation_endpoint">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Derivation Endpoint | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/plugins/derivation_endpoint"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Derivation Endpoint | Shrine"><meta data-rh="true" name="description" content="The derivationendpoint plugin provides a Rack app for"><meta data-rh="true" property="og:description" content="The derivationendpoint plugin provides a Rack app for"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/plugins/derivation_endpoint"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/plugins/derivation_endpoint" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/plugins/derivation_endpoint" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.3b0f70eb.js" as="script">
<link rel="preload" href="/assets/js/main.ea4eabff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a class="navbar__item navbar__link" href="/docs/release_notes/3.5.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/activerecord">Attachment</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/activerecord">Active Record</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/column">Column</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/entity">Entity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/model">Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/sequel">Sequel</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/backgrounding">Flow</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/backgrounding">Backgrounding</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/presign_endpoint">Presign Endpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/upload_endpoint">Upload Endpoint</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/plugins/derivation_endpoint">Processing</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/plugins/derivation_endpoint">Derivation Endpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/derivatives">Derivatives</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/data_uri">Source</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/data_uri">Data URI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/rack_file">Rack File</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/remote_url">Remote URL</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/remove_invalid">Validation</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/remove_invalid">Remove Invalid</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/validation">Validation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/validation_helpers">Validation Helpers</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/add_metadata">Metadata</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/add_metadata">Add Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/determine_mime_type">Determine MIME Type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/infer_extension">Infer Extension</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/metadata_attributes">Metadata Attributes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/refresh_metadata">Refresh Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/restore_cached_data">Restore Cached Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/signature">Signature</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/store_dimensions">Store Dimensions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/type_predicates">Type Predicates</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/download_endpoint">Downloading</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/download_endpoint">Download Endpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/rack_response">Rack Response</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/tempfile">Tempfile</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/cached_attachment_data">Form</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/cached_attachment_data">Cached Attachment Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/form_assign">Form Assign</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/remove_attachment">Remove Attachment</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/default_storage">Settings</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/default_storage">Default Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/default_url">Default URL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/dynamic_storage">Dynamic Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/multi_cache">Multi Cache</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/pretty_location">Pretty Location</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/upload_options">Upload Options</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/url_options">URL Options</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/plugins/atomic_helpers">Other</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/atomic_helpers">Atomic Helpers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/included">Included</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/instrumentation">Instrumentation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/keep_files">Keep Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/plugins/mirroring">Mirroring</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Derivation Endpoint</h1></header><p>The <a href="https://github.com/shrinerb/shrine/blob/master/lib/shrine/plugins/derivation_endpoint.rb" target="_blank" rel="noopener noreferrer"><code>derivation_endpoint</code></a> plugin provides a Rack app for
dynamically processing uploaded files on request. This allows you to create
URLs to files that might not have been generated yet, and have the endpoint
process them on-the-fly.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="quick-start">Quick start<a href="#quick-start" class="hash-link" aria-label="Direct link to Quick start" title="Direct link to Quick start">​</a></h2><p>We first load the plugin, providing a secret key and a path prefix to where the
endpoint will be mounted:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    secret_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR SECRET KEY&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivations/image</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>We can then mount the derivation endpoint for our uploader into our app&#x27;s
router on the path prefix we specified:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb (Rails)</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  mount </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.derivation_endpoint </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivations/image</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Next we can define a &quot;derivation&quot; block for the type of processing we want to
apply to an attached file. For example, we can generate image thumbnails using
the <a href="https://github.com/janko/image_processing" target="_blank" rel="noopener noreferrer">ImageProcessing</a> gem:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 1.8</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing/mini_magick</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, width, height|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">MiniMagick</span></span>
<span class="line"><span style="color:#F6F6F4">      .source(file)</span></span>
<span class="line"><span style="color:#F6F6F4">      .resize_to_limit!(width.to_i, height.to_i)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Now we can generate &quot;derivation&quot; URLs from attached files, which on request
will call the derivation block we defined.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">600</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">400</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;/derivations/image/thumbnail/600/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;</span></span></code></pre></div><p>In this example, <code>photo</code> is an instance of a <code>Photo</code> model which has an <code>image</code>
attachment. The URL will render a <code>600x400</code> thumbnail of the original image.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-it-works">How it works<a href="#how-it-works" class="hash-link" aria-label="Direct link to How it works" title="Direct link to How it works">​</a></h2><p>The <code>#derivation_url</code> method is defined on <code>Shrine::UploadedFile</code> objects. It
generates an URL consisting of the configured <a href="#prefix">path prefix</a>,
derivation name and arguments, serialized uploaded file, and an URL signature
generated using the configured secret key:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">/  derivations/image  /  thumbnail  /  600/400  /  eyJmZvbyIb3JhZ2UiOiJzdG9yZSJ9  ?  signature=...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  └──── prefix ─────┘  └── name ──┘  └─ args ─┘  └─── serialized source file ───┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>When the derivation URL is requested, the derivation endpoint will first verify
the signature included in query params, and proceed only if it matches the
calculated signature. This ensures that only the server can generate valid
derivation URLs, preventing potential DoS attacks.</p><p>The derivation endpoint then extracts the source file data, derivation name and
arguments from the request URL, and calls the corresponding derivation block,
passing the downloaded source file and derivation arguments. The derivation
block is evaluated within the context of a
<a href="#derivation-api"><code>Shrine::Derivation</code></a> instance.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, arg1, arg2, ...|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::Derivation&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  file </span><span style="color:#7B7F8B">#=&gt; #&lt;Tempfile:...&gt; (source file downloaded to disk)</span></span>
<span class="line"><span style="color:#F6F6F4">  arg1 </span><span style="color:#7B7F8B">#=&gt; &quot;600&quot; (first derivation argument in #derivation_url)</span></span>
<span class="line"><span style="color:#F6F6F4">  arg2 </span><span style="color:#7B7F8B">#=&gt; &quot;400&quot; (second derivation argument in #derivation_url)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ... do processing ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># return result as a File or Tempfile object</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>The derivation block is expected to return the processed file as a <code>File</code> or
<code>Tempfile</code> object. The resulting file is then rendered in the HTTP response.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance">Performance<a href="#performance" class="hash-link" aria-label="Direct link to Performance" title="Direct link to Performance">​</a></h3><p>By default, the processed file returned by the derivation block is not cached
anywhere. This means that repeated requests to the same derivation URL will
execute the derivation block each time, which can put a lot of load on your
application.</p><p>For this reason it&#x27;s highly recommended to put a <strong>CDN or other HTTP cache</strong> in
front of your application. If you&#x27;ve configured a CDN, you can set the CDN host
at the plugin level, and it will be used for all derivation URLs:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, host</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">https://your-dist-url.cloudfront.net</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><p>Additionally, you can have the endpoint cache derivatives to a storage. With
this setup, the generated derivative will be uploaded to the storage on initial
request, and then on subsequent requests the derivative will be served directly
from the storage.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span></code></pre></div><p>If you want to avoid having the endpoint directly serve the generated
derivatives, you can have the derivation response redirect to the uploaded
derivative on the storage service.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">, upload_redirect</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span></code></pre></div><p>For more details, see the <a href="#uploading">Uploading</a> section.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="derivation-response">Derivation response<a href="#derivation-response" class="hash-link" aria-label="Direct link to Derivation response" title="Direct link to Derivation response">​</a></h2><p>Mounting the derivation endpoint into the app&#x27;s router is the easiest way to
handle derivation requests, as routing and setting the response is done
automatically.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  mount </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.derivation_endpoint </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivations/image</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>However, this approach can also be limiting if one wants to perform additional
operations around derivation requests, such as authentication and
authorization.</p><p>Instead of mounting the endpoint into the router, you can also call the
derivation endpoint from a controller. In this case the endpoint needs to
receive the Rack env hash, so that it can infer derivation parameters from the
request URL. The return value is a 3-element array, containing the status,
headers, and body that should be returned in the HTTP response:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  get </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/derivations/image/*rest</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivations#image</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># app/controllers/derivations_controller.rb</span></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DerivationsController</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ApplicationController</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">image</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ... we can perform authentication here ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    set_rack_response </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.derivation_response(request.env)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">private</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">set_rack_response</span><span style="color:#F6F6F4">((</span><span style="color:#FFB86C;font-style:italic">status</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">headers</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">body</span><span style="color:#F6F6F4">))</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.status </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> status</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.headers.merge!(headers)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.response_body </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> body</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>For even more control, you can generate derivation responses in custom routes.
Once you retrieve the <code>Shrine::UploadedFile</code> object, you can call
<code>#derivation_response</code> directly on it, passing the derivation name and
arguments, as well as the Rack env hash.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  resources </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    member </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">      get </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">thumbnail</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># for example</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># app/controllers/photos_controller.rb</span></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">PhotosController</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ApplicationController</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">thumbnail</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># we can perform authorization here</span></span>
<span class="line"><span style="color:#F6F6F4">    photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.find(params[</span><span style="color:#BF9EEE">:id</span><span style="color:#F6F6F4">])</span></span>
<span class="line"><span style="color:#F6F6F4">    image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> photo.image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    set_rack_response image.derivation_response(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, env</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> request.env)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">private</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">set_rack_response</span><span style="color:#F6F6F4">((</span><span style="color:#FFB86C;font-style:italic">status</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">headers</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">body</span><span style="color:#F6F6F4">))</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.status </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> status</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.headers.merge!(headers)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.response_body </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> body</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p><code>Shrine.derivation_endpoint</code>, <code>Shrine.derivation_response</code>, and
<code>UploadedFile#derivation_response</code> methods all accept additional options, which
will override options set on the plugin level.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.derivation_endpoint(disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B"># or</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.derivation_response(env, disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B"># or</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_response(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, env</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> env, disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-settings">Dynamic settings<a href="#dynamic-settings" class="hash-link" aria-label="Direct link to Dynamic settings" title="Direct link to Dynamic settings">​</a></h2><p>For most options passed to <code>plugin :derivation_endpoint</code>,
<code>Shrine.derivation_endpoint</code>, <code>Shrine.derivation_response</code>, or
<code>Shrine::UploadedFile#derivation_response</code>, the value can also be a block that
returns a dynamic result. The block will be evaluated within the context of a
<a href="#derivation-api"><code>Shrine::Derivation</code></a> instance, allowing you to access
information about the current derivation:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">   </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::Derivation&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  name   </span><span style="color:#7B7F8B">#=&gt; :thumbnail</span></span>
<span class="line"><span style="color:#F6F6F4">  args   </span><span style="color:#7B7F8B">#=&gt; [&quot;500&quot;, &quot;400&quot;]</span></span>
<span class="line"><span style="color:#F6F6F4">  source </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><p>For example, we can use it to specify that thumbnails should be rendered inline
in the browser, while other derivatives will be force downloaded.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  name </span><span style="color:#F286C4">==</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">?</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">inline</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> : </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="host">Host<a href="#host" class="hash-link" aria-label="Direct link to Host" title="Direct link to Host">​</a></h2><p>Derivation URLs are relative by default. To generate absolute URLs, you can
pass the <code>:host</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, host</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">https://example.com</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><p>Now the generated URLs will include the specified URL host:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/.../thumbnail/eyJpZCI6ImZvbyIsInN?signature=...&quot;</span></span></code></pre></div><p>You can also pass <code>:host</code> per URL:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, host</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">https://example.com</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/.../thumbnail/eyJpZCI6ImZvbyIsInN?signature=...&quot;</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="prefix">Prefix<a href="#prefix" class="hash-link" aria-label="Direct link to Prefix" title="Direct link to Prefix">​</a></h2><p>If you&#x27;re mounting the derivation endpoint under a path prefix, the derivation
URLs will need to include that path prefix. This can be configured with the
<code>:prefix</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">transformations/image</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><p>Now generated URLs will include the specified path prefix:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../transformations/image/thumbnail/eyJpZCI6ImZvbyIsInN?signature=...&quot;</span></span></code></pre></div><p>You can also pass <code>:prefix</code> per URL:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">transformations/image</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../transformations/image/thumbnail/eyJpZCI6ImZvbyIsInN?signature=...&quot;</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="expiration">Expiration<a href="#expiration" class="hash-link" aria-label="Direct link to Expiration" title="Direct link to Expiration">​</a></h2><p>By default derivation URLs are valid indefinitely. If you want URLs to expire
after a certain amount of time, you can set the <code>:expires_in</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, expires_in</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">90</span></span></code></pre></div><p>Now any URL will stop being valid 90 seconds after it was generated:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?expires_at=1547843568&amp;signature=...&quot;</span></span></code></pre></div><p>You can also pass <code>:expires_in</code> per URL:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, expires_in</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">90</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?expires_at=1547843568&amp;signature=...&quot;</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="custom-signer">Custom signer<a href="#custom-signer" class="hash-link" aria-label="Direct link to Custom signer" title="Direct link to Custom signer">​</a></h2><p>The derivation URLs are signed by default, and the signature is checked when
the URLs are requested, which prevents tampering. If you have URL expiration
turned on, this may prevent your CDN from caching the response.</p><p>In this case, you may need to do custom CDN-specific URL signing. You can
bypass Shrine&#x27;s default signing by passing a custom signer:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">aws-sdk-cloudfront</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">signer </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Aws</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">CloudFront</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">UrlSigner</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(key_pair_id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, private_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  expires_in</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">90</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  signer</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (url, expires_in</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    signer.signed_url(url, expires</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Time</span><span style="color:#F6F6F4">.now.to_i </span><span style="color:#F286C4">+</span><span style="color:#F6F6F4"> expires_in)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span></code></pre></div><p>When <code>:signer</code> option is used, the <code>:secret_key</code> option is not required, as
that secret is only used for default signing.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="response-headers">Response headers<a href="#response-headers" class="hash-link" aria-label="Direct link to Response headers" title="Direct link to Response headers">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="content-type">Content Type<a href="#content-type" class="hash-link" aria-label="Direct link to Content Type" title="Direct link to Content Type">​</a></h3><p>The derivation response includes the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Type" target="_blank" rel="noopener noreferrer"><code>Content-Type</code></a> header. By default
default its value will be inferred from the file extension of the generated
derivative (using <code>Rack::Mime</code>). This can be overriden with the <code>:type</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image/webp</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> name </span><span style="color:#F286C4">==</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:webp</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><p>The above will set <code>Content-Type</code> response header value to <code>image/webp</code> for
<code>:webp</code> derivatives, while for others it will be inferred from the file
extension if possible.</p><p>You can also set <code>:type</code> per URL:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:webp</span><span style="color:#F6F6F4">, type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image/webp</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../webp/eyJpZCI6ImZvbyIsInN?type=image%2Fwebp&amp;signature=...&quot;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="content-disposition">Content Disposition<a href="#content-disposition" class="hash-link" aria-label="Direct link to Content Disposition" title="Direct link to Content Disposition">​</a></h3><p>The derivation response includes the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Disposition" target="_blank" rel="noopener noreferrer"><code>Content-Disposition</code></a> header. By default
the disposition is set to <code>inline</code>, with download filename generated from
derivation name, arguments and source file id. These values can be changed with
the <code>:disposition</code> and <code>:filename</code> options:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> { name </span><span style="color:#F286C4">==</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">?</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">inline</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> : </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> },</span></span>
<span class="line"><span style="color:#F6F6F4">  filename</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">    </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> { [name, </span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">args].join(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">-</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">) }</span></span></code></pre></div><p>With the above settings, visiting a thumbnail URL will render the image in the
browser, while other derivatives will be treated as an attachment and be
downloaded.</p><p>The <code>:filename</code> and <code>:disposition</code> options can also be set per URL:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:pdf</span><span style="color:#F6F6F4">, disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, filename</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">custom-filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?disposition=attachment&amp;filename=custom-filename&amp;signature=...&quot;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="cache-control">Cache Control<a href="#cache-control" class="hash-link" aria-label="Direct link to Cache Control" title="Direct link to Cache Control">​</a></h3><p>The endpoint uses the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control" target="_blank" rel="noopener noreferrer"><code>Cache-Control</code></a> response header to tell clients
(browsers, CDNs, HTTP caches) how long they can cache derivation responses. The
default cache duration is 1 year from the initial request, or if
<a href="#expiration"><code>:expires_in</code></a> is used it&#x27;s the time until the URL expires. The
header value can be changed with the <code>:cache_control</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, cache_control</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">public, max-age=</span><span style="color:#F286C4">#{</span><span style="color:#BF9EEE">7</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">24</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">60</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">60</span><span style="color:#F286C4">}</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># 7 weeks</span></span></code></pre></div><p>Note that <code>Cache-Control</code> is added to response headers only when using
<code>Shrine.derivation_endpoint</code> or <code>Shrine.derivation_response</code>, it&#x27;s not added
when using <code>Shrine::UploadedFile#derivation_response</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="uploading">Uploading<a href="#uploading" class="hash-link" aria-label="Direct link to Uploading" title="Direct link to Uploading">​</a></h2><p>By default the generated derivatives aren&#x27;t saved anywhere, which means that
repeated requests to the same derivation URL will call the derivation block
each time. If you don&#x27;t want to rely on solely on your HTTP cache, you can
enable the <code>:upload</code> option, which will make derivatives automatically cached
on the Shrine storage:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span></code></pre></div><p>Now whenever a derivation is requested, the endpoint will first check whether
the derivative already exists on the storage. If it doesn&#x27;t exist, it will
fetch the original uploaded file, call the derivation block, upload the
derivative to the storage, and serve the derivative. If the derivative does
exist on checking, the endpoint will download the derivative and serve it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upload-location">Upload location<a href="#upload-location" class="hash-link" aria-label="Direct link to Upload location" title="Direct link to Upload location">​</a></h3><p>The default upload location for derivatives is <code>&lt;source id&gt;/&lt;name&gt;-&lt;args&gt;</code>.
This can be changed with the <code>:upload_location</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">, upload_location</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># e.g. &quot;derivatives/9a7d1bfdad24a76f9cfaff137fe1b5c7/thumbnail-1000-800&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  [</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivatives</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">File</span><span style="color:#F6F6F4">.basename(source.id, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">.*</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">), [name, </span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">args].join(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">-</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)].join(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><p>Since the default upload location won&#x27;t have any file extension, the derivation
response won&#x27;t know the appropriate <code>Content-Type</code> header value to set, and the
generic <code>application/octet-stream</code> will be used. It&#x27;s recommended to use the
<a href="#content-type"><code>:type</code></a> option to set the appropriate <code>Content-Type</code> value.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upload-storage">Upload storage<a href="#upload-storage" class="hash-link" aria-label="Direct link to Upload storage" title="Direct link to Upload storage">​</a></h3><p>The target storage used is the same as for the source uploaded file. The
<code>:upload_storage</code> option can be used to specify a different Shrine storage:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">                             upload_storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:thumbnail_storage</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upload-options">Upload options<a href="#upload-options" class="hash-link" aria-label="Direct link to Upload options" title="Direct link to Upload options">​</a></h3><p>Additional storage-specific upload options can be passed via <code>:upload_options</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">                             upload_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { acl</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">public-read</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upload-open-options">Upload open options<a href="#upload-open-options" class="hash-link" aria-label="Direct link to Upload open options" title="Direct link to Upload open options">​</a></h3><p>Additional storage-specific download options for the uploaded derivation result
can be passed via <code>:upload_open_options</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">                             upload_open_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { response_content_encoding</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">gzip</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="redirecting">Redirecting<a href="#redirecting" class="hash-link" aria-label="Direct link to Redirecting" title="Direct link to Redirecting">​</a></h3><p>If you are using remote cloud storages, you can configure the endpoint to
redirect the client to the uploaded derivative on the remote storage instead of
serving it through the endpoint (which is the default behaviour) by setting both
<code>:upload</code> and <code>:upload_redirect</code> to <code>true</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">                             upload_redirect</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span></code></pre></div><p>Additional storage-specific URL options can be passed in for the redirect URL:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, upload</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">                             upload_redirect</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">                             upload_redirect_url_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { public</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><p>Note that redirecting only makes sense if you&#x27;re using remote storage services
such as AWS S3 or Google Cloud Storage.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="deleting-derivatives">Deleting derivatives<a href="#deleting-derivatives" class="hash-link" aria-label="Direct link to Deleting derivatives" title="Direct link to Deleting derivatives">​</a></h3><p>When the original attachment is deleted, its uploaded derivatives will not be
automatically deleted, you will need to do the deletion manually. If you&#x27;re
using <a href="https://shrinerb.com/docs/plugins/backgrounding" target="_blank" rel="noopener noreferrer">backgrounding</a>, you can do this in your <code>DestroyJob</code>.</p><p>If your storage implements <code>#delete_prefixed</code>, and you&#x27;re using the default
<a href="#upload-location"><code>:upload_location</code></a>, you can delete the directory containing
derivatives:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DestroyJob</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveJob::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ... destroy attached file ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    derivatives_directory </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher.file.id </span><span style="color:#F286C4">+</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">    storage               </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher.store.storage</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    storage.delete_prefixed(derivatives_directory)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Alternatively, you can delete each derivative individually:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">DERIVATIONS</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> [</span></span>
<span class="line"><span style="color:#F6F6F4">    [</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">    [</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">600</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">400</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">    [</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">400</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">    ...</span></span>
<span class="line"><span style="color:#F6F6F4">  ]</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DestroyJob</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveJob::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ... destroy attached file ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher.shrine_class</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">DERIVATIONS</span><span style="color:#F6F6F4">.each </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |args|</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher.file.derivation(</span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">args).delete</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cache-busting">Cache busting<a href="#cache-busting" class="hash-link" aria-label="Direct link to Cache busting" title="Direct link to Cache busting">​</a></h2><p>The derivation endpoint response instructs browsers, CDNs and other clients to
cache the response for a long time. This saves server resources and improves
response times. However, if the derivation block is modified, the derivation
URLs will remain unchanged, which means that old cached derivatives might still
be served.</p><p>If you want to ensure derivation URLs don&#x27;t point to old cached derivatives,
you can add a &quot;version&quot; query parameter to the URL, which will make HTTP caches
treat it as a new URL. You can do this via the <code>:version</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, version</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> { </span><span style="color:#BF9EEE">1</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> name </span><span style="color:#F286C4">==</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><p>With the above settings, all <code>:thumbnail</code> derivation URLs will include
<code>version</code> in the query string:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?version=1&amp;signature=...&quot;</span></span></code></pre></div><p>You can also bump the <code>:version</code> per URL:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, version</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">1</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;.../thumbnail/eyJpZCI6ImZvbyIsInN?version=1&amp;signature=...&quot;</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="accessing-source-file">Accessing source file<a href="#accessing-source-file" class="hash-link" aria-label="Direct link to Accessing source file" title="Direct link to Accessing source file">​</a></h2><p>Inside the derivation block we can access the source <code>UploadedFile</code> object via
<code>Shrine::Derivation#source</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, width, height|</span></span>
<span class="line"><span style="color:#F6F6F4">  source             </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  source.id          </span><span style="color:#7B7F8B">#=&gt; &quot;9a7d1bfdad24a76f9cfaff137fe1b5c7.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  source.storage_key </span><span style="color:#7B7F8B">#=&gt; :store</span></span>
<span class="line"><span style="color:#F6F6F4">  source.metadata    </span><span style="color:#7B7F8B">#=&gt; {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>By default, when using the derivation endpoint, original metadata of the source
file won&#x27;t be available in the derivation block. This is because any metadata
we would want to have available would need to be serialized into the derivation
URL, which would make it longer. Instead, you can opt in for the metadata you
want to have available:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">mime_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, width, height|</span></span>
<span class="line"><span style="color:#F6F6F4">  source.metadata </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B">#  &quot;filename&quot; =&gt; &quot;nature.jpg&quot;,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B">#  &quot;mime_type&quot; =&gt; &quot;image/jpeg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  source.original_filename </span><span style="color:#7B7F8B">#=&gt; &quot;nature.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  source.mime_type         </span><span style="color:#7B7F8B">#=&gt; &quot;image/jpeg&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="downloading">Downloading<a href="#downloading" class="hash-link" aria-label="Direct link to Downloading" title="Direct link to Downloading">​</a></h2><p>When a derivation is requested, the original uploaded file will be downloaded
to disk before the derivation block is called. If you want to pass in
additional storage-specific download options, you can do so via
<code>:download_options</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, download_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  sse_customer_algorithm</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">AES256</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  sse_customer_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">       </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">secret_key</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  sse_customer_key_md5</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">   </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">secret_key_md5</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><p>If the source file was not found, <code>Shrine::Derivation::SourceNotFound</code>
exception is raised. In a derivation response this is converted into a <code>404 Not
Found</code> response.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="skipping-download">Skipping download<a href="#skipping-download" class="hash-link" aria-label="Direct link to Skipping download" title="Direct link to Skipping download">​</a></h3><p>If for whatever reason you don&#x27;t want the uploaded file to be downloaded to
disk for you, you can set <code>:download</code> to <code>false</code>.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, download</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">false</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |width, height| </span><span style="color:#7B7F8B"># source file is not downloaded</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>One use case for this is delegating processing to a 3rd-party service:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">down/http</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |width, height|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># generate the thumbnail using ImageOptim.com</span></span>
<span class="line"><span style="color:#F6F6F4">  down </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Down</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Http</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(method</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:post</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  down.download(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">https://im2.io/&lt;USERNAME&gt;/</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">width</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">x</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">height</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">/</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">source.url</span><span style="color:#F286C4">}</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="derivation-api">Derivation API<a href="#derivation-api" class="hash-link" aria-label="Direct link to Derivation API" title="Direct link to Derivation API">​</a></h2><p>In addition to generating derivation responses, it&#x27;s also possible to operate
with derivations on a lower level. You can access that API by calling
<code>UploadedFile#derivation</code>, which returns a <code>Derivation</code> object.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> uploaded_file.derivation(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">derivation </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::Derivation: @name=:thumbnail, @args=[500, 500] ...&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">derivation.name   </span><span style="color:#7B7F8B">#=&gt; :thumbnail</span></span>
<span class="line"><span style="color:#F6F6F4">derivation.args   </span><span style="color:#7B7F8B">#=&gt; [500, 500]</span></span>
<span class="line"><span style="color:#F6F6F4">derivation.source </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span></code></pre></div><p>When initializing the <code>Derivation</code> object you can override any plugin options:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.derivation(</span><span style="color:#BF9EEE">:grayscale</span><span style="color:#F6F6F4">, upload_storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:other_storage</span><span style="color:#F6F6F4">)</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="url"><code>#url</code><a href="#url" class="hash-link" aria-label="Direct link to url" title="Direct link to url">​</a></h3><p><code>Derivation#url</code> method (called by <code>UploadedFile#derivation_url</code>) generates the
URL to the derivation.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation.url </span><span style="color:#7B7F8B">#=&gt; &quot;/thumbnail/500/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="response"><code>#response</code><a href="#response" class="hash-link" aria-label="Direct link to response" title="Direct link to response">​</a></h3><p><code>Derivation#response</code> method (called by <code>UploadedFile#derivation_response</code>)
generates appropriate status, headers, and body for the derivative to be
returned as an HTTP response.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">status, headers, body </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivation.response</span></span>
<span class="line"><span style="color:#F6F6F4">status  </span><span style="color:#7B7F8B">#=&gt; 200</span></span>
<span class="line"><span style="color:#F6F6F4">headers </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;Content-Type&quot; =&gt; &quot;image/jpeg&quot;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;Content-Length&quot; =&gt; &quot;12424&quot;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;Content-Disposition&quot; =&gt; &quot;inline; filename=\&quot;thumbnail-500-500-k9f8sdksdfk2414\&quot;&quot;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;Accept_Ranges&quot; =&gt; &quot;bytes&quot;</span></span>
<span class="line"><span style="color:#7B7F8B"># }</span></span>
<span class="line"><span style="color:#F6F6F4">body    </span><span style="color:#7B7F8B">#=&gt; #each object that yields derivative content</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="processed"><code>#processed</code><a href="#processed" class="hash-link" aria-label="Direct link to processed" title="Direct link to processed">​</a></h3><p><code>Derivation#processed</code> method returns the processed derivative. If
<a href="#uploading"><code>:upload</code></a> is enabled, it returns a <code>Shrine::UploadedFile</code> object
pointing to the derivative, processing and uploading the derivative if it
hasn&#x27;t been already.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivation.processed</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file    </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.id </span><span style="color:#7B7F8B">#=&gt; &quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generate"><code>#generate</code><a href="#generate" class="hash-link" aria-label="Direct link to generate" title="Direct link to generate">​</a></h3><p><code>Derivation#generate</code> method calls the derivation block and returns the result.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">result </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivation.generate</span></span>
<span class="line"><span style="color:#F6F6F4">result </span><span style="color:#7B7F8B">#=&gt; #&lt;Tempfile:...&gt;</span></span></code></pre></div><p>Internally it will download the source uploaded file to disk and pass it to the
derivation block (unless <code>:download</code> was disabled). You can also pass in an
already downloaded source file:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation.generate(source_file)</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upload"><code>#upload</code><a href="#upload" class="hash-link" aria-label="Direct link to upload" title="Direct link to upload">​</a></h3><p><code>Derivation#upload</code> method uploads the given file to the configured derivation
location.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivation.upload(file)</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file    </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.id </span><span style="color:#7B7F8B">#=&gt; &quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;</span></span></code></pre></div><p>It can also be called without arguments, in which case it will generate a new
derivative and upload it.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation.upload </span><span style="color:#7B7F8B"># generates derivative and uploads it</span></span></code></pre></div><p>Any additional options will be passed to the uploader.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="retrieve"><code>#retrieve</code><a href="#retrieve" class="hash-link" aria-label="Direct link to retrieve" title="Direct link to retrieve">​</a></h3><p><code>Derivation#retrieve</code> method returns <code>Shrine::UploadedFile</code> object pointing to
the uploaded derivative if it exists. If the uploaded derivative does not
exist, <code>nil</code> is returned.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivation.retrieve</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file    </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.id </span><span style="color:#7B7F8B">#=&gt; &quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="opened"><code>#opened</code><a href="#opened" class="hash-link" aria-label="Direct link to opened" title="Direct link to opened">​</a></h3><p><code>Derivation#opened</code> method returns opened <code>Shrine::UploadedFile</code> object pointing
to the uploaded derivative if it exists. If the uploaded derivative does not
exist, <code>nil</code> is returned.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivation.opened</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file    </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.id </span><span style="color:#7B7F8B">#=&gt; &quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="delete"><code>#delete</code><a href="#delete" class="hash-link" aria-label="Direct link to delete" title="Direct link to delete">​</a></h3><p><code>Derivation#delete</code> method deletes the uploaded derivative file from the
storage.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation.delete</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="option"><code>#option</code><a href="#option" class="hash-link" aria-label="Direct link to option" title="Direct link to option">​</a></h3><p><code>Derivation#option</code> returns the value of the specified plugin option.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation.option(</span><span style="color:#BF9EEE">:upload_location</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;bcfd0d67e4a8ec2dc9a6d7ddcf3825a1/thumbnail-500-500&quot;</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="plugin-options">Plugin Options<a href="#plugin-options" class="hash-link" aria-label="Direct link to Plugin Options" title="Direct link to Plugin Options">​</a></h2><table><thead><tr><th align="left">Name</th><th align="left">Description</th><th align="left">Default</th></tr></thead><tbody><tr><td align="left"><code>:cache_control</code></td><td align="left">Hash of directives for the <code>Cache-Control</code> response header</td><td align="left"><code>{ public: true, max_age: 365*24*60*60 }</code></td></tr><tr><td align="left"><code>:disposition</code></td><td align="left">Whether the browser should attempt to render the derivative (<code>inline</code>) or prompt the user to download the file to disk (<code>attachment</code>)</td><td align="left"><code>inline</code></td></tr><tr><td align="left"><code>:download</code></td><td align="left">Whether the source uploaded file should be downloaded to disk when the derivation block is called</td><td align="left"><code>true</code></td></tr><tr><td align="left"><code>:download_options</code></td><td align="left">Additional options to pass when downloading the source uploaded file</td><td align="left"><code>{}</code></td></tr><tr><td align="left"><code>:expires_in</code></td><td align="left">Number of seconds after which the URL will not be available anymore</td><td align="left"><code>nil</code></td></tr><tr><td align="left"><code>:filename</code></td><td align="left">Filename the browser will assume when the derivative is downloaded to disk</td><td align="left"><code>&lt;name&gt;-&lt;args&gt;-&lt;source id basename&gt;</code></td></tr><tr><td align="left"><code>:host</code></td><td align="left">URL host to use when for URLs</td><td align="left"><code>nil</code></td></tr><tr><td align="left"><code>:metadata</code></td><td align="left">List of metadata keys the source uploaded file should include in the derivation block</td><td align="left"><code>[]</code></td></tr><tr><td align="left"><code>:prefix</code></td><td align="left">Path prefix added to the URLs</td><td align="left"><code>nil</code></td></tr><tr><td align="left"><code>:secret_key</code></td><td align="left">Key used to sign derivation URLs in order to prevent tampering</td><td align="left">required</td></tr><tr><td align="left"><code>:signer</code></td><td align="left">Proc accepting URL and query params used for custom signing of URLs.</td><td align="left"><code>nil</code></td></tr><tr><td align="left"><code>:type</code></td><td align="left">Media type returned in the <code>Content-Type</code> response header in the derivation response</td><td align="left">determined from derivative&#x27;s extension when possible</td></tr><tr><td align="left"><code>:upload</code></td><td align="left">Whether the generated derivatives will be cached on the storage</td><td align="left"><code>false</code></td></tr><tr><td align="left"><code>:upload_location</code></td><td align="left">Location to which the derivatives will be uploaded on the storage</td><td align="left"><code>&lt;source id&gt;/&lt;name&gt;-&lt;args&gt;</code></td></tr><tr><td align="left"><code>:upload_options</code></td><td align="left">Additional options to be passed when uploading derivatives</td><td align="left"><code>{}</code></td></tr><tr><td align="left"><code>:upload_open_options</code></td><td align="left">Additional options to be passed when downloading the uploaded derivative</td><td align="left"><code>{}</code></td></tr><tr><td align="left"><code>:upload_redirect</code></td><td align="left">Whether the derivation response should redirect to the uploaded derivative</td><td align="left"><code>false</code></td></tr><tr><td align="left"><code>:upload_redirect_url_options</code></td><td align="left">Additional options to be passed when generating the URL for the uploaded derivative</td><td align="left"><code>{}</code></td></tr><tr><td align="left"><code>:upload_storage</code></td><td align="left">Storage to which the derivations will be uploaded</td><td align="left">same storage as the source file</td></tr><tr><td align="left"><code>:version</code></td><td align="left">Version number to append to the URL for cache busting</td><td align="left"><code>nil</code></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="instrumentation">Instrumentation<a href="#instrumentation" class="hash-link" aria-label="Direct link to Instrumentation" title="Direct link to Instrumentation">​</a></h2><p>If the <code>instrumentation</code> plugin has been loaded, the <code>determine_mime_type</code> plugin
adds instrumentation around derivation processing.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># instrumentation plugin needs to be loaded *before* derivation_endpoint</span></span>
<span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:instrumentation</span></span>
<span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span></span></code></pre></div><p>Derivation processing will trigger a <code>derivation.shrine</code> event with the
following payload:</p><table><thead><tr><th align="left">Key</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>:derivation</code></td><td align="left"><code>Shrine::Derivation</code> object for this processing</td></tr><tr><td align="left"><code>:uploader</code></td><td align="left">The uploader class that sent the event</td></tr></tbody></table><p>A default log subscriber is added as well which logs these events:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Derivation (492ms) – {:name=&gt;:thumbnail, :args=&gt;[600, 600], :uploader=&gt;Shrine}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>You can also use your own log subscriber:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, log_subscriber</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (event) {</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.logger.info </span><span style="color:#97E1F1;font-style:italic">JSON</span><span style="color:#F6F6F4">.generate(</span></span>
<span class="line"><span style="color:#F6F6F4">    name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     event.name,</span></span>
<span class="line"><span style="color:#F6F6F4">    duration</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> event.duration,</span></span>
<span class="line"><span style="color:#F6F6F4">    name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     event[</span><span style="color:#BF9EEE">:derivation</span><span style="color:#F6F6F4">].name,</span></span>
<span class="line"><span style="color:#F6F6F4">    args</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     event[</span><span style="color:#BF9EEE">:derivation</span><span style="color:#F6F6F4">].args,</span></span>
<span class="line"><span style="color:#F6F6F4">  )</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">{&quot;name&quot;:&quot;derivation&quot;,&quot;duration&quot;:492,&quot;name&quot;:&quot;thumbnail&quot;,&quot;args&quot;:[600,600],&quot;uploader&quot;:&quot;Shrine&quot;}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or disable logging altogether:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, log_subscriber</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span></span></code></pre></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/plugins/derivation_endpoint.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-07-06T11:58:41.000Z">Jul 6, 2023</time></b> by <b>Janko Marohnić</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/plugins/upload_endpoint"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Upload Endpoint</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/plugins/derivatives"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Derivatives</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#quick-start" class="table-of-contents__link toc-highlight">Quick start</a></li><li><a href="#how-it-works" class="table-of-contents__link toc-highlight">How it works</a><ul><li><a href="#performance" class="table-of-contents__link toc-highlight">Performance</a></li></ul></li><li><a href="#derivation-response" class="table-of-contents__link toc-highlight">Derivation response</a></li><li><a href="#dynamic-settings" class="table-of-contents__link toc-highlight">Dynamic settings</a></li><li><a href="#host" class="table-of-contents__link toc-highlight">Host</a></li><li><a href="#prefix" class="table-of-contents__link toc-highlight">Prefix</a></li><li><a href="#expiration" class="table-of-contents__link toc-highlight">Expiration</a></li><li><a href="#custom-signer" class="table-of-contents__link toc-highlight">Custom signer</a></li><li><a href="#response-headers" class="table-of-contents__link toc-highlight">Response headers</a><ul><li><a href="#content-type" class="table-of-contents__link toc-highlight">Content Type</a></li><li><a href="#content-disposition" class="table-of-contents__link toc-highlight">Content Disposition</a></li><li><a href="#cache-control" class="table-of-contents__link toc-highlight">Cache Control</a></li></ul></li><li><a href="#uploading" class="table-of-contents__link toc-highlight">Uploading</a><ul><li><a href="#upload-location" class="table-of-contents__link toc-highlight">Upload location</a></li><li><a href="#upload-storage" class="table-of-contents__link toc-highlight">Upload storage</a></li><li><a href="#upload-options" class="table-of-contents__link toc-highlight">Upload options</a></li><li><a href="#upload-open-options" class="table-of-contents__link toc-highlight">Upload open options</a></li><li><a href="#redirecting" class="table-of-contents__link toc-highlight">Redirecting</a></li><li><a href="#deleting-derivatives" class="table-of-contents__link toc-highlight">Deleting derivatives</a></li></ul></li><li><a href="#cache-busting" class="table-of-contents__link toc-highlight">Cache busting</a></li><li><a href="#accessing-source-file" class="table-of-contents__link toc-highlight">Accessing source file</a></li><li><a href="#downloading" class="table-of-contents__link toc-highlight">Downloading</a><ul><li><a href="#skipping-download" class="table-of-contents__link toc-highlight">Skipping download</a></li></ul></li><li><a href="#derivation-api" class="table-of-contents__link toc-highlight">Derivation API</a><ul><li><a href="#url" class="table-of-contents__link toc-highlight"><code>#url</code></a></li><li><a href="#response" class="table-of-contents__link toc-highlight"><code>#response</code></a></li><li><a href="#processed" class="table-of-contents__link toc-highlight"><code>#processed</code></a></li><li><a href="#generate" class="table-of-contents__link toc-highlight"><code>#generate</code></a></li><li><a href="#upload" class="table-of-contents__link toc-highlight"><code>#upload</code></a></li><li><a href="#retrieve" class="table-of-contents__link toc-highlight"><code>#retrieve</code></a></li><li><a href="#opened" class="table-of-contents__link toc-highlight"><code>#opened</code></a></li><li><a href="#delete" class="table-of-contents__link toc-highlight"><code>#delete</code></a></li><li><a href="#option" class="table-of-contents__link toc-highlight"><code>#option</code></a></li></ul></li><li><a href="#plugin-options" class="table-of-contents__link toc-highlight">Plugin Options</a></li><li><a href="#instrumentation" class="table-of-contents__link toc-highlight">Instrumentation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b0f70eb.js"></script>
<script src="/assets/js/main.ea4eabff.js"></script>
</body>
</html>