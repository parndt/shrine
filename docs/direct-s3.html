<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-direct-s3">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Direct Uploads to S3 | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/direct-s3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Direct Uploads to S3 | Shrine"><meta data-rh="true" name="description" content="Shrine gives you the ability to upload files directly to Amazon S3 (or any"><meta data-rh="true" property="og:description" content="Shrine gives you the ability to upload files directly to Amazon S3 (or any"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/direct-s3"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/direct-s3" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/direct-s3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.9151cbe8.js" as="script">
<link rel="preload" href="/assets/js/main.73137c51.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a class="navbar__item navbar__link" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a class="navbar__item navbar__link" href="/docs/release_notes/3.6.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/advantages">Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advantages">Advantages of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/design">Base</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">The Design of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/attacher">Using Attacher</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/storage/file-system">Storage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/file-system">File System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/s3">AWS S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/memory">Memory</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/direct-s3">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/metadata">Extracting Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing">File Processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/validation">File Validation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/multiple-files">Extras</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/multiple-files">Multiple Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/securing-uploads">Securing Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing">Testing with Shrine</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/changing-derivatives">Migrating</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-location">Migrating File Locations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-storage">Migrating File Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/creating-plugins">Extending</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-storages">Writing a Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/upgrading-to-3">Upgrading</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/refile">Upgrading from Refile</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Direct Uploads to S3</h1></header><p>Shrine gives you the ability to upload files directly to Amazon S3 (or any
other storage service that accepts direct uploads). Uploading directly to a
storage service is beneficial for several reasons:</p><ul><li><p>Accepting uploads is resource-intensive for the server, and delegating it to
an external service makes scaling easier.</p></li><li><p>If both temporary and permanent storage are S3, promoting an S3 file to
permanent storage will simply issue an S3 copy request, without any
downloading and reuploading.</p></li><li><p>With multiple servers it&#x27;s generally not possible to cache files to the disk,
unless you&#x27;re using a distibuted filesystem that&#x27;s shared between servers.</p></li><li><p>On Heroku any uploaded files that aren&#x27;t part of version control don&#x27;t persist,
they get removed each time you do a new deploy or when the dyno automatically
changes the location.</p></li><li><p>If your request workers have a timeout configured or you&#x27;re using Heroku,
uploading large files to S3 or any external service inside the
request-response lifecycle might not be able to finish before the request
times out.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="storage">Storage<a href="#storage" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h2><p>To start, let&#x27;s set both temporary and permanent storage to S3, with the
temporary storage uploading to the <code>cache/</code> prefix:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 3.0</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">aws-sdk-s3</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 1.14</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine/storage/s3</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">s3_options </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  bucket</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR BUCKET&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#7B7F8B"># required</span></span>
<span class="line"><span style="color:#F6F6F4">  access_key_id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR KEY&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  secret_access_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR SECRET&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  region</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;REGION&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">s3_options),</span></span>
<span class="line"><span style="color:#F6F6F4">  store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">s3_options),</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bucket-cors-configuration">Bucket CORS configuration<a href="#bucket-cors-configuration" class="hash-link" aria-label="Direct link to Bucket CORS configuration" title="Direct link to Bucket CORS configuration">​</a></h2><p>In order to be able upload files directly to your S3 bucket, you&#x27;ll need to
update your bucket&#x27;s CORS configuration, as public uploads are not allowed by
default. You can do that from the AWS S3 Console by going to your bucket,
clicking on the &quot;Permissions&quot; tab and then on &quot;CORS Configuration&quot;.</p><p>If you&#x27;re using <a href="https://uppy.io" target="_blank" rel="noopener noreferrer">Uppy</a>, this is the recommended CORS configuration for the
<a href="https://uppy.io/docs/aws-s3/" target="_blank" rel="noopener noreferrer">AWS S3 plugin</a> that should work for both POST and PUT uploads:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">&lt;?</span><span style="color:#F286C4">xml</span><span style="color:#62E884;font-style:italic"> version</span><span style="color:#F6F6F4">=</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">1.0</span><span style="color:#DEE492">&quot;</span><span style="color:#62E884;font-style:italic"> encoding</span><span style="color:#F6F6F4">=</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">UTF-8</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">?&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">&lt;</span><span style="color:#F286C4">CORSConfiguration</span><span style="color:#F6F6F4"> </span><span style="color:#62E884;font-style:italic">xmlns</span><span style="color:#F6F6F4">=</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">http://s3.amazonaws.com/doc/2006-03-01/</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  &lt;</span><span style="color:#F286C4">CORSRule</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedOrigin</span><span style="color:#F6F6F4">&gt;https://my-app.com&lt;/</span><span style="color:#F286C4">AllowedOrigin</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;GET&lt;/</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;POST&lt;/</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;PUT&lt;/</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">MaxAgeSeconds</span><span style="color:#F6F6F4">&gt;3000&lt;/</span><span style="color:#F286C4">MaxAgeSeconds</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;Authorization&lt;/</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;x-amz-date&lt;/</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;x-amz-content-sha256&lt;/</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;content-type&lt;/</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;content-disposition&lt;/</span><span style="color:#F286C4">AllowedHeader</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">ExposeHeader</span><span style="color:#F6F6F4">&gt;ETag&lt;/</span><span style="color:#F286C4">ExposeHeader</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  &lt;/</span><span style="color:#F286C4">CORSRule</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  &lt;</span><span style="color:#F286C4">CORSRule</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedOrigin</span><span style="color:#F6F6F4">&gt;*&lt;/</span><span style="color:#F286C4">AllowedOrigin</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;GET&lt;/</span><span style="color:#F286C4">AllowedMethod</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">    &lt;</span><span style="color:#F286C4">MaxAgeSeconds</span><span style="color:#F6F6F4">&gt;3000&lt;/</span><span style="color:#F286C4">MaxAgeSeconds</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  &lt;/</span><span style="color:#F286C4">CORSRule</span><span style="color:#F6F6F4">&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">&lt;/</span><span style="color:#F286C4">CORSConfiguration</span><span style="color:#F6F6F4">&gt;</span></span></code></pre></div><p>Or in JSON format:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">[</span></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">AllowedOrigins</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [ </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">https://my-app.com</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> ],</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">AllowedMethods</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [ </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">GET</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">POST</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">PUT</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> ],</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">MaxAgeSeconds</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">3000</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">AllowedHeaders</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span></span>
<span class="line"><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Authorization</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">x-amz-date</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">x-amz-content-sha256</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Content-Type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Content-Disposition</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">        ],</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">ExposeHeaders</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [ </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">ETag</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> ]</span></span>
<span class="line"><span style="color:#F6F6F4">    },</span></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">AllowedOrigins</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [ </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">*</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> ],</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">AllowedMethods</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [ </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">GET</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> ],</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#97E2F2">&quot;</span><span style="color:#97E1F1">MaxAgeSeconds</span><span style="color:#97E2F2">&quot;</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">3000</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F6F6F4">]</span></span></code></pre></div><p>Replace <code>https://my-app.com</code> with the URL to your app (in development you can
set this to <code>*</code>). Once you&#x27;ve hit &quot;Save&quot;, it may take some time for the
new CORS settings to be applied.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="strategy-a-dynamic">Strategy A (dynamic)<a href="#strategy-a-dynamic" class="hash-link" aria-label="Direct link to Strategy A (dynamic)" title="Direct link to Strategy A (dynamic)">​</a></h2><ul><li>Best user experience</li><li>Single or multiple file uploads</li><li>Some JavaScript needed</li></ul><p>When the user selects a file in the form, on the client side we asynchronously
fetch the upload parameters from the server, and use it to upload the file to
S3. It&#x27;s recommended to use <a href="https://uppy.io" target="_blank" rel="noopener noreferrer">Uppy</a> for client side uploads.</p><p>The <code>presign_endpoint</code> plugin provides a Rack application that generates these
upload parameters, which we can just mount in our application. We&#x27;ll make our
presign endpoint also use the additional <code>type</code> and <code>filename</code> query parameters
to set <code>Content-Type</code> header, <code>Content-Disposition</code> header (using the
<a href="https://github.com/shrinerb/content_disposition" target="_blank" rel="noopener noreferrer">content_disposition</a> gem), as well as limit the upload size to 10 MB (see
<a href="https://shrinerb.com/rdoc/classes/Shrine/Storage/S3.html#method-i-presign" target="_blank" rel="noopener noreferrer"><code>Shrine::Storage::S3#presign</code></a> for the list of available options).</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:presign_endpoint</span><span style="color:#F6F6F4">, presign_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (request) {</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># Uppy will send the &quot;filename&quot; and &quot;type&quot; query parameters</span></span>
<span class="line"><span style="color:#F6F6F4">  filename </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> request.params[</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">]</span></span>
<span class="line"><span style="color:#F6F6F4">  type     </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> request.params[</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  {</span></span>
<span class="line"><span style="color:#F6F6F4">    content_disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">ContentDisposition</span><span style="color:#F6F6F4">.inline(filename), </span><span style="color:#7B7F8B"># set download filename</span></span>
<span class="line"><span style="color:#F6F6F4">    content_type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">           type,                                </span><span style="color:#7B7F8B"># set content type (required if using DigitalOcean Spaces)</span></span>
<span class="line"><span style="color:#F6F6F4">    content_length_range</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">   </span><span style="color:#BF9EEE">0</span><span style="color:#F6F6F4">..(</span><span style="color:#BF9EEE">10</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span><span style="color:#F6F6F4">),                   </span><span style="color:#7B7F8B"># limit upload size to 10 MB</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb (Rails)</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  mount </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.presign_endpoint(</span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/s3/params</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>The above will create a <code>GET /s3/params</code> route, which internally calls
<a href="https://shrinerb.com/rdoc/classes/Shrine/Storage/S3.html#method-i-presign" target="_blank" rel="noopener noreferrer"><code>Shrine::Storage::S3#presign</code></a> to return the HTTP verb (POST) and the S3 URL
to which the file should be uploaded, along with the required POST parameters
and request headers.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># GET /s3/params</span></span>
<span class="line"><span style="color:#F6F6F4">{</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">method</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">post</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">url</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">https://my-bucket.s3-eu-west-1.amazonaws.com</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">fields</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: {</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">key</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">b7d575850ba61b44c8a9ff889dfdb14d88cdc25f8dd121004c8</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">policy</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">eyJleHBpcmF0aW9uIjoiMjAxNS0QwMToxMToyOVoiLCJjb25kaXRpb25zIjpbeyJidWNrZXQiOiJ...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">x-amz-credential</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">AKIAIJF55TMZYT6Q/20151024/eu-west-1/s3/aws4_request</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">x-amz-algorithm</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">AWS4-HMAC-SHA256</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">x-amz-date</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">20151024T001129Z</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">x-amz-signature</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">c1eb634f83f96b69bd675f535b3ff15ae184b102fcba51e4db5f4959b4ae26f4</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  },</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">headers</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: {}</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><p>Uppy&#x27;s <a href="https://uppy.io/docs/aws-s3/" target="_blank" rel="noopener noreferrer">AWS S3</a> plugin would then make a request to this endpoint
and use these parameters to upload the file directly to S3. Once the file has
been uploaded, you can generate a JSON representation of the uploaded file on
the client side, and write it to the hidden attachment field (or send it
directly in an AJAX request).</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">{</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">302858ldg9agjad7f3ls.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: {</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#BF9EEE">943483</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">nature.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">mime_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image/jpeg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><ul><li><code>id</code> – location of the file on S3 (minus the <code>:prefix</code>)</li><li><code>storage</code> – direct uploads typically use the <code>:cache</code> storage</li><li><code>metadata</code> – hash of metadata extracted from the file</li></ul><p>Once the form is submitted, this JSON data will then be assigned to the
attachment attribute instead of the raw file. See <a href="https://github.com/shrinerb/shrine/wiki/Adding-Direct-S3-Uploads" target="_blank" rel="noopener noreferrer">this walkthrough</a> for adding dynamic direct S3 uploads from scratch, as well
as the <a href="https://github.com/shrinerb/shrine/tree/master/demo" target="_blank" rel="noopener noreferrer">Roda</a> / <a href="https://github.com/erikdahlstrand/shrine-rails-example" target="_blank" rel="noopener noreferrer">Rails</a> demo app for a complete example
of multiple direct S3 uploads.</p><p>Also, if you&#x27;re dealing with larger files, you may want to make the uploads
resumable by using the <a href="https://uppy.io/docs/aws-s3/" target="_blank" rel="noopener noreferrer">AWS S3 Multipart</a> Uppy plugin
instead, with the <a href="https://github.com/janko/uppy-s3_multipart" target="_blank" rel="noopener noreferrer">uppy-s3_multipart</a> gem on the backend. Your back-end
implementation is similar, just using <code>Shrine.uppy_s3_multipart</code> in place of
<code>Shrine.presign_endpoint</code>. Instructions can be found in the <a href="https://github.com/janko/uppy-s3_multipart#shrine" target="_blank" rel="noopener noreferrer">gem
docs</a>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="strategy-b-static">Strategy B (static)<a href="#strategy-b-static" class="hash-link" aria-label="Direct link to Strategy B (static)" title="Direct link to Strategy B (static)">​</a></h2><ul><li>Basic user experience</li><li>Only for single uploads</li><li>No JavaScript needed</li></ul><p>An alternative to the previous strategy is to generate an S3 upload form on
page render. The user can then select a file and submit it directly to S3. For
generating the form can use <a href="https://shrinerb.com/rdoc/classes/Shrine/Storage/S3.html#method-i-presign" target="_blank" rel="noopener noreferrer"><code>Shrine::Storage::S3#presign</code></a>, which returns URL
and form fields that should be used for the upload.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">presign_data </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">].presign(</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">SecureRandom</span><span style="color:#F6F6F4">.hex,</span></span>
<span class="line"><span style="color:#F6F6F4">  success_action_redirect</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> new_album_url</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">form action</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> presign_data[</span><span style="color:#BF9EEE">:url</span><span style="color:#F6F6F4">], method</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">post</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, enctype</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">multipart/form-data</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |f|</span></span>
<span class="line"><span style="color:#F6F6F4">  presign_data[</span><span style="color:#BF9EEE">:fields</span><span style="color:#F6F6F4">].each </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |name, value|</span></span>
<span class="line"><span style="color:#F6F6F4">    f.input </span><span style="color:#BF9EEE">:hidden</span><span style="color:#F6F6F4">, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, value</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> value</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  f.input </span><span style="color:#BF9EEE">:file</span><span style="color:#F6F6F4">, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">file</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  f.button </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Submit</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Note the additional <code>:success_action_redirect</code> option which tells S3 where to
redirect to after the file has been uploaded. If you&#x27;re using the Rails form
builder to generate this form, you might need to also tell S3 to ignore the
additional <code>utf8</code> and <code>authenticity_token</code> fields that Rails generates:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">presign_data </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">].presign(</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">SecureRandom</span><span style="color:#F6F6F4">.hex,</span></span>
<span class="line"><span style="color:#F6F6F4">  allow_any</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">utf8</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">authenticity_token</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  success_action_redirect</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> new_album_url</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># ...</span></span></code></pre></div><p>Let&#x27;s assume we specified the redirect URL to be a page which renders the form
for a new record. S3 will include some information about the upload in form of
GET parameters in the URL, out of which we only need the <code>key</code> parameter:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">cached_file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> params[</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">key</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">][</span><span style="color:#E7EE98">/^cache</span><span style="color:#F286C4">\/</span><span style="color:#E7EE98">(.+)/</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">1</span><span style="color:#F6F6F4">], </span><span style="color:#7B7F8B"># we subtract the storage prefix</span></span>
<span class="line"><span style="color:#F6F6F4">  metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {},</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">form </span><span style="color:#BF9EEE;font-style:italic">@album</span><span style="color:#F6F6F4">, action</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/albums</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |f|</span></span>
<span class="line"><span style="color:#F6F6F4">  f.input </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">, type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:hidden</span><span style="color:#F6F6F4">, value</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> cached_file.to_json</span></span>
<span class="line"><span style="color:#F6F6F4">  f.button </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Save</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="shrine-metadata">Shrine metadata<a href="#shrine-metadata" class="hash-link" aria-label="Direct link to Shrine metadata" title="Direct link to Shrine metadata">​</a></h2><p>When attaching a file that was uploaded directly to S3, by default Shrine will
not extract metadata from the file, instead it will simply copy over any
metadata assigned on the client side. This is the default behaviour because
extracting metadata requires retrieving file content, which in this case means
additional HTTP requests.</p><p>See <a href="https://shrinerb.com/docs/metadata#direct-uploads" target="_blank" rel="noopener noreferrer">this section</a> or the rationale and instructions
on how to opt in.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="clearing-cache">Clearing cache<a href="#clearing-cache" class="hash-link" aria-label="Direct link to Clearing cache" title="Direct link to Clearing cache">​</a></h2><p>Directly uploaded files won&#x27;t automatically be deleted from your temporary
storage, so you&#x27;ll want to periodically clear them. One way to do that is
by setting up recurring script which calls <code>Shrine::Storage::S3#clear!</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">s3 </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">]</span></span>
<span class="line"><span style="color:#F6F6F4">s3.clear! { |object| object.last_modified </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Time</span><span style="color:#F6F6F4">.now </span><span style="color:#F286C4">-</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">7</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">24</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">60</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">60</span><span style="color:#F6F6F4"> } </span><span style="color:#7B7F8B"># delete files older than 1 week</span></span></code></pre></div><p>Alternatively you can add a bucket lifeycle rule to do this for you. This can
be done either from the <a href="http://docs.aws.amazon.com/AmazonS3/latest/UG/lifecycle-configuration-bucket-no-versioning.html" target="_blank" rel="noopener noreferrer">AWS Console</a> or via an <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/S3/Client.html#put_bucket_lifecycle_configuration-instance_method" target="_blank" rel="noopener noreferrer">API
call</a>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">aws-sdk-s3</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">client </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Aws</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Client</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span></span>
<span class="line"><span style="color:#F6F6F4">  access_key_id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR KEY&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  secret_access_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR SECRET&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  region</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;REGION&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">client.put_bucket_lifecycle_configuration(</span></span>
<span class="line"><span style="color:#F6F6F4">  bucket</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR BUCKET&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  lifecycle_configuration</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">    rules</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [{</span></span>
<span class="line"><span style="color:#F6F6F4">      expiration</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { days</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">7</span><span style="color:#F6F6F4"> },</span></span>
<span class="line"><span style="color:#F6F6F4">      filter</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache/</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> },</span></span>
<span class="line"><span style="color:#F6F6F4">      id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache-clear</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      status</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Enabled</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">    }]</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eventual-consistency">Eventual consistency<a href="#eventual-consistency" class="hash-link" aria-label="Direct link to Eventual consistency" title="Direct link to Eventual consistency">​</a></h2><p>When uploading objects to Amazon S3, sometimes they may not be available
immediately. This can be a problem when using direct S3 uploads, because
usually in this case you&#x27;re using S3 for both cache and store, so the S3 object
is moved to store soon after caching.</p><blockquote><p>Amazon S3 provides eventual consistency for some operations, so it is
possible that new data will not be available immediately after the upload,
which could result in an incomplete data load or loading stale data. COPY
operations where the cluster and the bucket are in different regions are
eventually consistent. All regions provide read-after-write consistency for
uploads of new objects with unique object keys. For more information about
data consistency, see <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html#ConsistencyMode" target="_blank" rel="noopener noreferrer">Amazon S3 Data Consistency Model</a> in the <em>Amazon Simple
Storage Service Developer Guide</em>.</p></blockquote><p>This means that in certain cases copying from cache to store can fail if it
happens immediately after uploading to cache. If you start noticing these
errors, and you&#x27;re using <code>backgrounding</code> plugin, you can tell your
backgrounding library to perform the job with a delay:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:backgrounding</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.promote_block </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># tells a Sidekiq worker to perform in 3 seconds</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">PromoteJob</span><span style="color:#F6F6F4">.perform_in(</span><span style="color:#BF9EEE">3</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.class.name, record.class.name, record.id, name, file_data)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="checksums">Checksums<a href="#checksums" class="hash-link" aria-label="Direct link to Checksums" title="Direct link to Checksums">​</a></h2><p>You can have AWS S3 verify the integrity of the uploaded data by including a
checksum generated on the client side in the upload request. For that we&#x27;ll
need to include the checksum in the presign request, which we can pass in via
the <code>checksum</code> query parameter. The <code>:content_md5</code> parameter is not supported
in POST presigns, so for this we&#x27;ll need to switch to PUT.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:presign_endpoint</span><span style="color:#F6F6F4">, presign_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (request) </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  {</span></span>
<span class="line"><span style="color:#F6F6F4">    method</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:put</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    content_md5</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> request.params[</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">checksum</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>See <a href="https://github.com/shrinerb/shrine/wiki/Using-Checksums-in-Direct-Uploads" target="_blank" rel="noopener noreferrer">this walkthrough</a> for a complete JavaScript
implementation of checksums.</p><p>Note that PUT presigns don&#x27;t support the <code>:content_length_range</code> option, but
they support <code>:content_length</code> instead. So, if you want to limit the upload
size during direct uploads, you can pass an additional <code>size</code> query parameter
to the presign request on the client side, and require it when generating
presign options:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:presign_endpoint</span><span style="color:#F6F6F4">, presign_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (request) </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  {</span></span>
<span class="line"><span style="color:#F6F6F4">    method</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:put</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    content_length</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> request.params.fetch(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">    content_md5</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> request.params[</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">checksum</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing<a href="#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h2><p>To avoid network requests in your test and development environment, you can use
<a href="https://minio.io" target="_blank" rel="noopener noreferrer">Minio</a>. Minio is an open source object storage server with AWS S3 compatible
API which you can run locally. See how to set it up in the <a href="https://shrinerb.com/docs/testing#minio" target="_blank" rel="noopener noreferrer">Testing</a> guide.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/direct_s3.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-06-14T21:14:24.000Z">Jun 14, 2021</time></b> by <b>Janko Marohnić</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/storage/memory"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Memory</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/metadata"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Extracting Metadata</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#storage" class="table-of-contents__link toc-highlight">Storage</a></li><li><a href="#bucket-cors-configuration" class="table-of-contents__link toc-highlight">Bucket CORS configuration</a></li><li><a href="#strategy-a-dynamic" class="table-of-contents__link toc-highlight">Strategy A (dynamic)</a></li><li><a href="#strategy-b-static" class="table-of-contents__link toc-highlight">Strategy B (static)</a></li><li><a href="#shrine-metadata" class="table-of-contents__link toc-highlight">Shrine metadata</a></li><li><a href="#clearing-cache" class="table-of-contents__link toc-highlight">Clearing cache</a></li><li><a href="#eventual-consistency" class="table-of-contents__link toc-highlight">Eventual consistency</a></li><li><a href="#checksums" class="table-of-contents__link toc-highlight">Checksums</a></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9151cbe8.js"></script>
<script src="/assets/js/main.73137c51.js"></script>
</body>
</html>