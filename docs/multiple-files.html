<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-multiple-files">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Multiple Files | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/multiple-files"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Multiple Files | Shrine"><meta data-rh="true" name="description" content="There are times when you want to allow users to attach multiple files to a"><meta data-rh="true" property="og:description" content="There are times when you want to allow users to attach multiple files to a"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/multiple-files"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/multiple-files" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/multiple-files" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.3b0f70eb.js" as="script">
<link rel="preload" href="/assets/js/main.c75c1b94.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a class="navbar__item navbar__link" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a class="navbar__item navbar__link" href="/docs/release_notes/3.5.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/advantages">Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advantages">Advantages of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/design">Base</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">The Design of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/attacher">Using Attacher</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/storage/file-system">Storage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/file-system">File System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/s3">AWS S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/memory">Memory</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/direct-s3">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/metadata">Extracting Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing">File Processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/validation">File Validation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/multiple-files">Extras</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/multiple-files">Multiple Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/securing-uploads">Securing Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing">Testing with Shrine</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/changing-derivatives">Migrating</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-location">Migrating File Locations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-storage">Migrating File Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/creating-plugins">Extending</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-storages">Writing a Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/upgrading-to-3">Upgrading</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/refile">Upgrading from Refile</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Multiple Files</h1></header><p>There are times when you want to allow users to attach multiple files to a
single resource, like an album having many photos or a playlist having many
songs. Some file attachment libraries provide a special interface for multiple
attachments, but Shrine doesn&#x27;t have one, because it&#x27;s more flexible to use
the &quot;nested attributes&quot; feature of your ORM directly to implement this.</p><p>The basic idea is to create a separate table that will have a many-to-one
relationship with the main table, and files will be attached on the records in
the new table. That way each record from the main table can implicitly have
multiple attachments through the associated records.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">album1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  photo1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - attachment1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  photo2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - attachment2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  photo3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - attachment3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">album2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  photo4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - attachment4</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  photo5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - attachment5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To illustrate, this code will create an album with three photos using nested
attributes:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Album</span><span style="color:#F6F6F4">.create(</span></span>
<span class="line"><span style="color:#F6F6F4">  title</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">My Album</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  photos_attributes</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span></span>
<span class="line"><span style="color:#F6F6F4">    { image</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">File</span><span style="color:#F6F6F4">.</span><span style="color:#97E1F1">open</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image1.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, binmode</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">) },</span></span>
<span class="line"><span style="color:#F6F6F4">    { image</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">File</span><span style="color:#F6F6F4">.</span><span style="color:#97E1F1">open</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image2.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, binmode</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">) },</span></span>
<span class="line"><span style="color:#F6F6F4">    { image</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">File</span><span style="color:#F6F6F4">.</span><span style="color:#97E1F1">open</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image3.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, binmode</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">) },</span></span>
<span class="line"><span style="color:#F6F6F4">  ]</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><p>This design gives you the greatest flexibility, allowing you to support:</p><ul><li>adding new attachments</li><li>updating existing attachments</li><li>removing existing attachments</li><li>sorting attachments (via a separate position column)</li><li>having additional fields on attachments (e.g. captions, votes, number of downloads etc.)</li><li>expanding this to be &quot;many-to-many&quot; relation (e.g. create different playlists from a list of songs, etc)</li><li>...</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-implement">How to Implement<a href="#how-to-implement" class="hash-link" aria-label="Direct link to How to Implement" title="Direct link to How to Implement">​</a></h2><p>For the rest of this guide, we will use the example where we have &quot;albums&quot; that
can have multiple &quot;photos&quot; in it. The main table is the albums table and the
files (or attachments) table will be the photos table.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-create-the-main-resource-and-attachment-table">1. Create the main resource and attachment table<a href="#1-create-the-main-resource-and-attachment-table" class="hash-link" aria-label="Direct link to 1. Create the main resource and attachment table" title="Direct link to 1. Create the main resource and attachment table">​</a></h3><p>Let&#x27;s create a table for the main resource and attachments, and add a foreign
key in the attachment table for the main table:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Sequel</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Active Record</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Sequel</span><span style="color:#F6F6F4">.migration </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  change </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    create_table </span><span style="color:#BF9EEE">:albums</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">      primary_key </span><span style="color:#BF9EEE">:id</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      </span><span style="color:#BF9EEE">String</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:title</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    create_table </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">      primary_key </span><span style="color:#BF9EEE">:id</span></span>
<span class="line"><span style="color:#F6F6F4">      foreign_key </span><span style="color:#BF9EEE">:album_id</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:albums</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      </span><span style="color:#BF9EEE">String</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:image_data</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">CreateAlbumsAndPhotos</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Migration</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">change</span></span>
<span class="line"><span style="color:#F6F6F4">    create_table </span><span style="color:#BF9EEE">:albums</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |t|</span></span>
<span class="line"><span style="color:#F6F6F4">      t.string     </span><span style="color:#BF9EEE">:title</span></span>
<span class="line"><span style="color:#F6F6F4">      t.timestamps</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    create_table </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |t|</span></span>
<span class="line"><span style="color:#F6F6F4">      t.references </span><span style="color:#BF9EEE">:album</span><span style="color:#F6F6F4">, foreign_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span>
<span class="line"><span style="color:#F6F6F4">      t.text       </span><span style="color:#BF9EEE">:image_data</span></span>
<span class="line"><span style="color:#F6F6F4">      t.timestamps</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div></div></div><p>In the Photo model, create a Shrine attachment attribute named <code>image</code>
(<code>:image</code> matches the <code>_data</code> column prefix above):</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Sequel</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Active Record</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sequel::Model</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-declare-nested-attributes">2. Declare nested attributes<a href="#2-declare-nested-attributes" class="hash-link" aria-label="Direct link to 2. Declare nested attributes" title="Direct link to 2. Declare nested attributes">​</a></h3><p>Using nested attributes is the easiest way to implement any dynamic
&quot;one-to-many&quot; association. In the Album model we&#x27;ll declare a one-to-many
relationship to the photos table, and allow it to directly accept attributes
for the associated photo records by enabling nested attributes:</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Sequel</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Active Record</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Mongoid</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Album</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sequel::Model</span></span>
<span class="line"><span style="color:#F6F6F4">  one_to_many </span><span style="color:#BF9EEE">:photos</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:association_dependencies</span><span style="color:#F6F6F4">, photos</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:destroy</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># destroy photos when album is destroyed</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:nested_attributes</span></span>
<span class="line"><span style="color:#F6F6F4">  nested_attributes </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, destroy</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Album</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  has_many </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, dependent</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:destroy</span></span>
<span class="line"><span style="color:#F6F6F4">  accepts_nested_attributes_for </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, allow_destroy</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Album</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Mongoid</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Document</span></span>
<span class="line"><span style="color:#F6F6F4">  embeds_many </span><span style="color:#BF9EEE">:photos</span></span>
<span class="line"><span style="color:#F6F6F4">  accepts_nested_attributes_for </span><span style="color:#BF9EEE">:photos</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div></div></div><p>Documentation on nested attributes:</p><ul><li><a href="http://sequel.jeremyevans.net/rdoc-plugins/classes/Sequel/Plugins/NestedAttributes.html" target="_blank" rel="noopener noreferrer"><code>Sequel::Model.nested_attributes</code></a></li><li><a href="http://api.rubyonrails.org/classes/ActiveRecord/NestedAttributes/ClassMethods.html" target="_blank" rel="noopener noreferrer"><code>ActiveRecord::Base.accepts_nested_attributes_for</code></a></li><li><a href="https://docs.mongodb.com/mongoid/master/tutorials/mongoid-nested-attributes/" target="_blank" rel="noopener noreferrer"><code>Mongoid::Document.accepts_nested_attributes_for</code></a></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-create-the-view">3. Create the View<a href="#3-create-the-view" class="hash-link" aria-label="Direct link to 3. Create the View" title="Direct link to 3. Create the View">​</a></h3><p>Create a form like you normally do to create the album. To this form we&#x27;ll add
a file field for selecting photos, which will have <code>multiple</code> attribute to
allow the user to select multiple files. We&#x27;ll also display nested fields for
already created photos, so that the same form can be used for updating the
album/photos as well (they will be submitted under the
<code>album[photos_attributes]</code> parameter).</p><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Rails form builder</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Forme</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">form_for </span><span style="color:#BF9EEE;font-style:italic">@album</span><span style="color:#F6F6F4">, html</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { enctype</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">multipart/form-data</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> } </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |f|</span></span>
<span class="line"><span style="color:#F6F6F4">  f.text_field </span><span style="color:#BF9EEE">:title</span></span>
<span class="line"><span style="color:#F6F6F4">  f.fields_for </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |</span><span style="color:#97E1F1">p</span><span style="color:#F6F6F4">| </span><span style="color:#7B7F8B"># adds new `album[photos_attributes]` parameter</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1">p</span><span style="color:#F6F6F4">.hidden_field </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">, value</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">p</span><span style="color:#F6F6F4">.object.cached_image_data, id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1">p</span><span style="color:#F6F6F4">.file_field   </span><span style="color:#BF9EEE">:image</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1">p</span><span style="color:#F6F6F4">.check_box    </span><span style="color:#BF9EEE">:_destroy</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">unless</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">p</span><span style="color:#F6F6F4">.object.new_record?</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  file_field_tag </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">files[]</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, multiple</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span>
<span class="line"><span style="color:#F6F6F4">  f.submit </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Create</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">form </span><span style="color:#BF9EEE;font-style:italic">@album</span><span style="color:#F6F6F4">, action</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/photos</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, enctype</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">multipart/form-data</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |f|</span></span>
<span class="line"><span style="color:#F6F6F4">  f.input </span><span style="color:#BF9EEE">:title</span></span>
<span class="line"><span style="color:#F6F6F4">  f.subform </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># adds new `album[photos_attributes]` parameter</span></span>
<span class="line"><span style="color:#F6F6F4">    f.input </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">,   type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:hidden</span><span style="color:#F6F6F4">, value</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> f.obj.cached_image_data</span></span>
<span class="line"><span style="color:#F6F6F4">    f.input </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">,   type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:file</span></span>
<span class="line"><span style="color:#F6F6F4">    f.input </span><span style="color:#BF9EEE">:_delete</span><span style="color:#F6F6F4">, type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:checkbox</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">unless</span><span style="color:#F6F6F4"> f.obj.new?</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  f.input </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">files[]</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:file</span><span style="color:#F6F6F4">, attr</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { multiple</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4"> }, obj</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#F6F6F4">  f.button </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">Create</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div></div></div><p>In your controller you should still be able to assign all the attributes to the
album, just remember to whitelist the new parameter for the nested attributes,
in this case <code>album[photos_attributes]</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4a-form-upload">4a. Form upload<a href="#4a-form-upload" class="hash-link" aria-label="Direct link to 4a. Form upload" title="Direct link to 4a. Form upload">​</a></h3><p>If you would like to avoid writing JavaScript, you can have selected files
uploaded via the form, and then in your controller you can assign them in the
format of nested attributes. You&#x27;ll want to merge these newly uploaded photos
with the existing photos params that will come from the nested form fields.
This could look something like this:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># In your controller:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># transform the list of uploaded files into a photos attributes hash</span></span>
<span class="line"><span style="color:#F6F6F4">new_photos_attributes </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> params[</span><span style="color:#BF9EEE">:files</span><span style="color:#F6F6F4">].inject({}) </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |hash, file|</span></span>
<span class="line"><span style="color:#F6F6F4">  hash.merge!(</span><span style="color:#97E1F1;font-style:italic">SecureRandom</span><span style="color:#F6F6F4">.hex </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> { image</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file })</span></span>
<span class="line"><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># merge new photos attributes with existing (`album_params` is whitelisted `params[:album]`)</span></span>
<span class="line"><span style="color:#F6F6F4">photos_attributes </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> album_params[</span><span style="color:#BF9EEE">:photos_attributes</span><span style="color:#F6F6F4">].to_h.merge(new_photos_attributes)</span></span>
<span class="line"><span style="color:#F6F6F4">album_attributes  </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> album_params.merge(photos_attributes</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> photos_attributes)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># create the album with photos</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Album</span><span style="color:#F6F6F4">.create(album_attributes)</span></span></code></pre></div><p>In this case you need to make sure your form tag has
<code>enctype=&quot;multipart/form-data&quot;</code> attributes specified, otherwise form upload
won&#x27;t succeed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4b-direct-upload">4b. Direct upload<a href="#4b-direct-upload" class="hash-link" aria-label="Direct link to 4b. Direct upload" title="Direct link to 4b. Direct upload">​</a></h3><p>Alternatively, you can have selected files immediately uploaded to a direct
upload endpoint, as soon as they&#x27;re selected. It&#x27;s recommended to use <a href="https://uppy.io" target="_blank" rel="noopener noreferrer">Uppy</a>
for handling client side file uploads. There are two methods of implementing
direct uploads: to your app using the <a href="https://shrinerb.com/docs/plugins/upload_endpoint" target="_blank" rel="noopener noreferrer"><code>upload_endpoint</code></a> plugin, or directly
to a storage like S3 using the <a href="https://shrinerb.com/docs/plugins/presign_endpoint" target="_blank" rel="noopener noreferrer"><code>presign_endpoint</code></a> plugin. See the
walkthroughs for setting up simple <a href="https://github.com/shrinerb/shrine/wiki/Adding-Direct-App-Uploads" target="_blank" rel="noopener noreferrer">direct app uploads</a> and <a href="https://github.com/shrinerb/shrine/wiki/Adding-Direct-S3-Uploads" target="_blank" rel="noopener noreferrer">direct S3
uploads</a>, as well as the <a href="https://github.com/shrinerb/shrine/tree/master/demo" target="_blank" rel="noopener noreferrer">Roda</a> or <a href="https://github.com/erikdahlstrand/shrine-rails-example" target="_blank" rel="noopener noreferrer">Rails</a> demo app
which implement multiple file uploads.</p><p>Once files are uploaded asynchronously, you can dynamically insert photo
attachment fields for the <code>image</code> attachment attribute into the form, where the
hidden field is filled with uploaded file data in JSON format, just like when
doing single direct uploads. The attachment field names should be namespaced
according to the convention that the nested attributes feature expects. In this
case it should be <code>album[photos_attributes][&lt;uid&gt;]</code>, where <code>&lt;uid&gt;</code> is any
unique string.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># naming format in which photos fields should be generated and submitted</span></span>
<span class="line"><span style="color:#F6F6F4">album[photos_attributes][</span><span style="color:#BF9EEE">11111</span><span style="color:#F6F6F4">][image] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&#x27;</span><span style="color:#E7EE98">{&quot;id&quot;:&quot;38k25.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}</span><span style="color:#DEE492">&#x27;</span></span>
<span class="line"><span style="color:#F6F6F4">album[photos_attributes][</span><span style="color:#BF9EEE">29323</span><span style="color:#F6F6F4">][image] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&#x27;</span><span style="color:#E7EE98">{&quot;id&quot;:&quot;sg0fg.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}</span><span style="color:#DEE492">&#x27;</span></span>
<span class="line"><span style="color:#F6F6F4">album[photos_attributes][</span><span style="color:#BF9EEE">34820</span><span style="color:#F6F6F4">][image] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&#x27;</span><span style="color:#E7EE98">{&quot;id&quot;:&quot;041jd.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}</span><span style="color:#DEE492">&#x27;</span></span></code></pre></div><p>In your controller you don&#x27;t need to make any changes to handle the nested
photos attributes (other than allowing them), your ORM will take care of
creating, updating, or removing the associated photos.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Album</span><span style="color:#F6F6F4">.create(album_params) </span><span style="color:#7B7F8B"># or `params[:album]`</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-adding-validations">5. Adding Validations<a href="#5-adding-validations" class="hash-link" aria-label="Direct link to 5. Adding Validations" title="Direct link to 5. Adding Validations">​</a></h3><p>You can add file validations to the <code>Photo</code> model using the
<code>validation_helpers</code> plugin. You just need to make sure that your ORM is
configured to automatically validate associated records.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:determine_mime_type</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_max_size </span><span style="color:#BF9EEE">10</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_mime_type </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">webp]</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div class="tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Sequel</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Active Record</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Album</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sequel::Model</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ... (nested_attributes already enables validating associated photos) ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Album</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  validates_associated </span><span style="color:#BF9EEE">:photos</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div></div></div><p>Note that by default only metadata set on the client side will be available for
validations. Shrine will not automatically run metadata extraction for directly
uploaded files, as this would require (at least partially) downloading each
file from storage, which could be an unwanted performance penalty. If you want
metadata to be extracted on the server side, you can load the
<code>restore_cached_data</code> plugin which will make metadata extraction run on
assignment, or you can extract the metadata manually (e.g. in a background job)
using the <code>refresh_metadata</code> plugin.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h3><p>Now we have a simple interface for accepting multiple attachments, which
internally uses the nested attributes feature of your ORM to create multiple
associated records, each with a single attachment. After creation you can also
add new attachments, or update and delete existing ones, which the nested
attributes feature gives you for free.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/multiple_files.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-06-01T23:07:30.000Z">Jun 1, 2023</time></b> by <b>Janko Marohnić</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/validation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">File Validation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/securing-uploads"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Securing Uploads</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-to-implement" class="table-of-contents__link toc-highlight">How to Implement</a><ul><li><a href="#1-create-the-main-resource-and-attachment-table" class="table-of-contents__link toc-highlight">1. Create the main resource and attachment table</a></li><li><a href="#2-declare-nested-attributes" class="table-of-contents__link toc-highlight">2. Declare nested attributes</a></li><li><a href="#3-create-the-view" class="table-of-contents__link toc-highlight">3. Create the View</a></li><li><a href="#4a-form-upload" class="table-of-contents__link toc-highlight">4a. Form upload</a></li><li><a href="#4b-direct-upload" class="table-of-contents__link toc-highlight">4b. Direct upload</a></li><li><a href="#5-adding-validations" class="table-of-contents__link toc-highlight">5. Adding Validations</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b0f70eb.js"></script>
<script src="/assets/js/main.c75c1b94.js"></script>
</body>
</html>