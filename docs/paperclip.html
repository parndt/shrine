<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-paperclip">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Upgrading from Paperclip | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/paperclip"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Upgrading from Paperclip | Shrine"><meta data-rh="true" name="description" content="This guide is aimed at helping Paperclip users transition to Shrine, and it"><meta data-rh="true" property="og:description" content="This guide is aimed at helping Paperclip users transition to Shrine, and it"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/paperclip"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/paperclip" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/paperclip" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.03658a87.js" as="script">
<link rel="preload" href="/assets/js/main.8e62a738.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a class="navbar__item navbar__link" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a class="navbar__item navbar__link" href="/docs/release_notes/3.5.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/advantages">Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advantages">Advantages of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/design">Base</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">The Design of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/attacher">Using Attacher</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/storage/file-system">Storage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/file-system">File System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/s3">AWS S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/memory">Memory</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/direct-s3">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/metadata">Extracting Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing">File Processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/validation">File Validation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/multiple-files">Extras</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/multiple-files">Multiple Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/securing-uploads">Securing Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing">Testing with Shrine</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/changing-derivatives">Migrating</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-location">Migrating File Locations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-storage">Migrating File Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/creating-plugins">Extending</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-storages">Writing a Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/upgrading-to-3">Upgrading</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/refile">Upgrading from Refile</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Upgrading from Paperclip</h1></header><p>This guide is aimed at helping Paperclip users transition to Shrine, and it
consists of three parts:</p><ol><li>Explanation of the key differences in design between Paperclip and Shrine</li><li>Instructions how to migrate an existing app that uses Paperclip to Shrine</li><li>Extensive reference of Paperclip&#x27;s interface with Shrine equivalents</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uploader">Uploader<a href="#uploader" class="hash-link" aria-label="Direct link to Uploader" title="Direct link to Uploader">​</a></h3><p>In Paperclip, the attachment logic is configured directly inside Active Record
models:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  has_attached_file </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    preserve_files</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    default_url</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/images/:style/missing.png</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  validated_attachment_content_type </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">, content_type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image/jpeg</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Shrine takes a more object-oriented approach, by encapsulating attachment logic
in &quot;uploader&quot; classes:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:keep_files</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:default_url</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/images/</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">derivative</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">/missing.png</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> derivative</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_mime_type </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg]</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage">Storage<a href="#storage" class="hash-link" aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h3><p>Paperclip storage is configured together with other attachment options. Also,
the storage implementations themselves are mixed into the attachment class,
which couples them to the attachment flow.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  has_attached_file </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:s3</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    s3_credentials</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">      bucket</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">my-bucket</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      access_key_id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">abc</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      secret_access_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">xyz</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    },</span></span>
<span class="line"><span style="color:#F6F6F4">    s3_region</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">eu-west-1</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Shrine storage objects are configured separately and are decoupled from
attachment:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span></span>
<span class="line"><span style="color:#F6F6F4">  bucket</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">my-bucket</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  access_key_id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">abc</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  secret_access_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">xyz</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  region</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">eu-west-1</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><p>Shrine also has a concept of &quot;temporary&quot; storage, which enables retaining
uploaded files in case of validation errors and <a href="https://shrinerb.com/docs/getting-started#direct-uploads" target="_blank" rel="noopener noreferrer">direct uploads</a>.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">FileSystem</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">public</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">uploads/cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">  store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(bucket</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">my-bucket</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">s3_options),</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="persistence">Persistence<a href="#persistence" class="hash-link" aria-label="Direct link to Persistence" title="Direct link to Persistence">​</a></h3><p>When using Paperclip, the attached file data will be persisted into several
columns:</p><ul><li><code>&lt;name&gt;_file_name</code></li><li><code>&lt;name&gt;_content_type</code></li><li><code>&lt;name&gt;_file_size</code></li><li><code>&lt;name&gt;_updated_at</code></li><li><code>&lt;name&gt;_created_at</code> (optional)</li><li><code>&lt;name&gt;_fingerprint</code> (optional)</li></ul><p>In contrast, Shrine uses a single <code>&lt;name&gt;_data</code> column to store data in JSON
format:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">{</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">path/to/image.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">store</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: {</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">nature.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#BF9EEE">4739472</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">mime_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image/jpeg</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image.id          </span><span style="color:#7B7F8B">#=&gt; &quot;path/to/image.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.storage_key </span><span style="color:#7B7F8B">#=&gt; :store</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.metadata    </span><span style="color:#7B7F8B">#=&gt; { &quot;filename&quot; =&gt; &quot;...&quot;, &quot;size&quot; =&gt; ..., &quot;mime_type&quot; =&gt; &quot;...&quot; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image.original_filename </span><span style="color:#7B7F8B">#=&gt; &quot;nature.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.size              </span><span style="color:#7B7F8B">#=&gt; 4739472</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.mime_type         </span><span style="color:#7B7F8B">#=&gt; &quot;image/jpeg&quot;</span></span></code></pre></div><p>This column can be queried if it&#x27;s made a JSON column. Alternatively, you can
use the <a href="https://shrinerb.com/docs/plugins/metadata_attributes" target="_blank" rel="noopener noreferrer"><code>metadata_attributes</code></a> plugin to save metadata
into separate columns.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="orm">ORM<a href="#orm" class="hash-link" aria-label="Direct link to ORM" title="Direct link to ORM">​</a></h4><p>While Paperclip works only with Active Record, Shrine is designed to integrate
with any persistence library (there are integrations for <a href="https://shrinerb.com/docs/plugins/activerecord" target="_blank" rel="noopener noreferrer">Active
Record</a>, <a href="https://shrinerb.com/docs/plugins/sequel" target="_blank" rel="noopener noreferrer">Sequel</a>, <a href="https://github.com/shrinerb/shrine-rom" target="_blank" rel="noopener noreferrer">ROM</a>, <a href="https://github.com/katafrakt/hanami-shrine" target="_blank" rel="noopener noreferrer">Hanami</a> and
<a href="https://github.com/shrinerb/shrine-mongoid" target="_blank" rel="noopener noreferrer">Mongoid</a>), and can also be used standalone:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.attach </span><span style="color:#97E1F1;font-style:italic">File</span><span style="color:#F6F6F4">.</span><span style="color:#97E1F1">open</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">nature.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;f4ba5bdbf366ef0b.jpg&quot; ...&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.url  </span><span style="color:#7B7F8B">#=&gt; &quot;https://my-bucket.s3.amazonaws.com/f4ba5bdbf366ef0b.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.data </span><span style="color:#7B7F8B">#=&gt; { &quot;id&quot; =&gt; &quot;f4ba5bdbf366ef0b.jpg&quot;, &quot;storage&quot; =&gt; &quot;store&quot;, &quot;metadata&quot; =&gt; { ... } }</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="location">Location<a href="#location" class="hash-link" aria-label="Direct link to Location" title="Direct link to Location">​</a></h4><p>Paperclip persists only the filename of the uploaded file, and recalculates the
full location dynamically based on location configuration. This can be
dangerous, because if some component of the location happens to change, all
existing links might become invalid.</p><p>To avoid this, Shrine persists the full location on attachment, and uses it
when generating file URL. So, even if you change how file locations are
generated, existing files that are on old locations will still remain
accessible.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="processing">Processing<a href="#processing" class="hash-link" aria-label="Direct link to Processing" title="Direct link to Processing">​</a></h3><p>In Shrine, processing is defined and performed on the instance level, which
gives you more control. You&#x27;re also not coupled to ImageMagick, e.g. you can
use <a href="http://libvips.github.io/libvips/" target="_blank" rel="noopener noreferrer">libvips</a> instead (both integrations are provided by the <a href="https://github.com/janko/image_processing" target="_blank" rel="noopener noreferrer">image_processing</a>
gem).</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  has_attached_file </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    styles</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">      large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">800x800&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">500x500&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">300x300&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing/mini_magick</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivatives</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">      large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Shrine is agnostic as to how you&#x27;re performing your processing, so you can
easily use any other processing tools. You can also combine different
processors for different versions.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="retrieving-versions">Retrieving versions<a href="#retrieving-versions" class="hash-link" aria-label="Direct link to Retrieving versions" title="Direct link to Retrieving versions">​</a></h4><p>When retrieving versions, Paperclip returns a list of declared styles which
may or may not have been generated. In contrast, Shrine persists data of
uploaded processed files into the database (including any extracted metadata),
which then becomes the source of truth on which versions have been generated.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image              </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;original.jpg&quot; ...&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives  </span><span style="color:#7B7F8B">#=&gt; {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives! </span><span style="color:#7B7F8B"># triggers processing</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives  </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#7B7F8B">#   large: #&lt;Shrine::UploadedFile id=&quot;large.jpg&quot; metadata={&quot;size&quot;=&gt;873232, ...} ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   medium: #&lt;Shrine::UploadedFile id=&quot;medium.jpg&quot; metadata={&quot;size&quot;=&gt;94823, ...} ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   small: #&lt;Shrine::UploadedFile id=&quot;small.jpg&quot; metadata={&quot;size&quot;=&gt;37322, ...} ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B"># }</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="reprocessing-versions">Reprocessing versions<a href="#reprocessing-versions" class="hash-link" aria-label="Direct link to Reprocessing versions" title="Direct link to Reprocessing versions">​</a></h4><p>Shrine doesn&#x27;t have a built-in way of regenerating versions, because that has
to be written and optimized differently depending on what versions have changed
which persistence library you&#x27;re using, how many records there are in the table
etc.</p><p>However, there is an extensive guide for <a href="https://shrinerb.com/docs/changing-derivatives" target="_blank" rel="noopener noreferrer">Managing Derivatives</a>, which provides
instructions on how to make these changes safely and with zero downtime.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a href="#validation" class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation">​</a></h3><p>File validation in Shrine is also instance-level, which allows using
conditionals:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  has_attached_file </span><span style="color:#BF9EEE">:image</span></span>
<span class="line"><span style="color:#F6F6F4">  validates_attachment </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    size</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { in</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">0</span><span style="color:#F6F6F4">..</span><span style="color:#BF9EEE">10</span><span style="color:#F6F6F4">.megabytes },</span></span>
<span class="line"><span style="color:#F6F6F4">    content_type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { content_type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">webp] }</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_max_size </span><span style="color:#BF9EEE">10</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> validate_mime_type </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">webp]</span></span>
<span class="line"><span style="color:#F6F6F4">      validate_max_dimensions [</span><span style="color:#BF9EEE">5000</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">5000</span><span style="color:#F6F6F4">]</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="custom-metadata">Custom metadata<a href="#custom-metadata" class="hash-link" aria-label="Direct link to Custom metadata" title="Direct link to Custom metadata">​</a></h4><p>With Shrine you can also extract and validate any custom metadata:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">VideoUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:add_metadata</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  add_metadata </span><span style="color:#BF9EEE">:duration</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |io|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">FFMPEG</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Movie</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(io.path).duration</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> file.duration </span><span style="color:#F286C4">&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">5</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">60</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">60</span></span>
<span class="line"><span style="color:#F6F6F4">      errors </span><span style="color:#F286C4">&lt;&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">must not be longer than 5 hours</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="mime-type-spoofing">MIME type spoofing<a href="#mime-type-spoofing" class="hash-link" aria-label="Direct link to MIME type spoofing" title="Direct link to MIME type spoofing">​</a></h4><p>Paperclip attempts to detect MIME type spoofing, which turned out to be
unreliable due to differences in MIME type databases between different ruby
libraries.</p><p>Shrine on the other hand simply allows you to determine MIME type from file
content, which you can then validate.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:determine_mime_type</span><span style="color:#F6F6F4">, analyzer</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:marcel</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> uploader.upload </span><span style="color:#97E1F1;font-style:italic">StringIO</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;?php ... ?&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">file.mime_type </span><span style="color:#7B7F8B">#=&gt; &quot;application/x-php&quot;</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-from-paperclip">Migrating from Paperclip<a href="#migrating-from-paperclip" class="hash-link" aria-label="Direct link to Migrating from Paperclip" title="Direct link to Migrating from Paperclip">​</a></h2><p>You have an existing app using Paperclip and you want to transfer it to Shrine.
Let&#x27;s assume we have a <code>Photo</code> model with the &quot;image&quot; attachment.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-add-shrine-column">1. Add Shrine column<a href="#1-add-shrine-column" class="hash-link" aria-label="Direct link to 1. Add Shrine column" title="Direct link to 1. Add Shrine column">​</a></h3><p>First we need to create the <code>image_data</code> column for Shrine:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">add_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_data</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:text</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-dual-write">2. Dual write<a href="#2-dual-write" class="hash-link" aria-label="Direct link to 2. Dual write" title="Direct link to 2. Dual write">​</a></h3><p>Next, we need to make new Paperclip attachments write to the <code>image_data</code>
column. This can be done by including the below module to all models that have
Paperclip attachments:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ...,</span></span>
<span class="line"><span style="color:#F6F6F4">  store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ...,</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:model</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:derivatives</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">module</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">PaperclipShrineSynchronization</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">self.included</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">model</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    model.before_save </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">      </span><span style="color:#97E1F1;font-style:italic">Paperclip</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">AttachmentRegistry</span><span style="color:#F6F6F4">.each_definition </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |klass, name, options|</span></span>
<span class="line"><span style="color:#F6F6F4">        write_shrine_data(name) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> changes.key?(</span><span style="color:#BF9EEE">:&quot;</span><span style="color:#F286C4">#{</span><span style="color:#BF9EEE">name</span><span style="color:#F286C4">}</span><span style="color:#BF9EEE">_file_name&quot;</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">&amp;&amp;</span><span style="color:#F6F6F4"> klass </span><span style="color:#F286C4">==</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.class</span></span>
<span class="line"><span style="color:#F6F6F4">      </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">write_shrine_data</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attachment </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> send(name)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher   </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.from_model(</span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">, name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> attachment.size.present?</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher.set shrine_file(attachment)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      attachment.styles.each </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |style_name, style|</span></span>
<span class="line"><span style="color:#F6F6F4">        attacher.merge_derivatives(style_name </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> shrine_file(style))</span></span>
<span class="line"><span style="color:#F6F6F4">      </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher.set </span><span style="color:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">private</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">shrine_file</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">object</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> object.is_a?(</span><span style="color:#97E1F1;font-style:italic">Paperclip</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">      shrine_attachment_file(object)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">      shrine_style_file(object)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">shrine_attachment_file</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attachment</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    location </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attachment.path</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># if you&#x27;re storing files on disk, make sure to subtract the absolute path</span></span>
<span class="line"><span style="color:#F6F6F4">    location </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> location.</span><span style="color:#97E1F1">sub</span><span style="color:#F6F6F4">(</span><span style="color:#EE6666">%r{</span><span style="color:#E7EE98">^</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">storage.prefix</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">/</span><span style="color:#EE6666">}</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;&quot;</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> storage.prefix</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.uploaded_file(</span></span>
<span class="line"><span style="color:#F6F6F4">      storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">       location,</span></span>
<span class="line"><span style="color:#F6F6F4">      metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">      </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> attachment.size,</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">  </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> attachment.original_filename,</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">mime_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> attachment.content_type,</span></span>
<span class="line"><span style="color:#F6F6F4">      }</span></span>
<span class="line"><span style="color:#F6F6F4">    )</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># If you&#x27;ll be using a `:prefix` on your Shrine storage, or you&#x27;re storing</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># files on the filesystem, make sure to subtract the appropriate part</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># from the path assigned to `:id`.</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">shrine_style_file</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">style</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    location </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> style.attachment.path(style.name)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># if you&#x27;re storing files on disk, make sure to subtract the absolute path</span></span>
<span class="line"><span style="color:#F6F6F4">    location </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> location.</span><span style="color:#97E1F1">sub</span><span style="color:#F6F6F4">(</span><span style="color:#EE6666">%r{</span><span style="color:#E7EE98">^</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">storage.prefix</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">/</span><span style="color:#EE6666">}</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;&quot;</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> storage.prefix</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.uploaded_file(</span></span>
<span class="line"><span style="color:#F6F6F4">      storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">       location,</span></span>
<span class="line"><span style="color:#F6F6F4">      metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {},</span></span>
<span class="line"><span style="color:#F6F6F4">    )</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">storage</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">]</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  has_attached_file </span><span style="color:#BF9EEE">:image</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">PaperclipShrineSynchronization</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># needs to be after `has_attached_file`</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>After you deploy this code, the <code>image_data</code> column should now be successfully
synchronized with new attachments.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-data-migration">3. Data migration<a href="#3-data-migration" class="hash-link" aria-label="Direct link to 3. Data migration" title="Direct link to 3. Data migration">​</a></h3><p>Next step is to run a script which writes all existing Paperclip attachments to
<code>image_data</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.find_each </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |photo|</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.write_shrine_data(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.save!</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-rewrite-code">4. Rewrite code<a href="#4-rewrite-code" class="hash-link" aria-label="Direct link to 4. Rewrite code" title="Direct link to 4. Rewrite code">​</a></h3><p>Now you should be able to rewrite your application so that it uses Shrine
instead of Paperclip (you can consult the reference in the next section). You
can remove the <code>PaperclipShrineSynchronization</code> module as well.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-remove-paperclip-columns">5. Remove Paperclip columns<a href="#5-remove-paperclip-columns" class="hash-link" aria-label="Direct link to 5. Remove Paperclip columns" title="Direct link to 5. Remove Paperclip columns">​</a></h3><p>If everything is looking good, we can remove Paperclip columns:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_file_name</span></span>
<span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_file_size</span></span>
<span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_content_type</span></span>
<span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_updated_at</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="paperclip-to-shrine-direct-mapping">Paperclip to Shrine direct mapping<a href="#paperclip-to-shrine-direct-mapping" class="hash-link" aria-label="Direct link to Paperclip to Shrine direct mapping" title="Direct link to Paperclip to Shrine direct mapping">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="has_attached_file"><code>has_attached_file</code><a href="#has_attached_file" class="hash-link" aria-label="Direct link to has_attached_file" title="Direct link to has_attached_file">​</a></h3><p>As mentioned above, Shrine&#x27;s equivalent of <code>has_attached_file</code> is including
an attachment module:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sequel::Model</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B"># adds `image`, `image=` and `image_url` methods</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Now we&#x27;ll list all options that <code>has_attached_file</code> accepts, and explain
Shrine&#x27;s equivalents:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-1"><code>:storage</code><a href="#storage-1" class="hash-link" aria-label="Direct link to storage-1" title="Direct link to storage-1">​</a></h4><p>In Shrine attachments will automatically use <code>:cache</code> and <code>:store</code> storages
which you have to register:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">FileSystem</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">public</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">uploads/cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">  store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">FileSystem</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">public</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">uploads</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><p>You can change that for a specific uploader with the <code>default_storage</code> plugin.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="styles-processors-convert_options"><code>:styles</code>, <code>:processors</code>, <code>:convert_options</code><a href="#styles-processors-convert_options" class="hash-link" aria-label="Direct link to styles-processors-convert_options" title="Direct link to styles-processors-convert_options">​</a></h4><p>Processing is defined by using the <code>derivatives</code> plugin:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivatives</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">      large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="default_url"><code>:default_url</code><a href="#default_url" class="hash-link" aria-label="Direct link to default_url" title="Direct link to default_url">​</a></h4><p>For default URLs you can use the <code>default_url</code> plugin:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:default_url</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/images/placeholders/</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">derivative </span><span style="color:#F286C4">||</span><span style="color:#E7EE98"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">original</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">.jpg</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="preserve_files"><code>:preserve_files</code><a href="#preserve_files" class="hash-link" aria-label="Direct link to preserve_files" title="Direct link to preserve_files">​</a></h4><p>Shrine provides a <code>keep_files</code> plugin which allows you to keep files that would
otherwise be deleted:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:keep_files</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="path-url-interpolator-url_generator"><code>:path</code>, <code>:url</code>, <code>:interpolator</code>, <code>:url_generator</code><a href="#path-url-interpolator-url_generator" class="hash-link" aria-label="Direct link to path-url-interpolator-url_generator" title="Direct link to path-url-interpolator-url_generator">​</a></h4><p>Shrine by default stores your files in the same directory, but you can also
load the <code>pretty_location</code> plugin for nice folder structure:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:pretty_location</span></span></code></pre></div><p>Alternatively, if you want to generate locations yourself you can override the
<code>#generate_location</code> method:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">generate_location</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">io</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">record</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    [ storage_key,</span></span>
<span class="line"><span style="color:#F6F6F4">      record </span><span style="color:#F286C4">&amp;&amp;</span><span style="color:#F6F6F4"> record.class.name.underscore,</span></span>
<span class="line"><span style="color:#F6F6F4">      record </span><span style="color:#F286C4">&amp;&amp;</span><span style="color:#F6F6F4"> record.id,</span></span>
<span class="line"><span style="color:#F6F6F4">      </span><span style="color:#F286C4">super</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      io.original_filename ].compact.join(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cache/user/123/2feff8c724e7ce17/nature.jpg</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">store/user/456/7f99669fde1e01fc/kitten.jpg</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="validate_media_type"><code>:validate_media_type</code><a href="#validate_media_type" class="hash-link" aria-label="Direct link to validate_media_type" title="Direct link to validate_media_type">​</a></h4><p>Shrine has this functionality in the <code>determine_mime_type</code> plugin.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="validates_attachment"><code>validates_attachment</code><a href="#validates_attachment" class="hash-link" aria-label="Direct link to validates_attachment" title="Direct link to validates_attachment">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="presence"><code>:presence</code><a href="#presence" class="hash-link" aria-label="Direct link to presence" title="Direct link to presence">​</a></h4><p>For presence validation you can use your ORM&#x27;s presence validator:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  validates_presence_of </span><span style="color:#BF9EEE">:image</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="content_type"><code>:content_type</code><a href="#content_type" class="hash-link" aria-label="Direct link to content_type" title="Direct link to content_type">​</a></h4><p>You can do MIME type validation with Shrine&#x27;s <code>validation_helpers</code> plugin:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_mime_type </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">webp]</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Make sure to also load the <code>determine_mime_type</code> plugin to detect MIME type
from file content.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">mimemagic</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:determine_mime_type</span><span style="color:#F6F6F4">, analyzer</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (io, analyzers) </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  analyzers[</span><span style="color:#BF9EEE">:mimemagic</span><span style="color:#F6F6F4">].call(io) </span><span style="color:#F286C4">||</span><span style="color:#F6F6F4"> analyzers[</span><span style="color:#BF9EEE">:file</span><span style="color:#F6F6F4">].call(io)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="size"><code>:size</code><a href="#size" class="hash-link" aria-label="Direct link to size" title="Direct link to size">​</a></h4><p>You can do filesize validation with Shrine&#x27;s <code>validation_helpers</code> plugin:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_max_size </span><span style="color:#BF9EEE">10</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="paperclipattachment"><code>Paperclip::Attachment</code><a href="#paperclipattachment" class="hash-link" aria-label="Direct link to paperclipattachment" title="Direct link to paperclipattachment">​</a></h3><p>This section explains the equivalent of Paperclip attachment&#x27;s methods, in
Shrine this is an instance of <code>Shrine::UploadedFile</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="url"><code>#url</code><a href="#url" class="hash-link" aria-label="Direct link to url" title="Direct link to url">​</a></h4><p>In Shrine you can generate URLs with <code>#&lt;name&gt;_url</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_url         </span><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/path/to/original.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/path/to/large.jpg&quot;</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="styles"><code>#styles</code><a href="#styles" class="hash-link" aria-label="Direct link to styles" title="Direct link to styles">​</a></h4><p>In Shrine you can use <code>#&lt;name&gt;_derivatives</code> to retrieve a list of versions:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_derivatives </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#7B7F8B">#   small:  #&lt;Shrine::UploadedFile&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   medium: #&lt;Shrine::UploadedFile&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   large:  #&lt;Shrine::UploadedFile&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B"># }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives[</span><span style="color:#BF9EEE">:small</span><span style="color:#F6F6F4">] </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># or</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image(</span><span style="color:#BF9EEE">:small</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="path"><code>#path</code><a href="#path" class="hash-link" aria-label="Direct link to path" title="Direct link to path">​</a></h4><p>Shrine doesn&#x27;t have this because storages are abstract and this would be
specific to the filesystem, but the closest is probably <code>#id</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image.id </span><span style="color:#7B7F8B">#=&gt; &quot;photo/342/image/398543qjfdsf.jpg&quot;</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="reprocess"><code>#reprocess!</code><a href="#reprocess" class="hash-link" aria-label="Direct link to reprocess" title="Direct link to reprocess">​</a></h4><p>Shrine doesn&#x27;t have an equivalent to this, but the <a href="https://shrinerb.com/docs/changing-derivatives" target="_blank" rel="noopener noreferrer">Managing Derivatives</a>
guide provides some useful tips on how to do this.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="paperclipstorages3"><code>Paperclip::Storage::S3</code><a href="#paperclipstorages3" class="hash-link" aria-label="Direct link to paperclipstorages3" title="Direct link to paperclipstorages3">​</a></h3><p>The built-in <a href="https://shrinerb.com/docs/storage/s3" target="_blank" rel="noopener noreferrer"><code>Shrine::Storage::S3</code></a> storage is a direct replacement for
<code>Paperclip::Storage::S3</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="s3_credentials-s3_region-bucket"><code>:s3_credentials</code>, <code>:s3_region</code>, <code>:bucket</code><a href="#s3_credentials-s3_region-bucket" class="hash-link" aria-label="Direct link to s3_credentials-s3_region-bucket" title="Direct link to s3_credentials-s3_region-bucket">​</a></h4><p>The Shrine storage accepts <code>:access_key_id</code>, <code>:secret_access_key</code>, <code>:region</code>,
and <code>:bucket</code> options in the initializer:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span></span>
<span class="line"><span style="color:#F6F6F4">  access_key_id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  secret_access_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  region</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  bucket</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="s3_headers-s3_permissions-s3_metadata"><code>:s3_headers</code>, <code>:s3_permissions</code>, <code>:s3_metadata</code><a href="#s3_headers-s3_permissions-s3_metadata" class="hash-link" aria-label="Direct link to s3_headers-s3_permissions-s3_metadata" title="Direct link to s3_headers-s3_permissions-s3_metadata">​</a></h4><p>These can be configured via the <code>:upload_options</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span></span>
<span class="line"><span style="color:#F6F6F4">  upload_options</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">    content_disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,         </span><span style="color:#7B7F8B"># headers</span></span>
<span class="line"><span style="color:#F6F6F4">    acl</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">                 </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">private</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,            </span><span style="color:#7B7F8B"># permissions</span></span>
<span class="line"><span style="color:#F6F6F4">    metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">            { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">key</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">value</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> }, </span><span style="color:#7B7F8B"># metadata</span></span>
<span class="line"><span style="color:#F6F6F4">  },</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">options</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="s3_protocol-s3_host_alias-s3_host_name"><code>:s3_protocol</code>, <code>:s3_host_alias</code>, <code>:s3_host_name</code><a href="#s3_protocol-s3_host_alias-s3_host_name" class="hash-link" aria-label="Direct link to s3_protocol-s3_host_alias-s3_host_name" title="Direct link to s3_protocol-s3_host_alias-s3_host_name">​</a></h4><p>The <code>#url</code> method accepts a <code>:host</code> option for specifying a CDN host. You can
use the <code>url_options</code> plugin to set it by default:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:url_options</span><span style="color:#F6F6F4">, store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { host</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">http://abc123.cloudfront.net</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="path-1"><code>:path</code><a href="#path-1" class="hash-link" aria-label="Direct link to path-1" title="Direct link to path-1">​</a></h4><p>The <code>#upload</code> method accepts the destination location as the second argument.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">s3 </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">S3</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">options)</span></span>
<span class="line"><span style="color:#F6F6F4">s3.upload(io, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">object/destination/path</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="url-1"><code>:url</code><a href="#url-1" class="hash-link" aria-label="Direct link to url-1" title="Direct link to url-1">​</a></h4><p>The Shrine storage has no replacement for the <code>:url</code> Paperclip option, and it
isn&#x27;t needed.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/paperclip.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2020-12-07T02:44:15.000Z">Dec 7, 2020</time></b> by <b>Viedit com</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/carrierwave"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Upgrading from CarrierWave</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/refile"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Upgrading from Refile</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#uploader" class="table-of-contents__link toc-highlight">Uploader</a></li><li><a href="#storage" class="table-of-contents__link toc-highlight">Storage</a></li><li><a href="#persistence" class="table-of-contents__link toc-highlight">Persistence</a></li><li><a href="#processing" class="table-of-contents__link toc-highlight">Processing</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li></ul></li><li><a href="#migrating-from-paperclip" class="table-of-contents__link toc-highlight">Migrating from Paperclip</a><ul><li><a href="#1-add-shrine-column" class="table-of-contents__link toc-highlight">1. Add Shrine column</a></li><li><a href="#2-dual-write" class="table-of-contents__link toc-highlight">2. Dual write</a></li><li><a href="#3-data-migration" class="table-of-contents__link toc-highlight">3. Data migration</a></li><li><a href="#4-rewrite-code" class="table-of-contents__link toc-highlight">4. Rewrite code</a></li><li><a href="#5-remove-paperclip-columns" class="table-of-contents__link toc-highlight">5. Remove Paperclip columns</a></li></ul></li><li><a href="#paperclip-to-shrine-direct-mapping" class="table-of-contents__link toc-highlight">Paperclip to Shrine direct mapping</a><ul><li><a href="#has_attached_file" class="table-of-contents__link toc-highlight"><code>has_attached_file</code></a></li><li><a href="#validates_attachment" class="table-of-contents__link toc-highlight"><code>validates_attachment</code></a></li><li><a href="#paperclipattachment" class="table-of-contents__link toc-highlight"><code>Paperclip::Attachment</code></a></li><li><a href="#paperclipstorages3" class="table-of-contents__link toc-highlight"><code>Paperclip::Storage::S3</code></a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.03658a87.js"></script>
<script src="/assets/js/main.8e62a738.js"></script>
</body>
</html>