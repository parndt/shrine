<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-refile">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Upgrading from Refile | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/refile"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Upgrading from Refile | Shrine"><meta data-rh="true" name="description" content="This guide is aimed at helping Refile users transition to Shrine, and it consists"><meta data-rh="true" property="og:description" content="This guide is aimed at helping Refile users transition to Shrine, and it consists"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/refile"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/refile" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/refile" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.3b0f70eb.js" as="script">
<link rel="preload" href="/assets/js/main.3b0d02ea.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a class="navbar__item navbar__link" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a class="navbar__item navbar__link" href="/docs/release_notes/3.5.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/advantages">Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advantages">Advantages of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/design">Base</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">The Design of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/attacher">Using Attacher</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/storage/file-system">Storage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/file-system">File System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/s3">AWS S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/memory">Memory</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/direct-s3">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/metadata">Extracting Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing">File Processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/validation">File Validation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/multiple-files">Extras</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/multiple-files">Multiple Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/securing-uploads">Securing Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing">Testing with Shrine</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/changing-derivatives">Migrating</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-location">Migrating File Locations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-storage">Migrating File Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/creating-plugins">Extending</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-storages">Writing a Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/upgrading-to-3">Upgrading</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/refile">Upgrading from Refile</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Upgrading from Refile</h1></header><p>This guide is aimed at helping Refile users transition to Shrine, and it consists
of three parts:</p><ol><li>Explanation of the key differences in design between Refile and Shrine</li><li>Instructions how to migrate an existing app that uses Refile to Shrine</li><li>Extensive reference of Refile&#x27;s interface with Shrine equivalents</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>Shrine borrows many great concepts from Refile: Refile&#x27;s &quot;backends&quot; are here
named &quot;storages&quot;, it uses the same IO abstraction for uploading and
representing uploaded files, similar attachment logic, and direct uploads are
supported as well.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uploader">Uploader<a href="#uploader" class="hash-link" aria-label="Direct link to Uploader" title="Direct link to Uploader">​</a></h3><p>While in Refile you work with storages directly, Shrine uses <em>uploaders</em> which
wrap storage uploads:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">storage </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">]</span></span>
<span class="line"><span style="color:#F6F6F4">storage </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::Storage::S3&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.upload(image, </span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.storage </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::Storage::S3&gt;</span></span></code></pre></div><p>This way, Shrine can perform tasks like generating location, extracting
metadata, processing, and logging, which are all storage-agnostic, and leave
storages to deal only with actual file storage. And these tasks can be
configured differently depending on the types of files you&#x27;re uploading:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  add_metadata </span><span style="color:#BF9EEE">:exif</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |io|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Image</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(io).exif</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">VideoUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  add_metadata </span><span style="color:#BF9EEE">:duration</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |io|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">FFMPEG</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Movie</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(io.path).duration</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="url">URL<a href="#url" class="hash-link" aria-label="Direct link to URL" title="Direct link to URL">​</a></h4><p>While Refile serves all files through the Rack endpoint mounted in your app,
Shrine serves files directly from storage services:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Refile</span><span style="color:#F6F6F4">.attachment_url(</span><span style="color:#BF9EEE;font-style:italic">@photo</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;/attachments/cache/50dfl833lfs0gfh.jpg&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#BF9EEE;font-style:italic">@photo</span><span style="color:#F6F6F4">.image.url </span><span style="color:#7B7F8B">#=&gt; &quot;https://my-bucket.s3.amazonaws.com/cache/50dfl833lfs0gfh.jpg&quot;</span></span></code></pre></div><p>If you&#x27;re using storage which don&#x27;t expose files over URL (e.g. a database
storage), or you want to secure your downloads, you can also serve files
through your app using the <a href="https://shrinerb.com/docs/plugins/download_endpoint" target="_blank" rel="noopener noreferrer"><code>download_endpoint</code></a> plugin.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="persistence">Persistence<a href="#persistence" class="hash-link" aria-label="Direct link to Persistence" title="Direct link to Persistence">​</a></h3><p>Refile persists the uploaded file location and metadata into individual
columns:</p><ul><li><code>&lt;attachment&gt;_id</code></li><li><code>&lt;attachment&gt;_filename</code></li><li><code>&lt;attachment&gt;_content_type</code></li><li><code>&lt;attachment&gt;_size</code></li></ul><p>Shrine, on the other hand, saves all uploaded file data into a single
<code>&lt;attachment&gt;_data</code> column:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">{</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">path/to/image.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">store</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: {</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">nature.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#BF9EEE">4739472</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">mime_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image/jpeg</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image.id          </span><span style="color:#7B7F8B">#=&gt; &quot;path/to/image.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.storage_key </span><span style="color:#7B7F8B">#=&gt; :store</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.metadata    </span><span style="color:#7B7F8B">#=&gt; { &quot;filename&quot; =&gt; &quot;...&quot;, &quot;size&quot; =&gt; ..., &quot;mime_type&quot; =&gt; &quot;...&quot; }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image.original_filename </span><span style="color:#7B7F8B">#=&gt; &quot;nature.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.size              </span><span style="color:#7B7F8B">#=&gt; 4739472</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.mime_type         </span><span style="color:#7B7F8B">#=&gt; &quot;image/jpeg&quot;</span></span></code></pre></div><p>This column can be queried if it&#x27;s made a JSON column. Alternatively, you can
use the <a href="https://shrinerb.com/docs/plugins/metadata_attributes" target="_blank" rel="noopener noreferrer"><code>metadata_attributes</code></a> plugin to save metadata
into separate columns.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="processing">Processing<a href="#processing" class="hash-link" aria-label="Direct link to Processing" title="Direct link to Processing">​</a></h3><p>Shrine provides on-the-fly processing via the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint" target="_blank" rel="noopener noreferrer"><code>derivation_endpoint</code></a> plugin:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing/mini_magick</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    secret_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;YOUR SECRET KEY&gt;</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivations/image</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># needs to match the mount point in routes</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, width, height|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">MiniMagick</span></span>
<span class="line"><span style="color:#F6F6F4">      .source(file)</span></span>
<span class="line"><span style="color:#F6F6F4">      .resize_to_limit!(width.to_i, height.to_i)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb (Rails)</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  mount </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.derivation_endpoint </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/derivations/image</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Shrine also support eager processing using the <a href="https://shrinerb.com/docs/plugins/derivatives" target="_blank" rel="noopener noreferrer"><code>derivatives</code></a>
plugin.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a href="#validation" class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation">​</a></h3><p>In Refile, file validation is defined statically on attachment definition:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sequel::Model</span></span>
<span class="line"><span style="color:#F6F6F4">  attachment </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">    extension</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[jpg jpeg png webp],</span></span>
<span class="line"><span style="color:#F6F6F4">    content_type</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">webp]</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>In Shrine, validation is performed on the instance-level, which allows you to
make the validation conditional:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_max_size </span><span style="color:#BF9EEE">10</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_extension </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[jpg jpeg png webp]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> validate_mime_type </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">webp]</span></span>
<span class="line"><span style="color:#F6F6F4">      validate_max_dimensions [</span><span style="color:#BF9EEE">5000</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">5000</span><span style="color:#F6F6F4">]</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Refile extracts the MIME type from the file extension, which means it can
easily be spoofed (just give a PHP file a <code>.jpg</code> extension). Shrine has the
<a href="https://shrinerb.com/docs/plugins/determine_mime_type" target="_blank" rel="noopener noreferrer"><code>determine_mime_type</code></a> plugin for determining MIME type
from file <em>content</em>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="direct-uploads">Direct uploads<a href="#direct-uploads" class="hash-link" aria-label="Direct link to Direct uploads" title="Direct link to Direct uploads">​</a></h3><p>Shrine borrows Refile&#x27;s idea of direct uploads, and ships with
<code>upload_endpoint</code> and <code>presign_endpoint</code> plugins which provide endpoints for
uploading files and generating presigns.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:upload_endpoint</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.upload_endpoint(</span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B"># Rack app that uploads files to specified storage</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:upload_endpoint</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.presign_endpoint(</span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B"># Rack app that generates presigns for specified storage</span></span></code></pre></div><p>While Refile ships with a plug-and-play JavaScript for direct uploads, Shrine
instead adopts <a href="https://uppy.io" target="_blank" rel="noopener noreferrer">Uppy</a>, a modern and modular JavaScript file upload library that
happens to integrate well with Shrine.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multiple-uploads">Multiple uploads<a href="#multiple-uploads" class="hash-link" aria-label="Direct link to Multiple uploads" title="Direct link to Multiple uploads">​</a></h3><p>Shrine doesn&#x27;t have support for multiple uploads out-of-the-box like Refile
does. Instead, you can implement them using a separate table with a one-to-many
relationship to which the files will be attached. The <a href="https://shrinerb.com/docs/multiple-files" target="_blank" rel="noopener noreferrer">Multiple Files</a> guide
explains this setup in more detail.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-from-refile">Migrating from Refile<a href="#migrating-from-refile" class="hash-link" aria-label="Direct link to Migrating from Refile" title="Direct link to Migrating from Refile">​</a></h2><p>You have an existing app using Refile and you want to transfer it to
Shrine. Let&#x27;s assume we have a <code>Photo</code> model with the &quot;image&quot; attachment.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-add-shrine-column">1. Add Shrine column<a href="#1-add-shrine-column" class="hash-link" aria-label="Direct link to 1. Add Shrine column" title="Direct link to 1. Add Shrine column">​</a></h3><p>First we need to create the <code>image_data</code> column for Shrine:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">add_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_data</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:text</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-dual-write">2. Dual write<a href="#2-dual-write" class="hash-link" aria-label="Direct link to 2. Dual write" title="Direct link to 2. Dual write">​</a></h3><p>Afterwards we need to make new uploads write to the <code>image_data</code> column. This
can be done by including the below module to all models that have Refile
attachments:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ...,</span></span>
<span class="line"><span style="color:#F6F6F4">  store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ...,</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:model</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">module</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">RefileShrineSynchronization</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">write_shrine_data</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.from_model(</span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">, name)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> read_attribute(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">).present?</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher.set shrine_file(name)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher.set </span><span style="color:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">shrine_file</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.uploaded_file(</span></span>
<span class="line"><span style="color:#F6F6F4">      storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">      id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">       send(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">      </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> (send(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> respond_to?(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_size</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)),</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">  </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> (send(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> respond_to?(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)),</span></span>
<span class="line"><span style="color:#F6F6F4">        </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">mime_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> (send(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_content_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> respond_to?(</span><span style="color:#DEE492">&quot;</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">name</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">_content_type</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)),</span></span>
<span class="line"><span style="color:#F6F6F4">      }</span></span>
<span class="line"><span style="color:#F6F6F4">    )</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ActiveRecord::Base</span></span>
<span class="line"><span style="color:#F6F6F4">  attachment </span><span style="color:#BF9EEE">:image</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">RefileShrineSynchronization</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  before_save </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    write_shrine_data(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> image_id_changed?</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>After you deploy this code, the <code>image_data</code> column should now be successfully
synchronized with new attachments.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-data-migration">3. Data migration<a href="#3-data-migration" class="hash-link" aria-label="Direct link to 3. Data migration" title="Direct link to 3. Data migration">​</a></h3><p>Next step is to run a script which writes all existing Refile attachments to
<code>image_data</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.find_each </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |photo|</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.write_shrine_data(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.save!</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-rewrite-code">4. Rewrite code<a href="#4-rewrite-code" class="hash-link" aria-label="Direct link to 4. Rewrite code" title="Direct link to 4. Rewrite code">​</a></h3><p>Now you should be able to rewrite your application so that it uses Shrine
instead of Refile (you can consult the reference in the next section). You can
remove the <code>RefileShrineSynchronization</code> module as well.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-remove-refile-columns">5. Remove Refile columns<a href="#5-remove-refile-columns" class="hash-link" aria-label="Direct link to 5. Remove Refile columns" title="Direct link to 5. Remove Refile columns">​</a></h3><p>If everything is looking good, we can remove Refile columns:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_id</span></span>
<span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_size</span></span>
<span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_filename</span></span>
<span class="line"><span style="color:#F6F6F4">remove_column </span><span style="color:#BF9EEE">:photos</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:image_content_type</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="refile-to-shrine-direct-mapping">Refile to Shrine direct mapping<a href="#refile-to-shrine-direct-mapping" class="hash-link" aria-label="Direct link to Refile to Shrine direct mapping" title="Direct link to Refile to Shrine direct mapping">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="refile"><code>Refile</code><a href="#refile" class="hash-link" aria-label="Direct link to refile" title="Direct link to refile">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cache-store-backends"><code>.cache</code>, <code>.store</code>, <code>.backends</code><a href="#cache-store-backends" class="hash-link" aria-label="Direct link to cache-store-backends" title="Direct link to cache-store-backends">​</a></h4><p>Shrine calles these &quot;storages&quot;, and it doesn&#x27;t have special accessors for
<code>:cache</code> and <code>:store</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Foo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">args),</span></span>
<span class="line"><span style="color:#F6F6F4">  store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Bar</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">args),</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="app-mount_point-automount"><code>.app</code>, <code>.mount_point</code>, <code>.automount</code><a href="#app-mount_point-automount" class="hash-link" aria-label="Direct link to app-mount_point-automount" title="Direct link to app-mount_point-automount">​</a></h4><p>The Rack apps provided by the <code>*_endpoint</code> Shrine plugins are mounted
explicitly:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># adds `POST /images/upload` endpoint</span></span>
<span class="line"><span style="color:#F6F6F4">  mount </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.upload_endpoint(</span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/images/upload</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="allow_uploads_to"><code>.allow_uploads_to</code><a href="#allow_uploads_to" class="hash-link" aria-label="Direct link to allow_uploads_to" title="Direct link to allow_uploads_to">​</a></h4><p>The <code>Shrine.upload_endpoint</code> and <code>Shrine.presign_endpoint</code> builders require you
to specify the storage that will be used.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="logger"><code>.logger</code><a href="#logger" class="hash-link" aria-label="Direct link to logger" title="Direct link to logger">​</a></h4><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.logger</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="processors-processor"><code>.processors</code>, <code>.processor</code><a href="#processors-processor" class="hash-link" aria-label="Direct link to processors-processor" title="Direct link to processors-processor">​</a></h4><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivatives</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, width, height|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="types"><code>.types</code><a href="#types" class="hash-link" aria-label="Direct link to types" title="Direct link to types">​</a></h4><p>Shrine defines validations on the uploader class level:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_max_size </span><span style="color:#BF9EEE">5</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">1024</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extract_filename"><code>.extract_filename</code><a href="#extract_filename" class="hash-link" aria-label="Direct link to extract_filename" title="Direct link to extract_filename">​</a></h4><p>Shrine&#x27;s equivalent is a <code>Shrine#extract_filename</code> private method. You can
instead use the <code>Shrine#extract_metadata</code> public method.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extract_content_type"><code>.extract_content_type</code><a href="#extract_content_type" class="hash-link" aria-label="Direct link to extract_content_type" title="Direct link to extract_content_type">​</a></h4><p>The <a href="https://shrinerb.com/docs/plugins/determine_mime_type" target="_blank" rel="noopener noreferrer"><code>determine_mime_type</code></a> plugin provides a
<code>Shrine.determine_mime_type</code> method.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="app_url-upload_url-attachment_upload_url-presign_url-attachment_presign_url"><code>.app_url</code>, <code>.upload_url</code>, <code>.attachment_upload_url</code>, <code>.presign_url</code>, <code>.attachment_presign_url</code><a href="#app_url-upload_url-attachment_upload_url-presign_url-attachment_presign_url" class="hash-link" aria-label="Direct link to app_url-upload_url-attachment_upload_url-presign_url-attachment_presign_url" title="Direct link to app_url-upload_url-attachment_upload_url-presign_url-attachment_presign_url">​</a></h4><p>Shrine requires you to use your framework to generate URLs to mounted
endpoints.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="attachment_url-file_url"><code>.attachment_url</code>, <code>.file_url</code><a href="#attachment_url-file_url" class="hash-link" aria-label="Direct link to attachment_url-file_url" title="Direct link to attachment_url-file_url">​</a></h4><p>You can call <code>#url</code> on the uploaded file, or <code>#&lt;name&gt;_url</code> on the model.
Alternatively, you can use <code>#download_url</code> provided by the <code>download_endpoint</code>
plugin.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="host-cdn_host-app_host-allow_downloads_from-allow_origin-content_max_age"><code>.host</code>, <code>.cdn_host</code>, <code>.app_host</code>, <code>.allow_downloads_from</code>, <code>allow_origin</code>, <code>.content_max_age</code><a href="#host-cdn_host-app_host-allow_downloads_from-allow_origin-content_max_age" class="hash-link" aria-label="Direct link to host-cdn_host-app_host-allow_downloads_from-allow_origin-content_max_age" title="Direct link to host-cdn_host-app_host-allow_downloads_from-allow_origin-content_max_age">​</a></h4><p>These can be configured on individual <code>*_endpoint</code> plugins.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="secret_key-token-valid_token"><code>.secret_key</code>, <code>.token</code>, <code>.valid_token?</code><a href="#secret_key-token-valid_token" class="hash-link" aria-label="Direct link to secret_key-token-valid_token" title="Direct link to secret_key-token-valid_token">​</a></h4><p>The secret key is required for the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint" target="_blank" rel="noopener noreferrer"><code>derivation_endpoint</code></a>, but these methods are not
exposed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attachment"><code>Attachment</code><a href="#attachment" class="hash-link" aria-label="Direct link to attachment" title="Direct link to attachment">​</a></h3><p>Shrine&#x27;s equivalent to calling the attachment is including an attachment module
of an uploader:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="extension-content_type-type"><code>:extension</code>, <code>:content_type</code>, <code>:type</code><a href="#extension-content_type-type" class="hash-link" aria-label="Direct link to extension-content_type-type" title="Direct link to extension-content_type-type">​</a></h4><p>In Shrine validations are done instance-level inside the uploader, most
commonly with the <code>validation_helpers</code> plugin:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:validation_helpers</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_extension </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[jpg jpeg png]</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_mime_type </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png]</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="cache-store"><code>:cache</code>, <code>:store</code><a href="#cache-store" class="hash-link" aria-label="Direct link to cache-store" title="Direct link to cache-store">​</a></h4><p>Shrine provides a <code>default_storage</code> plugin for setting custom storages on the
uploader:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:custom_cache</span><span style="color:#F6F6F4">] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Foo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">args)</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages[</span><span style="color:#BF9EEE">:custom_store</span><span style="color:#F6F6F4">] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Storage</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Bar</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">args)</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:default_storage</span><span style="color:#F6F6F4">, cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:custom_cache</span><span style="color:#F6F6F4">, store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:custom_store</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="raise_errors"><code>:raise_errors</code><a href="#raise_errors" class="hash-link" aria-label="Direct link to raise_errors" title="Direct link to raise_errors">​</a></h4><p>No equivalent currently exists in Shrine.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="accepts_attachments_for"><code>accepts_attachments_for</code><a href="#accepts_attachments_for" class="hash-link" aria-label="Direct link to accepts_attachments_for" title="Direct link to accepts_attachments_for">​</a></h3><p>No equivalent in Shrine, but take a look at the <a href="https://shrinerb.com/docs/multiple-files" target="_blank" rel="noopener noreferrer">Multiple Files</a> guide.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="form-helpers">Form helpers<a href="#form-helpers" class="hash-link" aria-label="Direct link to Form helpers" title="Direct link to Form helpers">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="attachment_field"><code>attachment_field</code><a href="#attachment_field" class="hash-link" aria-label="Direct link to attachment_field" title="Direct link to attachment_field">​</a></h4><p>The following Refile code</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">form_for </span><span style="color:#BF9EEE;font-style:italic">@user</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |form|</span></span>
<span class="line"><span style="color:#F6F6F4">  form.attachment_field </span><span style="color:#BF9EEE">:profile_image</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>is equivalent to the following Shrine code</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:cached_attachment_data</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">form_for </span><span style="color:#BF9EEE;font-style:italic">@user</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |form|</span></span>
<span class="line"><span style="color:#F6F6F4">  form.hidden_field </span><span style="color:#BF9EEE">:profile_image</span><span style="color:#F6F6F4">, value</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE;font-style:italic">@user</span><span style="color:#F6F6F4">.cached_profile_image_data, id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#F6F6F4">  form.file_field </span><span style="color:#BF9EEE">:profile_image</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="model-methods">Model methods<a href="#model-methods" class="hash-link" aria-label="Direct link to Model methods" title="Direct link to Model methods">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="remove_attachment"><code>remove_&lt;attachment&gt;</code><a href="#remove_attachment" class="hash-link" aria-label="Direct link to remove_attachment" title="Direct link to remove_attachment">​</a></h4><p>Shrine comes with a <code>remove_attachment</code> plugin which adds the same
<code>#remove_&lt;attachment&gt;</code> method to the model.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:remove_attachment</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">form_for </span><span style="color:#BF9EEE;font-style:italic">@user</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |form|</span></span>
<span class="line"><span style="color:#F6F6F4">  form.hidden_field </span><span style="color:#BF9EEE">:profile_image</span><span style="color:#F6F6F4">, value</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE;font-style:italic">@user</span><span style="color:#F6F6F4">.cached_profile_image_data, id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#F6F6F4">  form.file_field </span><span style="color:#BF9EEE">:profile_image</span></span>
<span class="line"><span style="color:#F6F6F4">  form.check_box </span><span style="color:#BF9EEE">:remove_profile_image</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="remote_attachment_url"><code>remote_&lt;attachment&gt;_url</code><a href="#remote_attachment_url" class="hash-link" aria-label="Direct link to remote_attachment_url" title="Direct link to remote_attachment_url">​</a></h4><p>Shrine comes with a <code>remote_url</code> plugin which adds the same
<code>#&lt;attachment&gt;_remote_url</code> method to the model.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:remote_url</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">form_for </span><span style="color:#BF9EEE;font-style:italic">@user</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |form|</span></span>
<span class="line"><span style="color:#F6F6F4">  form.hidden_field </span><span style="color:#BF9EEE">:profile_image</span><span style="color:#F6F6F4">, value</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE;font-style:italic">@user</span><span style="color:#F6F6F4">.cached_profile_image_data, id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span></span>
<span class="line"><span style="color:#F6F6F4">  form.file_field </span><span style="color:#BF9EEE">:profile_image</span></span>
<span class="line"><span style="color:#F6F6F4">  form.text_field </span><span style="color:#BF9EEE">:profile_image_remote_url</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/refile.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-02-19T16:57:27.000Z">Feb 19, 2022</time></b> by <b>Janko Marohnić</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/paperclip"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Upgrading from Paperclip</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#uploader" class="table-of-contents__link toc-highlight">Uploader</a></li><li><a href="#persistence" class="table-of-contents__link toc-highlight">Persistence</a></li><li><a href="#processing" class="table-of-contents__link toc-highlight">Processing</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li><li><a href="#direct-uploads" class="table-of-contents__link toc-highlight">Direct uploads</a></li><li><a href="#multiple-uploads" class="table-of-contents__link toc-highlight">Multiple uploads</a></li></ul></li><li><a href="#migrating-from-refile" class="table-of-contents__link toc-highlight">Migrating from Refile</a><ul><li><a href="#1-add-shrine-column" class="table-of-contents__link toc-highlight">1. Add Shrine column</a></li><li><a href="#2-dual-write" class="table-of-contents__link toc-highlight">2. Dual write</a></li><li><a href="#3-data-migration" class="table-of-contents__link toc-highlight">3. Data migration</a></li><li><a href="#4-rewrite-code" class="table-of-contents__link toc-highlight">4. Rewrite code</a></li><li><a href="#5-remove-refile-columns" class="table-of-contents__link toc-highlight">5. Remove Refile columns</a></li></ul></li><li><a href="#refile-to-shrine-direct-mapping" class="table-of-contents__link toc-highlight">Refile to Shrine direct mapping</a><ul><li><a href="#refile" class="table-of-contents__link toc-highlight"><code>Refile</code></a></li><li><a href="#attachment" class="table-of-contents__link toc-highlight"><code>Attachment</code></a></li><li><a href="#accepts_attachments_for" class="table-of-contents__link toc-highlight"><code>accepts_attachments_for</code></a></li><li><a href="#form-helpers" class="table-of-contents__link toc-highlight">Form helpers</a></li><li><a href="#model-methods" class="table-of-contents__link toc-highlight">Model methods</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b0f70eb.js"></script>
<script src="/assets/js/main.3b0d02ea.js"></script>
</body>
</html>