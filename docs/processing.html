<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-processing">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">File Processing | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/processing"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="File Processing | Shrine"><meta data-rh="true" name="description" content="Shrine allows you to process attached files eagerly or on-the-fly. For"><meta data-rh="true" property="og:description" content="Shrine allows you to process attached files eagerly or on-the-fly. For"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/processing"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/processing" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/processing" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.3b0f70eb.js" as="script">
<link rel="preload" href="/assets/js/main.ea4eabff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a class="navbar__item navbar__link" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a class="navbar__item navbar__link" href="/docs/release_notes/3.5.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/advantages">Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advantages">Advantages of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/design">Base</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">The Design of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/attacher">Using Attacher</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/storage/file-system">Storage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/file-system">File System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/s3">AWS S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/memory">Memory</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/direct-s3">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/metadata">Extracting Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/processing">File Processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/validation">File Validation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/multiple-files">Extras</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/multiple-files">Multiple Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/securing-uploads">Securing Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing">Testing with Shrine</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/changing-derivatives">Migrating</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-location">Migrating File Locations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-storage">Migrating File Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/creating-plugins">Extending</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-storages">Writing a Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/upgrading-to-3">Upgrading</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/refile">Upgrading from Refile</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>File Processing</h1></header><p>Shrine allows you to process attached files eagerly or on-the-fly. For
example, if your app is accepting image uploads, you can generate a predefined
set of of thumbnails when the image is attached to a record, or you can have
thumbnails generated dynamically as they&#x27;re needed.</p><p>How you&#x27;re going to implement processing is entirely up to you. For images it&#x27;s
recommended to use the <strong><a href="https://github.com/janko/image_processing" target="_blank" rel="noopener noreferrer">ImageProcessing</a></strong> gem, which provides wrappers for
processing with <a href="https://github.com/janko/image_processing/blob/master/doc/minimagick.md#readme" target="_blank" rel="noopener noreferrer">MiniMagick</a> and
<a href="https://github.com/janko/image_processing/blob/master/doc/vips.md#readme" target="_blank" rel="noopener noreferrer">libvips</a>. Here is an example of generating a thumbnail
with ImageProcessing:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ brew install imagemagick</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 1.8</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing/mini_magick</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">thumbnail </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">MiniMagick</span></span>
<span class="line"><span style="color:#F6F6F4">  .source(image)              </span><span style="color:#7B7F8B"># input file</span></span>
<span class="line"><span style="color:#F6F6F4">  .resize_to_limit(</span><span style="color:#BF9EEE">600</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">400</span><span style="color:#F6F6F4">)  </span><span style="color:#7B7F8B"># resize macro</span></span>
<span class="line"><span style="color:#F6F6F4">  .colorspace(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">grayscale</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)    </span><span style="color:#7B7F8B"># custom operation</span></span>
<span class="line"><span style="color:#F6F6F4">  .convert(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">jpeg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)            </span><span style="color:#7B7F8B"># output type</span></span>
<span class="line"><span style="color:#F6F6F4">  .saver(quality</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">90</span><span style="color:#F6F6F4">)         </span><span style="color:#7B7F8B"># output options</span></span>
<span class="line"><span style="color:#F6F6F4">  .call                       </span><span style="color:#7B7F8B"># run the pipeline</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">thumbnail </span><span style="color:#7B7F8B">#=&gt; #&lt;Tempfile:...&gt; (a 600x400 thumbnail of the source image)</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="eager-processing">Eager processing<a href="#eager-processing" class="hash-link" aria-label="Direct link to Eager processing" title="Direct link to Eager processing">​</a></h2><p>Let&#x27;s say we&#x27;re handling images, and want to generate a predefined set of
thumbnails with various dimensions. We can use the
<strong><a href="https://shrinerb.com/docs/plugins/derivatives" target="_blank" rel="noopener noreferrer"><code>derivatives</code></a></strong> plugin to upload and save the processed files:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:derivatives</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing/mini_magick</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">      large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(image</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> photo.valid?</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.image_derivatives! </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> photo.image_changed? </span><span style="color:#7B7F8B"># creates derivatives</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.save</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>After the processed files are uploaded, their data is saved into the
<code>&lt;attachment&gt;_data</code> column. You can then retrieve the derivatives as
<a href="http://shrinerb.com/rdoc/classes/Shrine/UploadedFile/InstanceMethods.html" target="_blank" rel="noopener noreferrer"><code>Shrine::UploadedFile</code></a> objects:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">)            </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">).url        </span><span style="color:#7B7F8B">#=&gt; &quot;/uploads/store/lg043.jpg&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">).size       </span><span style="color:#7B7F8B">#=&gt; 5825949</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">).mime_type  </span><span style="color:#7B7F8B">#=&gt; &quot;image/jpeg&quot;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conditional-derivatives">Conditional derivatives<a href="#conditional-derivatives" class="hash-link" aria-label="Direct link to Conditional derivatives" title="Direct link to Conditional derivatives">​</a></h3><p>The <code>Attacher.derivatives</code> block is evaluated in context of a
<code>Shrine::Attacher</code> instance:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::Attacher&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  file    </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  record  </span><span style="color:#7B7F8B">#=&gt; #&lt;Photo&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">  name    </span><span style="color:#7B7F8B">#=&gt; :image</span></span>
<span class="line"><span style="color:#F6F6F4">  context </span><span style="color:#7B7F8B">#=&gt; { ... }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>This gives you the ability to branch the processing logic based on the
attachment information:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">  magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"><span style="color:#F6F6F4">  result </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> record.is_a?(</span><span style="color:#BF9EEE">Photo</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    result[</span><span style="color:#BF9EEE">:jpg</span><span style="color:#F6F6F4">]  </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> magick.convert!(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">jpeg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    result[</span><span style="color:#BF9EEE">:gray</span><span style="color:#F6F6F4">] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> magick.colorspace!(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">grayscale</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> file.mime_type </span><span style="color:#F286C4">==</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image/svg+xml</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">    result[</span><span style="color:#BF9EEE">:png</span><span style="color:#F6F6F4">] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> magick.loader(transparent</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">white</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">).convert!(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">png</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  result</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>The <a href="https://shrinerb.com/docs/plugins/type_predicates" target="_blank" rel="noopener noreferrer"><code>type_predicates</code></a> plugin provides convenient predicate
methods for branching based on the file type.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backgrounding">Backgrounding<a href="#backgrounding" class="hash-link" aria-label="Direct link to Backgrounding" title="Direct link to Backgrounding">​</a></h3><p>Since file processing can be time consuming, it&#x27;s recommended to move it into a
background job.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-creating-derivatives-with-promotion">A) Creating derivatives with promotion<a href="#a-creating-derivatives-with-promotion" class="hash-link" aria-label="Direct link to A) Creating derivatives with promotion" title="Direct link to A) Creating derivatives with promotion">​</a></h4><p>The simplest way is to use the <a href="https://shrinerb.com/docs/plugins/backgrounding" target="_blank" rel="noopener noreferrer"><code>backgrounding</code></a> plugin to move
promotion into a background job, and then create derivatives as part of
promotion:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:backgrounding</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.promote_block </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">PromoteJob</span><span style="color:#F6F6F4">.perform_async(</span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.class.name, record.class.name, record.id, name, file_data)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">PromoteJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_id</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">file_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.create_derivatives </span><span style="color:#7B7F8B"># calls derivatives processor</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_promote</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># attachment has changed or the record has been deleted, nothing to do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="b-creating-derivatives-separately-from-promotion">B) Creating derivatives separately from promotion<a href="#b-creating-derivatives-separately-from-promotion" class="hash-link" aria-label="Direct link to B) Creating derivatives separately from promotion" title="Direct link to B) Creating derivatives separately from promotion">​</a></h4><p>Derivatives don&#x27;t need to be created as part of the attachment flow, you can
create them at any point after promotion:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">DerivativesJob</span><span style="color:#F6F6F4">.perform_async(</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.record.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.record.id,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.name,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.file_data,</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DerivativesJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_id</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">file_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.create_derivatives </span><span style="color:#7B7F8B"># calls derivatives processor</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_persist</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher&amp;.destroy_attached </span><span style="color:#7B7F8B"># delete now orphaned derivatives</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="c-creating-derivatives-concurrently">C) Creating derivatives concurrently<a href="#c-creating-derivatives-concurrently" class="hash-link" aria-label="Direct link to C) Creating derivatives concurrently" title="Direct link to C) Creating derivatives concurrently">​</a></h4><p>You can also generate derivatives concurrently:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">THUMBNAILS</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">    large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  [</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">    medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">    small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  [</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">    thumbnail </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">MiniMagick</span></span>
<span class="line"><span style="color:#F6F6F4">      .source(original)</span></span>
<span class="line"><span style="color:#F6F6F4">      .resize_to_limit!(</span><span style="color:#F286C4">*</span><span style="color:#97E1F1;font-style:italic">THUMBNAILS</span><span style="color:#F6F6F4">.fetch(name))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    { name </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> thumbnail }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">THUMBNAILS</span><span style="color:#F6F6F4">.each_key </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative_name|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">DerivativeJob</span><span style="color:#F6F6F4">.perform_async(</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.record.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.record.id,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.name,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.file_data,</span></span>
<span class="line"><span style="color:#F6F6F4">    derivative_name,</span></span>
<span class="line"><span style="color:#F6F6F4">  )</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DerivativeJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_id</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">file_data</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">derivative_name</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.create_derivatives(name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> derivative_name)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_persist </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |reloaded_attacher|</span></span>
<span class="line"><span style="color:#F6F6F4">      </span><span style="color:#7B7F8B"># make sure we don&#x27;t override derivatives created in other jobs</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher.merge_derivatives(reloaded_attacher.derivatives)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.derivatives[derivative_name].delete </span><span style="color:#7B7F8B"># delete now orphaned derivative</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="url-fallbacks">URL fallbacks<a href="#url-fallbacks" class="hash-link" aria-label="Direct link to URL fallbacks" title="Direct link to URL fallbacks">​</a></h3><p>If you&#x27;re creating derivatives in a background job, you&#x27;ll likely want to use
some fallbacks for derivative URLs while the background job is still
processing. You can do that with the <a href="https://shrinerb.com/docs/plugins/default_url" target="_blank" rel="noopener noreferrer"><code>default_url</code></a> plugin.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:default_url</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="a-fallback-to-original">A) Fallback to original<a href="#a-fallback-to-original" class="hash-link" aria-label="Direct link to A) Fallback to original" title="Direct link to A) Fallback to original">​</a></h4><p>You can fall back to the original file URL when the derivative is missing:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">  file&amp;.url </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> derivative</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/path/to/original.jpg&quot;</span></span>
<span class="line"><span style="color:#7B7F8B"># ... background job finishes ...</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/path/to/large.jpg&quot;</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="b-fallback-to-derivative">B) Fallback to derivative<a href="#b-fallback-to-derivative" class="hash-link" aria-label="Direct link to B) Fallback to derivative" title="Direct link to B) Fallback to derivative">​</a></h4><p>You can fall back to another derivative URL when the derivative is missing:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">  derivatives[</span><span style="color:#BF9EEE">:optimized</span><span style="color:#F6F6F4">]&amp;.url </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> derivative</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/path/to/optimized.jpg&quot;</span></span>
<span class="line"><span style="color:#7B7F8B"># ... background job finishes ...</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/path/to/large.jpg&quot;</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="c-fallback-to-on-the-fly">C) Fallback to on-the-fly<a href="#c-fallback-to-on-the-fly" class="hash-link" aria-label="Direct link to C) Fallback to on-the-fly" title="Direct link to C) Fallback to on-the-fly">​</a></h4><p>You can also fall back to <a href="#on-the-fly-processing">on-the-fly processing</a>,
which should generally provide the best user experience.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#BF9EEE">THUMBNAILS</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> {</span></span>
<span class="line"><span style="color:#F6F6F4">  small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  [</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  [</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">  file&amp;.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">*</span><span style="color:#97E1F1;font-style:italic">THUMBNAILS</span><span style="color:#F6F6F4">.fetch(derivative)) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> derivative</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;../derivations/thumbnail/800/800/...&quot;</span></span>
<span class="line"><span style="color:#7B7F8B"># ... background job finishes ...</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; &quot;https://example.com/path/to/large.jpg&quot;</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="on-the-fly-processing">On-the-fly processing<a href="#on-the-fly-processing" class="hash-link" aria-label="Direct link to On-the-fly processing" title="Direct link to On-the-fly processing">​</a></h2><p>Having eagerly created image thumbnails can be a pain to maintain, because
whenever you need to add a new version or change an existing one, you need to
retroactively apply it to all existing attachments (see the <a href="https://shrinerb.com/docs/changing-derivatives" target="_blank" rel="noopener noreferrer">Managing
Derivatives</a> guide for more details).</p><p>Sometimes it makes more sense to generate thumbnails dynamically as they&#x27;re
requested, and then cache them for future requests. This strategy is known as
processing &quot;<strong>on-the-fly</strong>&quot; or &quot;<strong>on-demand</strong>&quot;, and it&#x27;s suitable for
short-running processing such as creating image thumbnails or document
previews.</p><p>Shrine provides on-the-fly processing functionality via the
<strong><a href="https://shrinerb.com/docs/plugins/derivation_endpoint" target="_blank" rel="noopener noreferrer"><code>derivation_endpoint</code></a></strong> plugin. You set it up by
loading the plugin with a secret key (you generate this yourself, maybe via
something like <code>SecureRandom.hex</code>) and a path prefix, mount its Rack app in
your routes on the configured path prefix, and define processing you want to
perform:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/initializers/shrine.rb (Rails)</span></span>
<span class="line"><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, secret_key</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">&lt;SHRINE_SECRET_KEY&gt;</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing/mini_magick</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivation_endpoint</span><span style="color:#F6F6F4">, prefix</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivations/image</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># matches mount point</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  derivation </span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, width, height|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">MiniMagick</span></span>
<span class="line"><span style="color:#F6F6F4">      .source(file)</span></span>
<span class="line"><span style="color:#F6F6F4">      .resize_to_limit!(width.to_i, height.to_i)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># config/routes.rb (Rails)</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  mount </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F6F6F4">.derivation_endpoint </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/derivations/image</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Now you can generate thumbnail URLs from attached files, and the actual
thumbnail will be generated when the URL is requested:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image.derivation_url(</span><span style="color:#BF9EEE">:thumbnail</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">600</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">400</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; &quot;/derivations/image/thumbnail/600/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;</span></span></code></pre></div><p>The plugin is highly customizable, be sure to check out the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint" target="_blank" rel="noopener noreferrer">documentation</a>, especially the <a href="https://shrinerb.com/docs/plugins/derivation_endpoint#performance" target="_blank" rel="noopener noreferrer">performance
section</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-derivation">Dynamic derivation<a href="#dynamic-derivation" class="hash-link" aria-label="Direct link to Dynamic derivation" title="Direct link to Dynamic derivation">​</a></h3><p>If you have multiple types of transformations and don&#x27;t want to have a
derivation for each one, you can set up a single derivation that applies any
series of transformations:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  derivation </span><span style="color:#BF9EEE">:transform</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original, transformations|</span></span>
<span class="line"><span style="color:#F6F6F4">    transformations </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.urlsafe_deserialize(transformations)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    vips </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Vips</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"><span style="color:#F6F6F4">    vips.apply!(transformations)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image.derivation_url </span><span style="color:#BF9EEE">:transform</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.urlsafe_serialize(</span></span>
<span class="line"><span style="color:#F6F6F4">  crop</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">          [</span><span style="color:#BF9EEE">10</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">10</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  resize_to_fit</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  gaussblur</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#BF9EEE">1</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><p>You can create a helper method for convenience:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">derivation_url</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">file</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">transformations</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  file.derivation_url(</span><span style="color:#BF9EEE">:transform</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.urlsafe_serialize(transformations))</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">derivation_url photo.image,</span></span>
<span class="line"><span style="color:#F6F6F4">  crop</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">          [</span><span style="color:#BF9EEE">10</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">10</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  resize_to_fit</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">  gaussblur</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">     </span><span style="color:#BF9EEE">1</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="processing-other-filetypes">Processing other filetypes<a href="#processing-other-filetypes" class="hash-link" aria-label="Direct link to Processing other filetypes" title="Direct link to Processing other filetypes">​</a></h2><p>So far we&#x27;ve only been talking about processing images. However, there is
nothing image-specific in Shrine&#x27;s processing API, you can just as well process
any other types of files. The processing tool doesn&#x27;t need to have any special
Shrine integration, the ImageProcessing gem that we saw earlier is a completely
generic gem.</p><p>To demonstrate, here is an example of transcoding videos using</p><h1>Gemfile</h1><p>gem &quot;streamio-ffmpeg&quot;</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">```rb</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">require &quot;streamio-ffmpeg&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class VideoUploader &lt; Shrine</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  Attacher.derivatives do |original|</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    transcoded = Tempfile.new [&quot;transcoded&quot;, &quot;.mp4&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    screenshot = Tempfile.new [&quot;screenshot&quot;, &quot;.jpg&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    movie = FFMPEG::Movie.new(original.path)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    movie.transcode(transcoded.path)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    movie.screenshot(screenshot.path)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    { transcoded: transcoded, screenshot: screenshot }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="polymorphic-uploader">Polymorphic uploader<a href="#polymorphic-uploader" class="hash-link" aria-label="Direct link to Polymorphic uploader" title="Direct link to Polymorphic uploader">​</a></h3><p>Sometimes you might want an attachment attribute to accept multiple types of
files, and apply different processing depending on the type. Since Shrine&#x27;s
processing blocks are evaluated dynamically, you can use conditional logic:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">PolymorphicUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">IMAGE_TYPES</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">jpeg image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">png image</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">webp]</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">VIDEO_TYPES</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[video</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">mp4 video</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">quicktime]</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">PDF_TYPES</span><span style="color:#F6F6F4">   </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">%</span><span style="color:#F6F6F4">w[application</span><span style="color:#F286C4">/</span><span style="color:#F6F6F4">pdf]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    validate_mime_type </span><span style="color:#BF9EEE">IMAGE_TYPES</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">+</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">VIDEO_TYPES</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">+</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">PDF_TYPES</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">case</span><span style="color:#F6F6F4"> file.mime_type</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">when</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">IMAGE_TYPES</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">then</span><span style="color:#F6F6F4"> process_derivatives(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">, original)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">when</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">VIDEO_TYPES</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">then</span><span style="color:#F6F6F4"> process_derivatives(</span><span style="color:#BF9EEE">:video</span><span style="color:#F6F6F4">, original)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">when</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">*</span><span style="color:#BF9EEE">PDF_TYPES</span><span style="color:#F6F6F4">   </span><span style="color:#F286C4">then</span><span style="color:#F6F6F4"> process_derivatives(</span><span style="color:#BF9EEE">:pdf</span><span style="color:#F6F6F4">,   original)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#BF9EEE">:video</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#BF9EEE">:pdf</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="extras">Extras<a href="#extras" class="hash-link" aria-label="Direct link to Extras" title="Direct link to Extras">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="automatic-derivatives">Automatic derivatives<a href="#automatic-derivatives" class="hash-link" aria-label="Direct link to Automatic derivatives" title="Direct link to Automatic derivatives">​</a></h3><p>If you would like derivatives to be automatically created with promotion, you
can use the <code>create_on_promote</code> option built-in to the derivatives plugin.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Shrine::Attacher</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivatives</span><span style="color:#F6F6F4">, create_on_promote</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>This shouldn&#x27;t be needed if you&#x27;re processing in the
<a href="#backgrounding">background</a>, as in that case you have a background worker that
will be called for each attachment, so you can call
<code>Attacher#create_derivatives</code> there.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="libvips">libvips<a href="#libvips" class="hash-link" aria-label="Direct link to libvips" title="Direct link to libvips">​</a></h3><p>As mentioned, ImageProcessing gem also has an alternative backend for
processing images with <strong><a href="https://libvips.github.io/libvips/" target="_blank" rel="noopener noreferrer">libvips</a></strong>. libvips is a full-featured image
processing library like ImageMagick, with impressive performance
characteristics – it&#x27;s often <strong>multiple times faster</strong> than ImageMagick and has
low memory usage (see <a href="https://github.com/libvips/libvips/wiki/Why-is-libvips-quick" target="_blank" rel="noopener noreferrer">Why is libvips quick</a>).</p><p>Using libvips is as easy as installing it and switching to the
<a href="https://github.com/janko/image_processing/blob/master/doc/vips.md#readme" target="_blank" rel="noopener noreferrer"><code>ImageProcessing::Vips</code></a> backend:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ brew install vips</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 1.8</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image_processing/vips</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># all we did was replace `ImageProcessing::MiniMagick` with `ImageProcessing::Vips`</span></span>
<span class="line"><span style="color:#F6F6F4">thumbnail </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Vips</span></span>
<span class="line"><span style="color:#F6F6F4">  .source(image)</span></span>
<span class="line"><span style="color:#F6F6F4">  .resize_to_limit!(</span><span style="color:#BF9EEE">600</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">400</span><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">thumbnail </span><span style="color:#7B7F8B">#=&gt; #&lt;Tempfile:...&gt; (a 600x400 thumbnail of the source image)</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="parallelize-uploads">Parallelize uploads<a href="#parallelize-uploads" class="hash-link" aria-label="Direct link to Parallelize uploads" title="Direct link to Parallelize uploads">​</a></h3><p>If you&#x27;re generating derivatives, you can parallelize the uploads using the
<a href="https://github.com/ruby-concurrency/concurrent-ruby" target="_blank" rel="noopener noreferrer">concurrent-ruby</a> gem:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">concurrent-ruby</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">concurrent</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">derivatives </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher.process_derivatives</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">tasks </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivatives.map </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |name, file|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Concurrent</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Promises</span><span style="color:#F6F6F4">.future(name, file) </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |name, file|</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.add_derivative(name, file)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Concurrent</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Promises</span><span style="color:#F6F6F4">.zip(</span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">tasks).wait!</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="external-processing">External processing<a href="#external-processing" class="hash-link" aria-label="Direct link to External processing" title="Direct link to External processing">​</a></h3><p>You can also integrate Shrine with 3rd-party processing services such as
<a href="https://cloudinary.com/" target="_blank" rel="noopener noreferrer">Cloudinary</a> and <a href="https://www.imgix.com/" target="_blank" rel="noopener noreferrer">Imgix</a>. In the most common case, you&#x27;d serve images directly
from these services, see the corresponding plugin docs for more details
(<a href="https://github.com/shrinerb/shrine-cloudinary" target="_blank" rel="noopener noreferrer">shrine-cloudinary</a>, <a href="https://github.com/shrinerb/shrine-imgix" target="_blank" rel="noopener noreferrer">shrine-imgix</a> and <a href="https://shrinerb.com/docs/external/extensions#storages" target="_blank" rel="noopener noreferrer">others</a>)</p><p>You can also choose to use these services as an implementation detail of your
application, by downloading the processed images and saving them to your
storage. Here is how you might store files processed by Imgix as derivatives:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">down</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 5.0</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">http</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 4.0</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine-imgix</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">~&gt; 0.5</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:derivatives</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:imgix</span><span style="color:#F6F6F4">, client</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { host</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">my-app.imgix.net</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, secure_url_token</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">secret</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">down/http</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#BF9EEE">IMGIX_THUMBNAIL</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (file, width, height) </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">Down</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Http</span><span style="color:#F6F6F4">.download(file.imgix_url(w</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> width, h</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> height))</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">      large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">IMGIX_THUMBNAIL</span><span style="color:#F6F6F4">[file, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">      medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">IMGIX_THUMBNAIL</span><span style="color:#F6F6F4">[file, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">      small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">IMGIX_THUMBNAIL</span><span style="color:#F6F6F4">[file, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">],</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/processing.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-03-07T15:54:43.000Z">Mar 7, 2021</time></b> by <b>Dan Brown</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/metadata"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Extracting Metadata</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/validation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">File Validation</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#eager-processing" class="table-of-contents__link toc-highlight">Eager processing</a><ul><li><a href="#conditional-derivatives" class="table-of-contents__link toc-highlight">Conditional derivatives</a></li><li><a href="#backgrounding" class="table-of-contents__link toc-highlight">Backgrounding</a></li><li><a href="#url-fallbacks" class="table-of-contents__link toc-highlight">URL fallbacks</a></li></ul></li><li><a href="#on-the-fly-processing" class="table-of-contents__link toc-highlight">On-the-fly processing</a><ul><li><a href="#dynamic-derivation" class="table-of-contents__link toc-highlight">Dynamic derivation</a></li></ul></li><li><a href="#processing-other-filetypes" class="table-of-contents__link toc-highlight">Processing other filetypes</a><ul><li><a href="#polymorphic-uploader" class="table-of-contents__link toc-highlight">Polymorphic uploader</a></li></ul></li><li><a href="#extras" class="table-of-contents__link toc-highlight">Extras</a><ul><li><a href="#automatic-derivatives" class="table-of-contents__link toc-highlight">Automatic derivatives</a></li><li><a href="#libvips" class="table-of-contents__link toc-highlight">libvips</a></li><li><a href="#parallelize-uploads" class="table-of-contents__link toc-highlight">Parallelize uploads</a></li><li><a href="#external-processing" class="table-of-contents__link toc-highlight">External processing</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b0f70eb.js"></script>
<script src="/assets/js/main.ea4eabff.js"></script>
</body>
</html>