<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-upgrading-to-3">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Upgrading to Shrine 3.x | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/upgrading-to-3"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Upgrading to Shrine 3.x | Shrine"><meta data-rh="true" name="description" content="This guide provides instructions for upgrading Shrine in your apps to version"><meta data-rh="true" property="og:description" content="This guide provides instructions for upgrading Shrine in your apps to version"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/upgrading-to-3"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/upgrading-to-3" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/upgrading-to-3" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.9151cbe8.js" as="script">
<link rel="preload" href="/assets/js/main.73137c51.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a class="navbar__item navbar__link" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a class="navbar__item navbar__link" href="/docs/release_notes/3.6.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/advantages">Introduction</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advantages">Advantages of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/design">Base</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/design">The Design of Shrine</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/attacher">Using Attacher</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/storage/file-system">Storage</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/file-system">File System</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/s3">AWS S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/storage/memory">Memory</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/direct-s3">Features</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/metadata">Extracting Metadata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/processing">File Processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/validation">File Validation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/multiple-files">Extras</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/multiple-files">Multiple Files</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/securing-uploads">Securing Uploads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/testing">Testing with Shrine</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/changing-derivatives">Migrating</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-location">Migrating File Locations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/changing-storage">Migrating File Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/creating-plugins">Extending</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/creating-storages">Writing a Storage</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/upgrading-to-3">Upgrading</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/carrierwave">Upgrading from CarrierWave</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/paperclip">Upgrading from Paperclip</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/refile">Upgrading from Refile</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Upgrading to Shrine 3.x</h1></header><p>This guide provides instructions for upgrading Shrine in your apps to version
3.x. If you&#x27;re looking for a full list of changes, see the <strong><a href="https://shrinerb.com/docs/release_notes/3.0.0" target="_blank" rel="noopener noreferrer">3.0 release
notes</a></strong>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="attacher">Attacher<a href="#attacher" class="hash-link" aria-label="Direct link to Attacher" title="Direct link to Attacher">​</a></h2><p>The <code>Shrine::Attacher</code> class has been rewritten in Shrine 3.0, though much of
the main API remained the same.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="model">Model<a href="#model" class="hash-link" aria-label="Direct link to Model" title="Direct link to Model">​</a></h3><p>The main change is that <code>Attacher.new</code> is now used for initializing the
attacher without a model:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span></span>
<span class="line"><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::Attacher&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(photo, </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B"># ~&gt; ArgumentError: invalid number of arguments</span></span></code></pre></div><p>To initialize an attacher with a model, use <code>Attacher.from_model</code> provided by
the new <a href="https://shrinerb.com/docs/plugins/model" target="_blank" rel="noopener noreferrer"><code>model</code></a> plugin (which is automatically loaded by
<code>activerecord</code> and <code>sequel</code> plugins):</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.from_model(photo, </span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B"># ...</span></span></code></pre></div><p>If you&#x27;re using the <code>Shrine::Attachment</code> module with POROs, make sure to load
the <code>model</code> plugin.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:model</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Struct.new</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-attribute">Data attribute<a href="#data-attribute" class="hash-link" aria-label="Direct link to Data attribute" title="Direct link to Data attribute">​</a></h3><p>The <code>Attacher#read</code> method has been removed. If you want to generate serialized
attachment data, use <code>Attacher#column_data</code>. Otherwise if you want to generate
hash attachment data, use <code>Attacher#data</code>.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.column_data </span><span style="color:#7B7F8B">#=&gt; &#x27;{&quot;id&quot;:&quot;...&quot;,&quot;storage&quot;:&quot;...&quot;,&quot;metadata&quot;:{...}}&#x27;</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.data        </span><span style="color:#7B7F8B">#=&gt; { &quot;id&quot; =&gt; &quot;...&quot;, &quot;storage&quot; =&gt; &quot;...&quot;, &quot;metadata&quot; =&gt; { ... } }</span></span></code></pre></div><p>The <code>Attacher#data_attribute</code> has been renamed to <code>Attacher#attribute</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="state">State<a href="#state" class="hash-link" aria-label="Direct link to State" title="Direct link to State">​</a></h3><p>The attacher now maintains its own state, so if you&#x27;ve previously modified the
<code>#&lt;name&gt;_data</code> record attribute and expected the changes to be picked up by the
attacher, you&#x27;ll now need to call <code>Attacher#reload</code> for that:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; nil</span></span>
<span class="line"><span style="color:#F6F6F4">record.image_data </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&#x27;</span><span style="color:#E7EE98">{&quot;id&quot;:&quot;...&quot;,&quot;storage&quot;:&quot;...&quot;,&quot;metadata&quot;:{...}}</span><span style="color:#DEE492">&#x27;</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; nil</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.reload</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="assigning">Assigning<a href="#assigning" class="hash-link" aria-label="Direct link to Assigning" title="Direct link to Assigning">​</a></h3><p>The <code>Attacher#assign</code> method now raises an exception when non-cached uploaded
file data is assigned:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Shrine 2.x</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.assign(</span><span style="color:#DEE492">&#x27;</span><span style="color:#E7EE98">{&quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;store&quot;, &quot;metadata&quot;: {...}}</span><span style="color:#DEE492">&#x27;</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B"># ignored</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># Shrine 3.0</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.assign(</span><span style="color:#DEE492">&#x27;</span><span style="color:#E7EE98">{&quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;store&quot;, &quot;metadata&quot;: {...}}</span><span style="color:#DEE492">&#x27;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#7B7F8B">#~&gt; Shrine::Error: expected cached file, got #&lt;Shrine::UploadedFile storage=:store ...&gt;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a href="#validation" class="hash-link" aria-label="Direct link to Validation" title="Direct link to Validation">​</a></h3><p>The validation functionality has been extracted into the <code>validation</code> plugin.
If you&#x27;re using the <code>validation_helpers</code> plugin, it will automatically load
<code>validation</code> for you. Otherwise you&#x27;ll have to load it explicitly:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:validation</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="setting">Setting<a href="#setting" class="hash-link" aria-label="Direct link to Setting" title="Direct link to Setting">​</a></h3><p>The <code>Attacher#set</code> method has been renamed to <code>Attacher#change</code>, and the
private <code>Attacher#_set</code> method has been renamed to <code>Attacher#set</code> and made
public:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.change(uploaded_file) </span><span style="color:#7B7F8B"># sets file, remembers previous file, runs validations</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.set(uploaded_file)    </span><span style="color:#7B7F8B"># sets file</span></span></code></pre></div><p>If you&#x27;ve previously used <code>Attacher#replace</code> directly to delete previous file,
it has now been renamed to <code>Attacher#destroy_previous</code>.</p><p>Also note that <code>Attacher#attached?</code> now returns whether a file is attached,
while <code>Attacher#changed?</code> continues to return whether the attachment has
changed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uploading-and-deleting">Uploading and deleting<a href="#uploading-and-deleting" class="hash-link" aria-label="Direct link to Uploading and deleting" title="Direct link to Uploading and deleting">​</a></h3><p>The <code>Attacher#store!</code> and <code>Attacher#cache!</code> methods have been removed, you
should now use <code>Attacher#upload</code> instead:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.upload(io)               </span><span style="color:#7B7F8B"># uploads to permanent storage</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.upload(io, </span><span style="color:#BF9EEE">:cache</span><span style="color:#F6F6F4">)       </span><span style="color:#7B7F8B"># uploads to temporary storage</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.upload(io, </span><span style="color:#BF9EEE">:other_store</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B"># uploads to another storage</span></span></code></pre></div><p>The <code>Attacher#delete!</code> method has been removed as well, you should instead just
delete the file directly via <code>UploadedFile#delete</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="promoting">Promoting<a href="#promoting" class="hash-link" aria-label="Direct link to Promoting" title="Direct link to Promoting">​</a></h3><p>If you were promoting manually, the <code>Attacher#promote</code> method will now only
save promoted file in memory, it won&#x27;t persist the changes.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.promote</span></span>
<span class="line"><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">record.save </span><span style="color:#7B7F8B"># you need to persist the changes</span></span></code></pre></div><p>If you want the concurrenct-safe promotion with persistence, use the new
<code>Attacher#atomic_promote</code> method.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.atomic_promote</span></span></code></pre></div><p>The <code>Attacher#swap</code> method has been removed. If you were using it directly, you
can use <code>Attacher#set</code> and <code>Attacher#atomic_persist</code> instead:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">current_file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher.file</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.set(new_file)</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.atomic_persist(current_file)</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="backgrounding">Backgrounding<a href="#backgrounding" class="hash-link" aria-label="Direct link to Backgrounding" title="Direct link to Backgrounding">​</a></h2><p>The <code>backgrounding</code> plugin has been rewritten in Shrine 3.0 and has a new API.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:backgrounding</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.promote_block </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">PromoteJob</span><span style="color:#F6F6F4">.perform_async(</span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.class.name, record.class.name, record.id, name, file_data)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.destroy_block </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">DestroyJob</span><span style="color:#F6F6F4">.perform_async(</span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.class.name, data)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">PromoteJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_id</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">file_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_promote</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># attachment has changed or record has been deleted, nothing to do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DestroyJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.from_data(data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.destroy</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="dual-support">Dual support<a href="#dual-support" class="hash-link" aria-label="Direct link to Dual support" title="Direct link to Dual support">​</a></h3><p>When you&#x27;re making the switch in production, there might still be jobs in the
queue that have the old argument format. So, we&#x27;ll initially want to handle
both argument formats, and then switch to the new one once the jobs with old
format have been drained.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">PromoteJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">*</span><span style="color:#FFB86C;font-style:italic">args</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> args.one?</span></span>
<span class="line"><span style="color:#F6F6F4">      file_data, (record_class, record_id), name, shrine_class </span><span style="color:#F286C4">=</span></span>
<span class="line"><span style="color:#F6F6F4">        args.first.values_at(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">record</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">name</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine_class</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(shrine_class)</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attacher</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher_class, record_class, record_id, name, file_data </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> args</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">      record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_promote</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># attachment has changed or record has been deleted, nothing to do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DestroyJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#F286C4">*</span><span style="color:#FFB86C;font-style:italic">args</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> args.one?</span></span>
<span class="line"><span style="color:#F6F6F4">      data, shrine_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> args.first.values_at(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine_class</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      data           </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">JSON</span><span style="color:#F6F6F4">.parse(data)</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(shrine_class)</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attacher</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">      attacher_class, data </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> args</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.from_data(data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.destroy</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attacher-backgrounding">Attacher backgrounding<a href="#attacher-backgrounding" class="hash-link" aria-label="Direct link to Attacher backgrounding" title="Direct link to Attacher backgrounding">​</a></h3><p>In Shrine 2.x, <code>Attacher#_promote</code> and <code>Attacher#_delete</code> methods could be used
to spawn promote and delete jobs. This is now done by <code>Attacher#promote_cached</code>
and <code>Attacher#destroy_attached</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.promote_cached   </span><span style="color:#7B7F8B"># will spawn background job if registered</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.destroy_attached </span><span style="color:#7B7F8B"># will spawn background job if registered</span></span></code></pre></div><p>If you want to explicitly call backgrounding blocks, you can use
<code>Attacher#promote_background</code> and <code>Attacher#destroy_background</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.promote_background </span><span style="color:#7B7F8B"># calls promote block</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.destroy_background </span><span style="color:#7B7F8B"># calls destroy block</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="versions">Versions<a href="#versions" class="hash-link" aria-label="Direct link to Versions" title="Direct link to Versions">​</a></h2><p>The <code>versions</code>, <code>processing</code>, <code>recache</code>, and <code>delete_raw</code> plugins have been
deprecated in favour of the new <strong><a href="https://shrinerb.com/docs/plugins/derivatives" target="_blank" rel="noopener noreferrer"><code>derivatives</code></a></strong> plugin.</p><p>Let&#x27;s assume you have the following <code>versions</code> configuration:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:processing</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:versions</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:delete_raw</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  process(</span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |file, context|</span></span>
<span class="line"><span style="color:#F6F6F4">    versions </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { original</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    file.download </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">      magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">      versions[</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">]  </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">      versions[</span><span style="color:#BF9EEE">:medium</span><span style="color:#F6F6F4">] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">      versions[</span><span style="color:#BF9EEE">:small</span><span style="color:#F6F6F4">]  </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    versions</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>When an attached file is promoted to permanent storage, the versions would
automatically get generated:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(photo_params)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> photo.valid?</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.save </span><span style="color:#7B7F8B"># generates versions on promotion</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>With <code>derivatives</code>, the original file is automatically downloaded and retained
during processing, so the setup is simpler:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:derivatives</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  create_on_promote</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">      </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">, </span><span style="color:#7B7F8B"># automatically create derivatives on promotion</span></span>
<span class="line"><span style="color:#F6F6F4">  versions_compatibility</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># handle versions column format</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># the :original file should NOT be included anymore</span></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">      large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(photo_params)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> photo.valid?</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.save </span><span style="color:#7B7F8B"># creates derivatives on promotion</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="accessing-derivatives">Accessing derivatives<a href="#accessing-derivatives" class="hash-link" aria-label="Direct link to Accessing derivatives" title="Direct link to Accessing derivatives">​</a></h3><p>The derivative URLs are accessed in the same way as versions:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_url(</span><span style="color:#BF9EEE">:small</span><span style="color:#F6F6F4">)</span></span></code></pre></div><p>But the files themselves are accessed differently:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># versions</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#7B7F8B">#   original: #&lt;Shrine::UploadedFile ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   large: #&lt;Shrine::UploadedFile ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   medium: #&lt;Shrine::UploadedFile ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   small: #&lt;Shrine::UploadedFile ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B"># }</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image[</span><span style="color:#BF9EEE">:medium</span><span style="color:#F6F6F4">] </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># derivatives</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#7B7F8B">#   large: #&lt;Shrine::UploadedFile ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   medium: #&lt;Shrine::UploadedFile ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   small: #&lt;Shrine::UploadedFile ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B"># }</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image(</span><span style="color:#BF9EEE">:medium</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="migrating-versions">Migrating versions<a href="#migrating-versions" class="hash-link" aria-label="Direct link to Migrating versions" title="Direct link to Migrating versions">​</a></h3><p>The <code>versions</code> and <code>derivatives</code> plugins save processed file data to the
database column in different formats:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># versions</span></span>
<span class="line"><span style="color:#F6F6F4">{</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">original</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... } },</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">large</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">:    { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... } },</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">medium</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">:   { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... } },</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">small</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">:    { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... } }</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># derivatives</span></span>
<span class="line"><span style="color:#F6F6F4">{</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">,</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... },</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">derivatives</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: {</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">large</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">:  { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... } },</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">medium</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... } },</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">small</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">:  { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">: { ... } }</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div><p>The <code>:versions_compatibility</code> flag to the <code>derivatives</code> plugin enables it to
read the <code>versions</code> format, which aids in transition. Once the <code>derivatives</code>
plugin has been deployed to production, you can update existing records with
the new column format:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.find_each </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |photo|</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.image_attacher.write</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.image_attacher.atomic_persist</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>Afterwards you should be able to remove the <code>:versions_compatibility</code> flag.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backgrounding-derivatives">Backgrounding derivatives<a href="#backgrounding-derivatives" class="hash-link" aria-label="Direct link to Backgrounding derivatives" title="Direct link to Backgrounding derivatives">​</a></h3><p>If you&#x27;re using the <code>backgrounding</code> plugin, you can trigger derivatives
creation in the <code>PromoteJob</code> instead of the controller:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">PromoteJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_id</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">file_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.create_derivatives </span><span style="color:#7B7F8B"># call derivatives processor</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_promote</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># attachment has changed or record has been deleted, nothing to do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="recache">Recache<a href="#recache" class="hash-link" aria-label="Direct link to Recache" title="Direct link to Recache">​</a></h4><p>If you were using the <code>recache</code> plugin, you can replicate the behaviour by
creating another derivatives processor that you will trigger in the controller:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># this will be triggered in the background job</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#BF9EEE">:foreground</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># this will be triggered in the controller</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(photo_params)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> photo.valid?</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.image_derivatives!(</span><span style="color:#BF9EEE">:foreground</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> photo.image_changed?</span></span>
<span class="line"><span style="color:#F6F6F4">  photo.save</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">else</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="default-url">Default URL<a href="#default-url" class="hash-link" aria-label="Direct link to Default URL" title="Direct link to Default URL">​</a></h3><p>If you were using the <code>default_url</code> plugin, the <code>Attacher.default_url</code> now
receives a <code>:derivative</code> option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">https://my-app.com/fallbacks/</span><span style="color:#F286C4">#{</span><span style="color:#E7EE98">derivative</span><span style="color:#F286C4">}</span><span style="color:#E7EE98">.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> derivative</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fallback-to-original">Fallback to original<a href="#fallback-to-original" class="hash-link" aria-label="Direct link to Fallback to original" title="Direct link to Fallback to original">​</a></h4><p>With the <code>versions</code> plugin, a missing version URL would automatically fall back
to the original file. The <code>derivatives</code> plugin has no such fallback, but you
can configure it manually:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">  file&amp;.url </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> derivative</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="fallback-to-version">Fallback to version<a href="#fallback-to-version" class="hash-link" aria-label="Direct link to Fallback to version" title="Direct link to Fallback to version">​</a></h4><p>The <code>versions</code> plugin had the ability to fall back missing version URL to
another version that already exists. The <code>derivatives</code> plugin doesn&#x27;t have this
built in, but you can implement it as follows:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#BF9EEE">DERIVATIVE_FALLBACKS</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { foo</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:bar</span><span style="color:#F6F6F4">, ... }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_url </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">  derivatives[</span><span style="color:#97E1F1;font-style:italic">DERIVATIVE_FALLBACKS</span><span style="color:#F6F6F4">[derivative]]&amp;.url </span><span style="color:#F286C4">if</span><span style="color:#F6F6F4"> derivative</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="location">Location<a href="#location" class="hash-link" aria-label="Direct link to Location" title="Direct link to Location">​</a></h3><p>The <code>Shrine#generate_location</code> method will now receive a <code>:derivative</code>
parameter instead of <code>:version</code>:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">generate_location</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">io</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">derivative</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    derivative </span><span style="color:#7B7F8B">#=&gt; :large, :medium, :small, ...</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="overwriting-original">Overwriting original<a href="#overwriting-original" class="hash-link" aria-label="Direct link to Overwriting original" title="Direct link to Overwriting original">​</a></h3><p>With the <code>derivatives</code> plugin, saving processed files separately from the
original file, so the original file is automatically kept. This means it&#x27;s not
possible anymore to overwrite the original file as part of processing.</p><p>However, <strong>it&#x27;s highly recommended to always keep the original file</strong>, even if
you don&#x27;t plan to use it. That way, if there is ever a need to reprocess
derivatives, you have the original file to use as a base.</p><p>That being said, if you still want to overwrite the original file, <a href="https://discourse.shrinerb.com/t/keep-original-file-after-processing/50/4" target="_blank" rel="noopener noreferrer">this
thread</a> has some tips.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other">Other<a href="#other" class="hash-link" aria-label="Direct link to Other" title="Direct link to Other">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="processing">Processing<a href="#processing" class="hash-link" aria-label="Direct link to Processing" title="Direct link to Processing">​</a></h3><p>The <code>processing</code> plugin has been deprecated over the new
<a href="https://shrinerb.com/docs/plugins/derivatives" target="_blank" rel="noopener noreferrer"><code>derivatives</code></a> plugin. If you were previously replacing the
original file:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:processing</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  process(</span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">) </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |io, context|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">MiniMagick</span></span>
<span class="line"><span style="color:#F6F6F4">      .source(io.download)</span></span>
<span class="line"><span style="color:#F6F6F4">      .resize_to_limit!(</span><span style="color:#BF9EEE">1600</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">1600</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>you should now add the processed file as a derivative:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:derivatives</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    { normalized</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">1600</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">1600</span><span style="color:#F6F6F4">) }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="parallelize">Parallelize<a href="#parallelize" class="hash-link" aria-label="Direct link to Parallelize" title="Direct link to Parallelize">​</a></h3><p>The <code>parallelize</code> plugin has been removed. With <code>derivatives</code> plugin you can
parallelize uploading processed files manually:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">concurrent-ruby</span><span style="color:#DEE492">&quot;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">concurrent</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">attacher    </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> photo.image_attacher</span></span>
<span class="line"><span style="color:#F6F6F4">derivatives </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher.process_derivatives</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">tasks </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> derivatives.map </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |name, file|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Concurrent</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Promises</span><span style="color:#F6F6F4">.future(name, file) </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |name, file|</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.add_derivative(name, file)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Concurrent</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Promises</span><span style="color:#F6F6F4">.zip(</span><span style="color:#F286C4">*</span><span style="color:#F6F6F4">tasks).wait!</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="logging">Logging<a href="#logging" class="hash-link" aria-label="Direct link to Logging" title="Direct link to Logging">​</a></h3><p>The <code>logging</code> plugin has been removed in favour of the
<a href="https://shrinerb.com/docs/plugins/instrumentation" target="_blank" rel="noopener noreferrer"><code>instrumentation</code></a> plugin. You can replace code like</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:logging</span><span style="color:#F6F6F4">, logger</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.logger</span></span></code></pre></div><p>with</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.logger </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.logger</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:instrumentation</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backup">Backup<a href="#backup" class="hash-link" aria-label="Direct link to Backup" title="Direct link to Backup">​</a></h3><p>The <code>backup</code> plugin has been removed in favour of the new
<a href="https://shrinerb.com/docs/plugins/mirroring" target="_blank" rel="noopener noreferrer"><code>mirroring</code></a> plugin. You can replace code like</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:backup</span><span style="color:#F6F6F4">, storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:backup_store</span></span></code></pre></div><p>with</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:mirroring</span><span style="color:#F6F6F4">, mirror</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:backup_store</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="copy">Copy<a href="#copy" class="hash-link" aria-label="Direct link to Copy" title="Direct link to Copy">​</a></h3><p>The <code>copy</code> plugin has been removed as its behaviour can now be achieved easily.
You can replace code like</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:copy</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.copy(other_attacher)</span></span></code></pre></div><p>with</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.set </span><span style="color:#BF9EEE">nil</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># clear original attachment</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.attach other_attacher.file, storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> other_attacher.file.storage_key</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.add_derivatives other_attacher.derivatives </span><span style="color:#7B7F8B"># if using derivatives</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="moving">Moving<a href="#moving" class="hash-link" aria-label="Direct link to Moving" title="Direct link to Moving">​</a></h3><p>The <code>moving</code> plugin has been removed in favour of the <code>:move</code> option for
<code>FileSystem#upload</code>. You can set this option as default using the
<code>upload_options</code> plugin (the example assumes both <code>:cache</code> and <code>:store</code> are
FileSystem storages):</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:upload_options</span><span style="color:#F6F6F4">, cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { move</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4"> }, store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { move</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">true</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="parsed-json">Parsed JSON<a href="#parsed-json" class="hash-link" aria-label="Direct link to Parsed JSON" title="Direct link to Parsed JSON">​</a></h3><p>The <code>parsed_json</code> plugin has been removed as it&#x27;s now the default behaviour.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># this now works by default</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">d7e54d6ef2.jpg</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> { ... } }</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="module-include">Module Include<a href="#module-include" class="hash-link" aria-label="Direct link to Module Include" title="Direct link to Module Include">​</a></h3><p>The <code>module_include</code> plugin has been deprecated over overriding core classes
directly. You can replace code like</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  plugin </span><span style="color:#BF9EEE">:module_include</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  file_methods </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">image?</span></span>
<span class="line"><span style="color:#F6F6F4">      mime_type.start_with?(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>with</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">UploadedFile</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">image?</span></span>
<span class="line"><span style="color:#F6F6F4">      mime_type.start_with?(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/upgrading_to_3.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2023-06-01T23:07:30.000Z">Jun 1, 2023</time></b> by <b>Janko Marohnić</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/creating-storages"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Writing a Storage</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/carrierwave"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Upgrading from CarrierWave</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#attacher" class="table-of-contents__link toc-highlight">Attacher</a><ul><li><a href="#model" class="table-of-contents__link toc-highlight">Model</a></li><li><a href="#data-attribute" class="table-of-contents__link toc-highlight">Data attribute</a></li><li><a href="#state" class="table-of-contents__link toc-highlight">State</a></li><li><a href="#assigning" class="table-of-contents__link toc-highlight">Assigning</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li><li><a href="#setting" class="table-of-contents__link toc-highlight">Setting</a></li><li><a href="#uploading-and-deleting" class="table-of-contents__link toc-highlight">Uploading and deleting</a></li><li><a href="#promoting" class="table-of-contents__link toc-highlight">Promoting</a></li></ul></li><li><a href="#backgrounding" class="table-of-contents__link toc-highlight">Backgrounding</a><ul><li><a href="#dual-support" class="table-of-contents__link toc-highlight">Dual support</a></li><li><a href="#attacher-backgrounding" class="table-of-contents__link toc-highlight">Attacher backgrounding</a></li></ul></li><li><a href="#versions" class="table-of-contents__link toc-highlight">Versions</a><ul><li><a href="#accessing-derivatives" class="table-of-contents__link toc-highlight">Accessing derivatives</a></li><li><a href="#migrating-versions" class="table-of-contents__link toc-highlight">Migrating versions</a></li><li><a href="#backgrounding-derivatives" class="table-of-contents__link toc-highlight">Backgrounding derivatives</a></li><li><a href="#default-url" class="table-of-contents__link toc-highlight">Default URL</a></li><li><a href="#location" class="table-of-contents__link toc-highlight">Location</a></li><li><a href="#overwriting-original" class="table-of-contents__link toc-highlight">Overwriting original</a></li></ul></li><li><a href="#other" class="table-of-contents__link toc-highlight">Other</a><ul><li><a href="#processing" class="table-of-contents__link toc-highlight">Processing</a></li><li><a href="#parallelize" class="table-of-contents__link toc-highlight">Parallelize</a></li><li><a href="#logging" class="table-of-contents__link toc-highlight">Logging</a></li><li><a href="#backup" class="table-of-contents__link toc-highlight">Backup</a></li><li><a href="#copy" class="table-of-contents__link toc-highlight">Copy</a></li><li><a href="#moving" class="table-of-contents__link toc-highlight">Moving</a></li><li><a href="#parsed-json" class="table-of-contents__link toc-highlight">Parsed JSON</a></li><li><a href="#module-include" class="table-of-contents__link toc-highlight">Module Include</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9151cbe8.js"></script>
<script src="/assets/js/main.73137c51.js"></script>
</body>
</html>