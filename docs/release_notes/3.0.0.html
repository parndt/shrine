<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-release_notes/3.0.0">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.1">
<title data-rh="true">Shrine 3.0.0 | Shrine</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://shrinerb.com/img/logo.png"><meta data-rh="true" property="og:url" content="https://shrinerb.com/docs/release_notes/3.0.0"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Shrine 3.0.0 | Shrine"><meta data-rh="true" name="description" content="This guide covers all the changes in the 3.0.0 version of Shrine. If you&#x27;re"><meta data-rh="true" property="og:description" content="This guide covers all the changes in the 3.0.0 version of Shrine. If you&#x27;re"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://shrinerb.com/docs/release_notes/3.0.0"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/release_notes/3.0.0" hreflang="en"><link data-rh="true" rel="alternate" href="https://shrinerb.com/docs/release_notes/3.0.0" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://KBFWBJ5DPX-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Shrine" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.efb93a3c.css">
<link rel="preload" href="/assets/js/runtime~main.3b0f70eb.js" as="script">
<link rel="preload" href="/assets/js/main.ea4eabff.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.png" alt="Shrine logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Shrine</b></a><a class="navbar__item navbar__link" href="/docs/getting-started">Guides</a><a class="navbar__item navbar__link" href="/docs/plugins/activerecord">Plugins</a><a class="navbar__item navbar__link" href="/docs/external/extensions">External</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/release_notes/3.5.0">Release Notes</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/shrinerb/shrine" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Discussion<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/shrinerb/shrine/wiki" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/release_notes/3.5.0">Shrine 3.x</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.5.0">Shrine 3.5.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.4.0">Shrine 3.4.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.3.0">Shrine 3.3.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.2.2">Shrine 3.2.2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.2.1">Shrine 3.2.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.2.0">Shrine 3.2.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.1.0">Shrine 3.1.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/3.0.1">Shrine 3.0.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/release_notes/3.0.0">Shrine 3.0.0</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/release_notes/2.19.0">Shrine 2.x</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.19.0">Shrine 2.19.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.18.0">Shrine 2.18.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.17.0">Shrine 2.17.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.16.0">Shrine 2.16.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.15.0">Shrine 2.15.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.14.0">Shrine 2.14.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.13.0">Shrine 2.13.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.12.0">Shrine 2.12.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.11.0">Shrine 2.11.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.10.1">Shrine 2.10.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.10.0">Shrine 2.10.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.9.0">Shrine 2.9.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.8.0">Shrine 2.8.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.7.0">Shrine 2.7.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.6.1">Shrine 2.6.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.6.0">Shrine 2.6.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.5.0">Shrine 2.5.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.4.1">Shrine 2.4.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.4.0">Shrine 2.4.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.3.1">Shrine 2.3.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.3.0">Shrine 2.3.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.2.0">Shrine 2.2.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.1.1">Shrine 2.1.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.1.0">Shrine 2.1.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.0.1">Shrine 2.0.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/2.0.0">Shrine 2.0.0</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/release_notes/1.4.2">Shrine 1.x</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/1.4.2">Shrine 1.4.2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/1.4.1">Shrine 1.4.1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/1.4.0">Shrine 1.4.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/1.3.0">Shrine 1.3.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/1.2.0">Shrine 1.2.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/1.1.0">Shrine 1.1.0</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/release_notes/1.0.0">Shrine 1.0.0</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Shrine 3.0.0</h1></header><p>This guide covers all the changes in the 3.0.0 version of Shrine. If you&#x27;re
currently using Shrine 2.x, see <strong><a href="https://shrinerb.com/docs/upgrading-to-3" target="_blank" rel="noopener noreferrer">Upgrading to Shrine 3.x</a></strong> for instructions
on how to upgrade.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="major-features">Major features<a href="#major-features" class="hash-link" aria-label="Direct link to Major features" title="Direct link to Major features">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="derivatives">Derivatives<a href="#derivatives" class="hash-link" aria-label="Direct link to Derivatives" title="Direct link to Derivatives">​</a></h3><p>The new <strong><a href="https://shrinerb.com/docs/plugins/derivatives" target="_blank" rel="noopener noreferrer"><code>derivatives</code></a></strong> plugin has been added for storing
additional processed files alongside the main file.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:derivatives</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives_processor </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    magick </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">MiniMagick</span><span style="color:#F6F6F4">.source(original) </span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    {</span></span>
<span class="line"><span style="color:#F6F6F4">      large</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">800</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      medium</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> magick.resize_to_limit!(</span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">500</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">      small</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">  magick.resize_to_limit!(</span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">),</span></span>
<span class="line"><span style="color:#F6F6F4">    }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(photo_params)</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives! </span><span style="color:#7B7F8B"># creates derivatives</span></span>
<span class="line"><span style="color:#F6F6F4">photo.save</span></span></code></pre></div><p>This is a rewrite of the <a href="https://shrinerb.com/docs/plugins/versions" target="_blank" rel="noopener noreferrer"><code>versions</code></a> plugin, bringing numerous
improvements:</p><ul><li><p>processed files are separated from the main file</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_data </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;id&quot;: &quot;original.jpg&quot;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;storage&quot;: &quot;store&quot;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;metadata&quot;: { ... },</span></span>
<span class="line"><span style="color:#7B7F8B">#   &quot;derivatives&quot;: {</span></span>
<span class="line"><span style="color:#7B7F8B">#     &quot;large&quot;: { &quot;id&quot;: &quot;large.jpg&quot;, &quot;storage&quot;: &quot;store&quot;, &quot;metadata&quot;: { ... } },</span></span>
<span class="line"><span style="color:#7B7F8B">#     &quot;medium&quot;: { &quot;id&quot;: &quot;medium.jpg&quot;, &quot;storage&quot;: &quot;store&quot;, &quot;metadata&quot;: { ... } },</span></span>
<span class="line"><span style="color:#7B7F8B">#     &quot;small&quot;: { &quot;id&quot;: &quot;small.jpg&quot;, &quot;storage&quot;: &quot;store&quot;, &quot;metadata&quot;: { ... } }</span></span>
<span class="line"><span style="color:#7B7F8B">#   }</span></span>
<span class="line"><span style="color:#7B7F8B"># }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image             </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;original.jpg&quot; ...&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives </span><span style="color:#7B7F8B">#=&gt;</span></span>
<span class="line"><span style="color:#7B7F8B"># {</span></span>
<span class="line"><span style="color:#7B7F8B">#   large: #&lt;Shrine::UploadedFile id=&quot;large.jpg&quot; ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   medium: #&lt;Shrine::UploadedFile id=&quot;medium.jpg&quot; ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B">#   small: #&lt;Shrine::UploadedFile id=&quot;small.jpg&quot; ...&gt;,</span></span>
<span class="line"><span style="color:#7B7F8B"># }</span></span></code></pre></div></li><li><p>processing is decoupled from promotion</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.create(image</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file) </span><span style="color:#7B7F8B"># promote original file to permanent storage</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives!          </span><span style="color:#7B7F8B"># generate derivatives after promotion</span></span>
<span class="line"><span style="color:#F6F6F4">photo.save                        </span><span style="color:#7B7F8B"># save derivatives data</span></span></code></pre></div></li></ul><ul><li><p>ability to add or remove processed files at any point</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives_processor </span><span style="color:#BF9EEE">:thumbnails</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original|</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives_processor </span><span style="color:#BF9EEE">:crop</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |original, left</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">, top</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">, width</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">, height</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">|</span></span>
<span class="line"><span style="color:#F6F6F4">    vips </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageProcessing</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Vips</span><span style="color:#F6F6F4">.source(original)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    { cropped</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> vips.crop!(left, top, width, height) }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image_derivatives!(</span><span style="color:#BF9EEE">:thumbnails</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives </span><span style="color:#7B7F8B">#=&gt; { large: ..., medium: ..., small: ... }</span></span>
<span class="line"><span style="color:#F6F6F4">photo.save</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># ... sometime later ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives!(</span><span style="color:#BF9EEE">:crop</span><span style="color:#F6F6F4">, left</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">0</span><span style="color:#F6F6F4">, top</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">0</span><span style="color:#F6F6F4">, width</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">, height</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">300</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives </span><span style="color:#7B7F8B">#=&gt; { large: ..., medium: ..., small: ..., cropped: ... }</span></span>
<span class="line"><span style="color:#F6F6F4">photo.save</span></span></code></pre></div></li></ul><ul><li><p>possibility of uploading processed files to different storage</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">ImageUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># specify storage for all derivatives</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives_storage </span><span style="color:#BF9EEE">:other_store</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># or specify storage per derivative</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.derivatives_storage { |derivative| </span><span style="color:#BF9EEE">:other_store</span><span style="color:#F6F6F4"> }</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.create(image</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file)</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.storage_key </span><span style="color:#7B7F8B">#=&gt; :store</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives!</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_derivatives[</span><span style="color:#BF9EEE">:large</span><span style="color:#F6F6F4">].storage_key </span><span style="color:#7B7F8B">#=&gt; :other_store</span></span></code></pre></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attacher-redesign">Attacher redesign<a href="#attacher-redesign" class="hash-link" aria-label="Direct link to Attacher redesign" title="Direct link to Attacher redesign">​</a></h3><p>The <a href="https://shrinerb.com/docs/attacher" target="_blank" rel="noopener noreferrer"><code>Shrine::Attacher</code></a> class has been rewritten and can now be
used without models:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.attach(file)</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span></code></pre></div><p>The <code>Attacher#data</code>, <code>Attacher#load_data</code>, and <code>Attacher.from_data</code> methods
have been added for dumping and loading the attached file:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># dump attached file into a serializable Hash</span></span>
<span class="line"><span style="color:#F6F6F4">data </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher.data </span><span style="color:#7B7F8B">#=&gt; { &quot;id&quot; =&gt; &quot;abc123.jpg&quot;, &quot;storage&quot; =&gt; &quot;store&quot;, &quot;metadata&quot; =&gt; { ... } }</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># initialize attacher from attached file data...</span></span>
<span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.from_data(data)</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;abc123.jpg&quot; storage=:store metadata={...}&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># ...or load attached file into an existing attacher</span></span>
<span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.load_data(data)</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span></code></pre></div><p>Several more methods have been added:</p><ul><li><code>Attacher#attach</code> – attaches the file directly to permanent storage</li><li><code>Attacher#attach_cached</code> – extracted from <code>Attacher#assign</code></li><li><code>Attacher#upload</code> – calls <code>Shrine#upload</code>, passing <code>:record</code> and <code>:name</code> context</li><li><code>Attacher#file</code> – alias for <code>Attacher#get</code></li><li><code>Attacher#cache_key</code> – returns temporary storage key (<code>:cache</code> by default)</li><li><code>Attacher#store_key</code> – returns permanent storage key (<code>:store</code> by default)</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="column">Column<a href="#column" class="hash-link" aria-label="Direct link to Column" title="Direct link to Column">​</a></h4><p>The new <a href="https://shrinerb.com/docs/plugins/column" target="_blank" rel="noopener noreferrer"><code>column</code></a> plugin adds the ability to serialize attached file
data, in format suitable for writing into a database column.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:column</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># dump attached file data into a JSON string</span></span>
<span class="line"><span style="color:#F6F6F4">data </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher.column_data </span><span style="color:#7B7F8B">#=&gt; &#x27;{&quot;id&quot;:&quot;abc123.jpg&quot;,&quot;storage&quot;:&quot;store&quot;,&quot;metadata&quot;:{...}}&#x27;</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># initialize attacher from attached file data...</span></span>
<span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.from_column(data)</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;abc123.jpg&quot; storage=:store metadata={...}&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># ...or load attached file into an existing attacher</span></span>
<span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.load_column(data)</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile&gt;</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="entity">Entity<a href="#entity" class="hash-link" aria-label="Direct link to Entity" title="Direct link to Entity">​</a></h4><p>The new <a href="https://shrinerb.com/docs/plugins/entity" target="_blank" rel="noopener noreferrer"><code>entity</code></a> plugin adds support for immutable structs, which
are commonly used with ROM, Hanami and dry-rb.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:entity</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Hanami::Entity</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(image_data</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&#x27;</span><span style="color:#E7EE98">{&quot;id&quot;:&quot;abc123.jpg&quot;,&quot;storage&quot;:&quot;store&quot;,&quot;metadata&quot;:{...}}</span><span style="color:#DEE492">&#x27;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;abc123.jpg&quot; storage=:store ...&gt;</span></span></code></pre></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="model">Model<a href="#model" class="hash-link" aria-label="Direct link to Model" title="Direct link to Model">​</a></h4><p>The new <a href="https://shrinerb.com/docs/plugins/model" target="_blank" rel="noopener noreferrer"><code>model</code></a> plugin adds support for mutable structs, which is
used by <code>activerecord</code> and <code>sequel</code> plugins.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:model</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Struct.new</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> file</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;abc123.jpg&quot; storage=:cache ...&gt;</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image_data </span><span style="color:#7B7F8B">#=&gt; #=&gt; &#x27;{&quot;id&quot;:&quot;abc123.jpg&quot;, &quot;storage&quot;:&quot;cache&quot;, &quot;metadata&quot;:{...}}&#x27;</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backgrounding-rewrite">Backgrounding rewrite<a href="#backgrounding-rewrite" class="hash-link" aria-label="Direct link to Backgrounding rewrite" title="Direct link to Backgrounding rewrite">​</a></h3><ul><li>The <a href="https://shrinerb.com/docs/plugins/backgrounding" target="_blank" rel="noopener noreferrer"><code>backgrounding</code></a> plugin has been rewritten for more
flexibility and simplicity. The new usage is much more explicit:</li></ul><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:backgrounding</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.promote_block </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">PromoteJob</span><span style="color:#F6F6F4">.perform_async(</span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.class.name, record.class.name, record.id, name, file_data)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.destroy_block </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">DestroyJob</span><span style="color:#F6F6F4">.perform_async(</span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.class.name, data)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">PromoteJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record</span><span style="color:#F6F6F4">.id, </span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">file_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_promote</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># attachment has changed or the record has been deleted, nothing to do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">DestroyJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.from_data(data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.destroy</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><p>There are several main differences compared to the old implementation:</p><ul><li>we are in charge of passing the record to the background job</li><li>we can access the attacher before promotion</li><li>we can react to errors that caused promotion to abort</li></ul><p>We can now also register backgrounding hooks on an attacher instance, allowing
us to pass additional parameters to the background job:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(photo_params)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.image_attacher.promote_block </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |attacher|</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">PromoteJob</span><span style="color:#F6F6F4">.perform_async(</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.record.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.record.id,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.name,</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.file_data,</span></span>
<span class="line"><span style="color:#F6F6F4">    current_user.id, </span><span style="color:#7B7F8B"># &lt;== parameters from the controller</span></span>
<span class="line"><span style="color:#F6F6F4">  )</span></span>
<span class="line"><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">photo.save </span><span style="color:#7B7F8B"># will call our instance-level backgrounding hook</span></span></code></pre></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="persistence-interface">Persistence interface<a href="#persistence-interface" class="hash-link" aria-label="Direct link to Persistence interface" title="Direct link to Persistence interface">​</a></h3><p>The persistence plugins (<code>activerecord</code>, <code>sequel</code>) now implement a unified
<a href="https://shrinerb.com/docs/plugins/persistence" target="_blank" rel="noopener noreferrer">persistence</a> interface:</p><table><thead><tr><th align="left">Method</th><th align="left">Description</th></tr></thead><tbody><tr><td align="left"><code>Attacher#persist</code></td><td align="left">persists attachment data</td></tr><tr><td align="left"><code>Attacher#atomic_persist</code></td><td align="left">persists attachment data if attachment hasn’t changed</td></tr><tr><td align="left"><code>Attacher#atomic_promote</code></td><td align="left">promotes cached file and atomically persists changes</td></tr></tbody></table><p>The &quot;atomic&quot; methods use the new <a href="https://shrinerb.com/docs/plugins/atomic_helpers" target="_blank" rel="noopener noreferrer"><code>atomic_helpers</code></a> plugin,
and are useful for background jobs. For example, this is how we&#x27;d use them to
implement metadata extraction in the background in a concurrency-safe way:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">MetadataJob</span><span style="color:#F6F6F4">.perform_async(</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.record.class.name,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.record.id,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.name,</span></span>
<span class="line"><span style="color:#F6F6F4">  attacher.file_data,</span></span>
<span class="line"><span style="color:#F6F6F4">)</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MetadataJob</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Sidekiq</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Worker</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">perform</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">attacher_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_class</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">record_id</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">name</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">file_data</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher_class </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(attacher_class)</span></span>
<span class="line"><span style="color:#F6F6F4">    record         </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Object</span><span style="color:#F6F6F4">.const_get(record_class).find(record_id) </span><span style="color:#7B7F8B"># if using Active Record</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">    attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> attacher_class.retrieve(model</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> record, name</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> name, file</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> file_data)</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.refresh_metadata! </span><span style="color:#7B7F8B"># extract metadata</span></span>
<span class="line"><span style="color:#F6F6F4">    attacher.atomic_persist    </span><span style="color:#7B7F8B"># persist if attachment hasn&#x27;t changed</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">rescue</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">AttachmentChanged</span><span style="color:#F6F6F4">, </span><span style="color:#97E1F1;font-style:italic">ActiveRecord</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">RecordNotFound</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># attachment has changed or record has been deleted, nothing to do</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-new-plugins">Other new plugins<a href="#other-new-plugins" class="hash-link" aria-label="Direct link to Other new plugins" title="Direct link to Other new plugins">​</a></h2><ul><li><p>The new <a href="https://shrinerb.com/docs/plugins/mirroring" target="_blank" rel="noopener noreferrer"><code>mirroring</code></a> plugin has been added for replicating
uploads and deletes to other storages.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ..., store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ..., backup</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ... }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:mirroring</span><span style="color:#F6F6F4">, mirror</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:backup</span><span style="color:#F6F6F4"> }</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.upload(io, </span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B"># uploads to :store and :backup</span></span>
<span class="line"><span style="color:#F6F6F4">file.delete                      </span><span style="color:#7B7F8B"># deletes from :store and :backup</span></span></code></pre></div></li><li><p>The new <a href="https://shrinerb.com/docs/plugins/multi_cache" target="_blank" rel="noopener noreferrer"><code>multi_cache</code></a> plugin has been added for allowing an
attacher to accept files from additional temporary storages.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.storages </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ..., cache_one</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ..., cache_two</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ..., store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> ... }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:multi_cache</span><span style="color:#F6F6F4">, additional_cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> [</span><span style="color:#BF9EEE">:cache_one</span><span style="color:#F6F6F4">, </span><span style="color:#BF9EEE">:cache_two</span><span style="color:#F6F6F4">]</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> { ... } }</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.storage_key </span><span style="color:#7B7F8B">#=&gt; :cache</span></span>
<span class="line"><span style="color:#7B7F8B"># or</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache_one</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> { ... } }</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.storage_key </span><span style="color:#7B7F8B">#=&gt; :cache_one</span></span>
<span class="line"><span style="color:#7B7F8B"># or</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache_two</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> { ... } }</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.storage_key </span><span style="color:#7B7F8B">#=&gt; :cache_two</span></span></code></pre></div></li><li><p>The new <a href="https://shrinerb.com/docs/plugins/form_assign" target="_blank" rel="noopener noreferrer"><code>form_assign</code></a> plugin has been added for assigning
files directly from form params.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:form_assign</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> photo.image_attacher</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.form_assign({ </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">image</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> file, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">title</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">description</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> })</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.file </span><span style="color:#7B7F8B">#=&gt; #&lt;Shrine::UploadedFile id=&quot;...&quot; storage=:cache ...&gt;</span></span></code></pre></div></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-features">Other features<a href="#other-features" class="hash-link" aria-label="Direct link to Other features" title="Direct link to Other features">​</a></h2><ul><li><p>Model file assignment can now be configured to upload directly to permanent
storage.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:model</span><span style="color:#F6F6F4">, cache</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">false</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> file</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image.storage_key </span><span style="color:#7B7F8B">#=&gt; :store (permanent storage)</span></span></code></pre></div></li><li><p>New <code>Shrine.download_response</code> method has been added to the
<code>download_endpoint</code> plugin for generating file response from the controller.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Rails</span><span style="color:#F6F6F4">.application.routes.draw </span><span style="color:#F286C4">do</span></span>
<span class="line"><span style="color:#F6F6F4">  get </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">/attachments</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">files#download</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">FilesController</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ApplicationController</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">download</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#7B7F8B"># ... we can now perform things like authentication here ...</span></span>
<span class="line"><span style="color:#F6F6F4">    set_rack_response </span><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.download_response(env)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">private</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">set_rack_response</span><span style="color:#F6F6F4">((</span><span style="color:#FFB86C;font-style:italic">status</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">headers</span><span style="color:#F6F6F4">, </span><span style="color:#FFB86C;font-style:italic">body</span><span style="color:#F6F6F4">))</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.status </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> status</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.headers.merge!(headers)</span></span>
<span class="line"><span style="color:#F6F6F4">    </span><span style="color:#BF9EEE;font-style:italic">self</span><span style="color:#F6F6F4">.response_body </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> body</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></li><li><p>The <code>Attacher#refresh_metadata!</code> method has been added to <code>refresh_metadata</code>
plugin. It refreshes metadata and writes new attached file data back into the
data attribute.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.file.refresh_metadata!</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.write</span></span>
<span class="line"><span style="color:#7B7F8B"># can now be shortened to</span></span>
<span class="line"><span style="color:#F6F6F4">attacher.refresh_metadata!</span></span></code></pre></div></li><li><p>Including a <code>Shrine::Attachment</code> module now defines a <code>.&lt;name&gt;_attacher</code>
class method on the target class.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#BF9EEE">Attachment</span><span style="color:#F6F6F4">(</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.image_attacher </span><span style="color:#7B7F8B">#=&gt; #&lt;ImageUploader::Attacher ...&gt;</span></span></code></pre></div></li><li><p>The attachment data serializer is now configurable (by default <code>JSON</code>
standard library is used):</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">require</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">oj</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># https://github.com/ohler55/oj</span></span>
<span class="line"></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.plugin </span><span style="color:#BF9EEE">:column</span><span style="color:#F6F6F4">, serializer</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">Oj</span></span></code></pre></div></li><li><p>It&#x27;s now possible to pass options to the validate block via the <code>:validate</code>
option:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.assign(file, validate</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { foo</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">bar</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> })</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">MyUploader</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">&lt;</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Shrine</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.validate </span><span style="color:#F286C4">do</span><span style="color:#F6F6F4"> |</span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">options|</span></span>
<span class="line"><span style="color:#F6F6F4">    options </span><span style="color:#7B7F8B">#=&gt; { foo: &quot;bar&quot; }</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">end</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></li><li><p>Validation can now be skipped on assignment by passing <code>validate: false</code>.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">attacher.attach(file, validate</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">false</span><span style="color:#F6F6F4">) </span><span style="color:#7B7F8B"># skip validation</span></span></code></pre></div></li><li><p>Closing the uploaded file can now be prevented by passing <code>close: false</code> to
<code>Shrine#upload</code>.</p></li><li><p>Uploaded file can now be automatically deleted by passing <code>delete: true</code> to
<code>Shrine#upload</code>.</p></li><li><p>New <code>Attacher#file!</code> method has been added for retrieving the attached file
and raising and exception if it doesn&#x27;t exist.</p></li><li><p>New <code>Derivation#opened</code> method has been added for retrieving an opened
derivative in <code>derivation_endpoint</code> plugin.</p></li><li><p>New <code>Storage#delete_prefixed</code> method has been added for deleting all files
in specified directory.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">storage.delete_prefixed(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">some_directory/</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span></code></pre></div></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="performance-improvements">Performance improvements<a href="#performance-improvements" class="hash-link" aria-label="Direct link to Performance improvements" title="Direct link to Performance improvements">​</a></h2><ul><li><p>The attached file is now parsed and loaded from record column only once,
which can greatly improve performance if the same attached file is being
accessed multiple times.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">Photo</span><span style="color:#F6F6F4">.find(photo_id)</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#7B7F8B"># parses and loads attached file</span></span>
<span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#7B7F8B"># returns memoized attached file</span></span></code></pre></div></li><li><p>The <code>S3#open</code> method doesn&#x27;t perform a <code>#head_obect</code> request anymore.</p></li><li><p>The <code>derivation_endpoint</code> plugin doesn&#x27;t perform a <code>Storage#exists?</code> call
anymore when <code>:upload</code> is enabled.</p></li><li><p>The <code>download_endpoint</code> plugin doesn&#x27;t perform a <code>Storage#exists?</code> call
anymore.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-improvements">Other Improvements<a href="#other-improvements" class="hash-link" aria-label="Direct link to Other Improvements" title="Direct link to Other Improvements">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="core-improvements">Core improvements<a href="#core-improvements" class="hash-link" aria-label="Direct link to Core improvements" title="Direct link to Core improvements">​</a></h3><ul><li><p>Shrine now works again with MRI 2.3.</p></li><li><p>The memory storage from the <a href="https://github.com/shrinerb/shrine-memory" target="_blank" rel="noopener noreferrer">shrine-memory</a> gem has been merged into core.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># Gemfile</span></span>
<span class="line"><span style="color:#F6F6F4">gem </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">shrine-memory</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#7B7F8B"># this can be removed</span></span></code></pre></div></li><li><p>The <code>Attacher#assign</code> method now accepts cached file data as a Hash.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">photo.image </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">storage</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">cache</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">metadata</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> { ... } }</span></span></code></pre></div></li><li><p>An <code>UploadedFile</code> object can now be initialized with symbol keys.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Shrine</span><span style="color:#F6F6F4">.uploaded_file(id</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">...</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">, storage</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:store</span><span style="color:#F6F6F4">, metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { ... })</span></span></code></pre></div></li><li><p>The temporary storage doesn&#x27;t need to be defined anymore if it&#x27;s not used.</p></li><li><p>Any changes to <code>Shrine.storages</code> will now be applied to existing <code>Shrine</code> and
<code>Attacher</code> instances.</p></li><li><p>When copying the S3 object to another location, any specified upload options
will now be applied.</p></li><li><p>Deprecation of passing unknown options to <code>FileSystem#open</code> has been
reverted. This allows users to continue using <code>FileSystem</code> storage in tests
as a mock storage.</p></li><li><p>The <code>Shrine#upload</code> method now infers file extension from <code>filename</code> metadata,
making possible to use <code>filename</code> to specify file extension.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">file </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> uploader.upload(</span><span style="color:#97E1F1;font-style:italic">StringIO</span><span style="color:#F6F6F4">.</span><span style="color:#F286C4">new</span><span style="color:#F6F6F4">(</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">some text</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">), metadata</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> { </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">filename</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> </span><span style="color:#F286C4">=&gt;</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">file.txt</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4"> })</span></span>
<span class="line"><span style="color:#F6F6F4">file.id </span><span style="color:#7B7F8B">#=&gt; &quot;2a2467ee6acbc5cb.txt&quot;</span></span></code></pre></div></li><li><p>The <code>Shrine.opts</code> hash is now deep-copied on subclassing. This allows plugins
to freely mutate hashes and arrays in <code>Shrine.opts</code>, knowing they won&#x27;t be
shared across subclasses.</p></li><li><p>The <code>down</code> dependency has been updated to <code>~&gt; 5.0</code>.</p></li><li><p>The <code>Shrine::Attachment[]</code> method has been added as an alternative syntax for
creating attachment modules.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F286C4">class</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">Photo</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#F286C4">include</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ImageUploader</span><span style="color:#F286C4">::</span><span style="color:#97E1F1;font-style:italic">Attachment</span><span style="color:#F6F6F4">[</span><span style="color:#BF9EEE">:image</span><span style="color:#F6F6F4">]</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="plugin-improvements">Plugin improvements<a href="#plugin-improvements" class="hash-link" aria-label="Direct link to Plugin improvements" title="Direct link to Plugin improvements">​</a></h3><ul><li><p>The <code>activerecord</code> plugin now works with Active Record 3.</p></li><li><p>Callback code from <code>activerecord</code> and <code>sequel</code> plugin has been moved into
attacher methods, allowing the user to override them.</p><ul><li><code>Attacher#(activerecord|sequel)_before_save</code></li><li><code>Attacher#(activerecord|sequel)_after_save</code></li><li><code>Attacher#(activerecord|sequel)_after_destroy</code></li></ul></li><li><p>The <code>url_options</code> plugin now allows you to override URL options by deleting
them.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.url(response_content_disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">attachment</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span></code></pre></div><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:url_options</span><span style="color:#F6F6F4">, store</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1">-&gt;</span><span style="color:#F6F6F4"> (io, options) {</span></span>
<span class="line"><span style="color:#F6F6F4">  disposition </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> options.delete(</span><span style="color:#BF9EEE">:response_content_disposition</span><span style="color:#F6F6F4">, </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">inline</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">  {</span></span>
<span class="line"><span style="color:#F6F6F4">    response_content_disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#97E1F1;font-style:italic">ContentDisposition</span><span style="color:#F6F6F4">.</span><span style="color:#97E1F1">format</span><span style="color:#F6F6F4">(</span></span>
<span class="line"><span style="color:#F6F6F4">      disposition</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> disposition,</span></span>
<span class="line"><span style="color:#F6F6F4">      filename</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4">    io.original_filename,</span></span>
<span class="line"><span style="color:#F6F6F4">    )</span></span>
<span class="line"><span style="color:#F6F6F4">  }</span></span>
<span class="line"><span style="color:#F6F6F4">}</span></span></code></pre></div></li><li><p>The <code>:upload_options</code> hash passed to the uploader is now merged with any
options defined with the <code>upload_options</code> plugin.</p></li><li><p>The <code>default_storage</code> now evaluates the storage block in context of the
<code>Attacher</code> instance.</p></li><li><p>New <code>Attacher.default_cache</code> and <code>Attacher.default_store</code> methods have been
added to the <code>default_storage</code> plugin for declaratively setting default
storage.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_cache { ... }</span></span>
<span class="line"><span style="color:#97E1F1;font-style:italic">Attacher</span><span style="color:#F6F6F4">.default_store { ... }</span></span></code></pre></div></li><li><p>The <code>derivation_endpoint</code> plugin now handles string derivation names.</p></li><li><p>The <code>Derivation#upload</code> method from <code>derivation_endpoint</code> plugin now accepts
additional uploader options</p></li><li><p>The <code>Derivation#upload</code> method from <code>derivation_endpoint</code> plugin now accepts
any IO-like object.</p></li><li><p>The <code>derivation_endpoint</code> plugin doesn&#x27;t re-open <code>File</code> objects returned in
derivation block anymore.</p></li><li><p>The <code>instrumentation</code> plugin now instruments <code>UploadedFile#open</code> calls as a
new <code>open.shrine</code> event. <code>UploadedFile#download</code> is still instrumented as
<code>download.shrine</code>.</p></li><li><p>The <code>upload.shrine</code> event now has <code>:metadata</code> on the top level in
<code>instrumentation</code> plugin.</p></li><li><p>The width &amp; height validators in <code>store_dimensions</code> plugin don&#x27;t require
<code>UploadedFile#width</code> and <code>UploadedFile#height</code> methods to be defined anymore,
only that the corresponding metadata exists.</p></li><li><p>Any options passed to <code>Attacher#attach_cached</code> are now forwarded to metadata
extraction when <code>restore_cached_data</code> plugin is loaded.</p></li><li><p>The <code>infer_extension</code> plugin now works correctly with <code>pretty_location</code>
plugin when <code>pretty_location</code> was loaded after <code>infer_extension</code>.</p></li><li><p>The <code>pretty_location</code> plugin now accepts <code>:class_underscore</code> option for
underscoring class names.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:pretty_location</span></span>
<span class="line"><span style="color:#7B7F8B"># &quot;blogpost/aa357797-5845-451b-8662-08eecdc9f762/image/493g82jf23.jpg&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F6F6F4">plugin </span><span style="color:#BF9EEE">:pretty_location</span><span style="color:#F6F6F4">, class_underscore</span><span style="color:#F286C4">:</span><span style="color:#F6F6F4"> </span><span style="color:#BF9EEE">:true</span></span>
<span class="line"><span style="color:#7B7F8B"># &quot;blog_post/aa357797-5845-451b-8662-08eecdc9f762/image/493g82jf23.jpg&quot;</span></span></code></pre></div></li><li><p>You can now load multiple persistence plugins simulatenously, and the correct
one will be activated during persistence.</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="backwards-compatibility">Backwards compatibility<a href="#backwards-compatibility" class="hash-link" aria-label="Direct link to Backwards compatibility" title="Direct link to Backwards compatibility">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="plugin-deprecation-and-removal">Plugin deprecation and removal<a href="#plugin-deprecation-and-removal" class="hash-link" aria-label="Direct link to Plugin deprecation and removal" title="Direct link to Plugin deprecation and removal">​</a></h3><ul><li><p>The <code>backgrounding</code> plugin has been rewritten and has a new API. While the
new API works in a similar way, no backwards compatibility has been kept with
the previous API.</p></li><li><p>The <code>versions</code>, <code>processing</code>, <code>recache</code>, and <code>delete_raw</code> plugins have been
deprecated in favor of the new <code>derivatives</code> plugin.</p></li><li><p>The <code>module_include</code> plugin has been deprecated over overriding core classes
directly.</p></li><li><p>The <code>hooks</code>, <code>parallelize</code>, <code>parsed_json</code>, and <code>delete_promoted</code> plugins have
been removed.</p></li><li><p>The deprecated <code>copy</code>, <code>backup</code>, <code>multi_delete</code>, <code>moving</code>, <code>logging</code>,
<code>direct_upload</code> <code>background_helpers</code>, and <code>migration_helpers</code> plugins have
been removed.</p></li><li><p>The <code>default_url_options</code> plugin has been renamed to <code>url_options</code>.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attacher-api">Attacher API<a href="#attacher-api" class="hash-link" aria-label="Direct link to Attacher API" title="Direct link to Attacher API">​</a></h3><ul><li><p>The <code>Attacher.new</code> method now only accepts a hash of options, use
<code>Attacher.from_model</code> for initializing from a model.</p></li><li><p>If you&#x27;re changing the attachment data column directly, you&#x27;ll now need to
call <code>Attacher#reload</code> to make the attacher reflect those changes.</p></li><li><p>The <code>Attacher#promote</code> method now only saves the promoted file in memory,
it doesn&#x27;t persist the changes.</p></li><li><p>The <code>Attacher#_set</code> and <code>Attacher#set</code> methods have been renamed to
<code>Attacher#set</code> and <code>Attacher#changed</code>.</p></li><li><p>The <code>Attacher#cache!</code>, <code>Attacher#store!</code>, and <code>Attacher#delete!</code> methods have
been removed.</p></li><li><p>The <code>Attacher#_promote</code> and <code>Attacher#_delete</code> methods have been removed.</p></li><li><p>The <code>Attacher#swap</code>, <code>Attacher#update</code>, <code>Attacher#read</code>, <code>Attacher#write</code>,
<code>Attacher#convert_to_data</code>, <code>Attacher#convert_before_write</code>, and
<code>Attache#convert_after_read</code> methods have been removed.</p></li><li><p>The <code>Attacher.validate</code>, <code>Attacher#validate</code> and <code>Attacher#errors</code> methods
have been extracted into the new <code>validation</code> plugin.</p></li><li><p>The <code>Attacher#data_attribute</code> method has been renamed to <code>Attacher#attribute</code>.</p></li><li><p>The <code>Attacher#replace</code> method has been renamed to
<code>Attacher#destroy_previous</code>.</p></li><li><p>The <code>Attacher#assign</code> method now raises an exception when non-cached uploaded
file is assigned.</p></li><li><p>The <code>Attacher#attached?</code> method now returns whether a file is attached,
regardless of whether it was changed or not.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="attachment-api">Attachment API<a href="#attachment-api" class="hash-link" aria-label="Direct link to Attachment API" title="Direct link to Attachment API">​</a></h3><ul><li>The <code>Shrine::Attachment</code> module doesn&#x27;t define any instance methods by itself
anymore. This has been moved into <code>entity</code> and <code>model</code> plugins.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uploader-api">Uploader API<a href="#uploader-api" class="hash-link" aria-label="Direct link to Uploader API" title="Direct link to Uploader API">​</a></h3><ul><li><p>The <code>:phase</code> option has been removed.</p></li><li><p>The <code>Shrine#process</code> and <code>Shrine#processed</code> methods have been removed.</p></li><li><p>The <code>Shrine#store</code>, <code>Shrine#_store</code>, <code>Shrine#put</code>, and <code>Shrine#copy</code> methods
have been removed.</p></li><li><p>The <code>Shrine#delete</code>, <code>Shrine#_delete</code>, and <code>Shrine#remove</code> methods have been
removed.</p></li><li><p>The <code>Shrine#uploaded?</code> method has been removed.</p></li><li><p>The <code>Shrine.uploaded_file</code> method doesn&#x27;t yield files anymore by default.</p></li><li><p>The options for <code>Shrine#upload</code> and <code>Shrine#extract_metadata</code> are now
required to have symbol keys.</p></li><li><p>The <code>Shrine.uploaded_file</code> method now raises <code>ArgumentError</code> on invalid
arguments.</p></li><li><p>The <code>Shrine#upload</code> method doesn&#x27;t rescue exceptions that happen in
<code>IO#close</code> anymore.</p></li><li><p>The deprecated <code>Shrine::IO_METHODS</code> constant has been removed.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="uploaded-file-api">Uploaded File API<a href="#uploaded-file-api" class="hash-link" aria-label="Direct link to Uploaded File API" title="Direct link to Uploaded File API">​</a></h3><ul><li><p>The <code>UploadedFile</code> method now extracts data from the given hash on
initialization, it doesn&#x27;t store the whole hash anymore. This means the
following potential code won&#x27;t work anymore:</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#F6F6F4">uploaded_file.id </span><span style="color:#7B7F8B">#=&gt; &quot;foo&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.data[</span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">id</span><span style="color:#DEE492">&quot;</span><span style="color:#F6F6F4">] </span><span style="color:#F286C4">=</span><span style="color:#F6F6F4"> </span><span style="color:#DEE492">&quot;</span><span style="color:#E7EE98">bar</span><span style="color:#DEE492">&quot;</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.id </span><span style="color:#7B7F8B">#=&gt; &quot;foo&quot;</span></span></code></pre></div></li><li><p>The <code>UploadedFile#storage_key</code> method now returns a Symbol instead of a
String.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># previous behaviour</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.storage_key </span><span style="color:#7B7F8B">#=&gt; &quot;store&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># new behaviour</span></span>
<span class="line"><span style="color:#F6F6F4">uploaded_file.storage_key </span><span style="color:#7B7F8B">#=&gt; :store</span></span></code></pre></div></li><li><p>The <code>UploadedFile#==</code> method now requires both uploaded file objects to be
of the same class.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-api">Storage API<a href="#storage-api" class="hash-link" aria-label="Direct link to Storage API" title="Direct link to Storage API">​</a></h3><ul><li><p>The <code>Storage#open</code> method is now required to accept additional options.</p><div data-rehype-pretty-code-fragment=""><pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="line"><span style="color:#7B7F8B"># this won&#x27;t work anymore</span></span>
<span class="line"><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">open</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">id</span><span style="color:#F6F6F4">)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7B7F8B"># this is now required</span></span>
<span class="line"><span style="color:#F286C4">def</span><span style="color:#F6F6F4"> </span><span style="color:#62E884">open</span><span style="color:#F6F6F4">(</span><span style="color:#FFB86C;font-style:italic">id</span><span style="color:#F6F6F4">, </span><span style="color:#F286C4">**</span><span style="color:#F6F6F4">options)</span></span>
<span class="line"><span style="color:#F6F6F4">  </span><span style="color:#7B7F8B"># ...</span></span>
<span class="line"><span style="color:#F286C4">end</span></span></code></pre></div></li><li><p>The <code>Storage#open</code> method is now required to raise <code>Shrine::FileNotFound</code>
exception when the file is missing.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="s3-api">S3 API<a href="#s3-api" class="hash-link" aria-label="Direct link to S3 API" title="Direct link to S3 API">​</a></h3><ul><li><p>The support for <code>aws-sdk</code> 2.x and <code>aws-sdk-s3</code> &lt; 1.14 has been removed.</p></li><li><p><code>S3#open</code> now raises <code>Shrine::FileNotFound</code> exception when S3 object doesn&#x27;t
exist on the bucket.</p></li><li><p>The <code>S3#upload</code> method will now override any S3 object data when copying
from another S3 object. If you were relying on S3 object data being inherited
on copy, you will need to update your code.</p></li><li><p>The <code>:host</code> option in <code>S3#initialize</code> has been removed.</p></li><li><p>The <code>:download</code> option in <code>S3#url</code> has been removed.</p></li><li><p>Specifying <code>:multipart_threshold</code> as an integer is not supported anymore.</p></li><li><p>Non URI-escaped <code>:content_disposition</code> and <code>:response_content_disposition</code>
values are not supported anymore.</p></li><li><p>The <code>S3#presign</code> method now returns a hash instead of an object for default
POST method.</p></li><li><p>The deprecated <code>S3#stream</code>, <code>S3#download</code>, and <code>S3#s3</code> methods have been
removed.</p></li><li><p>The <code>S3#open</code> method doesn&#x27;t include an <code>:object</code> in <code>Down::ChunkedIO#data</code>
anymore.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="filesystem-api">FileSystem API<a href="#filesystem-api" class="hash-link" aria-label="Direct link to FileSystem API" title="Direct link to FileSystem API">​</a></h3><ul><li><p><code>FileSystem#open</code> now raises <code>Shrine::FileNotFound</code> exception when file does
not exist on the filesystem.</p></li><li><p>The deprecated <code>:host</code> option in <code>FileSystem#initialize</code> has been removed.</p></li><li><p>The deprecated <code>:older_than</code> option in <code>FileSystem#clear!</code> has been removed.</p></li><li><p>The deprecated <code>FileSystem#download</code> method has been removed.</p></li><li><p>The <code>FileSystem#movable?</code> and <code>FileSystem#move</code> methods have been made
private.</p></li><li><p>The <code>FileSystem#open</code> method doesn&#x27;t accept a block anymore.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="plugins-api">Plugins API<a href="#plugins-api" class="hash-link" aria-label="Direct link to Plugins API" title="Direct link to Plugins API">​</a></h3><ul><li><p><code>remote_url</code></p><ul><li>A custom downloader is now required to raise
<code>Shrine::Plugins::RemoteUrl::DownloadError</code> in order for the exception to
be converted into a validation error. <code>Down::NotFound</code> and <code>Down::TooLarge</code>
exceptions are converted by default. All other exceptions are propagated.</li></ul></li><li><p><code>upload_endpoint</code></p><ul><li><p>The deprecated <code>Shrine::Plugins::UploadEndpoint::App</code> constant has been
removed.</p></li><li><p>The <code>:request</code> option holding the <code>Rack::Request</code> object isn&#x27;t passed to
the uploader anymore.</p></li></ul></li><li><p><code>presign_endpoint</code></p><ul><li><p><code>Storage#presign</code> results that cannot coerce themselves into a Hash are not
supported anymore.</p></li><li><p>The deprecated <code>Shrine::Plugins::PresignEndpoint::App</code> constant has been
removed.</p></li></ul></li><li><p><code>derivation_endpoint</code></p><ul><li><p>The derivation block is now evaluated in context of a <code>Shrine::Derivation</code>
instance.</p></li><li><p>The derivation block can now return only <code>File</code> and <code>Tempfile</code> objects.</p></li><li><p>The <code>:download_errors</code> option has been removed, as it&#x27;s now obsolete.</p></li><li><p>The <code>:include_uploaded_file</code> option has been removed, as it&#x27;s now obsolete.</p></li><li><p>The source <code>UploadedFile</code> is not passed to the derivation block anymore
on <code>download: false</code>.</p></li><li><p>The <code>Derivation#upload</code> method now closes the uploaded file.</p></li><li><p>The <code>derivation.upload</code> instrumentation event payload now includes only
<code>:derivation</code> key.</p></li></ul></li><li><p><code>download_endpoint</code></p><ul><li><p>Support for legacy <code>/:storage/:id</code> URLs has been dropped.</p></li><li><p>The <code>:storages</code> plugin option has been removed.</p></li><li><p>The <code>Shrine::Plugins::DownloadEndpoint::App</code> constant has been removed.</p></li></ul></li><li><p><code>data_uri</code></p><ul><li><p>The deprecated <code>:filename</code> plugin option has been removed.</p></li><li><p>The deprecated <code>Shrine::Plugins::DataUri::DataFile</code> constant has been
removed.</p></li></ul></li><li><p><code>rack_file</code></p><ul><li><p>The deprecated <code>Shrine::Plugins::RackFile::UploadedFile</code> constant has been
removed.</p></li><li><p>Passing a Rack uploaded file hash to <code>Shrine#upload</code> is not supported
anymore.</p></li></ul></li><li><p><code>cached_attachment_data</code></p><ul><li><p>The <code>#&lt;name&gt;_cached_data=</code> model method has been removed.</p></li><li><p>The <code>Attacher#read_cached</code> method has been renamed to
<code>Attacher#cached_data</code>.</p></li></ul></li><li><p><code>default_url</code></p><ul><li>Passing a block when loading the plugin is not supported anymore.</li></ul></li><li><p><code>determine_mime_type</code></p><ul><li><p>The deprecated <code>:default</code> analyzer alias has been removed.</p></li><li><p>The private <code>Shrine#mime_type_analyzers</code> method has been removed.</p></li></ul></li><li><p><code>store_dimensions</code></p><ul><li><p>Failing to extract dimensions now prints out a warning by default.</p></li><li><p>The private <code>Shrine#extract_dimensions</code> and <code>Shrine#dimensions_analyzers</code>
methods have been removed.</p></li></ul></li><li><p><code>infer_extension</code></p><ul><li><p>The <code>:mini_mime</code> inferrer is now the default inferrer, which requires the
<code>mini_mime</code> gem.</p></li><li><p>The private <code>Shrine#infer_extension</code> method has been removed.</p></li></ul></li><li><p><code>validation_helpers</code></p><ul><li><p>The width &amp; height validators will now raise an exception if <code>width</code> or
<code>height</code> metadata is missing.</p></li><li><p>Support for regexes has been dropped for MIME type and extension
validators.</p></li></ul></li><li><p><code>versions</code></p><ul><li>The deprecated <code>:version_names</code>, <code>Shrine.version_names</code> and
<code>Shrine.version?</code> have been removed from <code>versions</code> plugin.</li></ul></li><li><p><code>keep_files</code></p><ul><li>The plugin will now always prevent deletion of both replaced and destroyed
attachments. The <code>:replaced</code> and <code>:destroyed</code> options don&#x27;t have effect
anymore.</li></ul></li><li><p><code>dynamic_storage</code></p><ul><li>The <code>Shrine.dynamic_storages</code> method has been removed.</li></ul></li><li><p><code>instrumentation</code></p><ul><li><p>The <code>:location</code>, <code>:upload_options</code>, and <code>:metadata</code> keys have been removed
from <code>:options</code> in <code>upload.shrine</code> event payload.</p></li><li><p>The <code>:metadata</code> key has been removed from <code>metadata.shrine</code> event payload.</p></li></ul></li><li><p><code>default_storage</code></p><ul><li>Passing <code>record</code> &amp; <code>name</code> arguments to the storage block has been
deprecated over evaluating the block in context of the attacher instance.</li></ul></li><li><p><code>sequel</code></p><ul><li>The <code>:callbacks</code> plugin option has been renamed to <code>:hooks</code>.</li></ul></li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/shrinerb/shrine/edit/master/doc/../doc/release_notes/3.0.0.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2020-01-11T18:57:24.000Z">Jan 11, 2020</time></b> by <b>Janko Marohnić</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/release_notes/3.0.1"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Shrine 3.0.1</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/release_notes/2.19.0"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Shrine 2.19.0</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#major-features" class="table-of-contents__link toc-highlight">Major features</a><ul><li><a href="#derivatives" class="table-of-contents__link toc-highlight">Derivatives</a></li><li><a href="#attacher-redesign" class="table-of-contents__link toc-highlight">Attacher redesign</a></li><li><a href="#backgrounding-rewrite" class="table-of-contents__link toc-highlight">Backgrounding rewrite</a></li><li><a href="#persistence-interface" class="table-of-contents__link toc-highlight">Persistence interface</a></li></ul></li><li><a href="#other-new-plugins" class="table-of-contents__link toc-highlight">Other new plugins</a></li><li><a href="#other-features" class="table-of-contents__link toc-highlight">Other features</a></li><li><a href="#performance-improvements" class="table-of-contents__link toc-highlight">Performance improvements</a></li><li><a href="#other-improvements" class="table-of-contents__link toc-highlight">Other Improvements</a><ul><li><a href="#core-improvements" class="table-of-contents__link toc-highlight">Core improvements</a></li><li><a href="#plugin-improvements" class="table-of-contents__link toc-highlight">Plugin improvements</a></li></ul></li><li><a href="#backwards-compatibility" class="table-of-contents__link toc-highlight">Backwards compatibility</a><ul><li><a href="#plugin-deprecation-and-removal" class="table-of-contents__link toc-highlight">Plugin deprecation and removal</a></li><li><a href="#attacher-api" class="table-of-contents__link toc-highlight">Attacher API</a></li><li><a href="#attachment-api" class="table-of-contents__link toc-highlight">Attachment API</a></li><li><a href="#uploader-api" class="table-of-contents__link toc-highlight">Uploader API</a></li><li><a href="#uploaded-file-api" class="table-of-contents__link toc-highlight">Uploaded File API</a></li><li><a href="#storage-api" class="table-of-contents__link toc-highlight">Storage API</a></li><li><a href="#s3-api" class="table-of-contents__link toc-highlight">S3 API</a></li><li><a href="#filesystem-api" class="table-of-contents__link toc-highlight">FileSystem API</a></li><li><a href="#plugins-api" class="table-of-contents__link toc-highlight">Plugins API</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Janko Marohnić</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b0f70eb.js"></script>
<script src="/assets/js/main.ea4eabff.js"></script>
</body>
</html>