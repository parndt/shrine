<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>2.7.0.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>2.7.0.md
</h1>
<div class='paths'>
doc/release_notes/2.7.0.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2023-07-10 16:53:28 +0200</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>â€”</p>

<h2 id="label-title-3A+Shrine+2.7.0">title: <a href="../../../classes/Shrine.html"><code>Shrine</code></a> <a href="2_7_0_md.html">2.7.0</a><span><a href="#label-title-3A+Shrine+2.7.0">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h2 id="label-New+Plugins">New Plugins<span><a href="#label-New+Plugins">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>The <code>direct_upload</code> plugin has been split into <code>upload_endpoint</code> and  <code>presign_endpoint</code> plugins. These plugins provide respective endpoints that  accept requests to the root URL, allowing users to fully choose the URL. They  also drop the Roda dependency.</p>
</li></ul>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:upload_endpoint</span>

<span class="ruby-comment"># config.ru</span>
<span class="ruby-identifier">map</span> <span class="ruby-string">&quot;/images/upload&quot;</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">run</span> <span class="ruby-constant">ImageUploader</span>.<span class="ruby-identifier">upload_endpoint</span>(<span class="ruby-value">:cache</span>)
<span class="ruby-keyword">end</span> <span class="ruby-comment"># creates a `POST /images/upload` endpoint</span>
</pre>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:presign_endpoint</span>

<span class="ruby-comment"># config.ru</span>
<span class="ruby-identifier">map</span> <span class="ruby-string">&quot;/presign&quot;</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">run</span> <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">presign_endpoint</span>(<span class="ruby-value">:cache</span>)
<span class="ruby-keyword">end</span> <span class="ruby-comment"># creates a `GET /presign` endpoint</span>
</pre>
<ul><li>
<p>The <code>rack_response</code> plugin has been extracted from <code>download_endpoint</code>. It  gives the ability to convert a <code>Shrine::UploadedFile</code> object into a Rack  response triple.</p>
</li></ul>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:rack_response</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">FilesController</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActionController</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">download</span>
    <span class="ruby-comment"># ...</span>
    <span class="ruby-identifier">file_response</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">attachment</span>.<span class="ruby-identifier">to_rack_response</span> <span class="ruby-comment"># returns a Rack response triple</span>

    <span class="ruby-identifier">response</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">file_response</span>[<span class="ruby-value">0</span>]
    <span class="ruby-identifier">response</span>.<span class="ruby-identifier">headers</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">file_response</span>[<span class="ruby-value">1</span>])
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">response_body</span> = <span class="ruby-identifier">file_response</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-New+Features">New Features<span><a href="#label-New+Features">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>The <code>determine_mime_type</code> plugin now supports the <a target="_top" href="https://github.com/discourse/mini_mime">mini_mime</a> gem for  determining the MIME type from file extension. The mini_mime gem is aimed to  be a lightweight replacement for the <a target="_top" href="https://github.com/mime-types/ruby-mime-types">mime-types</a> gem.</p>
</li></ul>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:determine_mime_type</span>, <span class="ruby-value">analyzer:</span> <span class="ruby-value">:mini_mime</span>
</pre>
<ul><li>
<p><code>Shrine::Attachment.new</code> now accepts additional options that are forwarded to  <code>Shrine::Attacher.new</code>. This allows for overriding temporary and permanent  storages per attachment declaration.</p>
</li></ul>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:image</span>, <span class="ruby-value">cache:</span> <span class="ruby-value">:other_cache</span>, <span class="ruby-value">store:</span> <span class="ruby-value">:other_store</span>)
<span class="ruby-keyword">end</span>
</pre>
<ul><li>
<p>The <code>activerecord</code> plugin now allows validation error messages to be an  array, which is passed as arguments to <code>record.errors.add</code>. This allows users  to delegate validation error message generation and i18n to ActiveRecord.</p>
</li></ul>

<pre class="ruby"><span class="ruby-identifier">validate_max_size</span> <span class="ruby-value">256</span> <span class="ruby-operator">*</span> <span class="ruby-value">1024</span><span class="ruby-operator">**</span><span class="ruby-value">2</span>, <span class="ruby-value">message:</span> <span class="ruby-operator">-&gt;</span> (<span class="ruby-identifier">max</span>) { [<span class="ruby-value">:too_large</span>, <span class="ruby-value">max:</span> <span class="ruby-identifier">max</span>] }
</pre>

<h2 id="label-Other+Improvements">Other Improvements<span><a href="#label-Other+Improvements">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p><code>Shrine::Storage::S3</code> now supports the new <code>aws-sdk-s3</code> gem. See the <a target="_top" href="https://aws.amazon.com/blogs/developer/aws-sdk-for-ruby-modularization-version-3-2/">AWS announcement</a> for more details on the modularization of the <code>aws-sdk</code> gem.</p>
</li></ul>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;aws-sdk-s3&quot;</span>, <span class="ruby-string">&quot;~&gt; 1.2&quot;</span>
</pre>
<ul><li>
<p><code>Shrine::Storage::S3#open</code> now uses streaming with the <code>aws-sdk-s3</code> gem  instead of <code>Down</code>. Previously this discrepancy would cause <code>aws-sdk-s3</code>  options like <code>:proxy</code> to not have any effect in <code>Shrine::Storage::S3#open</code>.</p>
</li><li>
<p><code>Shrine::Storage::S3</code> now raises an <code>ArgumentError</code> when <code>:bucket</code> option is  <code>nil</code>.</p>
</li><li>
<p>A <a href="../../../classes/Shrine.html"><code>Shrine</code></a> uploader can now call file validations from its superclass.</p>
</li></ul>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ProfileImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ImageUploader</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">super</span>() <span class="ruby-comment"># empty parentheses are required</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>
<ul><li>
<p>The <code>download_endpoint</code> now encodes uploaded file metadata in the URL,  allowing it to use them when generating a file response. Now the <code>filename</code>  metadata will be used for <code>Content-Disposition</code> if available. Also, the  <code>mime_type</code> metadata will be used for <code>Content-Type</code> instead of <code>Rack::Mime</code>  when available.</p>
</li><li>
<p>The <code>download_endpoint</code> now returns a <code>404 Not Found</code> when uploaded file is  missing.</p>
</li><li>
<p>The <code>download_endpoint</code> now returns <code>Cache-Control: max-age=31536000</code> header  which tells clients to cache the response for 1 year.</p>
</li><li>
<p>The <code>download_endpoint</code> now uses <code>Rack::BodyProxy</code> instead of Rodaâ€™s  <code>streaming</code> plugin, which means the <code>download_endpoint</code> plugin loads less  code in total.</p>
</li><li>
<p>Fixed <code>determine_mime_type</code> plugin raising an exception when empty files are  given to <code>file</code> or <code>filemagic</code> analyzers.</p>
</li><li>
<p>Un-deprecated <code>Shrine.uploaded_file</code> accepting file data as JSON string.</p>
</li><li>
<p>The <code>Shrine::UploadedFile#base64</code> and <code>Shrine::UploadedFile#data_uri</code> methods  from the <code>data_uri</code> plugin donâ€™t wrap the base64-encoded content to 60  columns anymore.</p>
</li><li>
<p>The <code>signature</code> plugin doesnâ€™t wrap base64-formatted signatures to 60 columns  anymore.</p>
</li><li>
<p>The <code>signature</code> plugin doesnâ€™t add a newline at the end of the base64-formatted  signature anymore.</p>
</li><li>
<p>The <code>data_uri</code> plugin doesnâ€™t raise an exception on Ruby <a href="2_4_1_md.html">2.4.1</a> on raw data URIs  anymore.</p>
</li><li>
<p>Reduce model pollution by eliminating the need for an internal  <code>@@&lt;attachment&gt;_attacher_class</code> class variable.</p>
</li><li>
<p>Fixed <code>direct_upload</code> plugin printing a deprecation warning when generating  fake presigns when query parameters are passed in.</p>
</li><li>
<p>Update Down dependency to the latest <code>4.x</code> version.</p>
</li></ul>

<h2 id="label-Backwards+compatibility">Backwards compatibility<span><a href="#label-Backwards+compatibility">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>With the release of <code>upload_endpoint</code> and <code>presign_endpoint</code> plugins, the  <code>direct_upload</code> plugin should now be considered deprecated. It will be  officially deprecated in <a href="../../../classes/Shrine.html"><code>Shrine</code></a> 3, and removed in <a href="../../../classes/Shrine.html"><code>Shrine</code></a> 4.</p>
</li><li>
<p>The <code>Shrine::DownloadEndpoint</code> constant has been deprecated over the  <code>Shrine.download_endpoint</code> method, and it will be removed in <a href="../../../classes/Shrine.html"><code>Shrine</code></a> 3. In  <a href="../../../classes/Shrine.html"><code>Shrine</code></a> 3 the returned app wonâ€™t be a <code>Roda</code> subclass anymore, instead it will  be a pure Rack class. If you are relying on this, you should update your code.  For example, if you were using <code>Roda.use</code> to add middlewares, you can instead  wrap the endpoint in the middlewares directly:</p>
</li></ul>

<pre class="ruby"><span class="ruby-identifier">map</span> <span class="ruby-string">&quot;/attachments&quot;</span> <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">use</span> <span class="ruby-constant">MyMiddleware</span>
  <span class="ruby-identifier">run</span> <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">download_endpoint</span>
<span class="ruby-keyword">end</span>
</pre>
<ul><li>
<p>The <code>download_endpoint</code> doesnâ€™t generate URLs which end with uploaded file ID  anymore; instead it generates URLs with base64-encoded uploaded file data.  The old URLs will remain supported indefinitely. If you were relying on URLs  including uploaded file ID, youâ€™ll need to update your code. If this was  becase you wanted to authenticate <code>download_endpoint</code> requests, you should  probably use the new <code>rack_response</code> plugin instead of <code>download_endpoint</code>.</p>
</li></ul>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
