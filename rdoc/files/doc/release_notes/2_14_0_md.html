<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>2.14.0.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>2.14.0.md
</h1>
<div class='paths'>
doc/release_notes/2.14.0.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2023-07-30 18:26:06 +0200</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>—</p>

<h2 id="label-title-3A+Shrine+2.14.0">title: <a href="../../../classes/Shrine.html"><code>Shrine</code></a> <a href="2_14_0_md.html">2.14.0</a><span><a href="#label-title-3A+Shrine+2.14.0">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h2 id="label-New+features">New features<span><a href="#label-New+features">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p><code>Shrine::Storage::S3</code> now accepts a <code>:client</code> option for specifying an AWS  SDK client object. This allows the user to configure client-side encryption by  passing a <code>Aws::S3::Encryption::Client</code> object:</p>
</li></ul>

<p>“‘rb  client = Aws::S3::Encryption::Client.new(  kms_key_id: “alias/my-key”,  **options  )</p>

<p><a href="../../../classes/Shrine/Storage/S3.html#method-c-new"><code>Shrine::Storage::S3.new</code></a>(client: client, bucket: “my-bucket”)  “‘</p>
<ul><li>
<p>The metadata blocks in the <code>add_metadata</code> plugin now have previous metadata  available to them in <code>context[:metadata]</code> (thanks to @jrochkind).</p>
</li></ul>

<p>“‘rb  add_metadata :foo do |io, context|  <a href=":metadata">context</a> #=&gt;  # {  # “filename” =&gt; “nature.jpg”,  # “size” =&gt; 123,  # “mime_type” =&gt; “image/jpeg”  # }</p>

<pre class="ruby"><span class="ruby-string">&quot;foo&quot;</span>
</pre>

<p>end</p>

<p>add_metadata :bar do |io, context|  <a href=":metadata">context</a> #=&gt;  # {  # “filename” =&gt; “nature.jpg”,  # “size” =&gt; 123,  # “mime_type” =&gt; “image/jpeg”,  # “foo” =&gt; “foo”  # }</p>

<pre class="ruby"><span class="ruby-string">&quot;bar&quot;</span>
</pre>

<p>end  “‘</p>
<ul><li>
<p><code>UploadedFile#to_rack_response</code> from <code>rack_response</code> plugin now accepts  <code>:type</code> and <code>:filename</code> options for overriding the values in metadata that  would otherwise be used for the <code>Content-Type</code> and <code>Content-Disposition</code>  response headers.</p>
</li></ul>

<p>“‘rb  status, headers, body = uploaded_file.to_rack_response(  type: “text/csv; charset=utf-8”,  filename: “export.csv”,  )</p>

<p><a href="&quot;Content-Type&quot;">headers</a> #=&gt; “text/csv; charset=utf-8”  <a href="&quot;Content-Disposition&quot;">headers</a> #=&gt; “inline; filename=&quot;export.csv&quot;”  “‘</p>
<ul><li>
<p><code>Shrine.data_uri</code> from <code>data_uri</code> plugin now accepts a <code>:filename</code> string,  which will be returned in  <code>Shrine::Plugins::DataUri::DataFile#original_filename</code>.</p>
</li></ul>

<p><code>rb   io = Shrine.data_uri(&quot;data:,content&quot;, filename: &quot;foo.txt&quot;)   io.original_filename #=&gt; &quot;foo.txt&quot; </code></p>
<ul><li>
<p><code>UploadedFile#download_url</code> from <code>download_endpoint</code> plugin now accepts a  <code>:host</code> option. Previously it was only possible to configure the URL host on  the plugin level.</p>
</li></ul>

<p><code>rb   uploaded_file.download_url(host: &quot;https://example.com&quot;) </code></p>
<ul><li>
<p><code>Attacher#cached?</code> and <code>Attacher#stored?</code> now accept an optional uploaded  file parameter, and return whether the given uploaded file is uploaded to the  temporary or permanent storage of the attacher (thanks to @jrochkind).</p>
</li></ul>

<h2 id="label-Performance+improvements">Performance improvements<span><a href="#label-Performance+improvements">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p><code>UploadedFile#download</code> doesn’t call <code>Storage#download</code> anymore (only  <code>Storage#open</code>). This improves performance when the uploaded file is  already opened, e.g. when using <code>refresh_metadata</code> plugin and  <code>Shrine.with_file</code> during metadata extraction. Instead of performing  a new download request, <code>UploadedFile#download</code> will in this case reuse the  already opened IO object.</p>
</li><li>
<p>Added <code>tempfile</code> plugin that makes it easier to avoid copying the  <code>UploadedFile</code> to disk multiple times during promotion. For example, in the  following code the uploaded file will be downloaded to disk only once  instead of three times.</p>
</li></ul>

<p><code>rb   Shrine.plugin :tempfile </code>  “‘rb  class MyUploader &lt; <a href="../../../classes/Shrine.html"><code>Shrine</code></a>  plugin :processing  plugin :add_metadata  plugin :refresh_metadata</p>

<pre class="ruby"><span class="ruby-identifier">process</span>(<span class="ruby-value">:store</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">io</span>.<span class="ruby-identifier">open</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">io</span>.<span class="ruby-identifier">refresh_metadata!</span>

    <span class="ruby-identifier">processor</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">Vips</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">io</span>.<span class="ruby-identifier">tempfile</span>)
    <span class="ruby-comment"># ... processing ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">add_metadata</span> <span class="ruby-value">:foo</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">with_file</span>(<span class="ruby-identifier">io</span>) { <span class="ruby-string">&quot;...&quot;</span> } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">context</span>[<span class="ruby-value">:action</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:store</span>
<span class="ruby-keyword">end</span>

<span class="ruby-identifier">add_metadata</span> <span class="ruby-value">:bar</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">with_file</span>(<span class="ruby-identifier">io</span>) { <span class="ruby-string">&quot;...&quot;</span> } <span class="ruby-keyword">unless</span> <span class="ruby-identifier">context</span>[<span class="ruby-value">:action</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:store</span>
<span class="ruby-keyword">end</span>
</pre>

<p>end  “‘</p>
<ul><li>
<p><code>UploadedFile#refresh_metadata!</code> from <code>refresh_metadata</code> plugin now detects  when the uploaded file is already opened and in that case doesn’t re-open the  file. This makes code like this faster:</p>
</li></ul>

<p><code>rb   uploaded_file.open do     uploaded_file.refresh_metadata! # doesn&#39;t re-open the file anymore   end </code></p>
<ul><li>
<p>The <code>rack_response</code> plugin now integrates with <code>Rack::Sendfile</code> middleware  when <code>Shrine::Storage::FileSystem</code> is used. It does so by making the response  body respond to <code>#to_path</code>.</p>
</li><li>
<p><code>#&lt;name&gt;_attacher</code> doesn’t look up the attachment class every time it’s  called with a new model instance anymore, making it slightly faster (thanks  to @printercu).</p>
</li></ul>

<h2 id="label-Other+improvements">Other improvements<span><a href="#label-Other+improvements">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>The <code>lib/shrine.rb</code> file has been split into <code>lib/shrine.rb</code>,  <code>lib/shrine/uploaded_file.rb</code>, <code>lib/shrine/attacher.rb</code>,  <code>lib/shrine/attachment.rb</code>, and <code>lib/shrine/plugins.rb</code> (thanks to  @printercu).</p>
</li><li>
<p><code>Shrine::Storage::S3</code> and <code>rack_response</code> plugin now use the  <a target="_top" href="https://github.com/shrinerb/content_disposition">content_disposition</a> gem for generating correctly formatted  <code>Content-Disposition</code> header values.</p>
</li><li>
<p>The <code>S3#download</code> and <code>S3#open</code> methods now work correctly with server-side  encryption (as long as the necessary <code>:sse_*</code> parameters are passed in).</p>
</li><li>
<p>Fixed <code>FileSystem#clear!</code> not working with symlinks (at least on MRI).</p>
</li><li>
<p>Fixed <code>add_metadata</code> plugin overriding previously defined metadata  blocks when loaded again.</p>
</li><li>
<p>Fixed <code>processing</code> plugin overriding previously defined processing  blocks when loaded again.</p>
</li><li>
<p>Fixed <code>backgrounding</code> plugin erroring when temorary/permanent storage is  declared in <code>Shrine::Attachment.new</code> and there are no <code>:cache</code> or <code>:store</code>  storages defined.</p>
</li><li>
<p>Fixed <code>UploadedFile#extension</code> (and thus the tempfile in  <code>UploadedFile#download</code>) including URL query parameters in the file extension  when <code>Shrine::Storage::Url</code> is used (<code>shrine-url</code> gem) with URLs that have  query parameters (thanks to @jrochkind).</p>
</li><li>
<p>Fixed <code>backgrounding</code> plugin aborting promotion when cached file metadata was  refreshed in the processing block and Active Record JSON column was used.</p>
<ul><li>
<p><code>refresh_metadata</code> plugin now avoids mutating the uploaded file data hash</p>
</li><li>
<p><code>backgrounding</code> plugin now continues promotion if cached file metadata has changed</p>
</li></ul>
</li><li>
<p>The <code>Shrine.data_uri</code> method from the <code>data_uri</code> plugin now picks up media  type parameters from the data URI and includes them in  <code>Shrine::Plugins::DataUri::DataFile#content_type</code>.</p>
</li></ul>

<p><code>rb   io = Shrine.data_uri(&quot;data:text/plain;charset=utf-8,content&quot;)   io.content_type #=&gt;   # BEFORE: &quot;text/plain&quot;   # AFTER:  &quot;text/plain;charset=utf-8&quot; </code></p>
<ul><li>
<p>When fetching <code>mime_type</code> metadata value from <code>io.content_type</code>, any media  type parameters are now stripped. This means that if the user uploads a text  file with a <code>Content-Type</code> of <code>text/plain; charset=utf-8</code>, the <code>mime_type</code>  will now correctly be stored as <code>text/plain</code>. This fixes any MIME type  validations that might not have been passing due to additional media type  parameters.</p>
</li><li>
<p>When <code>determine_mime_type</code> plugin is loaded with the <code>:default</code> analyzer,  a warning is not printed anymore.</p>
</li><li>
<p>When <code>Shrine::Storage::S3</code> is initialized with <code>bucket: nil</code>, an appropriate  error message is now raised.</p>
</li><li>
<p>The <code>:content_type</code> MIME type analyzer has been added to the  <code>Shrine.mime_type_analyzers</code> hash in <code>determine_mime_type</code> plugin (previously  known as <code>:default</code>).</p>
</li></ul>

<h2 id="label-Documentation">Documentation<span><a href="#label-Documentation">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>The <a target="_top" href="https://shrinerb.com/docs/retrieving-uploads">Retrieving Uploads</a> guide has been added.</p>
</li></ul>

<h2 id="label-Backwards+compatibility">Backwards compatibility<span><a href="#label-Backwards+compatibility">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>Support for MRI 2.1 and MRI 2.2 has been dropped.</p>
</li><li>
<p><code>Shrine::Plugins::Base</code> module has been removed and contained modules have  been moved to <code>InstanceMethods</code> and <code>ClassMethods</code> modules inside the  corresponding core classes. This should not break anything unless you were  referencing those modules directly.</p>
</li></ul>

<p><code>rb   Shrine::Plugins::Base::InstanceMethods        =&gt; Shrine::InstanceMethods   Shrine::Plugins::Base::ClassMethods           =&gt; Shrine::ClassMethods   Shrine::Plugins::Base::FileMethods            =&gt; Shrine::UploadedFile::InstanceMethods   Shrine::Plugins::Base::FileClassMethods       =&gt; Shrine::UploadedFile::ClassMethods   Shrine::Plugins::Base::AttacherMethods        =&gt; Shrine::Attacher::InstanceMethods   Shrine::Plugins::Base::AttacherClassMethods   =&gt; Shrine::Attacher::ClassMethods   Shrine::Plugins::Base::AttachmentMethods      =&gt; Shrine::Attachment::InstanceMethods   Shrine::Plugins::Base::AttachmentClassMethods =&gt; Shrine::Attachment::ClassMethods </code></p>
<ul><li>
<p><code>UploadedFile#download</code> doesn’t call <code>Storage#download</code> anymore, it now  always calls <code>Storage#open</code>. Since <code>Storage#download</code> is not used anywhere  else in <a href="../../../classes/Shrine.html"><code>Shrine</code></a>, storages can remove the <code>#download</code> method.</p>
</li><li>
<p><code>Shrine::Storage::S3#download</code> has been deprecated and will be removed in  <a href="../../../classes/Shrine.html"><code>Shrine</code></a> 3.</p>
</li><li>
<p>In <code>Shrine::Storage::S3#upload</code>, <code>#open</code>, and <code>#presign</code> it's now deprecated  to pass the <code>Content-Disposition</code> header value with non-ASCII characters.  Starting with <a href="../../../classes/Shrine.html"><code>Shrine</code></a> 3 these characters won't be escaped anymore. You should  now use the <a target="_top" href="https://github.com/shrinerb/content_disposition">content_disposition</a> gem to properly format the  <code>Content-Disposition</code> header value.</p>
</li></ul>

<p>“‘rb  # BAD:  plugin :default_url_options, store: -&gt; (io, **options) do  { response_content_disposition: “attachment; filename=&quot;#{io.original_filename}&quot;” }  end</p>

<p># GOOD:  plugin :default_url_options, store: -&gt; (io, **options) do  { response_content_disposition: ContentDisposition.attachment(io.original_filename) }  end  “‘</p>
<ul><li>
<p>The <code>mime_type</code> metadata value will now strip any additional media type  parameters such as <code>charset</code> from <code>io.content_type</code>. If you were relying on  this behaviour, you will need to update your code.</p>
</li><li>
<p>In <code>determine_mime_type</code> plugin, the <code>:default</code> MIME type analyzer has been  renamed to <code>:content_type</code>. The <code>:default</code> alias will stop being supported in  <a href="../../../classes/Shrine.html"><code>Shrine</code></a> 3.</p>
</li></ul>

<p><code>rb   plugin :determine_mime_type, analyzer: :default   # should be changed to   plugin :determine_mime_type, analyzer: :content_type </code></p>
<ul><li>
<p>The <code>UploadedFile</code> private methods that were added by the <code>rack_response</code>  plugin have now been moved to an internal class (leaving only  <code>#to_rack_response</code>). If you’ve are currently overriding any of these private  methods, you’ll need to update your code.</p>
</li><li>
<p>The <code>UploadedFile</code> private methods that were added by the <code>download_endpoint</code>  plugin have now been moved to an internal class (leaving only  <code>#download_url</code>). If you’ve are currently overriding any of these private  methods, you’ll need to update your code.</p>
</li></ul>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
