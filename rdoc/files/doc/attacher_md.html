<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>attacher.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>attacher.md
</h1>
<div class='paths'>
doc/attacher.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2023-01-04 11:06:42 +0100</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>—</p>

<h2 id="label-title-3A+Using+Attacher">title: Using Attacher<span><a href="#label-title-3A+Using+Attacher">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>This guide explains what is <code>Shrine::Attacher</code> and how to use it.</p>

<h2 id="label-Introduction">Introduction<span><a href="#label-Introduction">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The attachment logic is handled by a <code>Shrine::Attacher</code> object. The <code>Shrine::Attachment</code> module simply provides a convenience layer around a <code>Shrine::Attacher</code> object, which can be accessed via the <code>#&lt;name&gt;_attacher</code> attribute.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>(<span class="ruby-value">:image</span>)
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">new</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span> <span class="ruby-comment">#=&gt; #&lt;ImageUploader::Attacher&gt;</span>
</pre>

<p>We can also instantiate the same <code>Shrine::Attacher</code> object directly:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span> = <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">from_model</span>(<span class="ruby-identifier">photo</span>, <span class="ruby-value">:image</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment"># called by `photo.image`</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">url</span>  <span class="ruby-comment"># called by `photo.image_url`</span>
</pre>

<p>The {<code>model</code><a target="_top" href="https://shrinerb.com/docs/plugins/model">}</a>, {<code>entity</code><a target="_top" href="https://shrinerb.com/docs/plugins/entity">}</a>, and {<code>column</code><a target="_top" href="https://shrinerb.com/docs/plugins/column">}</a> plugins provide additional <code>Shrine::Attacher</code> methods (such as <code>Shrine::Attacher.from_model</code> we see above), but in this guide we’ll focus only on the core <code>Shrine::Attacher</code> methods.</p>

<p>So, we’ll assume a <code>Shrine::Attacher</code> object not backed by any model/entity:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">new</span>
</pre>

<h2 id="label-Storage">Storage<span><a href="#label-Storage">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>By default, an <code>Attacher</code> will use the <code>:cache</code> storage as the <strong>temporary</strong> storage, and the <code>:store</code> storage as the <strong>permanent</strong> storage.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">storages</span> = {
  <span class="ruby-value">cache:</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">Memory</span>.<span class="ruby-identifier">new</span>,
  <span class="ruby-value">store:</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">Memory</span>.<span class="ruby-identifier">new</span>,
}
</pre>

<pre class="ruby"><span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">new</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">cache_key</span> <span class="ruby-comment">#=&gt; :cache</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">store_key</span> <span class="ruby-comment">#=&gt; :store</span>
</pre>

<p>We can also change the default storage:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">cache:</span> <span class="ruby-value">:other_cache</span>, <span class="ruby-value">store:</span> <span class="ruby-value">:other_store</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">cache_key</span> <span class="ruby-comment">#=&gt; :other_cache</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">store_key</span> <span class="ruby-comment">#=&gt; :other_store</span>
</pre>

<p>You can also change default attacher options on the <code>Shrine::Attachment</code> module:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>(<span class="ruby-value">:image</span>, <span class="ruby-value">cache:</span> <span class="ruby-value">:other_cache</span>, <span class="ruby-value">store:</span> <span class="ruby-value">:other_store</span>)
<span class="ruby-keyword">end</span>
</pre>

<p>The <code>Attacher#cache</code> and <code>Attacher#store</code> methods will retrieve corresponding uploaders:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">cache</span> <span class="ruby-comment">#=&gt; #&lt;MyUploader @storage_key=:cache&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">store</span> <span class="ruby-comment">#=&gt; #&lt;MyUploader @storage_key=:store&gt;</span>
</pre>

<h2 id="label-Attaching">Attaching<span><a href="#label-Attaching">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Attaching+cached">Attaching cached<span><a href="#label-Attaching+cached">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>For attaching files submitted via a web form, <code>Attacher#assign</code> can be used:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">assign</span>(<span class="ruby-identifier">file</span>)
</pre>

<p>If given a raw file, it will upload it to temporary storage:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">assign</span>(<span class="ruby-identifier">file</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;asdf.jpg&quot; storage=:cache ...&gt;</span>
</pre>

<p>If given cached file data (JSON or Hash), it will set the cached file:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">assign</span>(<span class="ruby-string">&#39;{&quot;id&quot;:&quot;asdf.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;asdf.jpg&quot; storage=:cache ...&gt;</span>
</pre>

<p>If given an empty string, it will no-op:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">assign</span>(<span class="ruby-string">&quot;&quot;</span>) <span class="ruby-comment"># no-op</span>
</pre>

<p>If given <code>nil</code>, it will clear the attached file:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; &lt;Shrine::UploadedFile&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">assign</span>(<span class="ruby-keyword">nil</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; nil</span>
</pre>

<p>This plays nicely with the recommended HTML form fields for the attachment. If you’re not using the <code>hidden</code> form field (and therefore don’t need empty strings to be handled), you can also use <code>Attacher#attach_cached</code>:</p>

<pre># uploads file to cache
attacher.attach_cached(file)

# sets cached file
attacher.attach_cached(&#39;{&quot;id&quot;:&quot;asdf.jpg&quot;,&quot;storage&quot;:&quot;cache&quot;,&quot;metadata&quot;:{...}}&#39;)
attacher.attach_cached({ &quot;id&quot; =&gt; &quot;asdf.jpg&quot;, &quot;storage&quot; =&gt; &quot;cache&quot;, &quot;metadata&quot; =&gt; { ... } })
attacher.attach_cached({ id: &quot;asdf.jpg&quot;, storage: &quot;cache&quot;, metadata: { ... } })

# unsets attached file
attacher.attach_cached(nil)</pre>

<h3 id="label-Attaching+stored">Attaching stored<span><a href="#label-Attaching+stored">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Attacher#attach</code> method uploads a given file to permanent storage:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span>(<span class="ruby-identifier">file</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;asdf.jpg&quot; storage=:store ...&gt;</span>
</pre>

<p>This method is useful when attaching files from scripts, where validation doesn’t need to be performed, and where temporary storage can be skipped.</p>

<p>You can specify a different destination storage with the <code>:storage</code> option:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">storage:</span> <span class="ruby-value">:other_store</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;asdf.jpg&quot; storage=:other_store ...&gt;</span>
</pre>

<p>Any additional options passed to <code>Attacher#attach</code>, <code>Attacher#attach_cached</code> and <code>Attacher#assign</code> are forwarded to the uploader:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">metadata:</span> { <span class="ruby-string">&quot;foo&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;bar&quot;</span> })       <span class="ruby-comment"># adding metadata</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">upload_options:</span> { <span class="ruby-value">acl:</span> <span class="ruby-string">&quot;private&quot;</span> }) <span class="ruby-comment"># setting upload options</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">location:</span> <span class="ruby-string">&quot;path/to/file&quot;</span>)           <span class="ruby-comment"># setting upload location</span>
</pre>

<h3 id="label-Uploading">Uploading<span><a href="#label-Uploading">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you want to upload a file to without attaching it, you can use <code>Attacher#upload</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">file</span>)               <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile storage=:store ...&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">:cache</span>)       <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile storage=:cache ...&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">:other_store</span>) <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile storage=:other_store ...&gt;</span>
</pre>

<p>This is useful if you want to attacher <a href="#context">context</a> such as <code>:record</code> and <code>:name</code> to be automatically passed to the uploader.</p>

<p>You can also pass additional options for <code>Shrine#upload</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">metadata:</span> { <span class="ruby-string">&quot;foo&quot;</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;bar&quot;</span> })       <span class="ruby-comment"># adding metadata</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">upload_options:</span> { <span class="ruby-value">acl:</span> <span class="ruby-string">&quot;private&quot;</span> }) <span class="ruby-comment"># setting upload options</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">file</span>, <span class="ruby-value">location:</span> <span class="ruby-string">&quot;path/to/file&quot;</span>)           <span class="ruby-comment"># setting upload location</span>
</pre>

<h3 id="label-Changes">Changes<span><a href="#label-Changes">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>When a new file is attached, calling {<code>Attacher#finalize</code><a href="#finalization">}</a> will perform additional actions such as promotion and deleting any previous file. It will also trigger <a target="_top" href="https://shrinerb.com/docs/plugins/validation">validation</a>.</p>

<p>You can check whether a new file has been attached with <code>Attacher#changed?</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">changed?</span> <span class="ruby-comment">#=&gt; true</span>
</pre>

<p>You can use <code>Attacher#change</code> to attach an <code>UploadedFile</code> object as is:</p>

<pre class="ruby"><span class="ruby-identifier">uploaded_file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;foo&quot; ...&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">change</span>(<span class="ruby-identifier">uploaded_file</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;foo&quot; ...&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">changed?</span> <span class="ruby-comment">#=&gt; true</span>
</pre>

<p>If you want to attach a file without triggering dirty tracking or validation, you can use <code>Attacher#set</code>:</p>

<pre class="ruby"><span class="ruby-identifier">uploaded_file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;foo&quot; ...&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">uploaded_file</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile id=&quot;foo&quot; ...&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">changed?</span> <span class="ruby-comment">#=&gt; false</span>
</pre>

<h2 id="label-Finalizing">Finalizing<span><a href="#label-Finalizing">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>After the file is attached (with <code>Attacher#assign</code>, <code>Attacher#attach_cached</code>, or <code>Attacher#attach</code>), and data has been validated, the attachment can be “finalized”:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">finalize</span>
</pre>

<p>The <code>Attacher#finalize</code> method performs <a href="#promoting">promoting</a> and <a href="#replacing">replacing</a>. It also clears dirty tracking:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">changed?</span> <span class="ruby-comment">#=&gt; true</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">finalize</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">changed?</span> <span class="ruby-comment">#=&gt; false</span>
</pre>

<h3 id="label-Promoting">Promoting<span><a href="#label-Promoting">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><code>Attacher#finalize</code> checks if the attached file has been uploaded to temporary storage, and in this case uploads it to permanent storage.</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach_cached</span>(<span class="ruby-identifier">io</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">finalize</span> <span class="ruby-comment"># uploads attached file to permanent storage</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile storage=:store ...&gt;</span>
</pre>

<p>Internally it calls <code>Attacher#promote_cached</code>, which you can call directly if you want to pass any promote options:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile storage=:cache ...&gt;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">promote_cached</span> <span class="ruby-comment"># uploads attached file to permanent storage if new and cached</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile storage=:store ...&gt;</span>
</pre>

<p>You can also call <code>Attacher#promote</code> if you want to upload attached file to permanent storage, regardless of whether it’s cached or newly attached:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">promote</span>
</pre>

<p>Any options passed to <code>Attacher#promote_cached</code> or <code>Attacher#promote</code> will be forwarded to <code>Shrine#upload</code>.</p>

<h3 id="label-Replacing">Replacing<span><a href="#label-Replacing">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><code>Attacher#finalize</code> also deletes the previous attached file if any:</p>

<pre class="ruby"><span class="ruby-identifier">previous_file</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span>

<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span>(<span class="ruby-identifier">io</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">finalize</span>

<span class="ruby-identifier">previous_file</span>.<span class="ruby-identifier">exists?</span> <span class="ruby-comment">#=&gt; false</span>
</pre>

<p>Internally it calls <code>Attacher#destroy_previous</code> to do this:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">destroy_previous</span>
</pre>

<h2 id="label-Retrieving">Retrieving<span><a href="#label-Retrieving">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-File">File<span><a href="#label-File">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Attacher#file</code> is used to retrieve the attached file:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>
</pre>

<p>If no file is attached, <code>Attacher#file</code> returns nil:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; nil</span>
</pre>

<p>If you want to assert a file is attached, you can use <code>Attacher#file!</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file!</span> <span class="ruby-comment">#~&gt; Shrine::Error: no file is attached</span>
</pre>

<h3 id="label-Attached">Attached<span><a href="#label-Attached">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can also check whether a file is attached with <code>Attacher#attached?</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attached?</span> <span class="ruby-comment"># returns whether file is attached</span>
</pre>

<p>If you want to check to which storage a file is uploaded to, you can use <code>Attacher#cached?</code> and <code>Attacher#stored?</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span>(<span class="ruby-identifier">io</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">stored?</span>                <span class="ruby-comment">#=&gt; true (checks current file)</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">stored?</span>(<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span>) <span class="ruby-comment">#=&gt; true (checks given file)</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach_cached</span>(<span class="ruby-identifier">io</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">cached?</span>                <span class="ruby-comment">#=&gt; true (checks current file)</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">cached?</span>(<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span>) <span class="ruby-comment">#=&gt; true (checks given file)</span>
</pre>

<h3 id="label-URL">URL<span><a href="#label-URL">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The attached file URL can be retrieved with <code>Attacher#url</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">url</span> <span class="ruby-comment">#=&gt; &quot;https://example.com/file.jpg&quot;</span>
</pre>

<p>If no file is attached, <code>Attacher#url</code> returns <code>nil</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">url</span> <span class="ruby-comment">#=&gt; nil</span>
</pre>

<h3 id="label-Data">Data<span><a href="#label-Data">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can retrieve plain attached file data with <code>Attacher#data</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">data</span> <span class="ruby-comment">#=&gt;</span>
<span class="ruby-comment"># {</span>
<span class="ruby-comment">#   &quot;id&quot; =&gt; &quot;abc123.jpg&quot;,</span>
<span class="ruby-comment">#   &quot;storage&quot; =&gt; &quot;store&quot;,</span>
<span class="ruby-comment">#   &quot;metadata&quot; =&gt; {</span>
<span class="ruby-comment">#     &quot;size&quot; =&gt; 223984,</span>
<span class="ruby-comment">#     &quot;filename&quot; =&gt; &quot;nature.jpg&quot;,</span>
<span class="ruby-comment">#     &quot;mime_type&quot; =&gt; &quot;image/jpeg&quot;,</span>
<span class="ruby-comment">#   }</span>
<span class="ruby-comment"># }</span>
</pre>

<p>This data can be stored somewhere, and later the attached file can be loaded from it:</p>

<pre class="ruby"><span class="ruby-comment"># new attacher</span>
<span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">from_data</span>(<span class="ruby-identifier">data</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>

<span class="ruby-comment"># existing attacher</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; nil</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">load_data</span>(<span class="ruby-identifier">data</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>
</pre>

<p>Internally <code>Attacher#uploaded_file</code> is used to convert uploaded file data into a <code>Shrine::UploadedFile</code> object:</p>

<pre>attacher.uploaded_file(&quot;id&quot; =&gt; &quot;...&quot;, &quot;storage&quot; =&gt; &quot;...&quot;, &quot;metadata&quot; =&gt; { ... }) #=&gt; #&lt;Shrine::UploadedFile&gt;
attacher.uploaded_file(id: &quot;...&quot;, storage: &quot;...&quot;, metadata: { ... })             #=&gt; #&lt;Shrine::UploadedFile&gt;
attacher.uploaded_file(&#39;{&quot;id&quot;:&quot;...&quot;,&quot;storage&quot;:&quot;...&quot;,&quot;metadata&quot;:{...}}&#39;)          #=&gt; #&lt;Shrine::UploadedFile&gt;</pre>

<p>You will likely want to use a higher level abstraction for saving and loading this data, see {<code>column</code><a target="_top" href="https://shrinerb.com/docs/plugins/column">}</a>, {<code>entity</code><a target="_top" href="https://shrinerb.com/docs/plugins/entity">}</a> and {<code>model</code><a target="_top" href="https://shrinerb.com/docs/plugins/model">}</a> plugins for more details.</p>

<h2 id="label-Deleting">Deleting<span><a href="#label-Deleting">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The attached file can be deleted via <code>Attacher#destroy_attached</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">destroy_attached</span>
</pre>

<p>This will not delete cached files, to not interrupt any potential <a target="_top" href="https://shrinerb.com/docs/plugins/backgrounding">backgrounding</a> that might be in process.</p>

<p>If you want to delete the attached file regardless of storage it’s uploaded to, you can use <code>Attacher#destroy</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">destroy</span>
</pre>

<h2 id="label-Context">Context<span><a href="#label-Context">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>Attacher#context</code> hash is automatically forwarded to the uploader on <code>Attacher#upload</code>. When {<code>model</code><a target="_top" href="https://shrinerb.com/docs/plugins/model">}</a> or {<code>entity</code><a target="_top" href="https://shrinerb.com/docs/plugins/model">}</a> plugin is loaded, this will include <code>:record</code> and <code>:name</code> values:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">from_model</span>(<span class="ruby-identifier">photo</span>, <span class="ruby-value">:image</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">context</span> <span class="ruby-comment">#=&gt; { record: #&lt;Photo&gt;, name: :image }</span>
</pre>

<p>You can add here any other parameters you want to forward to the uploader:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">context</span>[<span class="ruby-value">:foo</span>] = <span class="ruby-string">&quot;bar&quot;</span>
</pre>

<p>However, it’s generally better practice to pass uploader options directly to <code>Attacher#assign</code>, <code>Attacher#attach</code>, <code>Attacher#promote</code> or any other method that’s calling <code>Attacher#upload</code>.</p>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
