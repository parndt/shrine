<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>changing_derivatives.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>changing_derivatives.md
</h1>
<div class='paths'>
doc/changing_derivatives.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2023-07-07 09:26:16 +0200</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>— id: changing-derivatives</p>

<h2 id="label-title-3A+Managing+Derivatives">title: Managing Derivatives<span><a href="#label-title-3A+Managing+Derivatives">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>This guide shows how to add, create, update, and remove <a target="_top" href="https://shrinerb.com/docs/plugins/derivatives">derivatives</a> for an app in production already handling file attachments, with zero downtime.</p>

<p>Let’s assume we have a <code>Photo</code> model with an <code>image</code> file attachment. The examples will be showing image thumbnails, but the advice applies to any kind of derivatives.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivatives</span>
<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:activerecord</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>(<span class="ruby-value">:image</span>)
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Adding+derivatives">Adding derivatives<span><a href="#label-Adding+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><em>Scenario: Your app is currently working only with original files, and you want to introduce derivatives.</em></p>

<p>You’ll first want to start creating the derivatives in production, without yet generating URLs for them (because existing attachments won’t yet have derivatives generated). Let’s assume you’re generating image thumbnails:</p>

<pre class="ruby"><span class="ruby-comment"># Gemfile</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;image_processing&quot;</span>, <span class="ruby-string">&quot;~&gt; 1.8&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;image_processing/mini_magick&quot;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">magick</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)

    <span class="ruby-comment"># generate the thumbnails you want here</span>
    {
      <span class="ruby-value">small:</span>  <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">300</span>, <span class="ruby-value">300</span>),
      <span class="ruby-value">medium:</span> <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">500</span>, <span class="ruby-value">500</span>),
      <span class="ruby-value">large:</span>  <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">800</span>, <span class="ruby-value">800</span>),
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">photo_params</span>)
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_derivatives!</span> <span class="ruby-comment"># generate derivatives</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">save</span>
</pre>

<p>Once we’ve deployed this to production, we can run the following script to generate derivatives for all existing attachments in production. It fetches the records in batches, downloads attachments on permanent storage, creates derivatives, and persists the changes.</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>

  <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">stored?</span>

  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">create_derivatives</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span>            <span class="ruby-comment"># persist changes if attachment has not changed in the meantime</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>,    <span class="ruby-comment"># attachment has changed</span>
         <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>  <span class="ruby-comment"># record has been deleted</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">delete_derivatives</span>        <span class="ruby-comment"># delete now orphaned derivatives</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Now all attachments should have correctly generated derivatives. You can update the attachment URLs to use derivatives as needed.</p>

<h2 id="label-Reprocessing+all+derivatives">Reprocessing all derivatives<span><a href="#label-Reprocessing+all+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><em>Scenario: The processing logic has changed for all or most derivatives, and now you want to reprocess them for existing attachments.</em></p>

<p>Let’s assume we’ve made the following change and have deployed it to production:</p>

<pre>Attacher.derivatives do |original|
   magick = ImageProcessing::MiniMagick.source(original)
+   .saver(quality: 85)

   {
     small:  magick.resize_to_limit!(300, 300),
     medium: magick.resize_to_limit!(500, 500),
     large:  magick.resize_to_limit!(800, 800),
   }
 end</pre>

<p>We can now run the following script to reprocess derivatives for all existing records. It fetches the records in batches, downloads attachments on permanent storage, reprocesses new derivatives, persists the changes, and deletes old derivatives.</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>

  <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">stored?</span>

  <span class="ruby-identifier">old_derivatives</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">derivatives</span>

  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">set_derivatives</span>({})                    <span class="ruby-comment"># clear derivatives</span>
  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">create_derivatives</span>                     <span class="ruby-comment"># reprocess derivatives</span>

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span>                       <span class="ruby-comment"># persist changes if attachment has not changed in the meantime</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">delete_derivatives</span>(<span class="ruby-identifier">old_derivatives</span>)  <span class="ruby-comment"># delete old derivatives</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>,               <span class="ruby-comment"># attachment has changed</span>
         <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>             <span class="ruby-comment"># record has been deleted</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">delete_derivatives</span>                   <span class="ruby-comment"># delete now orphaned derivatives</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Reprocessing+certain+derivatives">Reprocessing certain derivatives<span><a href="#label-Reprocessing+certain+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><em>Scenario: The processing logic has changed for specific derivatives, and now you want to reprocess them for existing attachments.</em></p>

<p>Let’s assume we’ve made a following change and have deployed it to production:</p>

<pre>Attacher.derivatives do |original|
   magick = ImageProcessing::MiniMagick.source(original)

   {
     small:  magick.resize_to_limit!(300, 300),
-    medium: magick.resize_to_limit!(500, 500),
+    medium: magick.resize_to_limit!(600, 600),
     large:  magick.resize_to_limit!(800, 800),
   }
 end</pre>

<p>We can now run the following script to reprocess the derivative for all existing records. It fetches the records in batches, downloads attachments with derivatives, reprocesses the specific derivative, persists the change, and deletes old derivative.</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>

  <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">derivatives</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-value">:medium</span>)

  <span class="ruby-identifier">old_medium</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">derivatives</span>[<span class="ruby-value">:medium</span>]
  <span class="ruby-identifier">new_medium</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">download</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>
      .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)
      .<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">600</span>, <span class="ruby-value">600</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">add_derivative</span>(<span class="ruby-value">:medium</span>, <span class="ruby-identifier">new_medium</span>)

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span>               <span class="ruby-comment"># persist changes if attachment has not changed in the meantime</span>
    <span class="ruby-identifier">old_medium</span>.<span class="ruby-identifier">delete</span>                     <span class="ruby-comment"># delete old derivative</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>,       <span class="ruby-comment"># attachment has changed</span>
         <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>     <span class="ruby-comment"># record has been deleted</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">derivatives</span>[<span class="ruby-value">:medium</span>].<span class="ruby-identifier">delete</span>  <span class="ruby-comment"># delete now orphaned derivative</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Adding+new+derivatives">Adding new derivatives<span><a href="#label-Adding+new+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><em>Scenario: A new derivative has been added to the processor, and now you want to add it to existing attachments.</em></p>

<p>Let’s assume we’ve made a following change and have deployed it to production:</p>

<pre>Attacher.derivatives do |original|
   magick = ImageProcessing::MiniMagick.source(original)

   {
+    square: magick.resize_to_fill!(150, 150),
     small:  magick.resize_to_limit!(300, 300),
     medium: magick.resize_to_limit!(600, 600),
     large:  magick.resize_to_limit!(800, 800),
   }
 end</pre>

<p>We can now run following script to add the new derivative for all existing records. It fetches the records in batches, downloads attachments on permanent storage, creates the new derivative, and persists the changes.</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>

  <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">stored?</span>

  <span class="ruby-identifier">square</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">download</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>
      .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)
      .<span class="ruby-identifier">resize_to_fill!</span>(<span class="ruby-value">150</span>, <span class="ruby-value">150</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">add_derivative</span>(<span class="ruby-value">:square</span>, <span class="ruby-identifier">square</span>)

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span>               <span class="ruby-comment"># persist changes if attachment has not changed in the meantime</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>,       <span class="ruby-comment"># attachment has changed</span>
         <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>     <span class="ruby-comment"># record has been deleted</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">derivatives</span>[<span class="ruby-value">:square</span>].<span class="ruby-identifier">delete</span>  <span class="ruby-comment"># delete now orphaned derivative</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Now all attachments should have the new derivative and you can start generating URLs for it.</p>

<h2 id="label-Removing+derivatives">Removing derivatives<span><a href="#label-Removing+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><em>Scenario: A derivative isn’t being used anymore, so we want to delete it for existing attachments.</em></p>

<p>Let’s assume we’ve made the following change and have deployed it to production:</p>

<pre>Attacher.derivatives do |original|
   magick = ImageProcessing::MiniMagick.source(original)

   {
-    square: magick.resize_to_fill!(150, 150),
     small:  magick.resize_to_limit!(300, 300),
     medium: magick.resize_to_limit!(600, 600),
     large:  magick.resize_to_limit!(800, 800),
   }
 end</pre>

<p>We can now run following script to remove the unused derivative for all existing record. It fetches the records in batches, removes and deletes the unused derivative, and persists the changes.</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>

  <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">derivatives</span>.<span class="ruby-identifier">key?</span>(<span class="ruby-value">:square</span>)

  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">remove_derivative</span>(<span class="ruby-value">:square</span>, <span class="ruby-value">delete:</span> <span class="ruby-keyword">true</span>)

  <span class="ruby-keyword">begin</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span>            <span class="ruby-comment"># persist changes if attachment has not changed in the meantime</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>,    <span class="ruby-comment"># attachment has changed</span>
         <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>  <span class="ruby-comment"># record has been deleted</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Backgrounding">Backgrounding<span><a href="#label-Backgrounding">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>For faster migration, we can also delay any of the operations above into a background job:</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>

  <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">stored?</span>

  <span class="ruby-constant">MakeChangeJob</span>.<span class="ruby-identifier">perform_async</span>(
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">record</span>.<span class="ruby-identifier">id</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">name</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file_data</span>,
  )
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MakeChangeJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
    <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-value">model:</span> <span class="ruby-identifier">record</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">file:</span> <span class="ruby-identifier">file_data</span>)
    <span class="ruby-comment"># ... make our change ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
