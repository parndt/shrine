<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>upgrading_to_3.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>upgrading_to_3.md
</h1>
<div class='paths'>
doc/upgrading_to_3.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2023-07-30 18:26:06 +0200</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>— id: upgrading-to-3</p>

<h2 id="label-title-3A+Upgrading+to+Shrine+3.x">title: Upgrading to <a href="../../classes/Shrine.html"><code>Shrine</code></a> 3.x<span><a href="#label-title-3A+Upgrading+to+Shrine+3.x">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>This guide provides instructions for upgrading <a href="../../classes/Shrine.html"><code>Shrine</code></a> in your apps to version 3.x. If you’re looking for a full list of changes, see the <strong>{3.0 release notes}[https://shrinerb.com/docs/release_notes/3.0.0]</strong>.</p>

<h2 id="label-Attacher">Attacher<span><a href="#label-Attacher">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>Shrine::Attacher</code> class has been rewritten in <a href="../../classes/Shrine.html"><code>Shrine</code></a> 3.0, though much of the main API remained the same.</p>

<h3 id="label-Model">Model<span><a href="#label-Model">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The main change is that <code>Attacher.new</code> is now used for initializing the attacher without a model:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">new</span>
<span class="ruby-comment">#=&gt; #&lt;Shrine::Attacher&gt;</span>

<span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">photo</span>, <span class="ruby-value">:image</span>)
<span class="ruby-comment"># ~&gt; ArgumentError: invalid number of arguments</span>
</pre>

<p>To initialize an attacher with a model, use <code>Attacher.from_model</code> provided by the new {<code>model</code><a target="_top" href="https://shrinerb.com/docs/plugins/model">}</a> plugin (which is automatically loaded by <code>activerecord</code> and <code>sequel</code> plugins):</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span> = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">from_model</span>(<span class="ruby-identifier">photo</span>, <span class="ruby-value">:image</span>)
<span class="ruby-comment"># ...</span>
</pre>

<p>If you’re using the <code>Shrine::Attachment</code> module with POROs, make sure to load the <code>model</code> plugin.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:model</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Struct</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:image_data</span>)
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>(<span class="ruby-value">:image</span>)
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Data+attribute">Data attribute<span><a href="#label-Data+attribute">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Attacher#read</code> method has been removed. If you want to generate serialized attachment data, use <code>Attacher#column_data</code>. Otherwise if you want to generate hash attachment data, use <code>Attacher#data</code>.</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">column_data</span> <span class="ruby-comment">#=&gt; &#39;{&quot;id&quot;:&quot;...&quot;,&quot;storage&quot;:&quot;...&quot;,&quot;metadata&quot;:{...}}&#39;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">data</span>        <span class="ruby-comment">#=&gt; { &quot;id&quot; =&gt; &quot;...&quot;, &quot;storage&quot; =&gt; &quot;...&quot;, &quot;metadata&quot; =&gt; { ... } }</span>
</pre>

<p>The <code>Attacher#data_attribute</code> has been renamed to <code>Attacher#attribute</code>.</p>

<h3 id="label-State">State<span><a href="#label-State">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The attacher now maintains its own state, so if you’ve previously modified the <code>#&lt;name&gt;_data</code> record attribute and expected the changes to be picked up by the attacher, you’ll now need to call <code>Attacher#reload</code> for that:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; nil</span>
<span class="ruby-identifier">record</span>.<span class="ruby-identifier">image_data</span> = <span class="ruby-string">&#39;{&quot;id&quot;:&quot;...&quot;,&quot;storage&quot;:&quot;...&quot;,&quot;metadata&quot;:{...}}&#39;</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; nil</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">reload</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span>
</pre>

<h3 id="label-Assigning">Assigning<span><a href="#label-Assigning">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Attacher#assign</code> method now raises an exception when non-cached uploaded file data is assigned:</p>

<pre class="ruby"><span class="ruby-comment"># Shrine 2.x</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">assign</span>(<span class="ruby-string">&#39;{&quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;store&quot;, &quot;metadata&quot;: {...}}&#39;</span>) <span class="ruby-comment"># ignored</span>

<span class="ruby-comment"># Shrine 3.0</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">assign</span>(<span class="ruby-string">&#39;{&quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;store&quot;, &quot;metadata&quot;: {...}}&#39;</span>)
<span class="ruby-comment">#~&gt; Shrine::Error: expected cached file, got #&lt;Shrine::UploadedFile storage=:store ...&gt;</span>
</pre>

<h3 id="label-Validation">Validation<span><a href="#label-Validation">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The validation functionality has been extracted into the <code>validation</code> plugin. If you’re using the <code>validation_helpers</code> plugin, it will automatically load <code>validation</code> for you. Otherwise you’ll have to load it explicitly:</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:validation</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Setting">Setting<span><a href="#label-Setting">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Attacher#set</code> method has been renamed to <code>Attacher#change</code>, and the private <code>Attacher#_set</code> method has been renamed to <code>Attacher#set</code> and made public:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">change</span>(<span class="ruby-identifier">uploaded_file</span>) <span class="ruby-comment"># sets file, remembers previous file, runs validations</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">uploaded_file</span>)    <span class="ruby-comment"># sets file</span>
</pre>

<p>If you’ve previously used <code>Attacher#replace</code> directly to delete previous file, it has now been renamed to <code>Attacher#destroy_previous</code>.</p>

<p>Also note that <code>Attacher#attached?</code> now returns whether a file is attached, while <code>Attacher#changed?</code> continues to return whether the attachment has changed.</p>

<h3 id="label-Uploading+and+deleting">Uploading and deleting<span><a href="#label-Uploading+and+deleting">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Attacher#store!</code> and <code>Attacher#cache!</code> methods have been removed, you should now use <code>Attacher#upload</code> instead:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">io</span>)               <span class="ruby-comment"># uploads to permanent storage</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">io</span>, <span class="ruby-value">:cache</span>)       <span class="ruby-comment"># uploads to temporary storage</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">io</span>, <span class="ruby-value">:other_store</span>) <span class="ruby-comment"># uploads to another storage</span>
</pre>

<p>The <code>Attacher#delete!</code> method has been removed as well, you should instead just delete the file directly via <code>UploadedFile#delete</code>.</p>

<h3 id="label-Promoting">Promoting<span><a href="#label-Promoting">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you were promoting manually, the <code>Attacher#promote</code> method will now only save promoted file in memory, it won’t persist the changes.</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">promote</span>
<span class="ruby-comment"># ...</span>
<span class="ruby-identifier">record</span>.<span class="ruby-identifier">save</span> <span class="ruby-comment"># you need to persist the changes</span>
</pre>

<p>If you want the concurrenct-safe promotion with persistence, use the new <code>Attacher#atomic_promote</code> method.</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_promote</span>
</pre>

<p>The <code>Attacher#swap</code> method has been removed. If you were using it directly, you can use <code>Attacher#set</code> and <code>Attacher#atomic_persist</code> instead:</p>

<pre class="ruby"><span class="ruby-identifier">current_file</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">new_file</span>)
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span>(<span class="ruby-identifier">current_file</span>)
</pre>

<h2 id="label-Backgrounding">Backgrounding<span><a href="#label-Backgrounding">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>backgrounding</code> plugin has been rewritten in <a href="../../classes/Shrine.html"><code>Shrine</code></a> 3.0 and has a new API.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:backgrounding</span>
<span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">promote_block</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">PromoteJob</span>.<span class="ruby-identifier">perform_async</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">record</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>)
<span class="ruby-keyword">end</span>
<span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">destroy_block</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">DestroyJob</span>.<span class="ruby-identifier">perform_async</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">data</span>)
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">PromoteJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
    <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-value">model:</span> <span class="ruby-identifier">record</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">file:</span> <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_promote</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>
    <span class="ruby-comment"># attachment has changed or record has been deleted, nothing to do</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">DestroyJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">data</span>)
    <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">from_data</span>(<span class="ruby-identifier">data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">destroy</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Dual+support">Dual support<span><a href="#label-Dual+support">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>When you’re making the switch in production, there might still be jobs in the queue that have the old argument format. So, we’ll initially want to handle both argument formats, and then switch to the new one once the jobs with old format have been drained.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">PromoteJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">one?</span>
      <span class="ruby-identifier">file_data</span>, (<span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>), <span class="ruby-identifier">name</span>, <span class="ruby-identifier">shrine_class</span> =
        <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-string">&quot;attachment&quot;</span>, <span class="ruby-string">&quot;record&quot;</span>, <span class="ruby-string">&quot;name&quot;</span>, <span class="ruby-string">&quot;shrine_class&quot;</span>)

      <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>
      <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">shrine_class</span>)<span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span> = <span class="ruby-identifier">args</span>

      <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
      <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-value">model:</span> <span class="ruby-identifier">record</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">file:</span> <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_promote</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>
    <span class="ruby-comment"># attachment has changed or record has been deleted, nothing to do</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">DestroyJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">one?</span>
      <span class="ruby-identifier">data</span>, <span class="ruby-identifier">shrine_class</span> = <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">values_at</span>(<span class="ruby-string">&quot;attachment&quot;</span>, <span class="ruby-string">&quot;shrine_class&quot;</span>)

      <span class="ruby-identifier">data</span>           = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">data</span>)
      <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">shrine_class</span>)<span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">data</span> = <span class="ruby-identifier">args</span>

      <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">from_data</span>(<span class="ruby-identifier">data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">destroy</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Attacher+backgrounding">Attacher backgrounding<span><a href="#label-Attacher+backgrounding">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In <a href="../../classes/Shrine.html"><code>Shrine</code></a> 2.x, <code>Attacher#_promote</code> and <code>Attacher#_delete</code> methods could be used to spawn promote and delete jobs. This is now done by <code>Attacher#promote_cached</code> and <code>Attacher#destroy_attached</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">promote_cached</span>   <span class="ruby-comment"># will spawn background job if registered</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">destroy_attached</span> <span class="ruby-comment"># will spawn background job if registered</span>
</pre>

<p>If you want to explicitly call backgrounding blocks, you can use <code>Attacher#promote_background</code> and <code>Attacher#destroy_background</code>:</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">promote_background</span> <span class="ruby-comment"># calls promote block</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">destroy_background</span> <span class="ruby-comment"># calls destroy block</span>
</pre>

<h2 id="label-Versions">Versions<span><a href="#label-Versions">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The <code>versions</code>, <code>processing</code>, <code>recache</code>, and <code>delete_raw</code> plugins have been deprecated in favour of the new <strong>{<code>derivatives</code>}[https://shrinerb.com/docs/plugins/derivatives]</strong> plugin.</p>

<p>Let’s assume you have the following <code>versions</code> configuration:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:processing</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:versions</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:delete_raw</span>

  <span class="ruby-identifier">process</span>(<span class="ruby-value">:store</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span>, <span class="ruby-identifier">context</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">versions</span> = { <span class="ruby-value">original:</span> <span class="ruby-identifier">file</span> }

    <span class="ruby-identifier">file</span>.<span class="ruby-identifier">download</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">magick</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)

      <span class="ruby-identifier">versions</span>[<span class="ruby-value">:large</span>]  = <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">800</span>, <span class="ruby-value">800</span>)
      <span class="ruby-identifier">versions</span>[<span class="ruby-value">:medium</span>] = <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">500</span>, <span class="ruby-value">500</span>)
      <span class="ruby-identifier">versions</span>[<span class="ruby-value">:small</span>]  = <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">300</span>, <span class="ruby-value">300</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">versions</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>When an attached file is promoted to permanent storage, the versions would automatically get generated:</p>

<pre class="ruby"><span class="ruby-identifier">photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">photo_params</span>)

<span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">valid?</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">save</span> <span class="ruby-comment"># generates versions on promotion</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>With <code>derivatives</code>, the original file is automatically downloaded and retained during processing, so the setup is simpler:</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivatives</span>,
  <span class="ruby-value">create_on_promote:</span>      <span class="ruby-keyword">true</span>, <span class="ruby-comment"># automatically create derivatives on promotion</span>
  <span class="ruby-value">versions_compatibility:</span> <span class="ruby-keyword">true</span>  <span class="ruby-comment"># handle versions column format</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">magick</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)

    <span class="ruby-comment"># the :original file should NOT be included anymore</span>
    {
      <span class="ruby-value">large:</span>  <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">800</span>, <span class="ruby-value">800</span>),
      <span class="ruby-value">medium:</span> <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">500</span>, <span class="ruby-value">500</span>),
      <span class="ruby-value">small:</span>  <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">300</span>, <span class="ruby-value">300</span>),
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">photo_params</span>)

<span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">valid?</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">save</span> <span class="ruby-comment"># creates derivatives on promotion</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Accessing+derivatives">Accessing derivatives<span><a href="#label-Accessing+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The derivative URLs are accessed in the same way as versions:</p>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-value">:small</span>)
</pre>

<p>But the files themselves are accessed differently:</p>

<pre class="ruby"><span class="ruby-comment"># versions</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span> <span class="ruby-comment">#=&gt;</span>
<span class="ruby-comment"># {</span>
<span class="ruby-comment">#   original: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="ruby-comment">#   large: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="ruby-comment">#   medium: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="ruby-comment">#   small: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="ruby-comment"># }</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>[<span class="ruby-value">:medium</span>] <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># derivatives</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_derivatives</span> <span class="ruby-comment">#=&gt;</span>
<span class="ruby-comment"># {</span>
<span class="ruby-comment">#   large: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="ruby-comment">#   medium: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="ruby-comment">#   small: #&lt;Shrine::UploadedFile ...&gt;,</span>
<span class="ruby-comment"># }</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>(<span class="ruby-value">:medium</span>) <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span>
</pre>

<h3 id="label-Migrating+versions">Migrating versions<span><a href="#label-Migrating+versions">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>versions</code> and <code>derivatives</code> plugins save processed file data to the database column in different formats:</p>

<pre># versions
{
  &quot;original&quot;: { &quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;...&quot;, &quot;metadata&quot;: { ... } },
  &quot;large&quot;:    { &quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;...&quot;, &quot;metadata&quot;: { ... } },
  &quot;medium&quot;:   { &quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;...&quot;, &quot;metadata&quot;: { ... } },
  &quot;small&quot;:    { &quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;...&quot;, &quot;metadata&quot;: { ... } }
}</pre>

<pre># derivatives
{
  &quot;id&quot;: &quot;...&quot;,
  &quot;storage&quot;: &quot;...&quot;,
  &quot;metadata&quot;: { ... },
  &quot;derivatives&quot;: {
    &quot;large&quot;:  { &quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;...&quot;, &quot;metadata&quot;: { ... } },
    &quot;medium&quot;: { &quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;...&quot;, &quot;metadata&quot;: { ... } },
    &quot;small&quot;:  { &quot;id&quot;: &quot;...&quot;, &quot;storage&quot;: &quot;...&quot;, &quot;metadata&quot;: { ... } }
  }
}</pre>

<p>The <code>:versions_compatibility</code> flag to the <code>derivatives</code> plugin enables it to read the <code>versions</code> format, which aids in transition. Once the <code>derivatives</code> plugin has been deployed to production, you can update existing records with the new column format:</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>.<span class="ruby-identifier">write</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>.<span class="ruby-identifier">atomic_persist</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Afterwards you should be able to remove the <code>:versions_compatibility</code> flag.</p>

<h3 id="label-Backgrounding+derivatives">Backgrounding derivatives<span><a href="#label-Backgrounding+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you’re using the <code>backgrounding</code> plugin, you can trigger derivatives creation in the <code>PromoteJob</code> instead of the controller:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">PromoteJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
    <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-value">model:</span> <span class="ruby-identifier">record</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">file:</span> <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">create_derivatives</span> <span class="ruby-comment"># call derivatives processor</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_promote</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>
    <span class="ruby-comment"># attachment has changed or record has been deleted, nothing to do</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-Recache">Recache<span><a href="#label-Recache">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>If you were using the <code>recache</code> plugin, you can replicate the behaviour by creating another derivatives processor that you will trigger in the controller:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># this will be triggered in the background job</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-value">:foreground</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># this will be triggered in the controller</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">photo_params</span>)

<span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">valid?</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_derivatives!</span>(<span class="ruby-value">:foreground</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_changed?</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">save</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">else</span>
  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Default+URL">Default URL<span><a href="#label-Default+URL">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you were using the <code>default_url</code> plugin, the <code>Attacher.default_url</code> now receives a <code>:derivative</code> option:</p>

<pre class="ruby"><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">default_url</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-value">derivative:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-operator">|</span>
  <span class="ruby-node">&quot;https://my-app.com/fallbacks/#{derivative}.jpg&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">derivative</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-Fallback+to+original">Fallback to original<span><a href="#label-Fallback+to+original">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>With the <code>versions</code> plugin, a missing version URL would automatically fall back to the original file. The <code>derivatives</code> plugin has no such fallback, but you can configure it manually:</p>

<pre class="ruby"><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">default_url</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-value">derivative:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">file</span>&amp;.<span class="ruby-identifier">url</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">derivative</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-Fallback+to+version">Fallback to version<span><a href="#label-Fallback+to+version">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The <code>versions</code> plugin had the ability to fall back missing version URL to another version that already exists. The <code>derivatives</code> plugin doesn’t have this built in, but you can implement it as follows:</p>

<pre>DERIVATIVE_FALLBACKS = { foo: :bar, ... }

Attacher.default_url do |derivative: nil, **|
  derivatives[DERIVATIVE_FALLBACKS[derivative]]&amp;.url if derivative
end</pre>

<h3 id="label-Location">Location<span><a href="#label-Location">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Shrine#generate_location</code> method will now receive a <code>:derivative</code> parameter instead of <code>:version</code>:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">generate_location</span>(<span class="ruby-identifier">io</span>, <span class="ruby-value">derivative:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span>)
    <span class="ruby-identifier">derivative</span> <span class="ruby-comment">#=&gt; :large, :medium, :small, ...</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Overwriting+original">Overwriting original<span><a href="#label-Overwriting+original">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>With the <code>derivatives</code> plugin, saving processed files separately from the original file, so the original file is automatically kept. This means it’s not possible anymore to overwrite the original file as part of processing.</p>

<p>However, <strong>it’s highly recommended to always keep the original file</strong>, even if you don’t plan to use it. That way, if there is ever a need to reprocess derivatives, you have the original file to use as a base.</p>

<p>That being said, if you still want to overwrite the original file, <a target="_top" href="https://discourse.shrinerb.com/t/keep-original-file-after-processing/50/4">this thread</a> has some tips.</p>

<h2 id="label-Other">Other<span><a href="#label-Other">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Processing">Processing<span><a href="#label-Processing">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>processing</code> plugin has been deprecated over the new {<code>derivatives</code><a target="_top" href="https://shrinerb.com/docs/plugins/derivatives">}</a> plugin. If you were previously replacing the original file:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:processing</span>

  <span class="ruby-identifier">process</span>(<span class="ruby-value">:store</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span>, <span class="ruby-identifier">context</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>
      .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">io</span>.<span class="ruby-identifier">download</span>)
      .<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">1600</span>, <span class="ruby-value">1600</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>you should now add the processed file as a derivative:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivatives</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">magick</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)

    { <span class="ruby-value">normalized:</span> <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">1600</span>, <span class="ruby-value">1600</span>) }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Parallelize">Parallelize<span><a href="#label-Parallelize">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>parallelize</code> plugin has been removed. With <code>derivatives</code> plugin you can parallelize uploading processed files manually:</p>

<pre class="ruby"><span class="ruby-comment"># Gemfile</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;concurrent-ruby&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;concurrent&quot;</span>

<span class="ruby-identifier">attacher</span>    = <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_attacher</span>
<span class="ruby-identifier">derivatives</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">process_derivatives</span>

<span class="ruby-identifier">tasks</span> = <span class="ruby-identifier">derivatives</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">Concurrent</span><span class="ruby-operator">::</span><span class="ruby-constant">Promises</span>.<span class="ruby-identifier">future</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">add_derivative</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-constant">Concurrent</span><span class="ruby-operator">::</span><span class="ruby-constant">Promises</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">tasks</span>).<span class="ruby-identifier">wait!</span>
</pre>

<h3 id="label-Logging">Logging<span><a href="#label-Logging">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>logging</code> plugin has been removed in favour of the {<code>instrumentation</code><a target="_top" href="https://shrinerb.com/docs/plugins/instrumentation">}</a> plugin. You can replace code like</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:logging</span>, <span class="ruby-value">logger:</span> <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>
</pre>

<p>with</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">logger</span> = <span class="ruby-constant">Rails</span>.<span class="ruby-identifier">logger</span>

<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:instrumentation</span>
</pre>

<h3 id="label-Backup">Backup<span><a href="#label-Backup">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>backup</code> plugin has been removed in favour of the new {<code>mirroring</code><a target="_top" href="https://shrinerb.com/docs/plugins/mirroring">}</a> plugin. You can replace code like</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:backup</span>, <span class="ruby-value">storage:</span> <span class="ruby-value">:backup_store</span>
</pre>

<p>with</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:mirroring</span>, <span class="ruby-value">mirror:</span> { <span class="ruby-value">store:</span> <span class="ruby-value">:backup_store</span> }
</pre>

<h3 id="label-Copy">Copy<span><a href="#label-Copy">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>copy</code> plugin has been removed as its behaviour can now be achieved easily. You can replace code like</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:copy</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">copy</span>(<span class="ruby-identifier">other_attacher</span>)
</pre>

<p>with</p>

<pre class="ruby"><span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">set</span> <span class="ruby-keyword">nil</span> <span class="ruby-comment"># clear original attachment</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">attach</span> <span class="ruby-identifier">other_attacher</span>.<span class="ruby-identifier">file</span>, <span class="ruby-value">storage:</span> <span class="ruby-identifier">other_attacher</span>.<span class="ruby-identifier">file</span>.<span class="ruby-identifier">storage_key</span>
<span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">add_derivatives</span> <span class="ruby-identifier">other_attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-comment"># if using derivatives</span>
</pre>

<h3 id="label-Moving">Moving<span><a href="#label-Moving">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>moving</code> plugin has been removed in favour of the <code>:move</code> option for <code>FileSystem#upload</code>. You can set this option as default using the <code>upload_options</code> plugin (the example assumes both <code>:cache</code> and <code>:store</code> are FileSystem storages):</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:upload_options</span>, <span class="ruby-value">cache:</span> { <span class="ruby-value">move:</span> <span class="ruby-keyword">true</span> }, <span class="ruby-value">store:</span> { <span class="ruby-value">move:</span> <span class="ruby-keyword">true</span> }
</pre>

<h3 id="label-Parsed+JSON">Parsed JSON<span><a href="#label-Parsed+JSON">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>parsed_json</code> plugin has been removed as it’s now the default behaviour.</p>

<pre># this now works by default
photo.image = { &quot;id&quot; =&gt; &quot;d7e54d6ef2.jpg&quot;, &quot;storage&quot; =&gt; &quot;cache&quot;, &quot;metadata&quot; =&gt; { ... } }</pre>

<h3 id="label-Module+Include">Module Include<span><a href="#label-Module+Include">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>module_include</code> plugin has been deprecated over overriding core classes directly. You can replace code like</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:module_include</span>

  <span class="ruby-identifier">file_methods</span> <span class="ruby-keyword">do</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">image?</span>
      <span class="ruby-identifier">mime_type</span>.<span class="ruby-identifier">start_with?</span>(<span class="ruby-string">&quot;image&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>with</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-keyword">class</span> <span class="ruby-constant">UploadedFile</span>
    <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">image?</span>
      <span class="ruby-identifier">mime_type</span>.<span class="ruby-identifier">start_with?</span>(<span class="ruby-string">&quot;image&quot;</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
