<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>refile.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>refile.md
</h1>
<div class='paths'>
doc/refile.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2023-07-07 09:26:16 +0200</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>—</p>

<h2 id="label-title-3A+Upgrading+from+Refile">title: Upgrading from Refile<span><a href="#label-title-3A+Upgrading+from+Refile">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>This guide is aimed at helping Refile users transition to <a href="../../classes/Shrine.html"><code>Shrine</code></a>, and it consists of three parts:</p>
<ol><li>
<p>Explanation of the key differences in design between Refile and <a href="../../classes/Shrine.html"><code>Shrine</code></a></p>
</li><li>
<p>Instructions how to migrate an existing app that uses Refile to <a href="../../classes/Shrine.html"><code>Shrine</code></a></p>
</li><li>
<p>Extensive reference of Refile’s interface with <a href="../../classes/Shrine.html"><code>Shrine</code></a> equivalents</p>
</li></ol>

<h2 id="label-Overview">Overview<span><a href="#label-Overview">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> borrows many great concepts from Refile: Refile’s “backends” are here named “storages”, it uses the same IO abstraction for uploading and representing uploaded files, similar attachment logic, and direct uploads are supported as well.</p>

<h3 id="label-Uploader">Uploader<span><a href="#label-Uploader">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>While in Refile you work with storages directly, <a href="../../classes/Shrine.html"><code>Shrine</code></a> uses <em>uploaders</em> which wrap storage uploads:</p>

<pre class="ruby"><span class="ruby-identifier">storage</span> = <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">storages</span>[<span class="ruby-value">:store</span>]
<span class="ruby-identifier">storage</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::Storage::S3&gt;</span>

<span class="ruby-identifier">uploaded_file</span> = <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">upload</span>(<span class="ruby-identifier">image</span>, <span class="ruby-value">:store</span>)
<span class="ruby-identifier">uploaded_file</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span>
<span class="ruby-identifier">uploaded_file</span>.<span class="ruby-identifier">storage</span> <span class="ruby-comment">#=&gt; #&lt;Shrine::Storage::S3&gt;</span>
</pre>

<p>This way, <a href="../../classes/Shrine.html"><code>Shrine</code></a> can perform tasks like generating location, extracting metadata, processing, and logging, which are all storage-agnostic, and leave storages to deal only with actual file storage. And these tasks can be configured differently depending on the types of files you’re uploading:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">add_metadata</span> <span class="ruby-value">:exif</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">MiniMagick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">io</span>).<span class="ruby-identifier">exif</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">VideoUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">add_metadata</span> <span class="ruby-value">:duration</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">io</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">FFMPEG</span><span class="ruby-operator">::</span><span class="ruby-constant">Movie</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">io</span>.<span class="ruby-identifier">path</span>).<span class="ruby-identifier">duration</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-URL">URL<span><a href="#label-URL">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>While Refile serves all files through the Rack endpoint mounted in your app, <a href="../../classes/Shrine.html"><code>Shrine</code></a> serves files directly from storage services:</p>

<pre class="ruby"><span class="ruby-constant">Refile</span>.<span class="ruby-identifier">attachment_url</span>(<span class="ruby-ivar">@photo</span>, <span class="ruby-value">:image</span>) <span class="ruby-comment">#=&gt; &quot;/attachments/cache/50dfl833lfs0gfh.jpg&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-ivar">@photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">url</span> <span class="ruby-comment">#=&gt; &quot;https://my-bucket.s3.amazonaws.com/cache/50dfl833lfs0gfh.jpg&quot;</span>
</pre>

<p>If you’re using storage which don’t expose files over URL (e.g. a database storage), or you want to secure your downloads, you can also serve files through your app using the {<code>download_endpoint</code><a target="_top" href="https://shrinerb.com/docs/plugins/download_endpoint">}</a> plugin.</p>

<h3 id="label-Persistence">Persistence<span><a href="#label-Persistence">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Refile persists the uploaded file location and metadata into individual columns:</p>
<ul><li>
<p><code>&lt;attachment&gt;_id</code></p>
</li><li>
<p><code>&lt;attachment&gt;_filename</code></p>
</li><li>
<p><code>&lt;attachment&gt;_content_type</code></p>
</li><li>
<p><code>&lt;attachment&gt;_size</code></p>
</li></ul>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a>, on the other hand, saves all uploaded file data into a single <code>&lt;attachment&gt;_data</code> column:</p>

<pre class="ruby">{
  <span class="ruby-value">&quot;id&quot;:</span> <span class="ruby-string">&quot;path/to/image.jpg&quot;</span>,
  <span class="ruby-value">&quot;storage&quot;:</span> <span class="ruby-string">&quot;store&quot;</span>,
  <span class="ruby-value">&quot;metadata&quot;:</span> {
    <span class="ruby-value">&quot;filename&quot;:</span> <span class="ruby-string">&quot;nature.jpg&quot;</span>,
    <span class="ruby-value">&quot;size&quot;:</span> <span class="ruby-value">4739472</span>,
    <span class="ruby-value">&quot;mime_type&quot;:</span> <span class="ruby-string">&quot;image/jpeg&quot;</span>
  }
}
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">id</span>          <span class="ruby-comment">#=&gt; &quot;path/to/image.jpg&quot;</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">storage_key</span> <span class="ruby-comment">#=&gt; :store</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">metadata</span>    <span class="ruby-comment">#=&gt; { &quot;filename&quot; =&gt; &quot;...&quot;, &quot;size&quot; =&gt; ..., &quot;mime_type&quot; =&gt; &quot;...&quot; }</span>

<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">original_filename</span> <span class="ruby-comment">#=&gt; &quot;nature.jpg&quot;</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">size</span>              <span class="ruby-comment">#=&gt; 4739472</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">mime_type</span>         <span class="ruby-comment">#=&gt; &quot;image/jpeg&quot;</span>
</pre>

<p>This column can be queried if it’s made a JSON column. Alternatively, you can use the {<code>metadata_attributes</code><a target="_top" href="https://shrinerb.com/docs/plugins/metadata_attributes">}</a> plugin to save metadata into separate columns.</p>

<h3 id="label-Processing">Processing<span><a href="#label-Processing">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> provides on-the-fly processing via the {<code>derivation_endpoint</code><a target="_top" href="https://shrinerb.com/docs/plugins/derivation_endpoint">}</a> plugin:</p>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;image_processing/mini_magick&quot;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivation_endpoint</span>,
    <span class="ruby-value">secret_key:</span> <span class="ruby-string">&quot;&lt;YOUR SECRET KEY&gt;&quot;</span>,
    <span class="ruby-value">prefix:</span>     <span class="ruby-string">&quot;derivations/image&quot;</span> <span class="ruby-comment"># needs to match the mount point in routes</span>

  <span class="ruby-identifier">derivation</span> <span class="ruby-value">:thumbnail</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span>, <span class="ruby-identifier">width</span>, <span class="ruby-identifier">height</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>
      .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">file</span>)
      .<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-identifier">width</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">height</span>.<span class="ruby-identifier">to_i</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># config/routes.rb (Rails)</span>
<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>
  <span class="ruby-comment"># ...</span>
  <span class="ruby-identifier">mount</span> <span class="ruby-constant">ImageUploader</span>.<span class="ruby-identifier">derivation_endpoint</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;/derivations/image&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> also support eager processing using the {<code>derivatives</code><a target="_top" href="https://shrinerb.com/docs/plugins/derivatives">}</a> plugin.</p>

<h3 id="label-Validation">Validation<span><a href="#label-Validation">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In Refile, file validation is defined statically on attachment definition:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Sequel</span><span class="ruby-operator">::</span><span class="ruby-constant">Model</span>
  <span class="ruby-identifier">attachment</span> <span class="ruby-value">:image</span>,
    <span class="ruby-value">extension:</span> <span class="ruby-node">%w[jpg jpeg png webp]</span>,
    <span class="ruby-value">content_type:</span> <span class="ruby-node">%w[image/jpeg image/png image/webp]</span>
<span class="ruby-keyword">end</span>
</pre>

<p>In <a href="../../classes/Shrine.html"><code>Shrine</code></a>, validation is performed on the instance-level, which allows you to make the validation conditional:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:validation_helpers</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">validate_max_size</span> <span class="ruby-value">10</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span>
    <span class="ruby-identifier">validate_extension</span> <span class="ruby-node">%w[jpg jpeg png webp]</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">validate_mime_type</span> <span class="ruby-node">%w[image/jpeg image/png image/webp]</span>
      <span class="ruby-identifier">validate_max_dimensions</span> [<span class="ruby-value">5000</span>, <span class="ruby-value">5000</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Refile extracts the MIME type from the file extension, which means it can easily be spoofed (just give a PHP file a <code>.jpg</code> extension). <a href="../../classes/Shrine.html"><code>Shrine</code></a> has the {<code>determine_mime_type</code><a target="_top" href="https://shrinerb.com/docs/plugins/determine_mime_type">}</a> plugin for determining MIME type from file <em>content</em>.</p>

<h3 id="label-Direct+uploads">Direct uploads<span><a href="#label-Direct+uploads">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> borrows Refile’s idea of direct uploads, and ships with <code>upload_endpoint</code> and <code>presign_endpoint</code> plugins which provide endpoints for uploading files and generating presigns.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:upload_endpoint</span>
<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">upload_endpoint</span>(<span class="ruby-value">:cache</span>) <span class="ruby-comment"># Rack app that uploads files to specified storage</span>

<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:upload_endpoint</span>
<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">presign_endpoint</span>(<span class="ruby-value">:cache</span>) <span class="ruby-comment"># Rack app that generates presigns for specified storage</span>
</pre>

<p>While Refile ships with a plug-and-play JavaScript for direct uploads, <a href="../../classes/Shrine.html"><code>Shrine</code></a> instead adopts <a target="_top" href="https://uppy.io">Uppy</a>, a modern and modular JavaScript file upload library that happens to integrate well with <a href="../../classes/Shrine.html"><code>Shrine</code></a>.</p>

<h3 id="label-Multiple+uploads">Multiple uploads<span><a href="#label-Multiple+uploads">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> doesn’t have support for multiple uploads out-of-the-box like Refile does. Instead, you can implement them using a separate table with a one-to-many relationship to which the files will be attached. The <a target="_top" href="https://shrinerb.com/docs/multiple-files">Multiple Files</a> guide explains this setup in more detail.</p>

<h2 id="label-Migrating+from+Refile">Migrating from Refile<span><a href="#label-Migrating+from+Refile">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>You have an existing app using Refile and you want to transfer it to <a href="../../classes/Shrine.html"><code>Shrine</code></a>. Let’s assume we have a <code>Photo</code> model with the “image” attachment.</p>

<h3 id="label-1.+Add+Shrine+column">1. Add <a href="../../classes/Shrine.html"><code>Shrine</code></a> column<span><a href="#label-1.+Add+Shrine+column">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>First we need to create the <code>image_data</code> column for Shrine:</p>

<pre class="ruby"><span class="ruby-identifier">add_column</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">:image_data</span>, <span class="ruby-value">:text</span>
</pre>

<h3 id="label-2.+Dual+write">2. Dual write<span><a href="#label-2.+Dual+write">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Afterwards we need to make new uploads write to the <code>image_data</code> column. This can be done by including the below module to all models that have Refile attachments:</p>

<pre>require &quot;shrine&quot;

Shrine.storages = {
  cache: ...,
  store: ...,
}

Shrine.plugin :model

module RefileShrineSynchronization
  def write_shrine_data(name)
    attacher = Shrine::Attacher.from_model(self, name)

    if read_attribute(&quot;#{name}_id&quot;).present?
      attacher.set shrine_file(name)
    else
      attacher.set nil
    end
  end

  def shrine_file(name)
    Shrine.uploaded_file(
      storage:  :store,
      id:       send(&quot;#{name}_id&quot;),
      metadata: {
        &quot;size&quot;      =&gt; (send(&quot;#{name}_size&quot;) if respond_to?(&quot;#{name}_size&quot;)),
        &quot;filename&quot;  =&gt; (send(&quot;#{name}_filename&quot;) if respond_to?(&quot;#{name}_filename&quot;)),
        &quot;mime_type&quot; =&gt; (send(&quot;#{name}_content_type&quot;) if respond_to?(&quot;#{name}_content_type&quot;)),
      }
    )
  end
end</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Base</span>
  <span class="ruby-identifier">attachment</span> <span class="ruby-value">:image</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">RefileShrineSynchronization</span>

  <span class="ruby-identifier">before_save</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">write_shrine_data</span>(<span class="ruby-value">:image</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">image_id_changed?</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>After you deploy this code, the <code>image_data</code> column should now be successfully synchronized with new attachments.</p>

<h3 id="label-3.+Data+migration">3. Data migration<span><a href="#label-3.+Data+migration">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Next step is to run a script which writes all existing Refile attachments to <code>image_data</code>:</p>

<pre class="ruby"><span class="ruby-constant">Photo</span>.<span class="ruby-identifier">find_each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">photo</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">write_shrine_data</span>(<span class="ruby-value">:image</span>)
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">save!</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-4.+Rewrite+code">4. Rewrite code<span><a href="#label-4.+Rewrite+code">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Now you should be able to rewrite your application so that it uses <a href="../../classes/Shrine.html"><code>Shrine</code></a> instead of Refile (you can consult the reference in the next section). You can remove the <code>RefileShrineSynchronization</code> module as well.</p>

<h3 id="label-5.+Remove+Refile+columns">5. Remove Refile columns<span><a href="#label-5.+Remove+Refile+columns">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If everything is looking good, we can remove Refile columns:</p>

<pre class="ruby"><span class="ruby-identifier">remove_column</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">:image_id</span>
<span class="ruby-identifier">remove_column</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">:image_size</span>
<span class="ruby-identifier">remove_column</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">:image_filename</span>
<span class="ruby-identifier">remove_column</span> <span class="ruby-value">:photos</span>, <span class="ruby-value">:image_content_type</span>
</pre>

<h2 id="label-Refile+to+Shrine+direct+mapping">Refile to <a href="../../classes/Shrine.html"><code>Shrine</code></a> direct mapping<span><a href="#label-Refile+to+Shrine+direct+mapping">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Refile"><code>Refile</code><span><a href="#label-Refile">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-.cache-2C+.store-2C+.backends"><code>.cache</code>, <code>.store</code>, <code>.backends</code><span><a href="#label-.cache-2C+.store-2C+.backends">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> calles these “storages”, and it doesn’t have special accessors for <code>:cache</code> and <code>:store</code>:</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">storages</span> = {
  <span class="ruby-value">cache:</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">Foo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>),
  <span class="ruby-value">store:</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">Bar</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>),
}
</pre>

<h4 id="label-.app-2C+.mount_point-2C+.automount"><code>.app</code>, <code>.mount_point</code>, <code>.automount</code><span><a href="#label-.app-2C+.mount_point-2C+.automount">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The Rack apps provided by the <code>*_endpoint</code> <a href="../../classes/Shrine.html"><code>Shrine</code></a> plugins are mounted explicitly:</p>

<pre class="ruby"><span class="ruby-comment"># config/routes.rb</span>
<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>
  <span class="ruby-comment"># adds `POST /images/upload` endpoint</span>
  <span class="ruby-identifier">mount</span> <span class="ruby-constant">ImageUploader</span>.<span class="ruby-identifier">upload_endpoint</span>(<span class="ruby-value">:cache</span>) <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;/images/upload&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-.allow_uploads_to"><code>.allow_uploads_to</code><span><a href="#label-.allow_uploads_to">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The <code>Shrine.upload_endpoint</code> and <code>Shrine.presign_endpoint</code> builders require you to specify the storage that will be used.</p>

<h4 id="label-.logger"><code>.logger</code><span><a href="#label-.logger">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">logger</span>
</pre>

<h4 id="label-.processors-2C+.processor"><code>.processors</code>, <code>.processor</code><span><a href="#label-.processors-2C+.processor">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivatives</span>

  <span class="ruby-identifier">derivation</span> <span class="ruby-value">:thumbnail</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span>, <span class="ruby-identifier">width</span>, <span class="ruby-identifier">height</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-.types"><code>.types</code><span><a href="#label-.types">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> defines validations on the uploader class level:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">MyUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:validation_helpers</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">validate_max_size</span> <span class="ruby-value">5</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span><span class="ruby-operator">*</span><span class="ruby-value">1024</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-.extract_filename"><code>.extract_filename</code><span><a href="#label-.extract_filename">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Shrine’s equivalent is a <code>Shrine#extract_filename</code> private method. You can instead use the <code>Shrine#extract_metadata</code> public method.</p>

<h4 id="label-.extract_content_type"><code>.extract_content_type</code><span><a href="#label-.extract_content_type">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The {<code>determine_mime_type</code><a target="_top" href="https://shrinerb.com/docs/plugins/determine_mime_type">}</a> plugin provides a <code>Shrine.determine_mime_type</code> method.</p>

<h4 id="label-.app_url-2C+.upload_url-2C+.attachment_upload_url-2C+.presign_url-2C+.attachment_presign_url"><code>.app_url</code>, <code>.upload_url</code>, <code>.attachment_upload_url</code>, <code>.presign_url</code>, <code>.attachment_presign_url</code><span><a href="#label-.app_url-2C+.upload_url-2C+.attachment_upload_url-2C+.presign_url-2C+.attachment_presign_url">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> requires you to use your framework to generate URLs to mounted endpoints.</p>

<h4 id="label-.attachment_url-2C+.file_url"><code>.attachment_url</code>, <code>.file_url</code><span><a href="#label-.attachment_url-2C+.file_url">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>You can call <code>#url</code> on the uploaded file, or <code>#&lt;name&gt;_url</code> on the model. Alternatively, you can use <code>#download_url</code> provided by the <code>download_endpoint</code> plugin.</p>

<h4 id="label-.host-2C+.cdn_host-2C+.app_host-2C+.allow_downloads_from-2C+allow_origin-2C+.content_max_age"><code>.host</code>, <code>.cdn_host</code>, <code>.app_host</code>, <code>.allow_downloads_from</code>, <code>allow_origin</code>, <code>.content_max_age</code><span><a href="#label-.host-2C+.cdn_host-2C+.app_host-2C+.allow_downloads_from-2C+allow_origin-2C+.content_max_age">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>These can be configured on individual <code>*_endpoint</code> plugins.</p>

<h4 id="label-.secret_key-2C+.token-2C+.valid_token-3F"><code>.secret_key</code>, <code>.token</code>, <code>.valid_token?</code><span><a href="#label-.secret_key-2C+.token-2C+.valid_token-3F">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The secret key is required for the {<code>derivation_endpoint</code><a target="_top" href="https://shrinerb.com/docs/plugins/derivation_endpoint">}</a>, but these methods are not exposed.</p>

<h3 id="label-Attachment"><code>Attachment</code><span><a href="#label-Attachment">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Shrine’s equivalent to calling the attachment is including an attachment module of an uploader:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Photo</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">Attachment</span>(<span class="ruby-value">:image</span>)
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Aextension-2C+-3Acontent_type-2C+-3Atype"><code>:extension</code>, <code>:content_type</code>, <code>:type</code><span><a href="#label-3Aextension-2C+-3Acontent_type-2C+-3Atype">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>In <a href="../../classes/Shrine.html"><code>Shrine</code></a> validations are done instance-level inside the uploader, most commonly with the <code>validation_helpers</code> plugin:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:validation_helpers</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">validate_extension</span> <span class="ruby-node">%w[jpg jpeg png]</span>
    <span class="ruby-identifier">validate_mime_type</span> <span class="ruby-node">%w[image/jpeg image/png]</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Acache-2C+-3Astore"><code>:cache</code>, <code>:store</code><span><a href="#label-3Acache-2C+-3Astore">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> provides a <code>default_storage</code> plugin for setting custom storages on the uploader:</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">storages</span>[<span class="ruby-value">:custom_cache</span>] = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">Foo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">storages</span>[<span class="ruby-value">:custom_store</span>] = <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Storage</span><span class="ruby-operator">::</span><span class="ruby-constant">Bar</span>.<span class="ruby-identifier">new</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">args</span>)
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:default_storage</span>, <span class="ruby-value">cache:</span> <span class="ruby-value">:custom_cache</span>, <span class="ruby-value">store:</span> <span class="ruby-value">:custom_store</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-3Araise_errors"><code>:raise_errors</code><span><a href="#label-3Araise_errors">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>No equivalent currently exists in <a href="../../classes/Shrine.html"><code>Shrine</code></a>.</p>

<h3 id="label-accepts_attachments_for"><code>accepts_attachments_for</code><span><a href="#label-accepts_attachments_for">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>No equivalent in <a href="../../classes/Shrine.html"><code>Shrine</code></a>, but take a look at the <a target="_top" href="https://shrinerb.com/docs/multiple-files">Multiple Files</a> guide.</p>

<h3 id="label-Form+helpers">Form helpers<span><a href="#label-Form+helpers">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-attachment_field"><code>attachment_field</code><span><a href="#label-attachment_field">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The following Refile code</p>

<pre class="ruby"><span class="ruby-identifier">form_for</span> <span class="ruby-ivar">@user</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">form</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">attachment_field</span> <span class="ruby-value">:profile_image</span>
<span class="ruby-keyword">end</span>
</pre>

<p>is equivalent to the following <a href="../../classes/Shrine.html"><code>Shrine</code></a> code</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:cached_attachment_data</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">form_for</span> <span class="ruby-ivar">@user</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">form</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">hidden_field</span> <span class="ruby-value">:profile_image</span>, <span class="ruby-value">value:</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">cached_profile_image_data</span>, <span class="ruby-value">id:</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">file_field</span> <span class="ruby-value">:profile_image</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Model+methods">Model methods<span><a href="#label-Model+methods">&para;</a> <a href="#top">&uarr;</a></span></h3>

<h4 id="label-remove_-3Cattachment-3E"><code>remove_&lt;attachment&gt;</code><span><a href="#label-remove_-3Cattachment-3E">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> comes with a <code>remove_attachment</code> plugin which adds the same <code>#remove_&lt;attachment&gt;</code> method to the model.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:remove_attachment</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">form_for</span> <span class="ruby-ivar">@user</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">form</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">hidden_field</span> <span class="ruby-value">:profile_image</span>, <span class="ruby-value">value:</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">cached_profile_image_data</span>, <span class="ruby-value">id:</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">file_field</span> <span class="ruby-value">:profile_image</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">check_box</span> <span class="ruby-value">:remove_profile_image</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-remote_-3Cattachment-3E_url"><code>remote_&lt;attachment&gt;_url</code><span><a href="#label-remote_-3Cattachment-3E_url">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> comes with a <code>remote_url</code> plugin which adds the same <code>#&lt;attachment&gt;_remote_url</code> method to the model.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:remote_url</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">form_for</span> <span class="ruby-ivar">@user</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">form</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">hidden_field</span> <span class="ruby-value">:profile_image</span>, <span class="ruby-value">value:</span> <span class="ruby-ivar">@user</span>.<span class="ruby-identifier">cached_profile_image_data</span>, <span class="ruby-value">id:</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">file_field</span> <span class="ruby-value">:profile_image</span>
  <span class="ruby-identifier">form</span>.<span class="ruby-identifier">text_field</span> <span class="ruby-value">:profile_image_remote_url</span>
<span class="ruby-keyword">end</span>
</pre>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
