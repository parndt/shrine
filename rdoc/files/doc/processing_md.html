<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
<head>
<title>processing.md</title>
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<link href='../../css/style.css' media='screen' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
  function popupCode(url) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }
  
  function toggleCode(id) {
    var code = document.getElementById(id)
  
    code.style.display = code.style.display != 'block' ? 'block' : 'none'
    return true
  }
  
  // Make codeblocks hidden by default
  document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
</script>
</head>
<body class='page'>
<div class='file' id='wrapper'>
<div class='header'>
<h1 class='name'>processing.md
</h1>
<div class='paths'>
doc/processing.md
</div>
<div class='last-update'>
Last Update:
<span class='datetime'>2023-01-04 11:06:42 +0100</span>
</div>
</div>
<div id='content'>
<div id='text'>
<div id='description'>
<p>—</p>

<h2 id="label-title-3A+File+Processing">title: File Processing<span><a href="#label-title-3A+File+Processing">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> allows you to process attached files eagerly or on-the-fly. For example, if your app is accepting image uploads, you can generate a predefined set of of thumbnails when the image is attached to a record, or you can have thumbnails generated dynamically as they’re needed.</p>

<p>How you’re going to implement processing is entirely up to you. For images it’s recommended to use the <strong>{ImageProcessing}[https://github.com/janko/image_processing]</strong> gem, which provides wrappers for processing with <a target="_top" href="https://github.com/janko/image_processing/blob/master/doc/minimagick.md#readme">MiniMagick</a> and <a target="_top" href="https://github.com/janko/image_processing/blob/master/doc/vips.md#readme">libvips</a>. Here is an example of generating a thumbnail with ImageProcessing:</p>

<pre>$ brew install imagemagick</pre>

<pre class="ruby"><span class="ruby-comment"># Gemfile</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;image_processing&quot;</span>, <span class="ruby-string">&quot;~&gt; 1.8&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;image_processing/mini_magick&quot;</span>

<span class="ruby-identifier">thumbnail</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>
  .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">image</span>)              <span class="ruby-comment"># input file</span>
  .<span class="ruby-identifier">resize_to_limit</span>(<span class="ruby-value">600</span>, <span class="ruby-value">400</span>)  <span class="ruby-comment"># resize macro</span>
  .<span class="ruby-identifier">colorspace</span>(<span class="ruby-string">&quot;grayscale&quot;</span>)    <span class="ruby-comment"># custom operation</span>
  .<span class="ruby-identifier">convert</span>(<span class="ruby-string">&quot;jpeg&quot;</span>)            <span class="ruby-comment"># output type</span>
  .<span class="ruby-identifier">saver</span>(<span class="ruby-value">quality:</span> <span class="ruby-value">90</span>)         <span class="ruby-comment"># output options</span>
  .<span class="ruby-identifier">call</span>                       <span class="ruby-comment"># run the pipeline</span>

<span class="ruby-identifier">thumbnail</span> <span class="ruby-comment">#=&gt; #&lt;Tempfile:...&gt; (a 600x400 thumbnail of the source image)</span>
</pre>

<h2 id="label-Eager+processing">Eager processing<span><a href="#label-Eager+processing">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Let’s say we’re handling images, and want to generate a predefined set of thumbnails with various dimensions. We can use the <strong>{<code>derivatives</code>}[https://shrinerb.com/docs/plugins/derivatives]</strong> plugin to upload and save the processed files:</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivatives</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;image_processing/mini_magick&quot;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">magick</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)

    {
      <span class="ruby-value">large:</span>  <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">800</span>, <span class="ruby-value">800</span>),
      <span class="ruby-value">medium:</span> <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">500</span>, <span class="ruby-value">500</span>),
      <span class="ruby-value">small:</span>  <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">300</span>, <span class="ruby-value">300</span>),
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span> = <span class="ruby-constant">Photo</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">image:</span> <span class="ruby-identifier">file</span>)

<span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">valid?</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_derivatives!</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_changed?</span> <span class="ruby-comment"># creates derivatives</span>
  <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">save</span>
<span class="ruby-keyword">end</span>
</pre>

<p>After the processed files are uploaded, their data is saved into the <code>&lt;attachment&gt;_data</code> column. You can then retrieve the derivatives as {<code>Shrine::UploadedFile</code><a target="_top" href="http://shrinerb.com/rdoc/classes/Shrine/UploadedFile/InstanceMethods.html">}</a> objects:</p>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>(<span class="ruby-value">:large</span>)            <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>(<span class="ruby-value">:large</span>).<span class="ruby-identifier">url</span>        <span class="ruby-comment">#=&gt; &quot;/uploads/store/lg043.jpg&quot;</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>(<span class="ruby-value">:large</span>).<span class="ruby-identifier">size</span>       <span class="ruby-comment">#=&gt; 5825949</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>(<span class="ruby-value">:large</span>).<span class="ruby-identifier">mime_type</span>  <span class="ruby-comment">#=&gt; &quot;image/jpeg&quot;</span>
</pre>

<h3 id="label-Conditional+derivatives">Conditional derivatives<span><a href="#label-Conditional+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>The <code>Attacher.derivatives</code> block is evaluated in context of a <code>Shrine::Attacher</code> instance:</p>

<pre class="ruby"><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
  <span class="ruby-keyword">self</span>    <span class="ruby-comment">#=&gt; #&lt;Shrine::Attacher&gt;</span>

  <span class="ruby-identifier">file</span>    <span class="ruby-comment">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>
  <span class="ruby-identifier">record</span>  <span class="ruby-comment">#=&gt; #&lt;Photo&gt;</span>
  <span class="ruby-identifier">name</span>    <span class="ruby-comment">#=&gt; :image</span>
  <span class="ruby-identifier">context</span> <span class="ruby-comment">#=&gt; { ... }</span>

  <span class="ruby-comment"># ...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This gives you the ability to branch the processing logic based on the attachment information:</p>

<pre class="ruby"><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">magick</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)
  <span class="ruby-identifier">result</span> = {}

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Photo</span>)
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:jpg</span>]  = <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">convert!</span>(<span class="ruby-string">&quot;jpeg&quot;</span>)
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:gray</span>] = <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">colorspace!</span>(<span class="ruby-string">&quot;grayscale&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">mime_type</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;image/svg+xml&quot;</span>
    <span class="ruby-identifier">result</span>[<span class="ruby-value">:png</span>] = <span class="ruby-identifier">magick</span>.<span class="ruby-identifier">loader</span>(<span class="ruby-value">transparent:</span> <span class="ruby-string">&quot;white&quot;</span>).<span class="ruby-identifier">convert!</span>(<span class="ruby-string">&quot;png&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span>
</pre>

<p>The {<code>type_predicates</code><a target="_top" href="https://shrinerb.com/docs/plugins/type_predicates">}</a> plugin provides convenient predicate methods for branching based on the file type.</p>

<h3 id="label-Backgrounding">Backgrounding<span><a href="#label-Backgrounding">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Since file processing can be time consuming, it’s recommended to move it into a background job.</p>

<h4 id="label-A-29+Creating+derivatives+with+promotion">A) Creating derivatives with promotion<span><a href="#label-A-29+Creating+derivatives+with+promotion">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>The simplest way is to use the {<code>backgrounding</code><a target="_top" href="https://shrinerb.com/docs/plugins/backgrounding">}</a> plugin to move promotion into a background job, and then create derivatives as part of promotion:</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:backgrounding</span>
<span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">promote_block</span> <span class="ruby-keyword">do</span>
  <span class="ruby-constant">PromoteJob</span>.<span class="ruby-identifier">perform_async</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">record</span>.<span class="ruby-identifier">id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>)
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">PromoteJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
    <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-value">model:</span> <span class="ruby-identifier">record</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">file:</span> <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">create_derivatives</span> <span class="ruby-comment"># calls derivatives processor</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_promote</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>
    <span class="ruby-comment"># attachment has changed or the record has been deleted, nothing to do</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-B-29+Creating+derivatives+separately+from+promotion">B) Creating derivatives separately from promotion<span><a href="#label-B-29+Creating+derivatives+separately+from+promotion">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>Derivatives don’t need to be created as part of the attachment flow, you can create them at any point after promotion:</p>

<pre class="ruby"><span class="ruby-constant">DerivativesJob</span>.<span class="ruby-identifier">perform_async</span>(
  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>,
  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>,
  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">record</span>.<span class="ruby-identifier">id</span>,
  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">name</span>,
  <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file_data</span>,
)
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">DerivativesJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
    <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-value">model:</span> <span class="ruby-identifier">record</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">file:</span> <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">create_derivatives</span> <span class="ruby-comment"># calls derivatives processor</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>
    <span class="ruby-identifier">attacher</span>&amp;.<span class="ruby-identifier">destroy_attached</span> <span class="ruby-comment"># delete now orphaned derivatives</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h4 id="label-C-29+Creating+derivatives+concurrently">C) Creating derivatives concurrently<span><a href="#label-C-29+Creating+derivatives+concurrently">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>You can also generate derivatives concurrently:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">THUMBNAILS</span> = {
    <span class="ruby-value">large:</span>  [<span class="ruby-value">800</span>, <span class="ruby-value">800</span>],
    <span class="ruby-value">medium:</span> [<span class="ruby-value">500</span>, <span class="ruby-value">500</span>],
    <span class="ruby-value">small:</span>  [<span class="ruby-value">300</span>, <span class="ruby-value">300</span>],
  }

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span>, <span class="ruby-value">name:</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">thumbnail</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>
      .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)
      .<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-operator">*</span><span class="ruby-constant">THUMBNAILS</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">name</span>))

    { <span class="ruby-identifier">name</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-identifier">thumbnail</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-constant">ImageUploader</span><span class="ruby-operator">::</span><span class="ruby-constant">THUMBNAILS</span>.<span class="ruby-identifier">each_key</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">derivative_name</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">DerivativeJob</span>.<span class="ruby-identifier">perform_async</span>(
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">record</span>.<span class="ruby-identifier">id</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">name</span>,
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">file_data</span>,
    <span class="ruby-identifier">derivative_name</span>,
  )
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">DerivativeJob</span>
  <span class="ruby-identifier">include</span> <span class="ruby-constant">Sidekiq</span><span class="ruby-operator">::</span><span class="ruby-constant">Worker</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">perform</span>(<span class="ruby-identifier">attacher_class</span>, <span class="ruby-identifier">record_class</span>, <span class="ruby-identifier">record_id</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">file_data</span>, <span class="ruby-identifier">derivative_name</span>)
    <span class="ruby-identifier">attacher_class</span> = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">attacher_class</span>)
    <span class="ruby-identifier">record</span>         = <span class="ruby-constant">Object</span>.<span class="ruby-identifier">const_get</span>(<span class="ruby-identifier">record_class</span>).<span class="ruby-identifier">find</span>(<span class="ruby-identifier">record_id</span>) <span class="ruby-comment"># if using Active Record</span>

    <span class="ruby-identifier">attacher</span> = <span class="ruby-identifier">attacher_class</span>.<span class="ruby-identifier">retrieve</span>(<span class="ruby-value">model:</span> <span class="ruby-identifier">record</span>, <span class="ruby-value">name:</span> <span class="ruby-identifier">name</span>, <span class="ruby-value">file:</span> <span class="ruby-identifier">file_data</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">create_derivatives</span>(<span class="ruby-value">name:</span> <span class="ruby-identifier">derivative_name</span>)
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">atomic_persist</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">reloaded_attacher</span><span class="ruby-operator">|</span>
      <span class="ruby-comment"># make sure we don&#39;t override derivatives created in other jobs</span>
      <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">merge_derivatives</span>(<span class="ruby-identifier">reloaded_attacher</span>.<span class="ruby-identifier">derivatives</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">AttachmentChanged</span>, <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">RecordNotFound</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">derivatives</span>[<span class="ruby-identifier">derivative_name</span>].<span class="ruby-identifier">delete</span> <span class="ruby-comment"># delete now orphaned derivative</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-URL+fallbacks">URL fallbacks<span><a href="#label-URL+fallbacks">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you’re creating derivatives in a background job, you’ll likely want to use some fallbacks for derivative URLs while the background job is still processing. You can do that with the {<code>default_url</code><a target="_top" href="https://shrinerb.com/docs/plugins/default_url">}</a> plugin.</p>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:default_url</span>
</pre>

<h4 id="label-A-29+Fallback+to+original">A) Fallback to original<span><a href="#label-A-29+Fallback+to+original">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>You can fall back to the original file URL when the derivative is missing:</p>

<pre class="ruby"><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">default_url</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-value">derivative:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">file</span>&amp;.<span class="ruby-identifier">url</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">derivative</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-value">:large</span>) <span class="ruby-comment">#=&gt; &quot;https://example.com/path/to/original.jpg&quot;</span>
<span class="ruby-comment"># ... background job finishes ...</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-value">:large</span>) <span class="ruby-comment">#=&gt; &quot;https://example.com/path/to/large.jpg&quot;</span>
</pre>

<h4 id="label-B-29+Fallback+to+derivative">B) Fallback to derivative<span><a href="#label-B-29+Fallback+to+derivative">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>You can fall back to another derivative URL when the derivative is missing:</p>

<pre class="ruby"><span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">default_url</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-value">derivative:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">derivatives</span>[<span class="ruby-value">:optimized</span>]&amp;.<span class="ruby-identifier">url</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">derivative</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-value">:large</span>) <span class="ruby-comment">#=&gt; &quot;https://example.com/path/to/optimized.jpg&quot;</span>
<span class="ruby-comment"># ... background job finishes ...</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-value">:large</span>) <span class="ruby-comment">#=&gt; &quot;https://example.com/path/to/large.jpg&quot;</span>
</pre>

<h4 id="label-C-29+Fallback+to+on-the-fly">C) Fallback to on-the-fly<span><a href="#label-C-29+Fallback+to+on-the-fly">&para;</a> <a href="#top">&uarr;</a></span></h4>

<p>You can also fall back to <a href="#on-the-fly-processing">on-the-fly processing</a>, which should generally provide the best user experience.</p>

<pre class="ruby"><span class="ruby-constant">THUMBNAILS</span> = {
  <span class="ruby-value">small:</span>  [<span class="ruby-value">300</span>, <span class="ruby-value">300</span>],
  <span class="ruby-value">medium:</span> [<span class="ruby-value">500</span>, <span class="ruby-value">500</span>],
  <span class="ruby-value">large:</span>  [<span class="ruby-value">800</span>, <span class="ruby-value">800</span>],
}

<span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">default_url</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-value">derivative:</span> <span class="ruby-keyword">nil</span>, <span class="ruby-operator">**</span><span class="ruby-operator">|</span>
  <span class="ruby-identifier">file</span>&amp;.<span class="ruby-identifier">derivation_url</span>(<span class="ruby-value">:thumbnail</span>, <span class="ruby-operator">*</span><span class="ruby-constant">THUMBNAILS</span>.<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">derivative</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">derivative</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-value">:large</span>) <span class="ruby-comment">#=&gt; &quot;../derivations/thumbnail/800/800/...&quot;</span>
<span class="ruby-comment"># ... background job finishes ...</span>
<span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image_url</span>(<span class="ruby-value">:large</span>) <span class="ruby-comment">#=&gt; &quot;https://example.com/path/to/large.jpg&quot;</span>
</pre>

<h2 id="label-On-the-fly+processing">On-the-fly processing<span><a href="#label-On-the-fly+processing">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Having eagerly created image thumbnails can be a pain to maintain, because whenever you need to add a new version or change an existing one, you need to retroactively apply it to all existing attachments (see the <a target="_top" href="https://shrinerb.com/docs/changing-derivatives">Managing Derivatives</a> guide for more details).</p>

<p>Sometimes it makes more sense to generate thumbnails dynamically as they’re requested, and then cache them for future requests. This strategy is known as processing “<strong>on-the-fly</strong>” or “<strong>on-demand</strong>”, and it’s suitable for short-running processing such as creating image thumbnails or document previews.</p>

<p><a href="../../classes/Shrine.html"><code>Shrine</code></a> provides on-the-fly processing functionality via the <strong>{<code>derivation_endpoint</code>}[https://shrinerb.com/docs/plugins/derivation_endpoint]</strong> plugin. You set it up by loading the plugin with a secret key (you generate this yourself, maybe via something like <code>SecureRandom.hex</code>) and a path prefix, mount its Rack app in your routes on the configured path prefix, and define processing you want to perform:</p>

<pre class="ruby"><span class="ruby-comment"># config/initializers/shrine.rb (Rails)</span>
<span class="ruby-comment"># ...</span>
<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivation_endpoint</span>, <span class="ruby-value">secret_key:</span> <span class="ruby-string">&quot;&lt;SHRINE_SECRET_KEY&gt;&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;image_processing/mini_magick&quot;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivation_endpoint</span>, <span class="ruby-value">prefix:</span> <span class="ruby-string">&quot;derivations/image&quot;</span> <span class="ruby-comment"># matches mount point</span>

  <span class="ruby-identifier">derivation</span> <span class="ruby-value">:thumbnail</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">file</span>, <span class="ruby-identifier">width</span>, <span class="ruby-identifier">height</span><span class="ruby-operator">|</span>
    <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">MiniMagick</span>
      .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">file</span>)
      .<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-identifier">width</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">height</span>.<span class="ruby-identifier">to_i</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-comment"># config/routes.rb (Rails)</span>
<span class="ruby-constant">Rails</span>.<span class="ruby-identifier">application</span>.<span class="ruby-identifier">routes</span>.<span class="ruby-identifier">draw</span> <span class="ruby-keyword">do</span>
  <span class="ruby-comment"># ...</span>
  <span class="ruby-identifier">mount</span> <span class="ruby-constant">ImageUploader</span>.<span class="ruby-identifier">derivation_endpoint</span> <span class="ruby-operator">=&gt;</span> <span class="ruby-string">&quot;/derivations/image&quot;</span>
<span class="ruby-keyword">end</span>
</pre>

<p>Now you can generate thumbnail URLs from attached files, and the actual thumbnail will be generated when the URL is requested:</p>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">derivation_url</span>(<span class="ruby-value">:thumbnail</span>, <span class="ruby-value">600</span>, <span class="ruby-value">400</span>)
<span class="ruby-comment">#=&gt; &quot;/derivations/image/thumbnail/600/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=...&quot;</span>
</pre>

<p>The plugin is highly customizable, be sure to check out the <a target="_top" href="https://shrinerb.com/docs/plugins/derivation_endpoint">documentation</a>, especially the <a target="_top" href="https://shrinerb.com/docs/plugins/derivation_endpoint#performance">performance section</a>.</p>

<h3 id="label-Dynamic+derivation">Dynamic derivation<span><a href="#label-Dynamic+derivation">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you have multiple types of transformations and don’t want to have a derivation for each one, you can set up a single derivation that applies any series of transformations:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-identifier">derivation</span> <span class="ruby-value">:transform</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span>, <span class="ruby-identifier">transformations</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">transformations</span> = <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">urlsafe_deserialize</span>(<span class="ruby-identifier">transformations</span>)

    <span class="ruby-identifier">vips</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">Vips</span>.<span class="ruby-identifier">source</span>(<span class="ruby-identifier">original</span>)
    <span class="ruby-identifier">vips</span>.<span class="ruby-identifier">apply!</span>(<span class="ruby-identifier">transformations</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>.<span class="ruby-identifier">derivation_url</span> <span class="ruby-value">:transform</span>, <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">urlsafe_serialize</span>(
  <span class="ruby-value">crop:</span>          [<span class="ruby-value">10</span>, <span class="ruby-value">10</span>, <span class="ruby-value">500</span>, <span class="ruby-value">500</span>],
  <span class="ruby-value">resize_to_fit:</span> [<span class="ruby-value">300</span>, <span class="ruby-value">300</span>],
  <span class="ruby-value">gaussblur:</span>     <span class="ruby-value">1</span>,
)
</pre>

<p>You can create a helper method for convenience:</p>

<pre class="ruby"><span class="ruby-keyword">def</span> <span class="ruby-identifier ruby-title">derivation_url</span>(<span class="ruby-identifier">file</span>, <span class="ruby-identifier">transformations</span>)
  <span class="ruby-identifier">file</span>.<span class="ruby-identifier">derivation_url</span>(<span class="ruby-value">:transform</span>, <span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">urlsafe_serialize</span>(<span class="ruby-identifier">transformations</span>))
<span class="ruby-keyword">end</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">derivation_url</span> <span class="ruby-identifier">photo</span>.<span class="ruby-identifier">image</span>,
  <span class="ruby-value">crop:</span>          [<span class="ruby-value">10</span>, <span class="ruby-value">10</span>, <span class="ruby-value">500</span>, <span class="ruby-value">500</span>],
  <span class="ruby-value">resize_to_fit:</span> [<span class="ruby-value">300</span>, <span class="ruby-value">300</span>],
  <span class="ruby-value">gaussblur:</span>     <span class="ruby-value">1</span>
</pre>

<h2 id="label-Processing+other+filetypes">Processing other filetypes<span><a href="#label-Processing+other+filetypes">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>So far we’ve only been talking about processing images. However, there is nothing image-specific in Shrine’s processing API, you can just as well process any other types of files. The processing tool doesn’t need to have any special <a href="../../classes/Shrine.html"><code>Shrine</code></a> integration, the ImageProcessing gem that we saw earlier is a completely generic gem.</p>

<p>To demonstrate, here is an example of transcoding videos using <a target="_top" href="https://github.com/streamio/streamio-ffmpeg">streamio-ffmpeg</a>:</p>

<pre class="ruby"><span class="ruby-comment"># Gemfile</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;streamio-ffmpeg&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;streamio-ffmpeg&quot;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">VideoUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">transcoded</span> = <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span> [<span class="ruby-string">&quot;transcoded&quot;</span>, <span class="ruby-string">&quot;.mp4&quot;</span>]
    <span class="ruby-identifier">screenshot</span> = <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span> [<span class="ruby-string">&quot;screenshot&quot;</span>, <span class="ruby-string">&quot;.jpg&quot;</span>]

    <span class="ruby-identifier">movie</span> = <span class="ruby-constant">FFMPEG</span><span class="ruby-operator">::</span><span class="ruby-constant">Movie</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">original</span>.<span class="ruby-identifier">path</span>)
    <span class="ruby-identifier">movie</span>.<span class="ruby-identifier">transcode</span>(<span class="ruby-identifier">transcoded</span>.<span class="ruby-identifier">path</span>)
    <span class="ruby-identifier">movie</span>.<span class="ruby-identifier">screenshot</span>(<span class="ruby-identifier">screenshot</span>.<span class="ruby-identifier">path</span>)

    { <span class="ruby-value">transcoded:</span> <span class="ruby-identifier">transcoded</span>, <span class="ruby-value">screenshot:</span> <span class="ruby-identifier">screenshot</span> }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h3 id="label-Polymorphic+uploader">Polymorphic uploader<span><a href="#label-Polymorphic+uploader">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Sometimes you might want an attachment attribute to accept multiple types of files, and apply different processing depending on the type. Since Shrine’s processing blocks are evaluated dynamically, you can use conditional logic:</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">PolymorphicUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">IMAGE_TYPES</span> = <span class="ruby-node">%w[image/jpeg image/png image/webp]</span>
  <span class="ruby-constant">VIDEO_TYPES</span> = <span class="ruby-node">%w[video/mp4 video/quicktime]</span>
  <span class="ruby-constant">PDF_TYPES</span>   = <span class="ruby-node">%w[application/pdf]</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">validate</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">validate_mime_type</span> <span class="ruby-constant">IMAGE_TYPES</span> <span class="ruby-operator">+</span> <span class="ruby-constant">VIDEO_TYPES</span> <span class="ruby-operator">+</span> <span class="ruby-constant">PDF_TYPES</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">file</span>.<span class="ruby-identifier">mime_type</span>
    <span class="ruby-keyword">when</span> <span class="ruby-operator">*</span><span class="ruby-constant">IMAGE_TYPES</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">process_derivatives</span>(<span class="ruby-value">:image</span>, <span class="ruby-identifier">original</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-operator">*</span><span class="ruby-constant">VIDEO_TYPES</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">process_derivatives</span>(<span class="ruby-value">:video</span>, <span class="ruby-identifier">original</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-operator">*</span><span class="ruby-constant">PDF_TYPES</span>   <span class="ruby-keyword">then</span> <span class="ruby-identifier">process_derivatives</span>(<span class="ruby-value">:pdf</span>,   <span class="ruby-identifier">original</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-value">:image</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-value">:video</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-value">:pdf</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">original</span><span class="ruby-operator">|</span>
    <span class="ruby-comment"># ...</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<h2 id="label-Extras">Extras<span><a href="#label-Extras">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Automatic+derivatives">Automatic derivatives<span><a href="#label-Automatic+derivatives">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you would like derivatives to be automatically created with promotion, you can use the <code>create_on_promote</code> option built-in to the derivatives plugin.</p>

<pre class="ruby"><span class="ruby-keyword">class</span> <span class="ruby-constant">Shrine</span><span class="ruby-operator">::</span><span class="ruby-constant">Attacher</span>
  <span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivatives</span>, <span class="ruby-value">create_on_promote:</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This shouldn’t be needed if you’re processing in the <a href="#backgrounding">background</a>, as in that case you have a background worker that will be called for each attachment, so you can call <code>Attacher#create_derivatives</code> there.</p>

<h3 id="label-libvips">libvips<span><a href="#label-libvips">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>As mentioned, ImageProcessing gem also has an alternative backend for processing images with <strong>{libvips}[https://libvips.github.io/libvips/]</strong>. libvips is a full-featured image processing library like ImageMagick, with impressive performance characteristics – it’s often <strong>multiple times faster</strong> than ImageMagick and has low memory usage (see <a target="_top" href="https://github.com/libvips/libvips/wiki/Why-is-libvips-quick">Why is libvips quick</a>).</p>

<p>Using libvips is as easy as installing it and switching to the {<code>ImageProcessing::Vips</code><a target="_top" href="https://github.com/janko/image_processing/blob/master/doc/vips.md#readme">}</a> backend:</p>

<pre>$ brew install vips</pre>

<pre class="ruby"><span class="ruby-comment"># Gemfile</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;image_processing&quot;</span>, <span class="ruby-string">&quot;~&gt; 1.8&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;image_processing/vips&quot;</span>

<span class="ruby-comment"># all we did was replace `ImageProcessing::MiniMagick` with `ImageProcessing::Vips`</span>
<span class="ruby-identifier">thumbnail</span> = <span class="ruby-constant">ImageProcessing</span><span class="ruby-operator">::</span><span class="ruby-constant">Vips</span>
  .<span class="ruby-identifier">source</span>(<span class="ruby-identifier">image</span>)
  .<span class="ruby-identifier">resize_to_limit!</span>(<span class="ruby-value">600</span>, <span class="ruby-value">400</span>)

<span class="ruby-identifier">thumbnail</span> <span class="ruby-comment">#=&gt; #&lt;Tempfile:...&gt; (a 600x400 thumbnail of the source image)</span>
</pre>

<h3 id="label-Parallelize+uploads">Parallelize uploads<span><a href="#label-Parallelize+uploads">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>If you’re generating derivatives, you can parallelize the uploads using the <a target="_top" href="https://github.com/ruby-concurrency/concurrent-ruby">concurrent-ruby</a> gem:</p>

<pre class="ruby"><span class="ruby-comment"># Gemfile</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;concurrent-ruby&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;concurrent&quot;</span>

<span class="ruby-identifier">derivatives</span> = <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">process_derivatives</span>

<span class="ruby-identifier">tasks</span> = <span class="ruby-identifier">derivatives</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
  <span class="ruby-constant">Concurrent</span><span class="ruby-operator">::</span><span class="ruby-constant">Promises</span>.<span class="ruby-identifier">future</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">attacher</span>.<span class="ruby-identifier">add_derivative</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">file</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>

<span class="ruby-constant">Concurrent</span><span class="ruby-operator">::</span><span class="ruby-constant">Promises</span>.<span class="ruby-identifier">zip</span>(<span class="ruby-operator">*</span><span class="ruby-identifier">tasks</span>).<span class="ruby-identifier">wait!</span>
</pre>

<h3 id="label-External+processing">External processing<span><a href="#label-External+processing">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>You can also integrate <a href="../../classes/Shrine.html"><code>Shrine</code></a> with 3rd-party processing services such as <a target="_top" href="https://cloudinary.com/">Cloudinary</a> and <a target="_top" href="https://www.imgix.com/">Imgix</a>. In the most common case, you’d serve images directly from these services, see the corresponding plugin docs for more details (<a target="_top" href="https://github.com/shrinerb/shrine-cloudinary">shrine-cloudinary</a>, <a target="_top" href="https://github.com/shrinerb/shrine-imgix">shrine-imgix</a> and <a target="_top" href="https://shrinerb.com/docs/external/extensions#storages">others</a>)</p>

<p>You can also choose to use these services as an implementation detail of your application, by downloading the processed images and saving them to your storage. Here is how you might store files processed by Imgix as derivatives:</p>

<pre class="ruby"><span class="ruby-comment"># Gemfile</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;down&quot;</span>, <span class="ruby-string">&quot;~&gt; 5.0&quot;</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;http&quot;</span>, <span class="ruby-string">&quot;~&gt; 4.0&quot;</span>
<span class="ruby-identifier">gem</span> <span class="ruby-string">&quot;shrine-imgix&quot;</span>, <span class="ruby-string">&quot;~&gt; 0.5&quot;</span>
</pre>

<pre class="ruby"><span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:derivatives</span>
<span class="ruby-constant">Shrine</span>.<span class="ruby-identifier">plugin</span> <span class="ruby-value">:imgix</span>, <span class="ruby-value">client:</span> { <span class="ruby-value">host:</span> <span class="ruby-string">&quot;my-app.imgix.net&quot;</span>, <span class="ruby-value">secure_url_token:</span> <span class="ruby-string">&quot;secret&quot;</span> }
</pre>

<pre class="ruby"><span class="ruby-identifier">require</span> <span class="ruby-string">&quot;down/http&quot;</span>

<span class="ruby-keyword">class</span> <span class="ruby-constant">ImageUploader</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">Shrine</span>
  <span class="ruby-constant">IMGIX_THUMBNAIL</span> = <span class="ruby-operator">-&gt;</span> (<span class="ruby-identifier">file</span>, <span class="ruby-identifier">width</span>, <span class="ruby-identifier">height</span>) <span class="ruby-keyword">do</span>
    <span class="ruby-constant">Down</span><span class="ruby-operator">::</span><span class="ruby-constant">Http</span>.<span class="ruby-identifier">download</span>(<span class="ruby-identifier">file</span>.<span class="ruby-identifier">imgix_url</span>(<span class="ruby-value">w:</span> <span class="ruby-identifier">width</span>, <span class="ruby-value">h:</span> <span class="ruby-identifier">height</span>))
  <span class="ruby-keyword">end</span>

  <span class="ruby-constant">Attacher</span>.<span class="ruby-identifier">derivatives</span> <span class="ruby-keyword">do</span>
    {
      <span class="ruby-value">large:</span>  <span class="ruby-constant">IMGIX_THUMBNAIL</span>[<span class="ruby-identifier">file</span>, <span class="ruby-value">800</span>, <span class="ruby-value">800</span>],
      <span class="ruby-value">medium:</span> <span class="ruby-constant">IMGIX_THUMBNAIL</span>[<span class="ruby-identifier">file</span>, <span class="ruby-value">500</span>, <span class="ruby-value">500</span>],
      <span class="ruby-value">small:</span>  <span class="ruby-constant">IMGIX_THUMBNAIL</span>[<span class="ruby-identifier">file</span>, <span class="ruby-value">300</span>, <span class="ruby-value">300</span>],
    }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>
</div>
<div id='context'>
</div>

</div>
</div>

<div id='footer-push'></div>
</div>
<div id='footer'>
<a href="https://github.com/jeremyevans/hanna-nouveau"><strong>Hanna Nouveau</strong> RDoc template</a>
</div>
</body>
</html>
